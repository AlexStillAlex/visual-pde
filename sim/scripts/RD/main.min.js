let e,t,n,i,o,a,r,s,l,u,c,d,f,h,m,p,g,b,v,_,w,y,S,C,D,x,F,E,T,A,V,U,P,k,q,M,R,I,L,N,B,O,W,j,Q,z,G,H,Y,J,X,Z,K,ee,te,ne,ie,oe,ae,re,se,le,ue,ce,de,fe,he,me,pe,ge,be,ve,_e,we=[],ye={},Se=[],Ce=[],De=[],xe=new Set,Fe=!0,Ee=!1,$e=!0,Te=!0,Ae=!1,Ve=!1,Ue=!1,Pe=!1,ke=!1,qe=!1,Me=0,Re=performance.now(),Ie=!1,Le=!0,Ne=1,Be=1,Oe=.15,We={},je=[],Qe={},ze=0;const Ge=["u","v","w","q"],He=["UFUN","VFUN","WFUN","QFUN"],Ye=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let Je,Xe,Ze,Ke,et,tt,nt,it=!1,ot=!1;const at=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as rt,drawShaderBotReplace as st,drawShaderBotAdd as lt,drawShaderShapeDisc as ut,drawShaderShapeVLine as ct,drawShaderShapeHLine as dt,drawShaderFactorSharp as ft,drawShaderFactorSmooth as ht}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as mt,computeDisplayFunShaderMid as pt,postGenericShaderBot as gt,postShaderDomainIndicator as bt,interpolationShader as vt}from"./post_shaders.js";import{copyShader as _t}from"../copy_shader.js";import{RDShaderTop as wt,RDShaderBot as yt,RDShaderDirichletX as St,RDShaderDirichletY as Ct,RDShaderDirichletIndicatorFun as Dt,RDShaderRobinX as xt,RDShaderRobinY as Ft,RDShaderRobinCustomDomainX as Et,RDShaderRobinCustomDomainY as $t,RDShaderUpdateNormal as Tt,RDShaderUpdateCross as At,RDShaderAlgebraicSpecies as Vt,RDShaderEnforceDirichletTop as Ut,RDShaderAdvectionPreBC as Pt,RDShaderAdvectionPostBC as kt,RDShaderDiffusionPreBC as qt,RDShaderDiffusionPostBC as Mt,RDShaderGhostX as Rt,RDShaderGhostY as It,RDShaderMain as Lt}from"./simulation_shaders.js";import{randShader as Nt,randNShader as Bt}from"../rand_shader.js";import{fiveColourDisplayTop as Ot,fiveColourDisplayBot as Wt,embossShader as jt,contourShader as Qt,surfaceVertexShaderColour as zt,surfaceVertexShaderCustom as Gt,overlayShader as Ht}from"./display_shaders.js";import{getColours as Yt}from"../colourmaps.js";import{genericVertexShader as Jt}from"../generic_shaders.js";import{getPreset as Xt,getUserTextFields as Zt,getFieldsInView as Kt,getListOfPresets as en,getOldPresetFieldsToNew as tn}from"./presets.js";import{clearShaderBot as nn,clearShaderTop as on}from"./clear_shader.js";import*as an from"../three.module.min.js";import{OrbitControls as rn}from"../OrbitControls.js";import{Line2 as sn}from"../lines/Line2.js";import{LineMaterial as ln}from"../lines/LineMaterial.js";import{LineGeometry as un}from"../lines/LineGeometry.js";import{minifyPreset as cn,maxifyPreset as dn}from"./minify_preset.js";import{LZString as fn}from"../lz-string.min.js";import{equationTEXFun as hn,getDefaultTeXLabelsDiffusion as mn,getDefaultTeXLabelsReaction as pn,getDefaultTeXLabelsBCsICs as gn,substituteGreek as bn}from"./TEX.js";let vn,_n,wn,yn=hn(),Sn={...mn(),...pn(),...gn()};const Cn=Kt();let Dn=new exprEval.Parser;Dn.consts.pi=Math.PI,Dn.consts.Pi=Math.PI,Dn.consts.e=Math.exp(1),O={};const xn=Zt();var Fn,En;j={reset:function(){ei()},toggleRunning:function(){ie?Zn():Kn()},copyConfigAsURL:function(){ua(la())},saveSimState:function(){Po()},exportSimState:function(){ko()},clearCheckpoints:function(){qe&&(p.dispose(),p=null,qe=!1)}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Fn=Array.prototype.push,En=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Fn.apply(this,En.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Pe=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Lo(t.toString().trim()+". Click <a href='/user-guide/FAQ#undeclared' target='blank'>here</a> for more information.")},Li()||$("#logo").hide();const $n=new URLSearchParams(window.location.search);if($n.has("no_ui")?($(".ui").addClass("hidden"),ke=!0):$(".ui").removeClass("hidden"),$n.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),ke=!0),$n.has("sf")&&(Be=parseFloat($n.get("sf")),(isNaN(Be)||Be<=0)&&(Be=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!ke){$("#warning").css("display","block");await Promise.race([no(document.getElementById("warning_ok"),"click",!0),no(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}ui("default"),function(){W={brushCoords:{type:"v2",value:new an.Vector2(.5,.5)},colour1:{type:"v4",value:new an.Vector4(0,0,0,0)},colour2:{type:"v4",value:new an.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new an.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new an.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new an.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},oe=!1,c=new an.Raycaster,d=new an.Vector2,s=new an.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),s.autoClear=!0,t=s.getContext(),ge=t.getParameter(t.MAX_TEXTURE_SIZE),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:an.RGBAFormat,type:an.FloatType,minFilter:an.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?an.NearestFilter:an.LinearFilter,we.push(new an.WebGLRenderTarget(O.maxDisc,O.maxDisc,m)),we.push(we[0].clone()),we.push(we[0].clone()),we.push(we[0].clone()),we.push(we[0].clone()),f=we[0].clone(),h=we[0].clone(),we.forEach((e=>{e.texture.wrapS=an.RepeatWrapping,e.texture.wrapT=an.RepeatWrapping})),f.texture.wrapS=an.ClampToEdgeWrapping,f.texture.wrapT=an.ClampToEdgeWrapping,h.texture.wrapS=an.ClampToEdgeWrapping,h.texture.wrapT=an.ClampToEdgeWrapping,i=new an.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new rn(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==O.plotType&&(O.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,O.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,O.cameraZoom=i.zoom,zo("cameraTheta"),zo("cameraPhi"),zo("cameraZoom"),ci(H),ga())})),o=new an.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new an.Scene,r=new an.Scene,a.add(i),a.background=new an.Color(O.backgroundColour),g=new an.MeshBasicMaterial({side:an.DoubleSide}),b=new an.ShaderMaterial({uniforms:W,vertexShader:Jt(),transparent:!0,side:an.DoubleSide}),S=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()}),F=new an.ShaderMaterial({uniforms:W,vertexShader:Jt(),fragmentShader:vt()}),v=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()}),ye.FE=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()}),ye.AB2=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()});for(let e=1;e<3;e++)ye["Mid"+e.toString()]=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()});for(let e=1;e<5;e++)ye["RK4"+e.toString()]=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()});y=new an.ShaderMaterial({uniforms:W,vertexShader:Jt(),fragmentShader:_t()}),w=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()}),_=new an.ShaderMaterial({uniforms:W,vertexShader:Jt()}),C=new ln({vertexColors:!0,linewidth:.01}),D=new ln({color:0,linewidth:.01}),x=new an.MeshBasicMaterial({color:O.arrowColour,side:an.DoubleSide}),E=new an.MeshBasicMaterial,T=new an.CylinderGeometry(.008,.008,.1),A=new an.ConeGeometry(.04,.04,4);const l=new an.PlaneGeometry(1,1);U=new an.Mesh(l,ye[0]),U.position.z=0,U.matrixWorldAutoUpdate=!1,r.add(U),Mn(),Rn(),Pn(),Ln(),Vn(),Nn(),Fi(),$i(),On(),Bn(),bi(),eo(),ei(),e.addEventListener("pointerdown",Gn),e.addEventListener("pointerup",Hn),e.addEventListener("pointermove",Yn),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(j.toggleRunning(),e.preventDefault()),"h"===e.key&&(ke?(ke=!1,$(".ui").removeClass("hidden"),ee.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",ue),ie?Kn():Zn(),Ki(),lo(),_o()):(ke=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Po(),"c"==e.key&&(O.resetFromCheckpoints=!O.resetFromCheckpoints,ba($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Vn(),ga()}),!1),window.addEventListener("message",ca),$("#checkpointInput").change((function(){qo(this.files[0]),this.value=null}))}();let Tn=!0;if($n.has("preset")&&(li($n.get("preset")),Tn=!1),$n.has("options")){var An=JSON.parse(fn.decompressFromEncodedURIComponent($n.get("options")));An.hasOwnProperty("p")&&(An=dn(An)),li(An),Tn=!1}function Vn(){Mn(),function(){U.material=y;for(let e=1;e<we.length;e++)W.textureSource.value=we[e].texture,we[e-1].setSize(de,fe),s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1),we[0].dispose(),we[0]=we[1].clone(),f.setSize(de,fe),zn(),h.setSize(Math.round(devicePixelRatio*be),Math.round(devicePixelRatio*ve))}(),Mo(p),kn(),Un(),Da(),Pn(),lo(),_o()}function Un(){V.geometry.dispose(),a.remove(V),P.geometry.dispose(),a.remove(P),k.geometry.dispose(),a.remove(k),q.geometry.dispose(),a.remove(q),Rn()}function Pn(){switch(qn(),O.plotType){case"line":u.enabled=!1,i.zoom=1,so(),b.vertexShader=zt();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=Jt();break;case"surface":u.enabled=!0,i.zoom=O.cameraZoom,so(),_a()}b.needsUpdate=!0,i.left=-he/(2*pe),i.right=he/(2*pe),i.top=me/(2*pe),i.bottom=-me/(2*pe),i.updateProjectionMatrix(),In()}function kn(){W.L.value=Ne,W.L_y.value=me,W.L_x.value=he,W.L_min.value=Math.min(me,he),W.dt.value=O.dt,W.dx.value=ce,W.dy.value=ce,W.heightScale.value=O.threeDHeightScale,W.maxColourValue.value=O.maxColourValue,W.minColourValue.value=O.minColourValue,W.customSurface.value=O.customSurface,W.vectorField.value=O.vectorField,da(),gi()}function qn(){try{Ne=Dn.evaluate(O.domainScale)}catch(e){Lo("Unable to evaluate the domain length. Please check the definition."),Ne=100}be=Math.round(e.getBoundingClientRect().width),ve=Math.round(e.getBoundingClientRect().height),l=ve/be,l<=0&&(l=.1),l>=1?(me=Ne,he=me/l):(he=Ne,me=he*l),1==O.dimension&&(he=Ne),W.L_x.value=he,W.L_y.value=me,pe=Math.max(he,me)}function Mn(){qn(),ce=Ne/100;try{ce=Dn.evaluate(O.spatialStep)}catch(e){Lo("Unable to evaluate the spatial step. Please check the definition.")}ce<=0&&(Lo("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),ce=Ne/100),de=Math.floor(he/ce),fe=Math.floor(me/ce),(de>ge||fe>ge)&&(Lo("Your device does not support a discretisation this fine (maximum "+ge+"). Please increase the space step to at least "+(Math.ceil(1e4*Ne/ge)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*ge*ce)/1e4).toPrecision(4)+"."),de=Math.min(de,ge),fe=Math.min(fe,ge)),0==de&&(de=1),0==fe&&(fe=1),1==O.dimension&&(fe=1),W.nXDisc.value=de,W.nYDisc.value=fe,M=new Array(de),R=new Array(de);let e=-.5,t=de>1?1/(de-1):.5;for(let n=0;n<M.length;n++)M[n]=e,e+=t;M=M.map((e=>e*he/pe)),Io(),et=new Float32Array(de*fe*4),ot=!1}function Rn(){qn();let e=[1,1];Le||(e=[de,fe]);const t=new an.PlaneGeometry(he/pe,me/pe,e[0],e[1]);V=new an.Mesh(t,b),V.position.z=0,V.visible="line"!=O.plotType,V.matrixAutoUpdate=!1,a.add(V);const n=new an.PlaneGeometry(he/pe,me/pe,1,1);P=new an.Mesh(n,g),P.position.z=0,P.visible=!1,P.matrixAutoUpdate=!1,a.add(P),In();const i=new un;I=Math.round(2*devicePixelRatio*be);const o=new Array(3*I).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),k=new sn(i,C),k.scale.set(1,1,1),k.visible="line"==O.plotType,a.add(k);const s=new un,l=new Array(3*I).fill(0);s.setPositions(l),q=new sn(s,D),q.scale.set(1,1,1),q.visible="line"==O.plotType&&O.overlay,a.add(q)}function In(){switch(O.plotType){case"plane":V.rotation.x=0,P.rotation.x=0;break;case"surface":V.rotation.x=-Math.PI/2,P.rotation.x=-Math.PI/2}V.updateMatrix(),P.updateMatrix()}function Ln(){O.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Nn(e){z=new dat.GUI({closeOnTop:!0,autoPlace:!1}),z.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(z.domElement),G=new dat.GUI({closeOnTop:!0,autoPlace:!1}),G.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(G.domElement),H=new dat.GUI({closeOnTop:!0,autoPlace:!1}),H.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(H.domElement),z.open(),G.open(),H.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),Y=G.addFolder("Brush");Ko(Xo(Y),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',Ta,null,"Toggle the brush on or off"),Se.brushAction=Y.add(O,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){On(),document.activeElement.blur()})),Se.brushType=Y.add(O,"brushType",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange((function(){On(),document.activeElement.blur()})),Y.add(O,"brushValue").name("Value").onFinishChange(On),Y.add(O,"brushRadius").name("Radius").onFinishChange(On),Se.whatToDraw=Y.add(O,"whatToDraw",vn).name("Species").onChange(On),Y=G.addFolder("Domain"),Y.add(O,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){ro(),document.activeElement.blur(),ga()})),Y.add(O,"domainScale").name("Largest side").onFinishChange((function(){Vn(),ga()})),Y.add(O,"spatialStep").name("Space step").onFinishChange((function(){Vn(),ga()})),Y.add(O,"minX").name("Min. $x$").onFinishChange((function(){$i(),ei()})),Se.minY=Y.add(O,"minY").name("Min. $y$").onFinishChange((function(){$i(),ei()}));const t=Xo(Y);Ko(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Ln(),Vn(),Pn(),ga()}),null,"Use a square domain"),Ko(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Custom',(function(){Ei(),Fi(),ai(),Di(),ga()}),null,"Specify a custom domain"),Se.domainIndicatorFun=Y.add(O,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Ei(),Fi(),ai(),yi(),ga()})),Y=G.addFolder("Timestepping"),Se.numTimestepsPerFrame=Y.add(O,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),fa(Se.numTimestepsPerFrame,1,400,1),Se.dt=Y.add(O,"dt").name("Timestep").onChange((function(){kn()})),Se.dt.__precision=12,Se.dt.min(0),Se.dt.updateDisplay(),Y.add(O,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=Xo(Y);Ko(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',zi,null,"Show/hide time display"),Ko(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){$e=W.t.value<O.autoPauseAt,Fi()}),null,"Toggle automatic pausing"),Se.autoPauseAt=Y.add(O,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){$e=W.t.value<O.autoPauseAt,Se.autoPauseAt.domElement.blur()})),Y=G.addFolder("Equations"),Y.add(O,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),$i(),ei()})),Se.algebraicSpecies=Y.add(O,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Ie=!0,$i(),Ie=!1,ei()})),Y.add(O,"speciesNames").name("Species names").onFinishChange((function(){Co()}));Ko(Xo(Y),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){$i()}),"cross_diffusion_controller","Toggle cross diffusion"),Y=z.addFolder("Definitions");Ko(Xo(Y),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Ti,null,"Typeset the specified equations"),Se.Duu=Y.add(O,"diffusionStr_1_1").onFinishChange((function(){ai(),Ti()})),To(Se.Duu,Vo,["U","UU"]),Ao(Se.Duu,Uo,["U","UU"]),Se.Duv=Y.add(O,"diffusionStr_1_2").onFinishChange((function(){ai(),Ti()})),To(Se.Duv,Vo,["UV"]),Ao(Se.Duv,Uo,["UV"]),Se.Duw=Y.add(O,"diffusionStr_1_3").onFinishChange((function(){ai(),Ti()})),To(Se.Duw,Vo,["UW"]),Ao(Se.Duw,Uo,["UW"]),Se.Duq=Y.add(O,"diffusionStr_1_4").onFinishChange((function(){ai(),Ti()})),To(Se.Duq,Vo,["UQ"]),Ao(Se.Duq,Uo,["UQ"]),Se.Dvu=Y.add(O,"diffusionStr_2_1").onFinishChange((function(){ai(),Ti()})),To(Se.Dvu,Vo,["VU"]),Ao(Se.Dvu,Uo,["VU"]),Se.Dvv=Y.add(O,"diffusionStr_2_2").onFinishChange((function(){ai(),Ti()})),To(Se.Dvv,Vo,["V","VV"]),Ao(Se.Dvv,Uo,["V","VV"]),Se.Dvw=Y.add(O,"diffusionStr_2_3").onFinishChange((function(){ai(),Ti()})),To(Se.Dvw,Vo,["VW"]),Ao(Se.Dvw,Uo,["VW"]),Se.Dvq=Y.add(O,"diffusionStr_2_4").onFinishChange((function(){ai(),Ti()})),To(Se.Dvq,Vo,["VQ"]),Ao(Se.Dvq,Uo,["VQ"]),Se.Dwu=Y.add(O,"diffusionStr_3_1").onFinishChange((function(){ai(),Ti()})),To(Se.Dwu,Vo,["WU"]),Ao(Se.Dwu,Uo,["WU"]),Se.Dwv=Y.add(O,"diffusionStr_3_2").onFinishChange((function(){ai(),Ti()})),To(Se.Dwv,Vo,["WV"]),Ao(Se.Dwv,Uo,["WV"]),Se.Dww=Y.add(O,"diffusionStr_3_3").onFinishChange((function(){ai(),Ti()})),To(Se.Dww,Vo,["W","WW"]),Ao(Se.Dww,Uo,["W","WW"]),Se.Dwq=Y.add(O,"diffusionStr_3_4").onFinishChange((function(){ai(),Ti()})),To(Se.Dwq,Vo,["WQ"]),Ao(Se.Dwq,Uo,["WQ"]),Se.Dqu=Y.add(O,"diffusionStr_4_1").onFinishChange((function(){ai(),Ti()})),To(Se.Dqu,Vo,["QU"]),Ao(Se.Dqu,Uo,["QU"]),Se.Dqv=Y.add(O,"diffusionStr_4_2").onFinishChange((function(){ai(),Ti()})),To(Se.Dqv,Vo,["QV"]),Ao(Se.Dqv,Uo,["QV"]),Se.Dqw=Y.add(O,"diffusionStr_4_3").onFinishChange((function(){ai(),Ti()})),To(Se.Dqw,Vo,["QW"]),Ao(Se.Dqw,Uo,["QW"]),Se.Dqq=Y.add(O,"diffusionStr_4_4").onFinishChange((function(){ai(),Ti()})),To(Se.Dqq,Vo,["Q","QQ"]),Ao(Se.Dqq,Uo,["Q","QQ"]),Se.f=Y.add(O,"reactionStr_1").onFinishChange((function(){ai(),Ti()})),To(Se.f,Vo,["UFUN"]),Ao(Se.f,Uo,["UFUN"]),Se.g=Y.add(O,"reactionStr_2").onFinishChange((function(){ai(),Ti()})),To(Se.g,Vo,["VFUN"]),Ao(Se.g,Uo,["VFUN"]),Se.h=Y.add(O,"reactionStr_3").onFinishChange((function(){ai(),Ti()})),To(Se.h,Vo,["WFUN"]),Ao(Se.h,Uo,["WFUN"]),Se.j=Y.add(O,"reactionStr_4").onFinishChange((function(){ai(),Ti()})),To(Se.j,Vo,["QFUN"]),Ao(Se.j,Uo,["QFUN"]),_e=z.addFolder("Parameters"),function(){let e,t,n=[],i=O.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Mi(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+ze,ze+=1,je.push(e),We[e]=t,n.push(e));for(const e of n)Ri(e,!1);e="param"+ze,je.push(e),We[e]=t,Ri(e,!0)}(),Y=z.addFolder("Boundary conditions"),Se.uBCs=Y.add(O,"boundaryConditions_1",{}).onChange((function(){ai(),pi(),document.activeElement.blur()})),Se.dirichletU=Y.add(O,"dirichletStr_1").onFinishChange(ai),Se.neumannU=Y.add(O,"neumannStr_1").onFinishChange(ai),Se.robinU=Y.add(O,"robinStr_1").onFinishChange(ai),Se.comboU=Y.add(O,"comboStr_1").name("Details").onFinishChange(ai),Se.vBCs=Y.add(O,"boundaryConditions_2",{}).onChange((function(){ai(),pi(),document.activeElement.blur()})),Se.dirichletV=Y.add(O,"dirichletStr_2").onFinishChange(ai),Se.neumannV=Y.add(O,"neumannStr_2").onFinishChange(ai),Se.robinV=Y.add(O,"robinStr_2").onFinishChange(ai),Se.comboV=Y.add(O,"comboStr_2").name("Details").onFinishChange(ai),Se.wBCs=Y.add(O,"boundaryConditions_3",{}).onChange((function(){ai(),pi(),document.activeElement.blur()})),Se.dirichletW=Y.add(O,"dirichletStr_3").onFinishChange(ai),Se.neumannW=Y.add(O,"neumannStr_3").onFinishChange(ai),Se.robinW=Y.add(O,"robinStr_3").onFinishChange(ai),Se.comboW=Y.add(O,"comboStr_3").name("Details").onFinishChange(ai),Se.qBCs=Y.add(O,"boundaryConditions_4",{}).name("$q$").onChange((function(){ai(),pi(),document.activeElement.blur()})),Se.dirichletQ=Y.add(O,"dirichletStr_4").onFinishChange(ai),Se.neumannQ=Y.add(O,"neumannStr_4").onFinishChange(ai),Se.robinQ=Y.add(O,"robinStr_4").onFinishChange(ai),Se.comboQ=Y.add(O,"comboStr_4").name("Details").onFinishChange(ai),Y=z.addFolder("Initial conditions"),Se.initCond_1=Y.add(O,"initCond_1").onFinishChange(bi),Se.initCond_2=Y.add(O,"initCond_2").onFinishChange(bi),Se.initCond_3=Y.add(O,"initCond_3").onFinishChange(bi),Se.initCond_4=Y.add(O,"initCond_4").onFinishChange(bi),X=G.addFolder("Images"),Y=X,wi(),Y=G.addFolder("Checkpoints");const i=Xo(Y);Ko(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),ea(i),Zo(i,'<i class="fa-regular fa-flag"></i> Set',Po,null,"Set a checkpoint at the current state",["narrow"]),Zo(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',ko,null,"Download the last checkpoint as a file",["narrow"]),Zo(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),Y.add(O,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),Y=G.addFolder("Misc."),Y.addColor(O,"backgroundColour").name("Background").onChange((function(){a.background=new an.Color(O.backgroundColour),ga()}));const o=Xo(Y);Ko(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){Hi(),ga()}),null,"Compute the integral of the plotted expression over the domain"),Ko(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){eo(),ga()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),Ko(o,"setSeed",'<i class="fa-regular fa-shuffle"></i> Set seed',(function(){O.setSeed&&(Re=O.randSeed),gi(),Fi()}),null,"Set the seed for random number generation"),Se.randSeed=Y.add(O,"randSeed").name("Random seed").onFinishChange((function(){gi()})),Y=Y.addFolder("Dev");const r=Xo(Y);Zo(r,'<i class="fa-regular fa-copy"></i> Copy code',ta,null,"Copy the simulation configuration as JSON to the clipboard"),Zo(r,'<i class="fa-regular fa-bug"></i> Copy debug',na,null,"Copy debug information to the clipboard");let s=en();var l;Object.keys(s).forEach((function(e){s[e]=e})),s.default=null,Y.add(O,"parent",(l=s,Object.keys(l).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=l[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const u=document.createElement("div");u.innerHTML="Settings",u.classList.add("ui_title"),G.domElement.prepend(u);const c=document.createElement("div");c.innerHTML="Equations",c.classList.add("ui_title"),z.domElement.prepend(c);const d=document.createElement("div");d.id="views_list",H.domElement.prepend(d);const f=document.createElement("div");f.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",f.classList.add("ui_title"),H.domElement.prepend(f),ee=H.addFolder("Edit view"),Y=ee;const h=Xo(Y,"edit_view_buttons");Zo(h,'<i class="fa-solid fa-pen-nib"></i> Rename',Wo,null,"Rename the current view"),Zo(h,'<i class="fa-solid fa-xmark"></i> Delete',jo,"deleteViewButton","Delete view"),Se.whatToPlot=Y.add(O,"whatToPlot").name("Expression: ").onFinishChange((function(){yi(),ga(),zo(this.property)})),Y.add(O,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){ao(),document.activeElement.blur(),ga(),zo(this.property)})),Y.add(O,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Wn(),Oi(),document.activeElement.blur(),ga(),zo(this.property)})).name("Colour map"),Se.minColourValue=Y.add(O,"minColourValue").name("Min value").onChange((function(){kn(),Wi(),ga(),zo(this.property)})),Se.minColourValue.__precision=2,Se.maxColourValue=Y.add(O,"maxColourValue").name("Max value").onChange((function(){kn(),Wi(),ga(),zo(this.property)})),Se.maxColourValue.__precision=2;const m=Xo(Y,"colour_map_buttons");Zo(m,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){O.flippedColourmap=!O.flippedColourmap,Wn(),Oi(),ga(),zo("flippedColourmap")}),null,"Reverse colour map",["narrow"]),Zo(m,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){yo(),Qn(),zo("minColourValue"),zo("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),Ko(m,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Oi(),zo("colourbar")}),null,"Display the colourbar",null,["narrow"]),ea(m),Ko(m,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){O.autoSetColourRange&&(yo(),Qn()),zo("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),Ko(m,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Wn(),ga(),zo("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),Ko(m,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Wn(),ga(),zo("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),Ko(m,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Wn(),ga(),zo("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),Ko(m,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Da(),ga(),zo("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),Y=ee.addFolder("Contours"),Y.domElement.id="contoursFolder",Se.contourColour=Y.addColor(O,"contourColour").name("Colour").onChange((function(){ma(),ga(),zo(this.property)})),Se.contourNum=Y.add(O,"contourNum").name("Number").onChange((function(){ma(),ga(),zo(this.property)})),fa(Se.contourNum,1,20,1),Ce.push(Se.contourNum),Se.contourEpsilon=Y.add(O,"contourEpsilon").name("Threshold").onChange((function(){ma(),ga(),zo(this.property)})),fa(Se.contourEpsilon,.001,.05,.001),Ce.push(Se.contourEpsilon),Y=ee.addFolder("Lighting"),Y.domElement.id="embossFolder",Se.embossSmoothness=Y.add(O,"embossSmoothness").name("Smoothness").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossSmoothness,0,2,.001),De.push(Se.embossSmoothness),Se.embossAmbient=Y.add(O,"embossAmbient").name("Ambient").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossAmbient,0,1,.001),De.push(Se.embossAmbient),Se.embossDiffuse=Y.add(O,"embossDiffuse").name("Diffuse").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossDiffuse,0,1,.001),De.push(Se.embossDiffuse),Se.embossSpecular=Y.add(O,"embossSpecular").name("Specular").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossSpecular,0,1,.001),De.push(Se.embossSpecular),Se.embossShiny=Y.add(O,"embossShiny").name("Precision").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossShiny,0,100,1),De.push(Se.embossShiny),Se.embossTheta=Y.add(O,"embossTheta").name("Inclination").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossTheta,0,1.5708,.001),De.push(Se.embossTheta),Se.embossPhi=Y.add(O,"embossPhi").name("Direction").onChange((function(){da(),ga(),zo(this.property)})),fa(Se.embossPhi,0,3.1456,.001),De.push(Se.embossPhi),Y=ee.addFolder("Overlay"),Y.domElement.id="overlayFolder",Y.addColor(O,"overlayColour").name("Colour").onChange((function(){pa(),ga(),zo(this.property)})),Y.add(O,"overlayExpr").name("Expression").onFinishChange((function(){Wn(),"line"==O.plotType&&Di(),ga(),zo(this.property)})),Se.overlayEpsilon=Y.add(O,"overlayEpsilon").name("Threshold").onChange((function(){pa(),ga(),zo(this.property)})),Se.overlayLineWidthMul=Y.add(O,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){$o(),ga(),zo(this.property)})),te=ee.addFolder("3D"),Y=te,J=Xo(Y),Ko(J,"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){W.customSurface.value=O.customSurface,_a(),wa(),ga(),zo("customSurface")}),null,"Plot the solution on a custom surface"),Se.surfaceFun=Y.add(O,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){yi(),ga(),zo(this.property)})),Se.threeDHeightScale=Y.add(O,"threeDHeightScale").name("Height scale").onChange((function(){kn(),ga(),zo(this.property)})),Se.cameraTheta=Y.add(O,"cameraTheta").name("View $\\theta$").onChange((function(){Pn(),ga(),zo(this.property)})),Se.cameraPhi=Y.add(O,"cameraPhi").name("View $\\phi$").onChange((function(){Pn(),ga(),zo(this.property)})),Se.cameraZoom=Y.add(O,"cameraZoom").name("Zoom").onChange((function(){Pn(),ga(),zo(this.property)})),Se.lineWidthMul=Y.add(O,"lineWidthMul",.1,2).name("Thickness").onChange((function(){$o(),ga(),zo(this.property)})),ne=ee.addFolder("Vector field"),Y=ne,Y.domElement.id="vectorFieldFolder",Y.addColor(O,"arrowColour").name("Colour").onChange((function(){xa(),ga(),zo(this.property)})),Y.add(O,"arrowX").onFinishChange((function(){Di(),ga(),zo(this.property)})).name("$x$ component"),Y.add(O,"arrowY").onFinishChange((function(){Di(),ga(),zo(this.property)})).name("$y$ component"),Se.arrowDensity=Y.add(O,"arrowDensity").onChange((function(){Da(),ga(),zo(this.property)})).name("Density"),Se.arrowDensity.__precision=2,fa(Se.arrowDensity,0,1,.001),Y.add(O,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Fi(),ga(),zo(this.property)})).name("Scaling"),Se.arrowLengthMax=Y.add(O,"arrowLengthMax").onFinishChange((function(){Da(),ga(),zo(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>va(e)))}function Bn(){Wn(),Oi(),yi(),On()}function On(){let e=po()+rt(),t="float brushRadius = "+ii(O.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(O.brushValue)&&(e+=Nt()),/\bRANDN\b/.test(O.brushValue)&&(e+=Bt()),e+="float brushValue = "+ii(O.brushValue)+";\n",e+=t,O.brushType){case"circle":e+=ut();break;case"hline":e+=dt();break;case"vline":e+=ct()}switch(O.brushAction){case"replace":e+=ft(),e+=st();break;case"add":e+=ft(),e+=lt();break;case"smoothreplace":e+=ht(),e+=st();break;case"smoothadd":e+=ht(),e+=lt()}Ta(),e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,mi(O.whatToDraw)),e}(e),e=Ea(e),v.fragmentShader=e,v.needsUpdate=!0}function Wn(){N=Yt(O.colourmap),O.flippedColourmap&&(N.reverse(),N=N.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),W.colour1.value=new an.Vector4(...N[0]),W.colour2.value=new an.Vector4(...N[1]),W.colour3.value=new an.Vector4(...N[2]),W.colour4.value=new an.Vector4(...N[3]),W.colour5.value=new an.Vector4(...N[4]);let e=po()+Ot();O.emboss&&(e+=jt(),da()),O.contours&&(e+=Qt(),ma()),O.overlay&&(e+=Ht().replaceAll("OVERLAYEXPR",ii(O.overlayExpr)),e=Ea(e),pa()),q.visible=O.overlay&&"line"==O.plotType,e+=Wt(),b.fragmentShader=e,b.needsUpdate=!0,S.needsUpdate=!0,B=N.map((e=>e[3])),N=N.map((e=>e.slice(0,-1)))}function jn(){switch(O.timesteppingScheme){case"Euler":U.material=ye.FE,W.textureSource.value=we[1].texture,W.textureSource1.value=we[2].texture,W.dt.value=O.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),W.t.value+=O.dt;break;case"AB2":U.material=ye.AB2,W.textureSource.value=we[1].texture,W.textureSource1.value=we[2].texture,W.dt.value=O.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),W.t.value+=O.dt;break;case"Mid":U.material=ye.Mid1,W.textureSource.value=we[1].texture,s.setRenderTarget(we[2]),s.render(r,o),U.material=ye.Mid2,W.textureSource1.value=we[2].texture,W.t.value+=.5*O.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1),W.t.value+=.5*O.dt;break;case"RK4":U.material=ye.RK41,W.textureSource.value=we[1].texture,s.setRenderTarget(we[2]),s.render(r,o),U.material=ye.RK42,W.textureSource1.value=we[2].texture,W.t.value+=.5*O.dt,s.setRenderTarget(we[3]),s.render(r,o),U.material=ye.RK43,W.textureSource2.value=we[3].texture,s.setRenderTarget(we[4]),s.render(r,o),U.material=ye.RK44,W.textureSource3.value=we[4].texture,W.t.value+=.5*O.dt,s.setRenderTarget(we[0]),s.render(r,o),we.rotate(-1)}}function Qn(){if(zn(),O.autoSetColourRange&&yo(),O.brushEnabled&&"surface"==O.plotType){let e=0;O.maxColourValue-O.minColourValue>0&&(e=(function(){Zi();let e=0;for(let t=0;t<et.length;t+=4)e+=et[t];return e/(de*fe)}()-O.minColourValue)/(O.maxColourValue-O.minColourValue)-.5,e=e.clamp(-.5,.5)),P.position.y=O.threeDHeightScale*e,P.updateWorldMatrix()}if("line"==O.plotType){Zi();let t=0;var e=O.maxColourValue-O.minColourValue;e=0==e?.5:e;for(let n=0;n<et.length;n+=4)R[t++]=(et[n]-O.minColourValue)/e-.5;let n=new an.SplineCurve(M.map(((e,t)=>new an.Vector2(e,R[t])))),i=n.getSpacedPoints(I);if(xo(k,i),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=Fo(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(k,i),O.overlay){t=0;for(let n=2;n<4*de;n+=4)R[t++]=(et[n]-O.minColourValue)/e-.5;n=new an.SplineCurve(M.map(((e,t)=>new an.Vector2(e,R[t])))),i=n.getSpacedPoints(I),xo(q,i)}}if(O.vectorField&&L){nt=new Float32Array(de*fe*4),s.readRenderTargetPixels(f,0,0,de,fe,nt);let e,t,n,i=[];for(const o of L.children)e=4*o.ind,t=nt[e+2],n=nt[e+3],o.visible=nt[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(O.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of L.children){const t=Oe*Eo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=L.customMax>0?L.customMax:1;for(const e of L.children){const t=Oe*Eo(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of L.children)e.scale.set(Oe,Oe,Oe)}}if(O.timeDisplay&&Gi(),O.integrate&&function(){if(O.integrate){let e;Zi(),1==O.dimension?e=W.dx.value:2==O.dimension&&(e=W.dx.value*W.dy.value);let t=0;for(let e=0;e<et.length;e+=4)t+=et[e]*(1-et[e+1]);t*=e,$("#integralValue").html(ji(t,4)),Ki()}}(),to()?(U.material=F,s.setRenderTarget(h),s.render(r,o),W.textureSource.value=h.texture,W.dxUpscaledScale.value=devicePixelRatio*be/de,W.dyUpscaledScale.value=devicePixelRatio*ve/fe):(W.dxUpscaledScale.value=1,W.dyUpscaledScale.value=1),s.setRenderTarget(null),s.render(a,i),it){it=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",s.render(a,i),t.href=s.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Mn(),Qn()}}function zn(){U.material=S,W.textureSource.value=we[1].texture,s.setRenderTarget(f),s.render(r,o),W.textureSource.value=f.texture,ot=!1,W.textureSource1.value=we[1].texture}function Gn(t){oe=Jn(t,e),oe&&(O.brushEnabled&&"surface"==O.plotType?u.enabled=!1:O.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Ni("#top_message"),window.clearTimeout(le),le=setTimeout((function(){$("#top_message").hasClass("fading_out")||Bi("#top_message")}),3e3)))}function Hn(e){oe=!1,"surface"==O.plotType&&(u.enabled=!0)}function Yn(t){Jn(t,e)}function Jn(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==O.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(P,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==O.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*de)/de,a=Math.round(a*fe)/fe,W.brushCoords.value=new an.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Xn(){s.setSize(de,fe,!1),qe&&O.resetFromCheckpoints?U.material=E:U.material=w,we.forEach((e=>{s.setRenderTarget(e),s.render(r,o)})),Io(),Qn()}function Zn(){ke||($("#pause").hide(),$("#play").show()),ie=!1}function Kn(){ke||($("#play").hide(),$("#pause").show()),Te=!0,window.clearTimeout(se),se=setTimeout(Xi,1e3),ie=!0}function ei(){O.setSeed&&(Re=O.randSeed),gi(),W.t.value=0,$e=!0,Gi(),Xn(),Qn(),Te=!0,window.clearTimeout(se),Xi()}function ti(){let e="";return e+="float UFUN = "+ii(O.reactionStr_1)+";\n",e+="float VFUN = "+ii(O.reactionStr_2)+";\n",e+="float WFUN = "+ii(O.reactionStr_3)+";\n",e+="float QFUN = "+ii(O.reactionStr_4)+";\n",e}function ni(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function ii(e){if(!No(e=" "+e+" ")||Aa(e))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])?\b/g);let i,o,a,r,s,l,u,c,d,f,h,m,p,g=0;const b={S:"One",T:"Two"},v={R:"r",G:"g",B:"b",A:"a"};for(const _ of n){for(i=_.index,m=b[_[1]],o=i+_[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,s=t.slice(o+g+1,a+g),s=vo(s),l=s.split(","),1!=l.length&&0!=l[1].trim().length||(l[1]="0"),l[0]="("+l[0]+"-MINX)/L_x",l[1]="("+l[1]+"-MINY)/L_y",f="texture(imageSource"+m+",vec2("+l.join(",")+")).",null!=_[2]?(p=v[_[2]],h=f+p):(p=["r","g","b"],h="("+p.map((e=>f+e)).join("+")+")/3.0 "),t=ki(t,h,i+g,a+1+g),g+=h.length-a+i-1)}return t}(e=(e=co(e=(e=(e=(e=oi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+wn[0]+")\\b","g"),(function(e,t){return"uvwq."+mi(t)}))).replaceAll(RegExp("\\b("+wn[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+mi(t)}))).replaceAll(RegExp("\\b("+wn[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+mi(t)})))).replaceAll(/\b(I_[ST][RBGA]?\b)\s*(?!\()/g,"$1(x,y) "));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e=e.replaceAll(/\bind\b/g,"float")}function oi(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function ai(){let e="",t="",n="",i="",o="",a="";const r=[O.boundaryConditions_1,O.boundaryConditions_2,O.boundaryConditions_3,O.boundaryConditions_4],s=[O.neumannStr_1,O.neumannStr_2,O.neumannStr_3,O.neumannStr_4],l=[O.comboStr_1,O.comboStr_2,O.comboStr_3,O.comboStr_4].map((e=>e+";")),u=[O.dirichletStr_1,O.dirichletStr_2,O.dirichletStr_3,O.dirichletStr_4],c=[O.robinStr_1,O.robinStr_2,O.robinStr_3,O.robinStr_4];r.forEach((function(t,n){"neumann"==t?(e+=ri(s[n],vn[n]),O.domainViaIndicatorFun?e+=Yo(n):e+=Ho(n)):"combo"==t&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=ri(t[2],vn[n],i),e+=Ho(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=hi(Rt(t),vn[e]),O.dimension>1&&(i+=hi(It(t),vn[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,ii(e[2]))}))})),r.forEach((function(e,t){if("dirichlet"==e)if(O.domainViaIndicatorFun){let e=Dt().replace(/indicatorFun/g,ii(O.domainIndicatorFun));n+=hi(e,vn[t])+ii(u[t])+";\n}\n"}else n+=si(u[t],vn[t]),n+=Go(t);else if("combo"==e)[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=si(e[2],vn[t],i),n+=Go(t,i)}));else if(O.domainViaIndicatorFun){let e=Dt().replace(/indicatorFun/g,ii(O.domainIndicatorFun));n+=hi(e,vn[t])+"0.0;\n}\n"}})),r.forEach((function(e,t){"robin"==e?(i+=ri(c[t],vn[t]),O.domainViaIndicatorFun?i+=Yo(t):i+=Ho(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=ri(e[2],vn[t],n),i+=Ho(t,n)}))}));let d=po();if(o=function(){let e="";return e+=ni(ii(O.diffusionStr_1_1)+";\n","uu"),e+=ni(ii(O.diffusionStr_2_2)+";\n","vv"),e+=ni(ii(O.diffusionStr_3_3)+";\n","ww"),e+=ni(ii(O.diffusionStr_4_4)+";\n","qq"),e}()+"\n",O.crossDiffusion?o+=function(){let e="";return e+=ni(ii(O.diffusionStr_1_2)+";\n","uv"),e+=ni(ii(O.diffusionStr_1_3)+";\n","uw"),e+=ni(ii(O.diffusionStr_1_4)+";\n","uq"),e+=ni(ii(O.diffusionStr_2_1)+";\n","vu"),e+=ni(ii(O.diffusionStr_2_3)+";\n","vw"),e+=ni(ii(O.diffusionStr_2_4)+";\n","vq"),e+=ni(ii(O.diffusionStr_3_1)+";\n","wu"),e+=ni(ii(O.diffusionStr_3_2)+";\n","wv"),e+=ni(ii(O.diffusionStr_3_4)+";\n","wq"),e+=ni(ii(O.diffusionStr_4_1)+";\n","qu"),e+=ni(ii(O.diffusionStr_4_2)+";\n","qv"),e+=ni(ii(O.diffusionStr_4_3)+";\n","qw"),e}()+"\n"+At():o+=Tt(),O.numAlgebraicSpecies>=2){const e=O.numSpecies-O.numAlgebraicSpecies;let t={};for(let n=e;n<O.numSpecies;n++){let i=[],o=O["reactionStr_"+(n+1).toString()];for(let t=e;t<O.numSpecies;t++)o=[o,O["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()]].join(" ");for(let t=e;t<O.numSpecies;t++){(new RegExp("\\b"+vn[t]+"(_(x|xb|xf|xb2|xf2|xx|y|yb|yf|yb2|yf2|yy))?\\b").test(o)||"0"!=O["diffusionStr_"+(n+1).toString()+"_"+(t+1).toString()])&&i.push(vn[t])}i!=[]&&(t[vn[n]]=i)}let n={},i=[],o=[];for(let a of vn.slice(e,O.numSpecies))$a(a,n,i,t,o);if(o.length>0)return void Lo("Cyclic variables detected. Please check the definition(s) of "+o.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.")}if(Xe&&O.crossDiffusion&&(a+=hi(Vt(),vn[1])),Ze&&O.crossDiffusion&&(a+=hi(Vt(),vn[2])),Ke&&O.crossDiffusion&&(a+=hi(Vt(),vn[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void Lo("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Pt(),qt(),e,t,i,kt(),Mt(),ti(),o].join(" "),h=/\bRAND\b/.test(f),m=/\bRANDN\b/.test(f);h&&(f=Nt()+f),m&&(f=Bt()+f),Ve=h||m;let p=[n,a,yt()].join(" "),g="FE";ye[g].fragmentShader=Ea([d,wt(g),f,Lt(g),p].join(" ")),g="AB2",ye[g].fragmentShader=Ea([d,wt(g),f,Lt(g),p].join(" ")),g="Mid";for(let e=1;e<3;e++)ye[g+e.toString()].fragmentShader=Ea([d,wt(g+e.toString()),f,Lt(g+e.toString()),p].join(" "));g="RK4";for(let e=1;e<5;e++)ye[g+e.toString()].fragmentShader=Ea([d,wt(g+e.toString()),f,Lt(g+e.toString()),p].join(" "));if(Object.keys(ye).forEach((e=>ye[e].needsUpdate=!0)),re=O.domainViaIndicatorFun||"dirichlet"==O.boundaryConditions_1||"dirichlet"==O.boundaryConditions_2||"dirichlet"==O.boundaryConditions_3||"dirichlet"==O.boundaryConditions_4||/Dirichlet/.test(O.comboStr_1)||/Dirichlet/.test(O.comboStr_2)||/Dirichlet/.test(O.comboStr_3)||/Dirichlet/.test(O.comboStr_4),re){if(n=d+Ut(),O.domainViaIndicatorFun){let e=Dt().replace(/indicatorFun/,ii(O.domainIndicatorFun)).replace(/updated/,"gl_FragColor");u.forEach((function(t,i){"dirichlet"==r[i]?n+=hi(e,vn[i])+ii(t)+";\n}\n":n+=hi(e,vn[i])+"0.0;\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=si(u[t],vn[t]),n+=Jo(t)):"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=si(e[2],vn[t],i),n+=Jo(t,i)}))}));n+="}",n=Ea(n),_.fragmentShader=n,_.needsUpdate=!0}}function ri(e,t,n){return null==n?["L","R","T","B"].map((n=>ri(e,t,n))).join(""):"float robinRHS"+t+n+" = "+ii(e)+";\n"}function si(e,t,n){return null==n?["L","R","T","B"].map((n=>si(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+ii(e)+";\n"}function li(e){ui("default"),ui(e),null!=O.threeD&&(O.threeD&&(O.dimension=2,null==O.plotType&&(O.plotType="surface")),delete O.threeD),null!=O.oneDimensional&&(O.oneDimensional&&(O.dimension=1,O.plotType="line"),delete O.oneDimensional),Ne*=Be,function(){if(0==O.views.length){let e=Qo();e.name="1",O.views.push(e)}else O.views=O.views.map((function(e){let t=Qo();return Object.assign(t,e),t}))}(),di(z,!0),di(G,!0),di(H,!0),Nn(),O.activeViewInd>=O.views.length&&(O.activeViewInd=O.views.length-1),Oo(O.views[O.activeViewInd],!1),$i(),Ln(),Vn(),kn(),a.background=new an.Color(O.backgroundColour),""!=O.initialState?fetch(O.initialState).then((e=>e.blob())).then((e=>qo(e))):ei(),Pn(),Z.remove(),K.remove(),wi(),eo()}function ui(e){let t;t=null==e?Xt(O.preset):"string"==typeof e?Xt(e):"object"==typeof e?e:Xt("default"),t.hasOwnProperty("parent")&&null!=t.parent&&ui(t.parent),ze=0,je=[],We={},Object.assign(O,t),ie=O.runningOnLoad,Co(),ie?Kn():Zn(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?O.tryClickingText=O.tryClickingText.replaceAll("clicking","tapping"):O.tryClickingText=O.tryClickingText.replaceAll("tapping","clicking"),O.brushRadius=O.brushRadius.toString(),O.hasOwnProperty("drawIn3D")&&(O.brushEnabled=O.drawIn3D);var n=0;n+=O.hasOwnProperty("algebraicV"),n+=O.hasOwnProperty("algebraicW"),(n+=O.hasOwnProperty("algebraicQ"))&&!O.numAlgebraicSpecies&&(O.numAlgebraicSpecies=n),delete O.algebraicV,delete O.algebraicW,delete O.algebraicQ;const i=tn();Object.keys(i).forEach((function(e){O.hasOwnProperty(e)&&(t.hasOwnProperty(i[e])||(O[i[e]]=O[e]),delete O[e])})),null==O.minColourValue&&(O.minColourValue=0),null==O.maxColourValue&&(O.maxColourValue=1),O.domainScale=O.domainScale.toString(),O.spatialStep=O.spatialStep.toString(),Q=JSON.parse(JSON.stringify(O));let o=[O.initCond_1,O.initCond_2,O.initCond_3,O.initCond_4,O.domainIndicatorFun,O.reactionStr_1,O.reactionStr_2,O.reactionStr_3,O.reactionStr_4,O.diffusionStr_1_1,O.diffusionStr_1_2,O.diffusionStr_1_3,O.diffusionStr_1_4,O.diffusionStr_2_1,O.diffusionStr_2_2,O.diffusionStr_2_3,O.diffusionStr_2_4,O.diffusionStr_3_1,O.diffusionStr_3_2,O.diffusionStr_3_3,O.diffusionStr_3_4,O.diffusionStr_4_1,O.diffusionStr_4_2,O.diffusionStr_4_3,O.diffusionStr_4_4,O.dirichletStr_1,O.dirichletStr_2,O.dirichletStr_3,O.dirichletStr_4,O.robinStr_1,O.robinStr_2,O.robinStr_3,O.robinStr_4,O.comboStr_1,O.comboStr_2,O.comboStr_3,O.comboStr_4,O.neumannStr_1,O.neumannStr_2,O.neumannStr_3,O.neumannStr_4,O.brushValue,O.whatToPlot].join(" ");O.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(o)}function ci(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)ci(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function di(e,t){if(null!=e){for(let t in e.__folders)di(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function fi(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function hi(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=mi(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function mi(e){return"rgba"[function(e){return vn.indexOf(e)}(e)]}function pi(){"dirichlet"==O.boundaryConditions_1?Se.dirichletU.show():Se.dirichletU.hide(),"dirichlet"==O.boundaryConditions_2?Se.dirichletV.show():Se.dirichletV.hide(),"dirichlet"==O.boundaryConditions_3?Se.dirichletW.show():Se.dirichletW.hide(),"dirichlet"==O.boundaryConditions_4?Se.dirichletQ.show():Se.dirichletQ.hide(),"neumann"==O.boundaryConditions_1?Se.neumannU.show():Se.neumannU.hide(),"neumann"==O.boundaryConditions_2?Se.neumannV.show():Se.neumannV.hide(),"neumann"==O.boundaryConditions_3?Se.neumannW.show():Se.neumannW.hide(),"neumann"==O.boundaryConditions_4?Se.neumannQ.show():Se.neumannQ.hide(),"robin"==O.boundaryConditions_1?Se.robinU.show():Se.robinU.hide(),"robin"==O.boundaryConditions_2?Se.robinV.show():Se.robinV.hide(),"robin"==O.boundaryConditions_3?Se.robinW.show():Se.robinW.hide(),"robin"==O.boundaryConditions_4?Se.robinQ.show():Se.robinQ.hide(),"combo"==O.boundaryConditions_1?Se.comboU.show():Se.comboU.hide(),"combo"==O.boundaryConditions_2?Se.comboV.show():Se.comboV.hide(),"combo"==O.boundaryConditions_3?Se.comboW.show():Se.comboW.hide(),"combo"==O.boundaryConditions_4?Se.comboQ.show():Se.comboQ.hide();const e=[Se.uBCs,Se.vBCs,Se.wBCs,Se.qBCs];O.domainViaIndicatorFun?e.forEach((e=>So(e,["Dirichlet","Neumann","Robin"],["dirichlet","neumann","robin"]))):e.forEach((e=>So(e,["Periodic","Dirichlet","Neumann","Robin","Combination"],["periodic","dirichlet","neumann","robin","combo"]))),ci(z)}function gi(){Re=(Re+123456789)%1e9,W.seed.value=Re/1e6}function bi(){let e=po()+on(),t=[O.initCond_1,O.initCond_2,O.initCond_3,O.initCond_4].join(" ");/\bRAND\b/.test(t)&&(e+=Nt()),/\bRANDN\b/.test(t)&&(e+=Bt()),e+="float u = "+ii(O.initCond_1)+";\n",e+="float v = "+ii(O.initCond_2)+";\n",e+="float w = "+ii(O.initCond_3)+";\n",e+="float q = "+ii(O.initCond_4)+";\n",e+=nn(),e=Ea(e),w.fragmentShader=e,w.needsUpdate=!0}function vi(){let e=new Image;e.src=Z.__image.src;let t=new an.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,W.imageSourceOne.value=t,O.resetOnImageLoad&&ei()}}function _i(){let e=new Image;e.src=K.__image.src;let t=new an.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,W.imageSourceTwo.value=t,O.resetOnImageLoad&&ei()},t.dispose()}function wi(){Y=X,Z=Y.addImage(O,"imagePathOne").name("$I_S(x,y)$").onChange(vi),K=Y.addImage(O,"imagePathTwo").name("$I_T(x,y)$").onChange(_i),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function yi(){ot=!1,Di(),Se.minColourValue.show(),Se.maxColourValue.show(),Oi(),Hi()}function Si(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Ci(){Zi();let e=1/0,t=-1/0;for(let n=0;n<et.length;n+=4)e=Math.min(e,et[n]),t=Math.max(t,et[n]);return[e,t]}function Di(){let e=po()+mt();e+=pt().replace(/\bXVECFUN\b/,ii(O.arrowX)).replace(/\bYVECFUN\b/,ii(O.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,ii(O.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,ii(O.surfaceFun))}(e),O.domainViaIndicatorFun&&(e+=bt().replace(/indicatorFun/g,ii(O.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",ii(O.overlayExpr)),e=Ea(e),pa(),S.fragmentShader=e+gt(),S.needsUpdate=!0}function xi(){O.numAlgebraicSpecies=Math.min(parseInt(O.numAlgebraicSpecies),parseInt(O.numSpecies)-1),Xe=O.numAlgebraicSpecies>=O.numSpecies-1,Ze=O.numAlgebraicSpecies>=O.numSpecies-2&&O.numSpecies>=3,Ke=O.numAlgebraicSpecies>=O.numSpecies-3&&O.numSpecies>=4}function Fi(){let e="function of "+vn.slice(0,O.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+vn[1]+",",""),i=e.replace(" "+vn[2]+",",""),o=e.replace(" "+vn[3]+",","");switch(1==O.dimension?(e=e.replace(" y,",""),Se.minY.hide()):Se.minY.show(),O.crossDiffusion&&parseInt(O.numSpecies)>1?(Ie||So(Se.algebraicSpecies,Array.from(Array(parseInt(O.numSpecies)).keys())),Se.algebraicSpecies.show()):Se.algebraicSpecies.hide(),O.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),Se.Duv.hide(),Se.Dvu.hide(),Se.Dvv.hide(),Se.g.hide(),Se.initCond_2.hide(),Se.vBCs.hide(),Se.Duw.hide(),Se.Dvw.hide(),Se.Dwu.hide(),Se.Dwv.hide(),Se.Dww.hide(),Se.h.hide(),Se.initCond_3.hide(),Se.wBCs.hide(),Se.Duq.hide(),Se.Dvq.hide(),Se.Dwq.hide(),Se.Dqu.hide(),Se.Dqv.hide(),Se.Dqw.hide(),Se.Dqq.hide(),Se.j.hide(),Se.initCond_4.hide(),Se.qBCs.hide(),parseInt(O.numSpecies)){case 4:O.crossDiffusion?(Se.Duq.show(),Se.Dvq.show(),Se.Dwq.show(),Se.Dqu.show(),Se.Dqv.show(),Se.Dqw.show()):(Se.Dwq.hide(),Se.Dqu.hide(),Se.Dvq.hide(),Se.Duq.hide(),Se.Dqv.hide(),Se.Dqw.hide()),Se.Dqq.show(),Se.j.show(),Se.initCond_4.show(),Se.qBCs.show();case 3:O.crossDiffusion?(Se.Duw.show(),Se.Dvw.show(),Se.Dwu.show(),Se.Dwv.show()):(Se.Duw.hide(),Se.Dvw.hide(),Se.Dwu.hide(),Se.Dwv.hide()),Se.Dww.show(),Se.h.show(),Se.initCond_3.show(),Se.wBCs.show();case 2:O.crossDiffusion?(Se.Duv.show(),Se.Dvu.show()):(Se.Duv.hide(),Se.Dvu.hide()),Se.Dvv.show(),Se.g.show(),Se.initCond_2.show(),Se.vBCs.show()}O.crossDiffusion?(fi(Se.Duu,Sn.Duu,e),fi(Se.Duv,Sn.Duv,e),fi(Se.Duw,Sn.Duw,e),fi(Se.Duq,Sn.Duq,e),fi(Se.Dvu,Sn.Dvu,e),fi(Se.Dvv,Sn.Dvv,e),fi(Se.Dvw,Sn.Dvw,e),fi(Se.Dvq,Sn.Dvq,e),fi(Se.Dwu,Sn.Dwu,e),fi(Se.Dwv,Sn.Dwv,e),fi(Se.Dww,Sn.Dww,e),fi(Se.Dwq,Sn.Dwq,e),fi(Se.Dqu,Sn.Dqu,e),fi(Se.Dqv,Sn.Dqv,e),fi(Se.Dqw,Sn.Dqw,e),fi(Se.Dqq,Sn.Dqq,e)):(fi(Se.Duu,Sn.Du,e),fi(Se.Dvv,Sn.Dv,e),fi(Se.Dww,Sn.Dw,e),fi(Se.Dqq,Sn.Dq,e)),fi(Se.f,Sn.UFUN,e),fi(Se.g,Sn.VFUN,e),fi(Se.h,Sn.WFUN,e),fi(Se.j,Sn.QFUN,e),Xe&&(fi(Se.Dvu,Sn.Dvu,t),fi(Se.Dvw,Sn.Dvw,t),fi(Se.Dvq,Sn.Dvq,t),fi(Se.g,Sn.VFUN,t),Se.Dvv.hide()),Ze&&(fi(Se.Dwu,Sn.Dwu,o),fi(Se.Dwv,Sn.Dwv,o),fi(Se.Dwq,Sn.Dwq,o),fi(Se.h,Sn.WFUN,o),Se.Dww.hide()),Ke&&(fi(Se.Dqu,Sn.Dqu,i),fi(Se.Dqv,Sn.Dqv,i),fi(Se.Dqw,Sn.Dqw,i),fi(Se.j,Sn.QFUN,i),Se.Dqq.hide()),fi(Se.uBCs,Sn.u),fi(Se.vBCs,Sn.v),fi(Se.wBCs,Sn.w),fi(Se.qBCs,Sn.q),fi(Se.dirichletU,Sn.uD),fi(Se.dirichletV,Sn.vD),fi(Se.dirichletW,Sn.wD),fi(Se.dirichletQ,Sn.qD),fi(Se.neumannU,Sn.uN),fi(Se.neumannV,Sn.vN),fi(Se.neumannW,Sn.wN),fi(Se.neumannQ,Sn.qN),fi(Se.robinU,Sn.uN),fi(Se.robinV,Sn.vN),fi(Se.robinW,Sn.wN),fi(Se.robinQ,Sn.qN),fi(Se.initCond_1,Sn.uInit),fi(Se.initCond_2,Sn.vInit),fi(Se.initCond_3,Sn.wInit),fi(Se.initCond_4,Sn.qInit),O.domainViaIndicatorFun?Se.domainIndicatorFun.show():Se.domainIndicatorFun.hide(),pi(),"surface"==O.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),te.name="3D options",te.domElement.classList.remove("hidden"),Se.lineWidthMul.hide(),Se.threeDHeightScale.show(),Se.cameraTheta.show(),Se.cameraPhi.show(),Se.cameraZoom.show()):"line"==O.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),te.name="Line options",te.domElement.classList.remove("hidden"),Se.lineWidthMul.show(),Se.threeDHeightScale.show(),Se.cameraTheta.hide(),Se.cameraPhi.hide(),Se.cameraZoom.hide()):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),te.domElement.classList.add("hidden"),Se.lineWidthMul.hide(),Se.threeDHeightScale.hide(),Se.cameraTheta.hide(),Se.cameraPhi.hide(),Se.cameraZoom.hide()),1==O.dimension&&$("#vectorFieldButton").hide(),Oi(),zi(),Hi(),$("#dataContainer").show(),wa(),"line"==O.plotType?(Se.brushType.hide(),$(":root").css("--ui-button-outline","black")):(Se.brushType.show(),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==O.arrowScale?Se.arrowLengthMax.show():Se.arrowLengthMax.hide(),So(Se.whatToDraw,vn.slice(0,O.numSpecies)),ha(),O.autoPause?Se.autoPauseAt.show():Se.autoPauseAt.hide(),"line"==O.plotType?(Se.overlayEpsilon.hide(),Se.overlayLineWidthMul.show()):(Se.overlayEpsilon.show(),Se.overlayLineWidthMul.hide()),O.setSeed?Se.randSeed.show():Se.randSeed.hide(),$(".toggle_button").each((function(){ba(this)})),Bo(),ci(z),ci(G),ci(H)}function Ei(){let e;switch(xi(),O.domainViaIndicatorFun&&(["dirichlet","neumann"].includes(O.boundaryConditions_1)||(O.boundaryConditions_1="dirichlet"),["dirichlet","neumann"].includes(O.boundaryConditions_2)||(O.boundaryConditions_2="dirichlet"),["dirichlet","neumann"].includes(O.boundaryConditions_3)||(O.boundaryConditions_3="dirichlet"),["dirichlet","neumann"].includes(O.boundaryConditions_4)||(O.boundaryConditions_4="dirichlet")),parseInt(O.numSpecies)){case 1:O.crossDiffusion=!1,O.whatToDraw=vn[0],O.whatToPlot=vn[0],O.diffusionStr_1_2="0",O.diffusionStr_1_3="0",O.diffusionStr_1_4="0",O.diffusionStr_2_1="0",O.diffusionStr_2_2="0",O.diffusionStr_2_3="0",O.diffusionStr_2_4="0",O.diffusionStr_3_1="0",O.diffusionStr_3_2="0",O.diffusionStr_3_3="0",O.diffusionStr_3_4="0",O.diffusionStr_4_1="0",O.diffusionStr_4_2="0",O.diffusionStr_4_3="0",O.diffusionStr_4_4="0",O.boundaryConditions_2="periodic",O.initCond_2="0",O.reactionStr_2="0",O.boundaryConditions_3="periodic",O.initCond_3="0",O.reactionStr_3="0",O.boundaryConditions_4="periodic",O.initCond_4="0",O.reactionStr_4="0",e=new RegExp("\\b("+wn[1]+")\\b"),e.test(O.reactionStr_1)&&(O.reactionStr_1="0");break;case 2:O.whatToDraw==vn[2]|O.whatToDraw==vn[3]&&(O.whatToDraw=vn[0]),O.whatToPlot==vn[2]|O.whatToPlot==vn[3]&&(O.whatToPlot=vn[0]),O.diffusionStr_1_3="0",O.diffusionStr_1_4="0",O.diffusionStr_2_3="0",O.diffusionStr_2_4="0",O.diffusionStr_3_1="0",O.diffusionStr_3_2="0",O.diffusionStr_3_3="0",O.diffusionStr_3_4="0",O.diffusionStr_4_1="0",O.diffusionStr_4_2="0",O.diffusionStr_4_3="0",O.diffusionStr_4_4="0",O.boundaryConditions_3="periodic",O.initCond_3="0",O.reactionStr_3="0",O.boundaryConditions_4="periodic",O.initCond_4="0",O.reactionStr_4="0",e=new RegExp("\\b("+wn[2]+")\\b"),e.test(O.reactionStr_1)&&(O.reactionStr_1="0"),e.test(O.reactionStr_2)&&(O.reactionStr_2="0");break;case 3:O.whatToDraw==vn[3]&&(O.whatToDraw=vn[0]),O.whatToPlot==vn[3]&&(O.whatToPlot=vn[0]),O.diffusionStr_1_4="0",O.diffusionStr_2_4="0",O.diffusionStr_3_4="0",O.diffusionStr_4_1="0",O.diffusionStr_4_2="0",O.diffusionStr_4_3="0",O.diffusionStr_4_4="0",O.boundaryConditions_4="periodic",O.initCond_4="0",O.reactionStr_4="0",e=new RegExp("\\b("+wn[3]+")\\b"),e.test(O.reactionStr_1)&&(O.reactionStr_1="0"),e.test(O.reactionStr_2)&&(O.reactionStr_2="0"),e.test(O.reactionStr_3)&&(O.reactionStr_3="0")}switch(Je){case 3:O.diffusionStr_2_2="0";break;case 6:O.diffusionStr_3_3="0";break;case 7:O.diffusionStr_2_2="0",O.diffusionStr_3_3="0";break;case 10:O.diffusionStr_4_4="0";break;case 11:O.diffusionStr_3_3="0",O.diffusionStr_4_4="0";break;case 12:O.diffusionStr_2_2="0",O.diffusionStr_3_3="0",O.diffusionStr_4_4="0"}ci(z),ci(G)}function $i(){!function(){switch(xi(),parseInt(O.numSpecies)){case 1:Je=0;break;case 2:Je=O.crossDiffusion?1==O.numAlgebraicSpecies?3:2:1;break;case 3:if(O.crossDiffusion)switch(O.numAlgebraicSpecies){case 0:Je=5;break;case 1:Je=6;break;case 2:Je=7}else Je=4;break;case 4:if(O.crossDiffusion)switch(O.numAlgebraicSpecies){case 0:Je=9;break;case 1:Je=10;break;case 2:Je=11;break;case 3:Je=12}else Je=8}}(),ao(),ro(),Ei(),Fi(),ho(),bo(),Ti()}function Ti(){let e,t=yn[Je];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(O.typesetCustomEqs){let o={};o.U=O.diffusionStr_1_1,o.UU=O.diffusionStr_1_1,o.V=O.diffusionStr_2_2,o.VV=O.diffusionStr_2_2,o.W=O.diffusionStr_3_3,o.WW=O.diffusionStr_3_3,o.Q=O.diffusionStr_4_4,o.QQ=O.diffusionStr_4_4,o.UV=O.diffusionStr_1_2,o.UW=O.diffusionStr_1_3,o.UQ=O.diffusionStr_1_4,o.VU=O.diffusionStr_2_1,o.VW=O.diffusionStr_2_3,o.VQ=O.diffusionStr_2_4,o.WU=O.diffusionStr_3_1,o.WV=O.diffusionStr_3_2,o.WQ=O.diffusionStr_3_4,o.QU=O.diffusionStr_4_1,o.QV=O.diffusionStr_4_2,o.QW=O.diffusionStr_4_3,o.UFUN=O.reactionStr_1,o.VFUN=O.reactionStr_2,o.WFUN=O.reactionStr_3,o.QFUN=O.reactionStr_4,Object.keys(o).forEach((function(e){Aa(o[e])&&(o[e]="0")}));var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!No(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Do(o[e],vn,Ge,"_(?:[xy][xybf]?)")})),xe.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){He.includes(e)||(t=function(e,t,n,i){null==i&&(i="  ");let o=n.replace(/\s+/g,"  ").trim();return["0","0.0","-0","-0.0","+0","+0.0"].includes(o)?e.replaceAll(t,""):"1"==o||"1.0"==o?e.replaceAll(t,"$2"):"-1"==o||"-1.0"==o?e.replaceAll(t,i[0]+"-"+i[1]+"$2"):e.replaceAll(t,i[0]+n+i[1]+"$2")}(t,n[e],o[e],"[]"))})),t=oo(t,n.UFUN,o.UFUN),t=oo(t,n.VFUN,o.VFUN),t=oo(t,n.WFUN,o.WFUN),t=oo(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}\(\)]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\(\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"\\lap $1"),e=/\\vnabla\s*\\cdot\s*\(\s*((?!\\vnabla).*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b(?:[xy]|[uvwq](?:_[xy])?|(?:I_[ST][RGBA]?))\b/g.test(t)?e:t.trim()+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else xe.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Do(t,["UFUN","VFUN","WFUN","QFUN"],He);1==O.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Do(t,Ge.concat(He),vn.concat(_n),"_(?:[xy][xybf]?)"),t=Ai(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(_o)}function Ai(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Vi(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Vi(e,"cos",!0),e=Vi(e,"tan",!0),e=Vi(e,"exp",!0),e=Vi(e,"log",!0),e=Vi(e,"sqrt",!1),e=Vi(e,"sinh",!0),e=Vi(e,"cosh",!0),e=Vi(e,"tanh",!0),e=Vi(e,"max",!0),e=Vi(e,"min",!0),e=oi(e=(e=Vi(e,"ind",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)t.includes(e[l])?(i+=1,o+=1):n.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=Ui(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=bn(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")).replaceAll(/<=/g," \\leq ")).replaceAll(/>=/g," \\geq ")).replaceAll(/([<>])/g," $1 ")}function Vi(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,s,l,u,c,d,f=0;for(const h of o){for(a=h.index,r=a+t.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=qi(i,"\\",a+f),f+=1,n?(i=qi(i,"{",r+f),f+=1,i=qi(i,"}",s+1+f),f+=1):(i=ki(i,"{",r+f),i=ki(i,"}",s+f)))}return i}function Ui(e,t){const n=["(","["],i=[")","]"];let o=Pi(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=ki(e,n[o],a),o+=1,o=Pi(o,n.length)):i.includes(e[a])&&(o-=1,o=Pi(o,n.length),e=ki(e,i[o],a));return e}function Pi(e,t){return(e%t+t)%t}function ki(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function qi(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Mi(e){return e=e.replace(/\s+/g,"  ").trim()}function Ri(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=We[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);We[e]=We[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),ci(_e),Ii(),Qn(),(ho()||Pe)&&(Pe=!1,bo())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)je.push(e),We[e]="",n=_e.add(We,e).name(""),va(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=je.indexOf(e);let n=Mi(We[je.at(t)]);if(""==n);else{let e=Ri(je.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Fa(t),e.lastName=t,Qe[t]=e}ze+=1;let o="params"+ze;this.remove(),Ri(o,!0),Ii(),(ho()||Pe)&&(Pe=!1,bo())}}));else{n=_e.add(We,e).name(""),va(n.domElement),n.domElement.classList.add("params");const t=We[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Fa(e),n.lastName=e,Qe[e]=n}n.onFinishChange((function(){let t=Mi(We[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=je.indexOf(e);je.splice(t,1),delete We[e],n.hasOwnProperty("lastName")&&!io(n.lastName)&&delete W[n.lastName]}else{i();const e=vo(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Fa(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!io(n.lastName)&&(delete W[n.lastName],n.lastName=t,Qe[t]=n)}}Ii(),ho()&&bo()})),Ii(),ho()&&bo()}return i(),n}function Ii(){O.kineticParams=Object.values(We).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Li(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Ni(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Bi(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Oi(){if(O.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+Fo(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==O.whatToPlot?($("#minLabel").html("$"+vn[0]+"$"),$("#midLabel").html("$"+vn[1]+"$"),$("#maxLabel").html("$"+vn[2]+"$")):Ae?$("#midLabel").html(O.views[O.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Ai(O.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),lo(),Wi()}else $("#colourbar").hide()}function Wi(){if("MAX"!=O.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Qi(e,n),Qi(t,n)]}(O.minColourValue,O.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=wo(Fo(0)),t=wo(Fo(.5)),n=wo(Fo(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function ji(e,t){return e.toPrecision(t)}function Qi(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function zi(){O.timeDisplay?($("#timeDisplay").show(),Gi()):$("#timeDisplay").hide(),Ji()}function Gi(){if(O.timeDisplay){let e=ji(W.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," × 10<sup>$2$3<sup>"),$("#timeValue").html(e),Ki()}}function Hi(){if(O.integrate){$("#integralDisplay").show();let e="";1==O.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Ai(O.whatToPlot)+"\\,\\d x",1==O.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Ji()}function Yi(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function Ji(){O.integrate&&O.timeDisplay?Yi("#timeDisplay",10):Yi("#timeDisplay",0)}function Xi(){let e=Ci();!Te||isFinite(e[0])&&isFinite(e[1])?se=setTimeout(Xi,1e3):(Te=!1,Ni("#oops_hit_nan"),Zn(),$("#erase").one("pointerdown",(function(){Bi("#oops_hit_nan"),Te=!0,window.clearTimeout(se),se=setTimeout(Xi,1e3)})))}function Zi(){if(!ot){try{s.readRenderTargetPixels(f,0,0,de,fe,et)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}ot=!0}}function Ki(){if(O.colourbar&&(O.integrate||O.timeDisplay)){let e,t=$("#colourbar")[0].getBoundingClientRect();e=O.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(Yi("#dataContainer",40),Ue=!0):Ue&&(Yi("#dataContainer",0),Ue=!1)}}function eo(){to()?(we.forEach((e=>{e.texture.magFilter=an.NearestFilter})),f.texture.magFilter=an.NearestFilter,h.texture.magFilter=an.NearestFilter):(we.forEach((e=>{e.texture.magFilter=an.LinearFilter})),f.texture.magFilter=an.LinearFilter,h.texture.magFilter=an.LinearFilter),Fi()}function to(){return n||O.forceManualInterpolation}function no(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function io(e,t){return null==t&&(t=[]),function(e){return[...(wt()+At()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e).concat(["I_T","I_TR","I_TG","I_TB","I_TA","I_S","I_SR","I_SG","I_SB","I_SA"])}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function oo(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function ao(){"line"==O.plotType?($o(),O.brushType="vline",On(),ci(G),V.visible=!1,k.visible=!0,O.contours=!1,O.emboss=!1,O.vectorField=!1,Da()):(V.visible=!0,k.visible=!1,"surface"==O.plotType?($("#simCanvas").css("outline","2px #000 solid"),Le&&(Le=!1,Un()),O.vectorField=!1,Da()):$("#simCanvas").css("outline","")),q.visible=O.overlay&&"line"==O.plotType,Wn(),Pn(),Fi(),Ta()}function ro(){Fe||(1!=O.dimension&&"line"==O.plotType&&(O.plotType="plane",zo("plotType"),ao()),1==O.dimension&&"line"!=O.plotType&&(O.plotType="line",O.vectorField=!1,zo("plotType"),ao())),1==O.dimension&&(O.minY="0.0"),Vn(),ai(),Ti(),Fi(),Hi()}function so(){const e="line"==O.plotType?0:O.cameraTheta,t="line"==O.plotType?0:O.cameraPhi,n=(new an.Vector3).setFromSphericalCoords(1,Math.PI/2-e*Math.PI/180,-t*Math.PI/180);i.position.set(n.x,n.y,n.z),i.lookAt(0,0,0)}function lo(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function uo(){return O.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function co(e){return vo(e)}function fo(){const e=/^\s*([a-zA-Z]\w*)\b/;let t=[];return uo().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function ho(){uo().split(";").filter((e=>e.length>0));const e=function(e){let t={},n={},i=[];const o=function(){const e=/^\s*([a-zA-Z]\w*)\b\s*=\s*(.*)/;let t=[];return uo().split(";").filter((e=>e.length>0)).forEach((function(n){const i=n.match(e);i?t.push([i[1].trim(),i[2].trim()]):Lo("Unable to evaluate the parameter definition '"+n+"'. Please check for syntax errors.")})),t}(),a=o.map((e=>e[0]));o.forEach((e=>t[e[0]]=e[1]));for(const e of o){let[o,r]=e;o in n||([n,,i]=go(o,t,n,[o],a,[]))}i.length>0&&Lo("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+". Click <a href='/user-guide/FAQ#cyclic' target='blank'>here</a> for more information.");return Object.keys(n).map((e=>[e,n[e]]))}(),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(fo());if(t.length>0)return Lo("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=mo(t[0],t[1]);n|=e,i|=o}return n&&!i}function mo(e,t){let n=!1,i=!1;const o=co(e);return io(o)?(Lo("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!W.hasOwnProperty(o),W[o]={type:"float",value:t}),[n,i]}function po(){return co(fo().map((e=>"uniform float "+e+";")).join("\n"))}function go(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const s of o)r=new RegExp("\\b"+s+"\\b","g"),r.test(t[e])&&(i.includes(s)?(n[s]=0,t[s]="0",t[e]="0",a.push(i.slice(i.indexOf(s)))):([n,,a]=go(s,t,n,[...i,s],o,a),t[e]=t[e].replaceAll(r,n[s].toString())));try{n[e]=Dn.evaluate(t[e])}catch(t){Lo("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function bo(){ai(),bi(),On(),yi(),Bn(),Di()}function vo(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+at[e])););return n}function _o(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function wo(e){return e.reduce(((e,t)=>e+t),0)/3}function yo(){let e=Ci();O.minColourValue=e[0],O.maxColourValue=e[1],W.maxColourValue.value=O.maxColourValue,W.minColourValue.value=O.minColourValue,Se.maxColourValue.updateDisplay(),Se.minColourValue.updateDisplay(),Wi()}function So(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Co(){let e;null!=vn&&(e=vn);const t=O.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Ge.length),n=t.concat(Ye.slice(t.length)),i=fo();let o;for(var a=0;a<n.length;a++)if(io(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void Lo("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");vn=n,_n=vn.map((e=>"f_{"+e+"}")),function(){wn=[];for(let e=0;e<vn.length;e++)wn.push("(?:"+vn.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...mn(),...gn()};if(Object.keys(r).forEach((function(e){Sn[e]=Ai(Do(r[e],Ge,vn,"_(?:[xy][xybf]?)"))})),r=pn(),Object.keys(r).forEach((function(e){Sn[e]=Ai(Do(r[e],He,_n))})),Fe)return;const s=["initCond_1","initCond_2","initCond_3","initCond_4","kineticParams"];Object.keys(O).forEach((function(t){xn.includes(t)&&(s.includes(t)||(O[t]=Do(O[t],e,vn,"_(?:[xy][xybf]?)")))})),O.views=O.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){xn.includes(i)&&(n[i]=Do(t[i],e,vn,"_(?:[xy][xybf]?)"))})),n})),Object.keys(Q).forEach((function(t){xn.includes(t)&&(s.includes(t)||(Q[t]=Do(Q[t],e,vn,"_(?:[xy][xybf]?)")))})),Q.views=Q.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){xn.includes(i)&&(n[i]=Do(t[i],e,vn,"_(?:[xy][xybf]?)"))})),n})),Ei(),Fi(),bo(),Ti()}function Do(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function xo(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=O.threeDHeightScale*me/pe,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function Fo(e){e=e.clamp(0,1);let t=0;for(;e>=B[t+1]&&t<N.length-2;)t+=1;return B[t+1]==B[t]?N[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=Eo(e[o],t[o],n);return i}(N[t],N[t+1],(e-B[t])/(B[t+1]-B[t])).map((e=>e.clamp(0,1)))}function Eo(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function $o(){C.linewidth=.01*O.lineWidthMul,D.linewidth=.01*O.overlayLineWidthMul,C.needsUpdate=!0,D.needsUpdate=!0}function To(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Ao(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Vo(e){e.forEach((function(e){xe.add(e)})),Ti()}function Uo(e){e.forEach((function(e){xe.delete(e)})),Ti()}function Po(){tt=new Float32Array(de*fe*4),s.readRenderTargetPixels(we[1],0,0,de,fe,tt),Ro(tt),qe=!0}function ko(){qe||Po();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([de,fe]),tt])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function qo(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Ro(e.slice(2),e.slice(0,2)),Mo(p),qe=!0,ei()},t.readAsArrayBuffer(e)}function Mo(e){if(null!=e)if("crop"==O.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=l/t;i>1&&(n=t/l,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Ro(e,t){null!=p&&p.dispose(),null==t&&(t=[de,fe]),p=new an.DataTexture(e,t[0],t[1],an.RGBAFormat,an.FloatType),p.needsUpdate=!0,p.magFilter=n?an.NearestFilter:an.LinearFilter,null!=E&&(E.map=p,E.needsUpdate)}function Io(){s.setSize(Math.round(devicePixelRatio*be),Math.round(devicePixelRatio*ve),!1)}function Lo(e){Zn(),Fe&&Ee||(Ee=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Ni("#error")))}function No(e){if(/\(\s*\)/.test(e))return Lo("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Lo("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Lo("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Bo(){let e;$("#views_list").empty();for(let t=0;t<O.views.length;t++)e=document.createElement("a"),e.onclick=function(){O.activeViewInd=t,Oo(O.views[t])},e.innerHTML="<div class='view_label'>"+O.views[t].name+"</div>",t==O.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Me=Math.max(O.views.length,Me),O.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),O.views.length}function Oo(e,t){Object.assign(O,e),delete O.name,ci(H),(null==t||t)&&(yi(),ao(),Wn(),kn(),Wi(),Oi(),Da(),ha(),Qn())}function Wo(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",O.views[O.activeViewInd].name);null!=e&&(O.views[O.activeViewInd].name=e,Bo(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function jo(){O.views.length>1?(O.views.splice(O.activeViewInd,1),O.activeViewInd<1?O.activeViewInd=0:O.activeViewInd-=1):O.views[O.activeViewInd].name="Custom",Oo(O.views[O.activeViewInd])}function Qo(){let e={};return Cn.forEach((function(t){e[t]=Q[t]})),e}function zo(e){O.activeViewInd<O.views.length&&(O.views[O.activeViewInd][e]=O[e])}function Go(e,t){let n="";return n+=hi(St(t),vn[e]),O.dimension>1&&(n+=hi(Ct(t),vn[e])),n}function Ho(e,t){let n="";return n+=hi(xt(t),vn[e]),O.dimension>1&&(n+=hi(Ft(t),vn[e])),n}function Yo(e,t){let n="";return n+=hi(Et(t,ii(O.domainIndicatorFun)),vn[e]),O.dimension>1&&(n+=hi($t(t,ii(O.domainIndicatorFun)),vn[e])),n}function Jo(e,t){let n="";return n+=hi(St(t).replaceAll(/updated/g,"gl_FragColor"),vn[e]),O.dimension>1&&(n+=hi(Ct(t).replaceAll(/updated/g,"gl_FragColor"),vn[e])),n}function Xo(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function Zo(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function Ko(e,t,n,i,o,a,r,s){const l=document.createElement("a");if(l.classList.add("toggle_button"),l.setAttribute("property",t),null==i&&(i=()=>{}),l.onclick=function(){O[l.getAttribute("property")]=!O[l.getAttribute("property")],ba(l),i()},null!=o&&(l.id=o),null!=a&&(l.title=a),null!=n&&(l.innerHTML=n),null!=r&&l.setAttribute("folderID",r),null!=s)for(const e of s)l.classList.add(e);return e.appendChild(l),ba(l),l}function ea(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function ta(){const e=Object.assign(Xt("default"),Xt(O.parent));let t=Si(O,e);1==O.views.length&&"1"==O.views[0].name&&delete t.views;for(const e of Object.keys(O.views[0]))O.hasOwnProperty(e)&&O.views.map((t=>t[e])).every((t=>t==O[e]))&&O.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/(:[^:]*),/g,"$1,\n\t").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function na(){let t="";t+=JSON.stringify(O),t+=JSON.stringify(W),t+=JSON.stringify({nXDisc:de,nYDisc:fe,domainHeight:me,domainWidth:he,aspectRatio:l,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function ia(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function oa(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function aa(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function ra(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function sa(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function la(){let e=Si(O,Xt("default"));return e.preset="Custom",e=cn(e),[location.href.replace(location.search,""),"?options=",fn.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function ua(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function ca(e){const t=Qe[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function da(){W.embossAmbient.value=O.embossAmbient,W.embossDiffuse.value=O.embossDiffuse,W.embossShiny.value=O.embossShiny,W.embossSmoothness.value=O.embossSmoothness,W.embossSpecular.value=O.embossSpecular,W.embossLightDir.value=new an.Vector3(Math.sin(O.embossTheta)*Math.cos(O.embossPhi),Math.sin(O.embossTheta)*Math.sin(O.embossPhi),Math.cos(O.embossTheta))}function fa(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function ha(){for(const e of[...De,...Ce]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function ma(){W.contourColour.value=new an.Color(O.contourColour),W.contourEpsilon.value=O.contourEpsilon,W.contourStep.value=1/(O.contourNum+1)}function pa(){W.overlayColour.value=new an.Color(O.overlayColour),W.overlayEpsilon.value=O.overlayEpsilon,W.overlayLine.value=O.overlay&&"line"==O.plotType,D.color=new an.Color(O.overlayColour),D.needsUpdate=!0}function ga(){ie||Qn()}function ba(e){O[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function va(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function _a(){O.customSurface?b.vertexShader=Gt():b.vertexShader=zt(),b.needsUpdate=!0}function wa(){"surface"==O.plotType?($(J).show(),O.customSurface?(Se.surfaceFun.show(),Se.threeDHeightScale.hide()):(Se.surfaceFun.hide(),Se.threeDHeightScale.show())):($(J).hide(),Se.surfaceFun.hide())}function ya(){L=new an.Group,a.add(L);const e=Math.max(de,fe),t=Math.round(Eo(3,window.width<629?20:64,O.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(de/n),o=Math.floor(fe/n),r=Math.floor((de-n*(i-1))/2),s=Math.floor((fe-n*(o-1))/2);let l,u,c,d,f,h;for(let e=0;e<o;e++){u=s+e*n,h=((u+.5)/fe-.5)*V.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,f=((c+.5)/de-.5)*V.geometry.parameters.width,l=c+u*de,d=Sa([f,h,1],[0,0,0]),d.ind=l,L.add(d)}}function Sa(e,t){const n=new an.Group,i=new an.Mesh(T,x);i.rotation.x=Math.PI/2;const o=new an.Mesh(A,x);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=T.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(Oe),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Ca(){if(L)for(a.remove(L);L.children.length;)L.remove(L.children[0])}function Da(){if(W.vectorField.value=O.vectorField,O.vectorField){if(Ca(),ya(),xa(),"relative"==O.arrowScale)try{L.customMax=Dn.evaluate(O.arrowLengthMax)}catch(e){Lo("Unable to evaluate the maximum arrow length. Please check the definition."),L.customMax=1}}else Ca()}function xa(){x.color=new an.Color(O.arrowColour)}function Fa(e){const t=io(e,vn.concat(_n));return t&&Lo("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}function Ea(e){return e=(e=e.replaceAll(/\bMINX\b/g,(()=>ii(O.minX)))).replaceAll(/\bMINY\b/g,(()=>ii(O.minY)))}function $a(e,t,n,i,o){if(e in t)return[t,n.slice(0,-1),o];for(const a of i[e])n.includes(a)?o.push(n.slice(n.indexOf(a))):[t,,o]=$a(a,t,[...n,a],i,o);return t[e]=!0,[t,n.slice(0,-1),o]}function Ta(){if($("#simCanvas").css("cursor","auto"),O.brushEnabled&&"surface"!=O.plotType&&"line"!=O.plotType)switch(O.brushType){case"circle":$("#simCanvas").css("cursor","url('images/cursor-circle.svg') 12 12, auto");break;case"hline":$("#simCanvas").css("cursor","url('images/cursor-hline.svg') 32 32, auto");break;case"vline":$("#simCanvas").css("cursor","url('images/cursor-vline.svg') 32 32, auto")}}function Aa(e){return/^\s*$/.test(e)}Tn&&li("GrayScott"),Ae=$n.has("story"),Ae&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),ee.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Oi(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),ue=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Li()||Tn||O.forceTryClickingPopup)&&!O.suppressTryClickingPopup&&O.brushEnabled&&($("#top_message").html("<p>"+O.tryClickingText+"</p>"),Ni("#top_message"),setTimeout((()=>Bi("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Bi("#top_message")))),$("#settings").click((function(){ia(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&ra(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&sa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&oa(),$("#views_ui").is(":visible")&&aa()),$("#left_ui").is(":visible")&&_o()})),$("#equations").click((function(){oa(),_o(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&ia(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&aa()})),$("#pause").click((function(){Zn()})),$("#play").click((function(){Kn()})),$("#erase").click((function(){ei()})),$("#share").click((function(){sa(),$("#help_panel").is(":visible")&&ra()})),$("#help").click((function(){ra(),$("#share_panel").is(":visible")&&sa()})),$("#screenshot").click((function(){it=!0,Qn(),sa()})),$("#link").click((function(){j.copyConfigAsURL(),sa()})),$("#embed").click((function(){!function(){let e=la();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}ua('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),sa()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){ra()})),$("#views").click((function(){aa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&ia(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&oa()})),$("#error_close_button").click((function(){Bi("#error")})),$("#oops_hit_nan_close").click((function(){Bi("#oops_hit_nan"),Te=!0})),$(document).on("click","#add_view",(function(){!function(){let e=Qo();e.name=++Me,O.views.push(e),O.activeViewInd=O.views.length-1,Bo()}()})),Fe=!1,function e(){requestAnimationFrame(e),ae=oe,oe&&O.brushEnabled&&function(){!O.setSeed&&O.brushValue.includes("RAND")&&gi();U.material=v;for(let e=1;e<we.length;e++)W.textureSource.value=we[e].texture,s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1)}();if(ie){!re||function(){U.material=_;for(let e=1;e<we.length;e++)W.textureSource.value=we[e].texture,s.setRenderTarget(we[e-1]),s.render(r,o);we.rotate(-1)}();for(let e=0;e<O.numTimestepsPerFrame;e++){if(O.autoPause&&$e&&W.t.value>=O.autoPauseAt){$e=!1,Zn();break}Ve&&!O.setSeed&&gi(),jn()}}(ae||ie)&&Qn()}();