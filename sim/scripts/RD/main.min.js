let e,t,n,i,o,a,r,l,s,u,c,d,f,p,h,m,g,b,v,S,w,y,C,x,V,F,U,_,E,D,A,T,W,R,Q,P,k,M,I,N,L,q,O,B,j,z,G,J,H,X,Y,Z,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,pe,he,me,ge,be,ve,Se,we,ye,Ce,xe,Ve,Fe,Ue,$e,_e,Ee,De,Ae,Te,We,Re,Qe,Pe,ke,Me,Ie,Ne,Le,qe,Oe,Be,je,ze,Ge,Je,He,Xe,Ye,Ze,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,pt,ht,mt,gt,bt,vt,St,wt,yt,Ct,xt,Vt,Ft=[],Ut={},$t=[],_t=[],Et=new Set,Dt=!0,At=!1,Tt=!0,Wt=!1,Rt=!1,Qt=!1,Pt=!1,kt=!1,Mt=!1,It=0,Nt=!1,Lt=!0,qt=1,Ot=1,Bt=.15,jt={},zt=[],Gt={},Jt=0;const Ht=["u","v","w","q"],Xt=["UFUN","VFUN","WFUN","QFUN"],Yt=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],Zt=["REACT1","REACT2","REACT3","REACT4"];let Kt,en,tn,nn,on,an,rn,ln=!1,sn=!1;const un=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as cn,drawShaderBotReplace as dn,drawShaderBotAdd as fn,drawShaderShapeDisc as pn,drawShaderShapeVLine as hn,drawShaderShapeHLine as mn,drawShaderFactorSharp as gn,drawShaderFactorSmooth as bn}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as vn,computeDisplayFunShaderMid as Sn,computeMaxSpeciesShaderMid as wn,postGenericShaderBot as yn,postShaderDomainIndicator as Cn,interpolationShader as xn}from"./post_shaders.js";import{copyShader as Vn}from"../copy_shader.js";import{RDShaderTop as Fn,RDShaderBot as Un,RDShaderDirichletX as $n,RDShaderDirichletY as _n,RDShaderDirichletIndicatorFun as En,RDShaderRobinX as Dn,RDShaderRobinY as An,RDShaderUpdateNormal as Tn,RDShaderUpdateCross as Wn,RDShaderAlgebraicSpecies as Rn,RDShaderEnforceDirichletTop as Qn,RDShaderAdvectionPreBC as Pn,RDShaderAdvectionPostBC as kn,RDShaderDiffusionPreBC as Mn,RDShaderDiffusionPostBC as In,RDShaderGhostX as Nn,RDShaderGhostY as Ln,RDShaderMain as qn}from"./simulation_shaders.js";import{randShader as On,randNShader as Bn}from"../rand_shader.js";import{fiveColourDisplayTop as jn,fiveColourDisplayBot as zn,embossShader as Gn,contourShader as Jn,surfaceVertexShaderColour as Hn,surfaceVertexShaderCustom as Xn,overlayShader as Yn}from"./display_shaders.js";import{getColours as Zn}from"../colourmaps.js";import{genericVertexShader as Kn}from"../generic_shaders.js";import{getPreset as ei,getUserTextFields as ti,getFieldsInView as ni}from"./presets.js";import{clearShaderBot as ii,clearShaderTop as oi}from"./clear_shader.js";import*as ai from"../three.module.min.js";import{OrbitControls as ri}from"../OrbitControls.js";import{Line2 as li}from"../lines/Line2.js";import{LineMaterial as si}from"../lines/LineMaterial.js";import{LineGeometry as ui}from"../lines/LineGeometry.js";import{minifyPreset as ci,maxifyPreset as di}from"./minify_preset.js";import{LZString as fi}from"../lz-string.min.js";import{equationTEXFun as pi,getDefaultTeXLabelsDiffusion as hi,getDefaultTeXLabelsReaction as mi,getDefaultTeXLabelsBCsICs as gi,substituteGreek as bi}from"./TEX.js";let vi,Si,wi,yi=pi(),Ci={...hi(),...mi(),...gi()};const xi=ni();let Vi=new exprEval.Parser;Vi.consts.pi=Math.PI,Vi.consts.Pi=Math.PI,Vi.consts.e=Math.exp(1),N={};const Fi=ti();var Ui,$i;q={reset:function(){eo()},toggleRunning:function(){ut?Zi():Ki()},copyConfigAsURL:function(){cr(ur())},saveSimState:function(){Ra()},exportSimState:function(){Qa()},clearCheckpoints:function(){Mt&&(m.dispose(),m=null,Mt=!1)},restoreCurrentView:function(){var e;N.activeViewInd<N.views.length&&(e=N.activeViewInd,N.views[e]=mt[e],Oa(N.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Ui=Array.prototype.push,$i=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Ui.apply(this,$i.call(this,0,e)),this}),Array.prototype.last=function(){return this[this.length-1]},e=document.getElementById("simCanvas"),console.error=function(e){Pt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Na(t)},qo()||$("#logo").hide();const _i=new URLSearchParams(window.location.search);if(_i.has("no_ui")?($(".ui").addClass("hidden"),kt=!0):$(".ui").removeClass("hidden"),_i.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),kt=!0),_i.has("sf")&&(Ot=parseFloat(_i.get("sf")),(isNaN(Ot)||Ot<=0)&&(Ot=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!kt){$("#warning").css("display","block");await Promise.race([aa(document.getElementById("warning_ok"),"click",!0),aa(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}uo("default"),function(){L={brushCoords:{type:"v2",value:new ai.Vector2(.5,.5)},colour1:{type:"v4",value:new ai.Vector4(0,0,0,0)},colour2:{type:"v4",value:new ai.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new ai.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new ai.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new ai.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},ct=!1,c=new ai.Raycaster,d=new ai.Vector2,l=new ai.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),h={format:ai.RGBAFormat,type:ai.FloatType,minFilter:ai.NearestFilter},n|=/android/i.test(navigator.userAgent),h.magFilter=n?ai.NearestFilter:ai.LinearFilter,Ft.push(new ai.WebGLRenderTarget(N.maxDisc,N.maxDisc,h)),Ft.push(Ft[0].clone()),Ft.push(Ft[0].clone()),Ft.push(Ft[0].clone()),Ft.push(Ft[0].clone()),f=Ft[0].clone(),p=Ft[0].clone(),Ft.forEach((e=>{e.texture.wrapS=ai.RepeatWrapping,e.texture.wrapT=ai.RepeatWrapping})),f.texture.wrapS=ai.ClampToEdgeWrapping,f.texture.wrapT=ai.ClampToEdgeWrapping,p.texture.wrapS=ai.ClampToEdgeWrapping,p.texture.wrapT=ai.ClampToEdgeWrapping,i=new ai.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new ri(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==N.plotType&&(N.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,N.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,N.cameraZoom=i.zoom,Ga("cameraTheta"),Ga("cameraPhi"),Ga("cameraZoom"),co(z),br())})),o=new ai.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new ai.Scene,r=new ai.Scene,a.add(i),a.background=new ai.Color(N.backgroundColour),g=new ai.MeshBasicMaterial({side:ai.DoubleSide}),b=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn(),transparent:!0,side:ai.DoubleSide}),C=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()}),F=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn(),fragmentShader:xn()}),v=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()}),Ut.FE=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()}),Ut.AB2=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()});for(let e=1;e<3;e++)Ut["Mid"+e.toString()]=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()});for(let e=1;e<5;e++)Ut["RK4"+e.toString()]=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()});y=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn(),fragmentShader:Vn()}),w=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()}),S=new ai.ShaderMaterial({uniforms:L,vertexShader:Kn()}),x=new si({vertexColors:!0,linewidth:.01}),V=new ai.MeshBasicMaterial({color:N.arrowColour,side:ai.DoubleSide}),U=new ai.MeshBasicMaterial,_=new ai.CylinderGeometry(.008,.008,.1),E=new ai.ConeGeometry(.04,.04,4);const s=new ai.PlaneGeometry(1,1);A=new ai.Mesh(s,Ut[0]),A.position.z=0,r.add(A),Pi(),ki(),Wi(),Ii(),Ai(),Ni(),Eo(),Ao(),qi(),Li(),wo(),ia(),eo(),e.addEventListener("pointerdown",Gi),e.addEventListener("pointerup",Ji),e.addEventListener("pointermove",Hi),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(q.toggleRunning(),e.preventDefault()),"h"===e.key&&(kt?(kt=!1,$(".ui").removeClass("hidden"),at.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",gt),ut?Ki():Zi(),na(),da(),ya()):(kt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&Ra(),"c"==e.key&&(N.resetFromCheckpoints=!N.resetFromCheckpoints,vr($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Ai(),br()}),!1),window.addEventListener("message",dr),$("#checkpointInput").change((function(){Pa(this.files[0]),this.value=null}))}();let Ei=!0;if(_i.has("preset")&&(so(_i.get("preset")),Ei=!1),_i.has("options")){var Di=JSON.parse(fi.decompressFromEncodedURIComponent(_i.get("options")));Di.hasOwnProperty("p")&&(Di=di(Di)),so(Di),Ei=!1}function Ai(){Pi(),function(){A.material=y;for(let e=1;e<Ft.length;e++)L.textureSource.value=Ft[e].texture,Ft[e-1].setSize(bt,vt),l.setRenderTarget(Ft[e-1]),l.render(r,o);Ft.rotate(-1),Ft[0].dispose(),Ft[0]=Ft[1].clone(),f.setSize(bt,vt),zi(),p.setSize(Math.round(devicePixelRatio*Ct),Math.round(devicePixelRatio*xt))}(),ka(m),Ri(),Ti(),Fr(),Wi(),da(),ya()}function Ti(){D.geometry.dispose(),a.remove(D),T.geometry.dispose(),a.remove(T),W.geometry.dispose(),a.remove(W),ki()}function Wi(){switch(Qi(),N.plotType){case"line":N.cameraTheta=0,N.cameraPhi=0,u.enabled=!1,i.zoom=1,ca(),b.vertexShader=Hn();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=Kn();break;case"surface":u.enabled=!0,i.zoom=N.cameraZoom,ca(),wr()}b.needsUpdate=!0,i.left=-St/(2*yt),i.right=St/(2*yt),i.top=wt/(2*yt),i.bottom=-wt/(2*yt),i.updateProjectionMatrix(),Mi()}function Ri(){L.L.value=qt,L.L_y.value=wt,L.L_x.value=St,L.L_min.value=Math.min(wt,St),L.dt.value=N.dt,L.dx.value=St/bt,L.dy.value=wt/vt,L.heightScale.value=N.threeDHeightScale,L.maxColourValue.value=N.maxColourValue,L.minColourValue.value=N.minColourValue,L.customSurface.value=N.customSurface,L.vectorField.value=N.vectorField,fr(),N.fixRandSeed||So()}function Qi(){try{qt=Vi.evaluate(N.domainScale)}catch(e){Na("Unable to evaluate the domain length. Please check the definition."),qt=100}Ct=Math.round(e.getBoundingClientRect().width),xt=Math.round(e.getBoundingClientRect().height),s=xt/Ct,s<=0&&(s=.1),s>=1?(wt=qt,St=wt/s):(St=qt,wt=St*s),1==N.dimension&&(St=qt),L.L_x.value=St,L.L_y.value=wt,yt=Math.max(St,wt)}function Pi(){Qi();let e=qt/100;try{e=Vi.evaluate(N.spatialStep)}catch(e){Na("Unable to evaluate the spatial step. Please check the definition.")}e<=0&&(Na("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),e=qt/100),bt=Math.floor(St/e),vt=Math.floor(wt/e),0==bt&&(bt=1),0==vt&&(vt=1),1==N.dimension&&(vt=1),L.nXDisc.value=bt,L.nYDisc.value=vt,R=new Array(bt),Q=new Array(bt);let t=-.5,n=1/bt;for(let e=0;e<R.length;e++)R[e]=t,t+=n;Ia(),on=new Float32Array(bt*vt*4),sn=!1}function ki(){Qi();let e=[1,1];Lt||(e=[bt,vt]);const t=new ai.PlaneGeometry(St/yt,wt/yt,e[0],e[1]);D=new ai.Mesh(t,b),D.position.z=0,D.visible="line"!=N.plotType,D.matrixAutoUpdate=!1,a.add(D);const n=new ai.PlaneGeometry(St/yt,wt/yt,1,1);T=new ai.Mesh(n,g),T.position.z=0,T.visible=!1,T.matrixAutoUpdate=!1,a.add(T),Mi();const i=new ui;P=Math.round(devicePixelRatio*Ct);const o=new Array(3*P).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),W=new li(i,x),W.scale.set(1,1,1),W.visible="line"==N.plotType,a.add(W)}function Mi(){switch(N.plotType){case"plane":D.rotation.x=0,T.rotation.x=0;break;case"surface":D.rotation.x=-Math.PI/2,T.rotation.x=-Math.PI/2}D.updateMatrix(),T.updateMatrix()}function Ii(){N.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Ni(e){B=new dat.GUI({closeOnTop:!0,autoPlace:!1}),B.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(B.domElement),j=new dat.GUI({closeOnTop:!0,autoPlace:!1}),j.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(j.domElement),z=new dat.GUI({closeOnTop:!0,autoPlace:!1}),z.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(z.domElement),B.open(),j.open(),z.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),G=j.addFolder("Brush");er(Za(G),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',null,null,"Toggle the brush on or off"),G.add(N,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(qi),J=G.add(N,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(qi),G.add(N,"brushValue").name("Value").onFinishChange(qi),G.add(N,"brushRadius").name("Radius").onFinishChange(qi),ve=G.add(N,"whatToDraw",vi).name("Species").onChange(qi),G=j.addFolder("Domain"),G.add(N,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){ua(),br()})),G.add(N,"domainScale").name("Largest side").onFinishChange((function(){Ai(),br()})),G.add(N,"spatialStep").name("Space step").onFinishChange((function(){Ai(),br()}));const t=Za(G);er(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Ii(),Ai(),Wi(),br()}),null,"Use a square domain"),er(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Implicit',(function(){Do(),Eo(),ao(),$o(),br()}),null,"Determine the domain implicitly"),ee=G.add(N,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Do(),Eo(),ao(),Vo(),br()})),G=j.addFolder("Timestepping"),He=G.add(N,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),pr(He,1,400,1),be=G.add(N,"dt").name("Timestep").onChange((function(){Ri()})),be.__precision=12,be.min(0),be.updateDisplay(),G.add(N,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme");er(Za(G),"timeDisplay",'<i class="fa-regular fa-stopwatch"></i> Elapsed time',Ho,null,"Show/hide time display"),G=j.addFolder("Equations"),G.add(N,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){Ao(),eo()})),K=G.add(N,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Nt=!0,Ao(),Nt=!1,eo()})),G.add(N,"speciesNames").name("Species names").onFinishChange((function(){Fa()})),G.add(N,"reactionNames").name("Reactions").onFinishChange((function(){Fa()}));er(Za(G),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Ao()}),"cross_diffusion_controller","Toggle cross diffusion"),G=B.addFolder("Definitions");er(Za(G),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',To,null,"Typeset the specified equations"),te=G.add(N,"diffusionStrUU").onFinishChange((function(){ao(),To()})),Da(te,Ta,["D","U","UU"]),Aa(te,Wa,["D","U","UU"]),ne=G.add(N,"diffusionStrUV").onFinishChange((function(){ao(),To()})),Da(ne,Ta,["UV"]),Aa(ne,Wa,["UV"]),ie=G.add(N,"diffusionStrUW").onFinishChange((function(){ao(),To()})),Da(ie,Ta,["UW"]),Aa(ie,Wa,["UW"]),oe=G.add(N,"diffusionStrUQ").onFinishChange((function(){ao(),To()})),Da(oe,Ta,["UQ"]),Aa(oe,Wa,["UQ"]),ae=G.add(N,"diffusionStrVU").onFinishChange((function(){ao(),To()})),Da(ae,Ta,["VU"]),Aa(ae,Wa,["VU"]),re=G.add(N,"diffusionStrVV").onFinishChange((function(){ao(),To()})),Da(re,Ta,["V","VV"]),Aa(re,Wa,["V","VV"]),le=G.add(N,"diffusionStrVW").onFinishChange((function(){ao(),To()})),Da(le,Ta,["VW"]),Aa(le,Wa,["VW"]),se=G.add(N,"diffusionStrVQ").onFinishChange((function(){ao(),To()})),Da(se,Ta,["VQ"]),Aa(se,Wa,["VQ"]),ue=G.add(N,"diffusionStrWU").onFinishChange((function(){ao(),To()})),Da(ue,Ta,["WU"]),Aa(ue,Wa,["WU"]),ce=G.add(N,"diffusionStrWV").onFinishChange((function(){ao(),To()})),Da(ce,Ta,["WV"]),Aa(ce,Wa,["WV"]),de=G.add(N,"diffusionStrWW").onFinishChange((function(){ao(),To()})),Da(de,Ta,["W","WW"]),Aa(de,Wa,["W","WW"]),fe=G.add(N,"diffusionStrWQ").onFinishChange((function(){ao(),To()})),Da(fe,Ta,["WQ"]),Aa(fe,Wa,["WQ"]),pe=G.add(N,"diffusionStrQU").onFinishChange((function(){ao(),To()})),Da(pe,Ta,["QU"]),Aa(pe,Wa,["QU"]),he=G.add(N,"diffusionStrQV").onFinishChange((function(){ao(),To()})),Da(he,Ta,["QV"]),Aa(he,Wa,["QV"]),me=G.add(N,"diffusionStrQW").onFinishChange((function(){ao(),To()})),Da(me,Ta,["QW"]),Aa(me,Wa,["QW"]),ge=G.add(N,"diffusionStrQQ").onFinishChange((function(){ao(),To()})),Da(ge,Ta,["Q","QQ"]),Aa(ge,Wa,["Q","QQ"]),H=G.add(N,"reactionStrU").onFinishChange((function(){ao(),To()})),Da(H,Ta,["UFUN"]),Aa(H,Wa,["UFUN"]),X=G.add(N,"reactionStrV").onFinishChange((function(){ao(),To()})),Da(X,Ta,["VFUN"]),Aa(X,Wa,["VFUN"]),Y=G.add(N,"reactionStrW").onFinishChange((function(){ao(),To()})),Da(Y,Ta,["WFUN"]),Aa(Y,Wa,["WFUN"]),Z=G.add(N,"reactionStrQ").onFinishChange((function(){ao(),To()})),Da(Z,Ta,["QFUN"]),Aa(Z,Wa,["QFUN"]),Vt=B.addFolder("Parameters"),function(){let e,t,n=[],i=N.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Io(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+Jt,Jt+=1,zt.push(e),jt[e]=t,n.push(e));for(const e of n)No(e,!1);e="param"+Jt,zt.push(e),jt[e]=t,No(e,!0)}(),G=B.addFolder("Boundary conditions"),We=G.add(N,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){ao(),vo()})),ke=G.add(N,"dirichletStrU").onFinishChange(ao),je=G.add(N,"neumannStrU").onFinishChange(ao),Xe=G.add(N,"robinStrU").onFinishChange(ao),Le=G.add(N,"comboStrU").name("Details").onFinishChange(ao),Re=G.add(N,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){ao(),vo()})),Me=G.add(N,"dirichletStrV").onFinishChange(ao),ze=G.add(N,"neumannStrV").onFinishChange(ao),Ye=G.add(N,"robinStrV").onFinishChange(ao),qe=G.add(N,"comboStrV").name("Details").onFinishChange(ao),Qe=G.add(N,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){ao(),vo()})),Ie=G.add(N,"dirichletStrW").onFinishChange(ao),Ge=G.add(N,"neumannStrW").onFinishChange(ao),Ze=G.add(N,"robinStrW").onFinishChange(ao),Oe=G.add(N,"comboStrW").name("Details").onFinishChange(ao),Pe=G.add(N,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){ao(),vo()})),Ne=G.add(N,"dirichletStrQ").onFinishChange(ao),Je=G.add(N,"neumannStrQ").onFinishChange(ao),Ke=G.add(N,"robinStrQ").onFinishChange(ao),Be=G.add(N,"comboStrQ").name("Details").onFinishChange(ao),G=B.addFolder("Initial conditions"),Ee=G.add(N,"clearValueU").onFinishChange(wo),De=G.add(N,"clearValueV").onFinishChange(wo),Ae=G.add(N,"clearValueW").onFinishChange(wo),Te=G.add(N,"clearValueQ").onFinishChange(wo),et=j.addFolder("Images"),G=et,xo(),G=j.addFolder("Checkpoints");const n=Za(G);er(n,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),tr(n),Ka(n,'<i class="fa-regular fa-flag"></i> Set',Ra,null,"Set a checkpoint at the current state",["narrow"]),Ka(n,'<i class="fa-regular fa-file-arrow-down"></i> Export',Qa,null,"Download the last checkpoint as a file",["narrow"]),Ka(n,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),G.add(N,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize"),G=j.addFolder("Misc."),G.addColor(N,"backgroundColour").name("Background").onChange((function(){a.background=new ai.Color(N.backgroundColour),br()}));const i=Za(G);er(i,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){Yo(),br()}),null,"Compute the integral of the plotted expression over the domain"),er(i,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){ia(),br()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),er(i,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',null,null,"Fix the random seed"),Ka(i,'<i class="fa-regular fa-copy"></i> Copy code',nr,null,"Copy the simulation configuration as JSON"),G=G.addFolder("Debug");Ka(Za(G),"Copy debug information",ir);const o=document.createElement("div");o.innerHTML="Settings",o.classList.add("ui_title"),j.domElement.prepend(o);const r=document.createElement("div");r.innerHTML="Equations",r.classList.add("ui_title"),B.domElement.prepend(r);const l=document.createElement("div");l.id="views_list",z.domElement.prepend(l);const s=document.createElement("div");s.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",s.classList.add("ui_title"),z.domElement.prepend(s),at=z.addFolder("Edit view"),G=at;const u=Za(G,"edit_view_buttons");Ka(u,'<i class="fa-solid fa-pen-nib"></i> Rename',Ba,null,"Rename the current view"),Ka(u,'<i class="fa-solid fa-xmark"></i> Delete',ja,"deleteViewButton","Delete view"),st=G.add(N,"whatToPlot").name("Expression: ").onFinishChange((function(){Vo(),br(),Ga(this.property)})),G.add(N,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){sa(),document.activeElement.blur(),br(),Ga(this.property)})),G.add(N,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Oi(),jo(),br(),Ga(this.property)})).name("Colour map"),Fe=G.add(N,"minColourValue").name("Min value").onChange((function(){Ri(),zo(),br(),Ga(this.property)})),Fe.__precision=2,Ue=G.add(N,"maxColourValue").name("Max value").onChange((function(){Ri(),zo(),br(),Ga(this.property)})),Ue.__precision=2;const c=Za(G,"colour_map_buttons");Ka(c,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){N.flippedColourmap=!N.flippedColourmap,Oi(),jo(),br(),Ga("flippedColourmap")}),null,"Reverse colour map",["narrow"]),Ka(c,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){xa(),ji(),Ga("minColourValue"),Ga("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),er(c,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){jo(),Ga("colourbar")}),null,"Display the colourbar",null,["narrow"]),tr(c),er(c,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){N.autoSetColourRange&&(xa(),ji()),Ga("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),er(c,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Oi(),br(),Ga("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),er(c,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Oi(),br(),Ga("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),er(c,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Oi(),br(),Ga("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),er(c,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Fr(),br(),Ga("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),G=at.addFolder("Contours"),G.domElement.id="contoursFolder",G.addColor(N,"contourColour").name("Colour").onChange((function(){mr(),br(),Ga(this.property)})),$t.push(G.add(N,"contourNum").name("Number").onChange((function(){mr(),br(),Ga(this.property)}))),pr($t.last(),1,20,1),$t.push(G.add(N,"contourEpsilon").name("Threshold").onChange((function(){mr(),br(),Ga(this.property)}))),pr($t.last(),.001,.05,.001),G=at.addFolder("Lighting"),G.domElement.id="embossFolder",_t.push(G.add(N,"embossSmoothness").name("Smoothness").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,2,.001),_t.push(G.add(N,"embossAmbient").name("Ambient").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,1,.001),_t.push(G.add(N,"embossDiffuse").name("Diffuse").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,1,.001),_t.push(G.add(N,"embossSpecular").name("Specular").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,1,.001),_t.push(G.add(N,"embossShiny").name("Precision").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,100,1),_t.push(G.add(N,"embossTheta").name("Inclination").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,1.5708,.001),_t.push(G.add(N,"embossPhi").name("Direction").onChange((function(){fr(),br(),Ga(this.property)}))),pr(_t.last(),0,3.1456,.001),G=at.addFolder("Overlay"),G.domElement.id="overlayFolder",G.addColor(N,"overlayColour").name("Colour").onChange((function(){gr(),br(),Ga(this.property)})),G.add(N,"overlayExpr").name("Expression").onFinishChange((function(){Oi(),br(),Ga(this.property)})),G.add(N,"overlayEpsilon").name("Threshold").onChange((function(){gr(),br(),Ga(this.property)})),rt=at.addFolder("3D"),G=rt;er(Za(G),"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){L.customSurface.value=N.customSurface,wr(),yr(),br(),Ga("customSurface")}),"customSurfaceToggle","Plot the solution on a custom surface"),ye=G.add(N,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){Vo(),br(),Ga(this.property)})),we=G.add(N,"threeDHeightScale").name("Max height").onChange((function(){Ri(),Ga(this.property)})),Ce=G.add(N,"cameraTheta").name("View $\\theta$").onChange((function(){Wi(),Ga(this.property)})),xe=G.add(N,"cameraPhi").name("View $\\phi$").onChange((function(){Wi(),Ga(this.property)})),Ve=G.add(N,"cameraZoom").name("Zoom").onChange((function(){Wi(),Ga(this.property)})),Se=G.add(N,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Ea(),ji(),Ga(this.property)})),lt=at.addFolder("Vector field"),G=lt,G.domElement.id="vectorFieldFolder",G.addColor(N,"arrowColour").name("Colour").onChange((function(){Ur(),br(),Ga(this.property)})),G.add(N,"arrowX").onFinishChange((function(){$o(),br(),Ga(this.property)})).name("$x$ component"),G.add(N,"arrowY").onFinishChange((function(){$o(),br(),Ga(this.property)})).name("$y$ component"),it=G.add(N,"arrowDensity").onChange((function(){Fr(),br(),Ga(this.property)})).name("Density"),it.__precision=2,pr(it,0,1,.001),G.add(N,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){Eo(),br(),Ga(this.property)})).name("Scaling"),ot=G.add(N,"arrowLengthMax").onFinishChange((function(){Fr(),br(),Ga(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Sr(e)))}function Li(){Oi(),jo(),Vo(),qi()}function qi(){let e=ba()+cn(),t="float brushRadius = "+io(N.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(N.brushValue)&&(e+=On()),/\bRANDN\b/.test(N.brushValue)&&(e+=Bn()),e+="float brushValue = "+io(N.brushValue)+";\n",e+=t,N.typeOfBrush){case"circle":e+=pn();break;case"hline":e+=mn();break;case"vline":e+=hn()}switch(N.brushAction){case"replace":e+=gn(),e+=dn();break;case"add":e+=gn(),e+=fn();break;case"smoothreplace":e+=bn(),e+=dn();break;case"smoothadd":e+=bn(),e+=fn()}e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,bo(N.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function Oi(){M=Zn(N.colourmap),N.flippedColourmap&&(M.reverse(),M=M.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),L.colour1.value=new ai.Vector4(...M[0]),L.colour2.value=new ai.Vector4(...M[1]),L.colour3.value=new ai.Vector4(...M[2]),L.colour4.value=new ai.Vector4(...M[3]),L.colour5.value=new ai.Vector4(...M[4]);let e=ba()+jn();N.emboss&&(e+=Gn(),fr()),N.contours&&(e+=Jn(),mr()),N.overlay&&(e+=Yn().replaceAll("OVERLAYEXPR",io(N.overlayExpr)),gr()),e+=zn(),b.fragmentShader=e,b.needsUpdate=!0,C.needsUpdate=!0,I=M.map((e=>e[3])),M=M.map((e=>e.slice(0,-1)))}function Bi(){switch(N.timesteppingScheme){case"Euler":A.material=Ut.FE,L.textureSource.value=Ft[1].texture,L.textureSource1.value=Ft[2].texture,L.dt.value=N.dt,l.setRenderTarget(Ft[0]),l.render(r,o),Ft.rotate(-1),L.t.value+=N.dt;break;case"AB2":A.material=Ut.AB2,L.textureSource.value=Ft[1].texture,L.textureSource1.value=Ft[2].texture,L.dt.value=N.dt,l.setRenderTarget(Ft[0]),l.render(r,o),Ft.rotate(-1),L.t.value+=N.dt;break;case"Mid":A.material=Ut.Mid1,L.textureSource.value=Ft[1].texture,l.setRenderTarget(Ft[2]),l.render(r,o),A.material=Ut.Mid2,L.textureSource1.value=Ft[2].texture,L.t.value+=.5*N.dt,l.setRenderTarget(Ft[0]),l.render(r,o),Ft.rotate(-1),L.t.value+=.5*N.dt;break;case"RK4":A.material=Ut.RK41,L.textureSource.value=Ft[1].texture,l.setRenderTarget(Ft[2]),l.render(r,o),A.material=Ut.RK42,L.textureSource1.value=Ft[2].texture,L.t.value+=.5*N.dt,l.setRenderTarget(Ft[3]),l.render(r,o),A.material=Ut.RK43,L.textureSource2.value=Ft[3].texture,l.setRenderTarget(Ft[4]),l.render(r,o),A.material=Ut.RK44,L.textureSource3.value=Ft[4].texture,L.t.value+=.5*N.dt,l.setRenderTarget(Ft[0]),l.render(r,o),Ft.rotate(-1)}}function ji(){if(N.autoSetColourRange&&xa(),N.brushEnabled&&"surface"==N.plotType){let e=0;N.maxColourValue-N.minColourValue>0&&(e=(function(){ta();let e=0;for(let t=0;t<on.length;t+=4)e+=on[t];return e/(bt*vt)}()-N.minColourValue)/(N.maxColourValue-N.minColourValue)-.5,e=e.clamp(-.5,.5)),T.position.y=N.threeDHeightScale*e,T.updateWorldMatrix()}if(zi(),"line"==N.plotType){ta();let t,n=0;var e=N.maxColourValue-N.minColourValue;e=0==e?.5:e;for(let i=0;i<on.length;i+=4)t=(on[i]-N.minColourValue)/e-.5,Q[n++]=t.clamp(-.5,.5);const i=new ai.SplineCurve(R.map(((e,t)=>new ai.Vector2(e,Q[t])))),o=i.getSpacedPoints(P);!function(e){let t,n=W.geometry.attributes.instanceStart,i=W.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)t=e[o].toArray(),t[1]*=N.threeDHeightScale,o<e.length&&n.setXYZ(o,t[0],t[1],0),o>0&&i.setXYZ(o-1,t[0],t[1],0);n.needsUpdate=!0,i.needsUpdate=!0}(o),function(e){let t,n=W.geometry.attributes.instanceColorStart,i=W.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)t=$a(e[o].toArray()[1]+.5),o<e.length&&n.setXYZ(o,t[0],t[1],t[2]),o>0&&i.setXYZ(o-1,t[0],t[1],t[2]);n.needsUpdate=!0}(o)}if(N.vectorField&&k){rn=new Float32Array(bt*vt*4),l.readRenderTargetPixels(f,0,0,bt,vt,rn);let e,t,n,i=[];for(const o of k.children)e=4*o.ind,t=rn[e+2],n=rn[e+3],o.visible=rn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(N.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of k.children){const t=Bt*_a(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=k.customMax>0?k.customMax:1;for(const e of k.children){const t=Bt*_a(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of k.children)e.scale.set(Bt,Bt,Bt)}}if(N.timeDisplay&&Xo(),N.integrate&&function(){if(N.integrate){let e;ta(),1==N.dimension?e=L.dx.value:2==N.dimension&&(e=L.dx.value*L.dy.value);let t=0;for(let e=0;e<on.length;e+=4)t+=on[e];t*=e,$("#integralValue").html(Go(t,4)),na()}}(),oa()?(A.material=F,l.setRenderTarget(p),l.render(r,o),L.textureSource.value=p.texture,L.dxUpscaledScale.value=devicePixelRatio*Ct/bt,L.dyUpscaledScale.value=devicePixelRatio*xt/vt):(L.dxUpscaledScale.value=1,L.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),ln){ln=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Pi(),ji()}}function zi(){A.material=C,L.textureSource.value=Ft[1].texture,l.setRenderTarget(f),l.render(r,o),L.textureSource.value=f.texture,sn=!1,L.textureSource1.value=Ft[1].texture}function Gi(t){ct=Xi(t,e),ct&&(N.brushEnabled&&"surface"==N.plotType?u.enabled=!1:N.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Oo("#top_message"),window.clearTimeout(ht),ht=setTimeout((function(){$("#top_message").hasClass("fading_out")||Bo("#top_message")}),3e3)))}function Ji(e){ct=!1,"surface"==N.plotType&&(u.enabled=!0)}function Hi(t){Xi(t,e)}function Xi(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==N.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(T,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==N.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*bt)/bt,a=Math.round(a*vt)/vt,L.brushCoords.value=new ai.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Yi(){l.setSize(bt,vt,!1),N.fixRandSeed||So(),Mt&&N.resetFromCheckpoints?A.material=U:A.material=w,Ft.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Ia(),ji()}function Zi(){kt||($("#pause").hide(),$("#play").show()),ut=!1}function Ki(){kt||($("#play").hide(),$("#pause").show()),Tt=!0,window.clearTimeout(pt),pt=setTimeout(ea,1e3),ut=!0}function eo(){Yi(),L.t.value=0,Xo(),ji(),Tt=!0,window.clearTimeout(pt),ea()}function to(){let e="";return e+="float UFUN = "+io(N.reactionStrU)+";\n",e+="float VFUN = "+io(N.reactionStrV)+";\n",e+="float WFUN = "+io(N.reactionStrW)+";\n",e+="float QFUN = "+io(N.reactionStrQ)+";\n",e}function no(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function io(e){if(!La(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])\b/g);let i,o,a,r,l,s,u,c,d,f,p,h,m=0;const g={S:"One",T:"Two"},b={R:"x",G:"y",B:"z",A:"w"};for(const v of n){for(i=v.index,p=g[v[1]],h=b[v[2]],o=i+v[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+m+1,a+m),l=wa(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+")/L_x",s[1]="("+s[1]+")/L_y",f="texture(imageSource"+p+",vec2("+s.join(",")+"))."+h,t=ko(t,f,i+m,a+1+m),m+=f.length-a+i-1)}return t}(e=pa(e=(e=(e=(e=oo(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){switch(n){case"0":return"1";case"1":return"("+t+")";case"2":return"(("+t+")*("+t+"))";case"3":return"(("+t+")*("+t+")*("+t+"))";case"4":return"(("+t+")*("+t+")*("+t+")*("+t+"))";case"5":return"(("+t+")*("+t+")*("+t+")*("+t+")*("+t+"))";default:return"safepow("+t+","+n+")"}}))).replaceAll(RegExp("\\b("+wi[0]+")\\b","g"),(function(e,t){return"uvwq."+bo(t)}))).replaceAll(RegExp("\\b("+wi[0]+")_([xy])\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+bo(t)}))).replaceAll(RegExp("\\b("+wi[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+bo(t)}))));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function oo(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function ao(){let e="",t="",n="",i="",o="",a="";const r=[N.boundaryConditionsU,N.boundaryConditionsV,N.boundaryConditionsW,N.boundaryConditionsQ],l=[N.neumannStrU,N.neumannStrV,N.neumannStrW,N.neumannStrQ],s=[N.comboStrU,N.comboStrV,N.comboStrW,N.comboStrQ].map((e=>e+";")),u=[N.dirichletStrU,N.dirichletStrV,N.dirichletStrW,N.dirichletStrQ],c=[N.robinStrU,N.robinStrV,N.robinStrW,N.robinStrQ];if(r.forEach((function(t,n){"neumann"==t?(e+=ro(l[n],vi[n]),e+=Ja(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=ro(t[2],vi[n],i),e+=Ja(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=go(Nn(t),vi[e]),N.dimension>1&&(i+=go(Ln(t),vi[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,io(e[2]))}))})),N.domainViaIndicatorFun){let e=En().replace(/indicatorFun/g,io(N.domainIndicatorFun));u.forEach((function(t,i){n+=go(e,vi[i])+io(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=lo(u[t],vi[t]),n+=Ha(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=lo(e[2],vi[t],i),n+=Ha(t,i)}))}));r.forEach((function(e,t){"robin"==e?(i+=ro(c[t],vi[t]),i+=Xa(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=ro(e[2],vi[t],n),i+=Xa(t,n)}))}));let d=ba();if(o=function(){let e="";return e+=no(io(N.diffusionStrUU)+";\n","uu"),e+=no(io(N.diffusionStrVV)+";\n","vv"),e+=no(io(N.diffusionStrWW)+";\n","ww"),e+=no(io(N.diffusionStrQQ)+";\n","qq"),e}()+"\n",N.crossDiffusion?o+=function(){let e="";return e+=no(io(N.diffusionStrUV)+";\n","uv"),e+=no(io(N.diffusionStrUW)+";\n","uw"),e+=no(io(N.diffusionStrUQ)+";\n","uq"),e+=no(io(N.diffusionStrVU)+";\n","vu"),e+=no(io(N.diffusionStrVW)+";\n","vw"),e+=no(io(N.diffusionStrVQ)+";\n","vq"),e+=no(io(N.diffusionStrWU)+";\n","wu"),e+=no(io(N.diffusionStrWV)+";\n","wv"),e+=no(io(N.diffusionStrWQ)+";\n","wq"),e+=no(io(N.diffusionStrQU)+";\n","qu"),e+=no(io(N.diffusionStrQV)+";\n","qv"),e+=no(io(N.diffusionStrQW)+";\n","qw"),e}()+"\n"+Wn():o+=Tn(),en&&N.crossDiffusion&&(a+=go(Rn(),vi[1])),tn&&N.crossDiffusion&&(a+=go(Rn(),vi[2])),nn&&N.crossDiffusion&&(a+=go(Rn(),vi[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void Na("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Pn(),Mn(),e,t,i,kn(),In(),to(),o].join(" "),p=/\bRAND\b/.test(f),h=/\bRANDN\b/.test(f);p&&(f=On()+f),h&&(f=Bn()+f),Rt=p||h;let m=[n,a,Un()].join(" "),g="FE";Ut[g].fragmentShader=[d,Fn(g),f,qn(g),m].join(" "),g="AB2",Ut[g].fragmentShader=[d,Fn(g),f,qn(g),m].join(" "),g="Mid";for(let e=1;e<3;e++)Ut[g+e.toString()].fragmentShader=[d,Fn(g+e.toString()),f,qn(g+e.toString()),m].join(" ");g="RK4";for(let e=1;e<5;e++)Ut[g+e.toString()].fragmentShader=[d,Fn(g+e.toString()),f,qn(g+e.toString()),m].join(" ");if(Object.keys(Ut).forEach((e=>Ut[e].needsUpdate=!0)),ft=N.domainViaIndicatorFun||"dirichlet"==N.boundaryConditionsU||"dirichlet"==N.boundaryConditionsV||"dirichlet"==N.boundaryConditionsW||"dirichlet"==N.boundaryConditionsQ||/Dirichlet/.test(N.comboStrU)||/Dirichlet/.test(N.comboStrV)||/Dirichlet/.test(N.comboStrW)||/Dirichlet/.test(N.comboStrQ),ft){if(n=d+Qn(),N.domainViaIndicatorFun){let e=En().replace(/indicatorFun/g,io(N.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(t,i){n+=go(e,vi[i])+io(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=lo(u[t],vi[t]),n+=Ya(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=lo(e[2],vi[t],i),n+=Ya(t,i)}))}));n+="}",S.fragmentShader=n,S.needsUpdate=!0}}function ro(e,t,n){return null==n?["L","R","T","B"].map((n=>ro(e,t,n))).join(""):"float robinRHS"+t+n+" = "+io(e)+";\n"}function lo(e,t,n){return null==n?["L","R","T","B"].map((n=>lo(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+io(e)+";\n"}function so(e){uo("default"),uo(e),null!=N.threeD&&(N.threeD&&(N.dimension=2,N.plotType="surface"),delete N.threeD),null!=N.oneDimensional&&(N.oneDimensional&&(N.dimension=1,N.plotType="line"),delete N.oneDimensional),qt*=Ot,function(){if(0==N.views.length){let e=za();e.name="1",N.views.push(e)}else N.views=N.views.map((function(e){let t=za();return Object.assign(t,e),t}));mt=N.views}(),fo(B,!0),fo(j,!0),fo(z,!0),Ni(),N.activeViewInd<N.views.length?Oa(N.views[N.activeViewInd],!1):Oa({},!0),Ao(),Ii(),Ai(),Ri(),a.background=new ai.Color(N.backgroundColour),""!=N.initialState?fetch(N.initialState).then((e=>e.blob())).then((e=>Pa(e))):eo(),Wi(),tt.remove(),nt.remove(),xo(),ia()}function uo(e){let t;t=null==e?ei(N.preset):"string"==typeof e?ei(e):"object"==typeof e?e:ei("default"),t.hasOwnProperty("parent")&&null!=t.parent&&uo(t.parent),Jt=0,zt=[],jt={},Object.assign(N,t),ut=N.runningOnLoad,Fa(!0),ut?Ki():Zi(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?N.tryClickingText=N.tryClickingText.replaceAll("clicking","tapping"):N.tryClickingText=N.tryClickingText.replaceAll("tapping","clicking"),N.brushRadius=N.brushRadius.toString(),N.hasOwnProperty("drawIn3D")&&(N.brushEnabled=N.drawIn3D);var n=0;n+=N.hasOwnProperty("algebraicV"),n+=N.hasOwnProperty("algebraicW"),(n+=N.hasOwnProperty("algebraicQ"))&&!N.numAlgebraicSpecies&&(N.numAlgebraicSpecies=n),delete N.algebraicV,delete N.algebraicW,delete N.algebraicQ,null==N.minColourValue&&(N.minColourValue=0),null==N.maxColourValue&&(N.maxColourValue=1),N.domainScale=N.domainScale.toString(),N.spatialStep=N.spatialStep.toString(),O=JSON.parse(JSON.stringify(N));let i=[N.clearValueU,N.clearValueV,N.clearValueW,N.clearValueQ,N.domainIndicatorFun,N.reactionStrU,N.reactionStrV,N.reactionStrW,N.reactionStrQ,N.diffusionStrUU,N.diffusionStrUV,N.diffusionStrUW,N.diffusionStrUQ,N.diffusionStrVU,N.diffusionStrVV,N.diffusionStrVW,N.diffusionStrVQ,N.diffusionStrWU,N.diffusionStrWV,N.diffusionStrWW,N.diffusionStrWQ,N.diffusionStrQU,N.diffusionStrQV,N.diffusionStrQW,N.diffusionStrQQ,N.dirichletStrU,N.dirichletStrV,N.dirichletStrW,N.dirichletStrQ,N.robinStrU,N.robinStrV,N.robinStrW,N.robinStrQ,N.comboStrU,N.comboStrV,N.comboStrW,N.comboStrQ,N.neumannStrU,N.neumannStrV,N.neumannStrW,N.neumannStrQ,N.brushValue,N.whatToPlot].join(" ");N.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function co(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)co(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function fo(e,t){if(null!=e){for(let t in e.__folders)fo(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function po(e){null!=e&&(e.__li.style.display="none")}function ho(e){null!=e&&(e.__li.style.display="")}function mo(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function go(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=bo(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function bo(e){return"rgba"[function(e){return vi.indexOf(e)}(e)]}function vo(){"dirichlet"==N.boundaryConditionsU?ho(ke):po(ke),"dirichlet"==N.boundaryConditionsV?ho(Me):po(Me),"dirichlet"==N.boundaryConditionsW?ho(Ie):po(Ie),"dirichlet"==N.boundaryConditionsQ?ho(Ne):po(Ne),"neumann"==N.boundaryConditionsU?ho(je):po(je),"neumann"==N.boundaryConditionsV?ho(ze):po(ze),"neumann"==N.boundaryConditionsW?ho(Ge):po(Ge),"neumann"==N.boundaryConditionsQ?ho(Je):po(Je),"robin"==N.boundaryConditionsU?ho(Xe):po(Xe),"robin"==N.boundaryConditionsV?ho(Ye):po(Ye),"robin"==N.boundaryConditionsW?ho(Ze):po(Ze),"robin"==N.boundaryConditionsQ?ho(Ke):po(Ke),"combo"==N.boundaryConditionsU?ho(Le):po(Le),"combo"==N.boundaryConditionsV?ho(qe):po(qe),"combo"==N.boundaryConditionsW?ho(Oe):po(Oe),"combo"==N.boundaryConditionsQ?ho(Be):po(Be),N.domainViaIndicatorFun?(po(We),po(Re),po(Qe),po(Pe)):ho(We)}function So(){L.seed.value=performance.now()%1e6/1e6}function wo(){let e=ba()+oi(),t=[N.clearValueU,N.clearValueV,N.clearValueW,N.clearValueQ].join(" ");/\bRAND\b/.test(t)&&(e+=On()),/\bRANDN\b/.test(t)&&(e+=Bn()),e+="float u = "+io(N.clearValueU)+";\n",e+="float v = "+io(N.clearValueV)+";\n",e+="float w = "+io(N.clearValueW)+";\n",e+="float q = "+io(N.clearValueQ)+";\n",e+=ii(),w.fragmentShader=e,w.needsUpdate=!0}function yo(){let e=new Image;e.src=tt.__image.src;let t=new ai.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,L.imageSourceOne.value=t,N.resetOnImageLoad&&eo()}}function Co(){let e=new Image;e.src=nt.__image.src;let t=new ai.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,L.imageSourceTwo.value=t,N.resetOnImageLoad&&eo()},t.dispose()}function xo(){G=et,tt=G.addImage(N,"imagePathOne").name("$I_S(x,y)$").onChange(yo),nt=G.addImage(N,"imagePathTwo").name("$I_T(x,y)$").onChange(Co),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Vo(){"MAX"==N.whatToPlot?(C.fragmentShader=wn()+Cn().replace(/indicatorFun/g,io(N.domainIndicatorFun))+yn(),C.needsUpdate=!0,N.minColourValue=0,N.maxColourValue=1,Ri(),po(Fe),po(Ue),po($e),po(_e),N.autoSetColourRange=!1,co(j)):($o(),ho(Fe),ho(Ue),ho($e),ho(_e)),jo(),Yo()}function Fo(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Uo(){ta();let e=1/0,t=-1/0;for(let n=0;n<on.length;n+=4)e=Math.min(e,on[n]),t=Math.max(t,on[n]);return[e,t]}function $o(){let e=ba()+vn();e+=Sn().replace(/\bXVECFUN\b/,io(N.arrowX)).replace(/\bYVECFUN\b/,io(N.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,io(N.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,io(N.surfaceFun))}(e),N.domainViaIndicatorFun&&(e+=Cn().replace(/indicatorFun/g,io(N.domainIndicatorFun))),C.fragmentShader=e+yn(),C.needsUpdate=!0}function _o(){N.numAlgebraicSpecies=Math.min(parseInt(N.numAlgebraicSpecies),parseInt(N.numSpecies)-1),en=N.numAlgebraicSpecies>=N.numSpecies-1,tn=N.numAlgebraicSpecies>=N.numSpecies-2&&N.numSpecies>=3,nn=N.numAlgebraicSpecies>=N.numSpecies-3&&N.numSpecies>=4}function Eo(){let e="function of "+vi.slice(0,N.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+vi[1]+",",""),i=e.replace(" "+vi[2]+",",""),o=e.replace(" "+vi[3]+",","");switch(1==N.dimension&&(e=e.replace(" y,","")),N.crossDiffusion&&parseInt(N.numSpecies)>1?(Nt||Va(K,Array.from(Array(parseInt(N.numSpecies)).keys())),ho(K)):po(K),N.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),po(ne),po(ae),po(re),po(X),po(De),po(Re),po(ie),po(le),po(ue),po(ce),po(de),po(Y),po(Ae),po(Qe),po(oe),po(se),po(fe),po(pe),po(he),po(me),po(ge),po(Z),po(Te),po(Pe),parseInt(N.numSpecies)){case 4:N.crossDiffusion?(ho(oe),ho(se),ho(fe),ho(pe),ho(he),ho(me)):(po(fe),po(pe),po(se),po(oe),po(he),po(me)),ho(ge),ho(Z),ho(Te),ho(Pe);case 3:N.crossDiffusion?(ho(ie),ho(le),ho(ue),ho(ce)):(po(ie),po(le),po(ue),po(ce)),ho(de),ho(Y),ho(Ae),ho(Qe);case 2:N.crossDiffusion?(ho(ne),ho(ae)):(po(ne),po(ae)),ho(re),ho(X),ho(De),ho(Re)}1==N.numSpecies?mo(te,Ci.D,e):N.crossDiffusion?(mo(te,Ci.Duu,e),mo(ne,Ci.Duv,e),mo(ie,Ci.Duw,e),mo(oe,Ci.Duq,e),mo(ae,Ci.Dvu,e),mo(re,Ci.Dvv,e),mo(le,Ci.Dvw,e),mo(se,Ci.Dvq,e),mo(ue,Ci.Dwu,e),mo(ce,Ci.Dwv,e),mo(de,Ci.Dww,e),mo(fe,Ci.Dwq,e),mo(pe,Ci.Dqu,e),mo(he,Ci.Dqv,e),mo(me,Ci.Dqw,e),mo(ge,Ci.Dqq,e)):(mo(te,Ci.Du,e),mo(re,Ci.Dv,e),mo(de,Ci.Dw,e),mo(ge,Ci.Dq,e)),mo(H,Ci.UFUN,e),mo(X,Ci.VFUN,e),mo(Y,Ci.WFUN,e),mo(Z,Ci.QFUN,e),en&&(mo(ae,Ci.Dvu,t),mo(le,Ci.Dvw,t),mo(se,Ci.Dvq,t),mo(X,Ci.VFUN,t),po(re)),tn&&(mo(ue,Ci.Dwu,o),mo(ce,Ci.Dwv,o),mo(fe,Ci.Dwq,o),mo(Y,Ci.WFUN,o),po(de)),nn&&(mo(pe,Ci.Dqu,i),mo(he,Ci.Dqv,i),mo(me,Ci.Dqw,i),mo(Z,Ci.QFUN,i),po(ge)),mo(We,Ci.u),mo(Re,Ci.v),mo(Qe,Ci.w),mo(Pe,Ci.q),mo(ke,Ci.uD),mo(Me,Ci.vD),mo(Ie,Ci.wD),mo(Ne,Ci.qD),mo(je,Ci.uN),mo(ze,Ci.vN),mo(Ge,Ci.wN),mo(Je,Ci.qN),mo(Xe,Ci.uN),mo(Ye,Ci.vN),mo(Ze,Ci.wN),mo(Ke,Ci.qN),mo(Ee,Ci.uInit),mo(De,Ci.vInit),mo(Ae,Ci.wInit),mo(Te,Ci.qInit),N.domainViaIndicatorFun?ho(ee):po(ee),vo(),"surface"==N.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),rt.name="3D options",rt.domElement.classList.remove("hidden"),N.customSurface&&ho(ye),po(Se),ho(we),ho(Ce),ho(xe),ho(Ve)):"line"==N.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),rt.name="Line options",rt.domElement.classList.remove("hidden"),ho(Se),ho(we),po(Ce),po(xe),po(Ve)):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),rt.domElement.classList.add("hidden"),po(Se),po(we),po(Ce),po(xe),po(Ve)),jo(),Ho(),Yo(),$("#dataContainer").show(),yr(),"line"==N.plotType?(po(J),$(":root").css("--ui-button-outline","black")):(ho(J),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==N.arrowScale?ho(ot):po(ot),Va(ve,vi.slice(0,N.numSpecies)),hr(),$(".toggle_button").each((function(){vr(this)})),qa(),co(B),co(j),co(z)}function Do(){let e;switch(_o(),N.domainViaIndicatorFun&&(N.boundaryConditionsU="dirichlet",N.boundaryConditionsV="dirichlet",N.boundaryConditionsW="dirichlet",N.boundaryConditionsQ="dirichlet"),parseInt(N.numSpecies)){case 1:N.crossDiffusion=!1,N.whatToDraw=vi[0],N.whatToPlot=vi[0],N.diffusionStrUV="0",N.diffusionStrUW="0",N.diffusionStrUQ="0",N.diffusionStrVU="0",N.diffusionStrVV="0",N.diffusionStrVW="0",N.diffusionStrVQ="0",N.diffusionStrWU="0",N.diffusionStrWV="0",N.diffusionStrWW="0",N.diffusionStrWQ="0",N.diffusionStrQU="0",N.diffusionStrQV="0",N.diffusionStrQW="0",N.diffusionStrQQ="0",N.boundaryConditionsV="periodic",N.clearValueV="0",N.reactionStrV="0",N.boundaryConditionsW="periodic",N.clearValueW="0",N.reactionStrW="0",N.boundaryConditionsQ="periodic",N.clearValueQ="0",N.reactionStrQ="0",e=new RegExp("\\b("+wi[1]+")\\b"),e.test(N.reactionStrU)&&(N.reactionStrU="0");break;case 2:N.whatToDraw==vi[2]|N.whatToDraw==vi[3]&&(N.whatToDraw=vi[0]),N.whatToPlot==vi[2]|N.whatToPlot==vi[3]&&(N.whatToPlot=vi[0]),N.diffusionStrUW="0",N.diffusionStrUQ="0",N.diffusionStrVW="0",N.diffusionStrVQ="0",N.diffusionStrWU="0",N.diffusionStrWV="0",N.diffusionStrWW="0",N.diffusionStrWQ="0",N.diffusionStrQU="0",N.diffusionStrQV="0",N.diffusionStrQW="0",N.diffusionStrQQ="0",N.boundaryConditionsW="periodic",N.clearValueW="0",N.reactionStrW="0",N.boundaryConditionsQ="periodic",N.clearValueQ="0",N.reactionStrQ="0",e=new RegExp("\\b("+wi[2]+")\\b"),e.test(N.reactionStrU)&&(N.reactionStrU="0"),e.test(N.reactionStrV)&&(N.reactionStrV="0");break;case 3:N.whatToDraw==vi[3]&&(N.whatToDraw=vi[0]),N.whatToPlot==vi[3]&&(N.whatToPlot=vi[0]),N.diffusionStrUQ="0",N.diffusionStrVQ="0",N.diffusionStrWQ="0",N.diffusionStrQU="0",N.diffusionStrQV="0",N.diffusionStrQW="0",N.diffusionStrQQ="0",N.boundaryConditionsQ="periodic",N.clearValueQ="0",N.reactionStrQ="0",e=new RegExp("\\b("+wi[3]+")\\b"),e.test(N.reactionStrU)&&(N.reactionStrU="0"),e.test(N.reactionStrV)&&(N.reactionStrV="0"),e.test(N.reactionStrW)&&(N.reactionStrW="0")}switch(Kt){case 3:N.diffusionStrVV="0";break;case 6:N.diffusionStrWW="0";break;case 7:N.diffusionStrVV="0",N.diffusionStrWW="0";break;case 10:N.diffusionStrQQ="0";break;case 11:N.diffusionStrWW="0",N.diffusionStrQQ="0";break;case 12:N.diffusionStrVV="0",N.diffusionStrWW="0",N.diffusionStrQQ="0"}co(B),co(j)}function Ao(){!function(){switch(_o(),parseInt(N.numSpecies)){case 1:Kt=0;break;case 2:Kt=N.crossDiffusion?1==N.numAlgebraicSpecies?3:2:1;break;case 3:if(N.crossDiffusion)switch(N.numAlgebraicSpecies){case 0:Kt=5;break;case 1:Kt=6;break;case 2:Kt=7}else Kt=4;break;case 4:if(N.crossDiffusion)switch(N.numAlgebraicSpecies){case 0:Kt=9;break;case 1:Kt=10;break;case 2:Kt=11;break;case 3:Kt=12}else Kt=8}}(),sa(),ua(),Do(),Eo(),ma(),Sa(),To()}function To(){let e,t=yi[Kt];const n={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(N.typesetCustomEqs){let o={};o.D=N.diffusionStrUU,o.U=N.diffusionStrUU,o.UU=N.diffusionStrUU,o.V=N.diffusionStrVV,o.VV=N.diffusionStrVV,o.W=N.diffusionStrWW,o.WW=N.diffusionStrWW,o.Q=N.diffusionStrQQ,o.QQ=N.diffusionStrQQ,o.UV=N.diffusionStrUV,o.UW=N.diffusionStrUW,o.UQ=N.diffusionStrUQ,o.VU=N.diffusionStrVU,o.VW=N.diffusionStrVW,o.VQ=N.diffusionStrVQ,o.WU=N.diffusionStrWU,o.WV=N.diffusionStrWV,o.WQ=N.diffusionStrWQ,o.QU=N.diffusionStrQU,o.QV=N.diffusionStrQV,o.QW=N.diffusionStrQW,o.UFUN=N.reactionStrU,o.VFUN=N.reactionStrV,o.WFUN=N.reactionStrW,o.QFUN=N.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!La(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Ua(o[e],vi,Ht,"_[xy]")})),Et.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Xt.includes(e)||(t=function(e,t,n,i){let o=n.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(t,"");if("1"==o||"1.0"==o)return e.replaceAll(t,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(t,"-$2");if(n.match(/[a-zA-Z]/))return n.match(/[\+-]/)&&null!=i?e.replaceAll(t,i[0]+n+i[1]+"$2"):e.replaceAll(t,n+"$2");return e}(t,n[e],o[e],"[]"))})),t=la(t,n.UFUN,o.UFUN),t=la(t,n.VFUN,o.VFUN),t=la(t,n.WFUN,o.WFUN),t=la(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b[xy]|[uvwq]\b/g.test(t)?e:t+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Et.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Ua(t,["UFUN","VFUN","WFUN","QFUN"],Si,"_[xy]");1==N.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Ua(t,Ht.concat(Xt),vi.concat(Si),"_[xy]"),t=Wo(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(ya)}function Wo(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Ro(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Ro(e,"cos",!0),e=Ro(e,"tan",!0),e=Ro(e,"exp",!0),e=Ro(e,"log",!0),e=Ro(e,"sqrt",!1),e=Ro(e,"sinh",!0),e=Ro(e,"cosh",!0),e=Ro(e,"tanh",!0),e=Ro(e,"max",!0),e=oo(e=(e=Ro(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Qo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=bi(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")}function Ro(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const p of o){for(a=p.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=Mo(i,"\\",a+f),f+=1,n?(i=Mo(i,"{",r+f),f+=1,i=Mo(i,"}",l+1+f),f+=1):(i=ko(i,"{",r+f),i=ko(i,"}",l+f)))}return i}function Qo(e,t){const n=["(","["],i=[")","]"];let o=Po(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=ko(e,n[o],a),o+=1,o=Po(o,n.length)):i.includes(e[a])&&(o-=1,o=Po(o,n.length),e=ko(e,i[o],a));return e}function Po(e,t){return(e%t+t)%t}function ko(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function Mo(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Io(e){return e=e.replace(/\s+/g,"  ").trim()}function No(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=jt[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);jt[e]=jt[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),co(Vt),Lo(),ji(),(ma()||Pt)&&(Pt=!1,Sa())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)zt.push(e),jt[e]="",n=Vt.add(jt,e).name(""),Sr(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=zt.indexOf(e);let n=Io(jt[zt.at(t)]);if(""==n);else{let e=No(zt.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];$r(t),e.lastName=t,Gt[t]=e}Jt+=1;let o="params"+Jt;this.remove(),No(o,!0),Lo(),(ma()||Pt)&&(Pt=!1,Sa())}}));else{n=Vt.add(jt,e).name(""),Sr(n.domElement),n.domElement.classList.add("params");const t=jt[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];$r(e),n.lastName=e,Gt[e]=n}n.onFinishChange((function(){let t=Io(jt[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=zt.indexOf(e);zt.splice(t,1),delete jt[e],n.hasOwnProperty("lastName")&&!ra(n.lastName)&&delete L[n.lastName]}else{i();const e=wa(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];$r(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!ra(n.lastName)&&(delete L[n.lastName],n.lastName=t,Gt[t]=n)}}Lo(),ma()&&Sa()})),Lo(),ma()&&Sa()}return i(),n}function Lo(){N.kineticParams=Object.values(jt).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function qo(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Oo(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Bo(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function jo(){if(N.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+$a(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==N.whatToPlot?($("#minLabel").html("$"+vi[0]+"$"),$("#midLabel").html("$"+vi[1]+"$"),$("#maxLabel").html("$"+vi[2]+"$")):Wt?$("#midLabel").html(N.views[N.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+Wo(N.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),da(),zo()}else $("#colourbar").hide()}function zo(){if("MAX"!=N.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Jo(e,n),Jo(t,n)]}(N.minColourValue,N.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Ca($a(0)),t=Ca($a(.5)),n=Ca($a(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Go(e,t){return e.toPrecision(t)}function Jo(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function Ho(){N.timeDisplay?($("#timeDisplay").show(),Xo()):$("#timeDisplay").hide(),Ko()}function Xo(){if(N.timeDisplay){let e=Go(L.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," × 10<sup>$2$3<sup>"),$("#timeValue").html(e),na()}}function Yo(){if(N.integrate){$("#integralDisplay").show();let e="";1==N.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+Wo(N.whatToPlot)+"\\,\\d x",1==N.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Ko()}function Zo(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function Ko(){N.integrate&&N.timeDisplay?Zo("#timeDisplay",10):Zo("#timeDisplay",0)}function ea(){let e=Uo();!Tt||isFinite(e[0])&&isFinite(e[1])?pt=setTimeout(ea,1e3):(Tt=!1,Oo("#oops_hit_nan"),Zi(),$("#oops_hit_nan").one("click",(function(){Bo("#oops_hit_nan"),Tt=!0})),$("#erase").one("pointerdown",(function(){Bo("#oops_hit_nan"),Tt=!0,window.clearTimeout(pt),pt=setTimeout(ea,1e3)})))}function ta(){if(!sn){try{l.readRenderTargetPixels(f,0,0,bt,vt,on)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}sn=!0}}function na(){if(N.colourbar&&N.integrate|N.timeDisplay){let e,t=$("#colourbar")[0].getBoundingClientRect();e=N.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(Zo("#dataContainer",40),Qt=!0):Qt&&(Zo("#dataContainer",0),Qt=!1)}}function ia(){oa()?(Ft.forEach((e=>{e.texture.magFilter=ai.NearestFilter})),f.texture.magFilter=ai.NearestFilter,p.texture.magFilter=ai.NearestFilter):(Ft.forEach((e=>{e.texture.magFilter=ai.LinearFilter})),f.texture.magFilter=ai.LinearFilter,p.texture.magFilter=ai.LinearFilter),Eo()}function oa(){return n||N.forceManualInterpolation}function aa(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function ra(e,t){return null==t&&(t=[]),function(e){return[...(Fn()+Wn()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function la(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function sa(){"line"==N.plotType?(Ea(),N.typeOfBrush="vline",qi(),co(j),D.visible=!1,W.visible=!0,N.contours=!1,N.emboss=!1,N.vectorField=!1,Fr()):(D.visible=!0,W.visible=!1,"surface"==N.plotType?($("#simCanvas").css("outline","2px #000 solid"),Lt&&(Lt=!1,Ti()),N.vectorField=!1,Fr()):$("#simCanvas").css("outline","")),Oi(),Wi(),Eo()}function ua(){1!=N.dimension&&"line"==N.plotType&&(N.plotType="plane",sa()),1==N.dimension&&"line"!=N.plotType&&(N.plotType="line",sa()),Ai(),ao(),To(),Eo(),Yo()}function ca(){const e=(new ai.Vector3).setFromSphericalCoords(1,Math.PI/2-N.cameraTheta*Math.PI/180,-N.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function da(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function fa(){return N.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function pa(e){return wa(e)}function ha(){const e=/(\w+)\s*=/;return fa().split(";").filter((e=>e.length>0)).map((t=>t.match(e)[1].trim()))}function ma(){const e=function(e){let t={},n={},i=[];e.forEach((function(e){const[n,i]=e.split("=").map((e=>e.trim()));t[n]=i}));const o=e.map((e=>e.split("=").map((e=>e.trim())))),a=o.map((e=>e[0]));for(const e of o){let[o,r]=e;o in n||([n,,i]=va(o,t,n,[o],a,[]))}i.length>0&&Na("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+".");return Object.keys(n).map((e=>[e,n[e]]))}(fa().split(";").filter((e=>e.length>0))),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(ha());if(t.length>0)return Na("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=ga(t[0],t[1]);n|=n,i|=o}return n&&!i}function ga(e,t){let n=!1,i=!1;const o=pa(e);return ra(o)?(Na("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!L.hasOwnProperty(o),L[o]={type:"float",value:t}),[n,i]}function ba(){return pa(ha().map((e=>"uniform float "+e+";")).join("\n"))}function va(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(l)):([n,,a]=va(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));try{n[e]=Vi.evaluate(t[e])}catch(t){Na("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function Sa(){ao(),wo(),qi(),Vo(),Li(),$o()}function wa(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+un[e])););return n}function ya(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Ca(e){return e.reduce(((e,t)=>e+t),0)/3}function xa(){let e=Uo();N.minColourValue=e[0],N.maxColourValue=e[1],L.maxColourValue.value=N.maxColourValue,L.minColourValue.value=N.minColourValue,Ue.updateDisplay(),Fe.updateDisplay(),zo()}function Va(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Fa(e){let t;null!=vi&&(t=vi);const n=N.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Ht.length),i=N.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Xt.length),o=n.concat(Yt.slice(n.length)),a=i.concat(Zt.slice(i.length)),r=ha();let l;for(var s=0;s<o.length;s++)if(ra(o[s],r.concat(a)))return l=r.includes(o[s])?"as a parameter":a.includes(o[s])?"as a reaction":"under the hood",void Na("The name '"+o[s]+"' is used "+l+", so can't be used as a species name. Please use a different name for "+o[s]+".");for(s=0;s<a.length;s++)if(ra(a[s],r.concat(o[s])))return l=r.includes(a[s])?"as a parameter":o.includes(a[s])?"as a reaction":"under the hood",void Na("The name '"+a[s]+"' is used "+l+", so can't be used as a function name. Please use a different name for "+a[s]+".");vi=o,Si=a,function(){wi=[];for(let e=0;e<vi.length;e++)wi.push("(?:"+vi.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let u={...hi(),...gi()};Object.keys(u).forEach((function(e){Ci[e]=Wo(Ua(u[e],Ht,vi,"_[xy]"))})),u=mi(),Object.keys(u).forEach((function(e){Ci[e]=Wo(Ua(u[e],Xt,Si))})),e||(Object.keys(N).forEach((function(e){Fi.includes(e)&&(N[e]=Ua(N[e],t,vi,"_[xy]"))})),N.views=N.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){Fi.includes(i)&&(n[i]=Ua(e[i],t,vi,"_[xy]"))})),n})),Object.keys(O).forEach((function(e){Fi.includes(e)&&(O[e]=Ua(O[e],t,vi,"_[xy]"))})),O.views=O.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){Fi.includes(i)&&(n[i]=Ua(e[i],t,vi,"_[xy]"))})),n})),Do(),Eo(),Sa(),To())}function Ua(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function $a(e){e=e.clamp(0,1);let t=0;for(;e>=I[t+1]&&t<M.length-2;)t+=1;return I[t+1]==I[t]?M[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=_a(e[o],t[o],n);return i}(M[t],M[t+1],(e-I[t])/(I[t+1]-I[t])).map((e=>e.clamp(0,1)))}function _a(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Ea(){x.linewidth=.01*N.lineWidthMul,x.needsUpdate=!0}function Da(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Aa(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Ta(e){e.forEach((function(e){Et.add(e)})),To()}function Wa(e){e.forEach((function(e){Et.delete(e)})),To()}function Ra(){an=new Float32Array(bt*vt*4),l.readRenderTargetPixels(Ft[1],0,0,bt,vt,an),Ma(an),Mt=!0}function Qa(){Mt||Ra();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([bt,vt]),an])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Pa(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Ma(e.slice(2),e.slice(0,2)),ka(m),Mt=!0,eo()},t.readAsArrayBuffer(e)}function ka(e){if(null!=e)if("crop"==N.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Ma(e,t){null!=m&&m.dispose(),null==t&&(t=[bt,vt]),m=new ai.DataTexture(e,t[0],t[1],ai.RGBAFormat,ai.FloatType),m.needsUpdate=!0,m.magFilter=n?ai.NearestFilter:ai.LinearFilter,null!=U&&(U.map=m,U.needsUpdate)}function Ia(){l.setSize(Math.round(devicePixelRatio*Ct),Math.round(devicePixelRatio*xt),!1)}function Na(e){Zi(),Dt&&At||(At=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Oo("#error"),$("#error").one("click",(function(){Bo("#error")}))))}function La(e){if(/\(\s*\)/.test(e))return Na("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Na("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Na("A binary operator is missing an operand in "+e.trim()+"."),!1)}function qa(){let e;$("#views_list").empty();for(let t=0;t<N.views.length;t++)e=document.createElement("a"),e.onclick=function(){N.activeViewInd=t,Oa(N.views[t])},e.innerHTML="<div class='view_label'>"+N.views[t].name+"</div>",t==N.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);It=Math.max(N.views.length,It),N.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),N.views.length}function Oa(e,t){Object.assign(N,e),delete N.name,co(z),(null==t||t)&&(Vo(),sa(),Oi(),Ri(),zo(),jo(),Fr(),hr(),ji())}function Ba(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",N.views[N.activeViewInd].name);null!=e&&(N.views[N.activeViewInd].name=e,qa(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function ja(){N.views.length>1?(N.views.splice(N.activeViewInd,1),N.activeViewInd<1?N.activeViewInd=0:N.activeViewInd-=1):N.views[N.activeViewInd].name="Custom",Oa(N.views[N.activeViewInd])}function za(){let e={};return xi.forEach((function(t){e[t]=O[t]})),e}function Ga(e){N.activeViewInd<N.views.length&&(N.views[N.activeViewInd][e]=N[e])}function Ja(e,t){let n="";return n+=go(Dn(t),vi[e]),N.dimension>1&&(n+=go(An(t),vi[e])),n}function Ha(e,t){let n="";return n+=go($n(t),vi[e]),N.dimension>1&&(n+=go(_n(t),vi[e])),n}function Xa(e,t){let n="";return n+=go(Dn(t),vi[e]),N.dimension>1&&(n+=go(An(t),vi[e])),n}function Ya(e,t){let n="";return n+=go($n(t).replaceAll(/updated/g,"gl_FragColor"),vi[e]),N.dimension>1&&(n+=go(_n(t).replaceAll(/updated/g,"gl_FragColor"),vi[e])),n}function Za(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function Ka(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function er(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){N[s.getAttribute("property")]=!N[s.getAttribute("property")],vr(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),vr(s),s}function tr(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function nr(){let e=Fo(N,ei("default"));1==N.views.length&&"1"==N.views[0].name&&delete e.views;for(const e of Object.keys(N.views[0]))N.hasOwnProperty(e)&&N.views.map((t=>t[e])).every((t=>t==N[e]))&&N.views.forEach((t=>delete t[e]));e.preset="PRESETNAME";let t=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");t='case "PRESETNAME":\n\toptions = '+t+";\nbreak;",navigator.clipboard.writeText(t)}function ir(){let t="";t+=JSON.stringify(N),t+=JSON.stringify(L),t+=JSON.stringify({nXDisc:bt,nYDisc:vt,domainHeight:wt,domainWidth:St,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function or(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function ar(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function rr(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function lr(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function sr(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function ur(){let e=Fo(N,ei("default"));return e.preset="Custom",e=ci(e),[location.href.replace(location.search,""),"?options=",fi.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function cr(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function dr(e){const t=Gt[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function fr(){L.embossAmbient.value=N.embossAmbient,L.embossDiffuse.value=N.embossDiffuse,L.embossShiny.value=N.embossShiny,L.embossSmoothness.value=N.embossSmoothness,L.embossSpecular.value=N.embossSpecular,L.embossLightDir.value=new ai.Vector3(Math.sin(N.embossTheta)*Math.cos(N.embossPhi),Math.sin(N.embossTheta)*Math.sin(N.embossPhi),Math.cos(N.embossTheta))}function pr(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function hr(){for(const e of[..._t,...$t]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function mr(){L.contourColour.value=new ai.Color(N.contourColour),L.contourEpsilon.value=N.contourEpsilon,L.contourStep.value=1/(N.contourNum+1)}function gr(){L.overlayColour.value=new ai.Color(N.overlayColour),L.overlayEpsilon.value=N.overlayEpsilon}function br(){ut||ji()}function vr(e){N[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Sr(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function wr(){N.customSurface?b.vertexShader=Xn():b.vertexShader=Hn(),b.needsUpdate=!0}function yr(){"surface"==N.plotType?($("#customSurfaceToggle").show(),N.customSurface?(ho(ye),po(we)):(po(ye),ho(we))):($("#customSurfaceToggle").hide(),po(ye))}function Cr(){k=new ai.Group,a.add(k);const e=Math.max(bt,vt),t=Math.round(_a(3,window.width<629?20:32,N.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(bt/n),o=Math.floor(vt/n),r=Math.floor((bt-n*(i-1))/2),l=Math.floor((vt-n*(o-1))/2);let s,u,c,d,f,p;for(let e=0;e<o;e++){u=l+e*n,p=((u+.5)/vt-.5)*D.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,f=((c+.5)/bt-.5)*D.geometry.parameters.width,s=c+u*bt,d=xr([f,p,1],[0,0,0]),d.ind=s,k.add(d)}}function xr(e,t){const n=new ai.Group,i=new ai.Mesh(_,V);i.rotation.x=Math.PI/2;const o=new ai.Mesh(E,V);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=_.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(Bt),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Vr(){if(k)for(a.remove(k);k.children.length;)k.remove(k.children[0])}function Fr(){if(L.vectorField.value=N.vectorField,N.vectorField){if(Vr(),Cr(),Ur(),"relative"==N.arrowScale)try{k.customMax=Vi.evaluate(N.arrowLengthMax)}catch(e){Na("Unable to evaluate the maximum arrow length. Please check the definition."),k.customMax=1}}else Vr()}function Ur(){V.color=new ai.Color(N.arrowColour)}function $r(e){const t=ra(e,vi.concat(Si));return t&&Na("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}Ei&&so("GrayScott"),Wt=_i.has("story"),Wt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),at.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),jo(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),gt=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(qo()||Ei||N.forceTryClickingPopup)&&!N.suppressTryClickingPopup&&N.brushEnabled&&($("#top_message").html("<p>"+N.tryClickingText+"</p>"),Oo("#top_message"),setTimeout((()=>Bo("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Bo("#top_message")))),$("#settings").click((function(){or(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&lr(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&sr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&ar(),$("#views_ui").is(":visible")&&rr()),$("#left_ui").is(":visible")&&ya()})),$("#equations").click((function(){ar(),ya(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&or(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&rr()})),$("#pause").click((function(){Zi()})),$("#play").click((function(){Ki()})),$("#erase").click((function(){eo()})),$("#share").click((function(){sr(),$("#help_panel").is(":visible")&&lr()})),$("#help").click((function(){lr(),$("#share_panel").is(":visible")&&sr()})),$("#screenshot").click((function(){ln=!0,ji(),sr()})),$("#link").click((function(){q.copyConfigAsURL(),sr()})),$("#embed").click((function(){!function(){let e=ur();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}cr('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),sr()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){lr()})),$("#views").click((function(){rr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&or(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&ar()})),$(document).on("click","#add_view",(function(){!function(){let e=za();e.name=++It,N.views.push(e),N.activeViewInd=N.views.length-1,qa()}()})),Dt=!1,function e(){requestAnimationFrame(e),dt=ct,ct&&N.brushEnabled&&function(){!N.fixRandSeed&&N.brushValue.includes("RAND")&&So();A.material=v;for(let e=1;e<Ft.length;e++)L.textureSource.value=Ft[e].texture,l.setRenderTarget(Ft[e-1]),l.render(r,o);Ft.rotate(-1)}();if(ut){!ft||function(){A.material=S;for(let e=1;e<Ft.length;e++)L.textureSource.value=Ft[e].texture,l.setRenderTarget(Ft[e-1]),l.render(r,o);Ft.rotate(-1)}();for(let e=0;e<N.numTimestepsPerFrame;e++)Rt&&!N.fixRandSeed&&So(),Bi()}(dt||ut)&&ji()}();