let e,t,n,i,o,a,r,l,s,u,c,d,f,m,p,h,g,b,v,S,y,w,C,V,x,U,_,E,F,D,A,T,W,R,Q,P,k,I,N,L,M,O,q,B,j,G,z,J,H,X,Z,Y,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,me,pe,he,ge,be,ve,Se,ye,we,Ce,Ve,xe,Ue,$e,_e,Ee,Fe,De,Ae,Te,We,Re,Qe,Pe,ke,Ie,Ne,Le,Me,Oe,qe,Be,je,Ge,ze,Je,He,Xe,Ze,Ye,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,mt,pt,ht,gt,bt,vt,St,yt,wt,Ct,Vt,xt,Ut,$t,_t=[],Et={},Ft=new Set,Dt=!1,At=!1,Tt=!1,Wt=!1,Rt=!1,Qt=!1,Pt=0,kt=!1,It=!0,Nt=1,Lt={},Mt=[],Ot={},qt=0;const Bt=["u","v","w","q"],jt=["UFUN","VFUN","WFUN","QFUN"],Gt=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],zt=["REACT1","REACT2","REACT3","REACT4"];let Jt,Ht,Xt,Zt,Yt,Kt,en=!1,tn=!1;const nn=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as on,drawShaderBotReplace as an,drawShaderBotAdd as rn,drawShaderShapeDisc as ln,drawShaderShapeVLine as sn,drawShaderShapeHLine as un,drawShaderFactorSharp as cn,drawShaderFactorSmooth as dn}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as fn,computeDisplayFunShaderMid as mn,computeMaxSpeciesShaderMid as pn,postGenericShaderBot as hn,postShaderDomainIndicator as gn,interpolationShader as bn}from"./post_shaders.js";import{copyShader as vn}from"../copy_shader.js";import{RDShaderTop as Sn,RDShaderBot as yn,RDShaderDirichletX as wn,RDShaderDirichletY as Cn,RDShaderDirichletIndicatorFun as Vn,RDShaderRobinX as xn,RDShaderRobinY as Un,RDShaderUpdateNormal as $n,RDShaderUpdateCross as _n,RDShaderAlgebraicSpecies as En,RDShaderEnforceDirichletTop as Fn,RDShaderAdvectionPreBC as Dn,RDShaderAdvectionPostBC as An,RDShaderDiffusionPreBC as Tn,RDShaderDiffusionPostBC as Wn,RDShaderGhostX as Rn,RDShaderGhostY as Qn,RDShaderMain as Pn}from"./simulation_shaders.js";import{randShader as kn,randNShader as In}from"../rand_shader.js";import{fiveColourDisplayTop as Nn,fiveColourDisplayBot as Ln,embossShader as Mn,contourShader as On,surfaceVertexShaderColour as qn,surfaceVertexShaderCustom as Bn,overlayShader as jn}from"./display_shaders.js";import{getColours as Gn}from"../colourmaps.js";import{genericVertexShader as zn}from"../generic_shaders.js";import{getPreset as Jn,getUserTextFields as Hn,getFieldsInView as Xn}from"./presets.js";import{clearShaderBot as Zn,clearShaderTop as Yn}from"./clear_shader.js";import*as Kn from"../three.module.min.js";import{OrbitControls as ei}from"../OrbitControls.js";import{Line2 as ti}from"../lines/Line2.js";import{LineMaterial as ni}from"../lines/LineMaterial.js";import{LineGeometry as ii}from"../lines/LineGeometry.js";import{minifyPreset as oi,maxifyPreset as ai}from"./minify_preset.js";import{LZString as ri}from"../lz-string.min.js";import{equationTEXFun as li,getDefaultTeXLabelsDiffusion as si,getDefaultTeXLabelsReaction as ui,getDefaultTeXLabelsBCsICs as ci,substituteGreek as di}from"./TEX.js";let fi,mi,pi,hi=li(),gi={...si(),...ui(),...ci()};const bi=Xn();let vi=new exprEval.Parser;P={};const Si=Hn();var yi,wi;I={reset:function(){Ji()},toggleRunning:function(){dt?Gi():zi()},copyConfigAsURL:function(){nr(tr())},saveSimState:function(){$a()},exportSimState:function(){_a()},clearCheckpoints:function(){Qt&&(h.dispose(),h=null,Qt=!1)},restoreCurrentView:function(){var e;P.activeViewInd<P.views.length&&(e=P.activeViewInd,P.views[e]=bt[e],Qa(P.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(yi=Array.prototype.push,wi=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,yi.apply(this,wi.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Wt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Ta(t)},Po()||$("#logo").hide();const Ci=new URLSearchParams(window.location.search);if(Ci.has("no_ui")?($(".ui").addClass("hidden"),Rt=!0):$(".ui").removeClass("hidden"),Ci.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),Rt=!0),Ci.has("sf")&&(Nt=parseFloat(Ci.get("sf")),(isNaN(Nt)||Nt<=0)&&(Nt=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!Rt){$("#warning").css("display","block");await Promise.race([Ko(document.getElementById("warning_ok"),"click",!0),Ko(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}io("default"),function(){k={brushCoords:{type:"v2",value:new Kn.Vector2(.5,.5)},colour1:{type:"v4",value:new Kn.Vector4(0,0,0,0)},colour2:{type:"v4",value:new Kn.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new Kn.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new Kn.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new Kn.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0}},ft=!1,c=new Kn.Raycaster,d=new Kn.Vector2,l=new Kn.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),p={format:Kn.RGBAFormat,type:Kn.FloatType,minFilter:Kn.NearestFilter},n|=/android/i.test(navigator.userAgent),p.magFilter=n?Kn.NearestFilter:Kn.LinearFilter,_t.push(new Kn.WebGLRenderTarget(P.maxDisc,P.maxDisc,p)),_t.push(_t[0].clone()),_t.push(_t[0].clone()),_t.push(_t[0].clone()),_t.push(_t[0].clone()),f=_t[0].clone(),m=_t[0].clone(),_t.forEach((e=>{e.texture.wrapS=Kn.RepeatWrapping,e.texture.wrapT=Kn.RepeatWrapping})),f.texture.wrapS=Kn.ClampToEdgeWrapping,f.texture.wrapT=Kn.ClampToEdgeWrapping,m.texture.wrapS=Kn.ClampToEdgeWrapping,m.texture.wrapT=Kn.ClampToEdgeWrapping,i=new Kn.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new ei(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==P.plotType&&(P.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,P.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,P.cameraZoom=i.zoom,Na("cameraTheta"),Na("cameraPhi"),Na("cameraZoom"),oo(O),sr())})),o=new Kn.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new Kn.Scene,r=new Kn.Scene,a.add(i),a.background=new Kn.Color(P.backgroundColour),g=new Kn.MeshBasicMaterial({side:Kn.DoubleSide}),b=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn(),transparent:!0,side:Kn.DoubleSide}),C=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()}),x=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn(),fragmentShader:bn()}),v=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()}),Et.FE=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()}),Et.AB2=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()});for(let e=1;e<3;e++)Et["Mid"+e.toString()]=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()});for(let e=1;e<5;e++)Et["RK4"+e.toString()]=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()});w=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn(),fragmentShader:vn()}),y=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()}),S=new Kn.ShaderMaterial({uniforms:k,vertexShader:zn()}),V=new ni({vertexColors:!0,linewidth:.01}),U=new Kn.MeshBasicMaterial;const s=new Kn.PlaneGeometry(1,1);E=new Kn.Mesh(s,Et[0]),E.position.z=0,r.add(E),Di(),Ai(),_i(),Wi(),Ui(),Ri(),Vo(),Uo(),Pi(),Qi(),po(),Zo(),Ji(),e.addEventListener("pointerdown",Mi),e.addEventListener("pointerup",Oi),e.addEventListener("pointermove",qi),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(I.toggleRunning(),e.preventDefault()),"h"===e.key&&(Rt?(Rt=!1,$(".ui").removeClass("hidden"),st.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",vt),dt?zi():Gi(),Xo(),aa(),ma()):(Rt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&$a(),"c"==e.key&&(P.resetFromCheckpoints=!P.resetFromCheckpoints,ur($("#checkpointButton")[0])))})),window.addEventListener("resize",Ui,!1),window.addEventListener("message",ir),$("#checkpointInput").change((function(){Ea(this.files[0]),this.value=null}))}();let Vi=!0;if(Ci.has("preset")&&(no(Ci.get("preset")),Vi=!1),Ci.has("options")){var xi=JSON.parse(ri.decompressFromEncodedURIComponent(Ci.get("options")));xi.hasOwnProperty("p")&&(xi=ai(xi)),no(xi),Vi=!1}function Ui(){Di(),function(){E.material=w;for(let e=1;e<_t.length;e++)k.textureSource.value=_t[e].texture,_t[e-1].setSize(St,yt),l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1),_t[0].dispose(),_t[0]=_t[1].clone(),f.setSize(St,yt),Li(),m.setSize(Math.round(devicePixelRatio*xt),Math.round(devicePixelRatio*Ut))}(),Fa(h),Ei(),$i(),_i(),aa(),ma(),Ni()}function $i(){_.geometry.dispose(),a.remove(_),F.geometry.dispose(),a.remove(F),D.geometry.dispose(),a.remove(D),Ai()}function _i(){switch(Fi(),P.plotType){case"line":P.cameraTheta=0,P.cameraPhi=0,u.enabled=!1,i.zoom=1,oa(),b.vertexShader=qn();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=zn();break;case"surface":u.enabled=!0,i.zoom=P.cameraZoom,oa(),dr()}b.needsUpdate=!0,i.left=-wt/(2*Vt),i.right=wt/(2*Vt),i.top=Ct/(2*Vt),i.bottom=-Ct/(2*Vt),i.updateProjectionMatrix(),Ti()}function Ei(){k.L.value=P.domainScale,k.L_y.value=Ct,k.L_x.value=wt,k.L_min.value=Math.min(Ct,wt),k.dt.value=P.dt,k.dx.value=wt/St,k.dy.value=Ct/yt,k.heightScale.value=P.threeDHeightScale,k.maxColourValue.value=P.maxColourValue,k.minColourValue.value=P.minColourValue,k.customSurface.value=P.customSurface,or(),P.fixRandSeed||mo()}function Fi(){xt=Math.round(e.getBoundingClientRect().width),Ut=Math.round(e.getBoundingClientRect().height),s=Ut/xt,s<=0&&(s=.1),s>=1?(Ct=P.domainScale,wt=Ct/s):(wt=P.domainScale,Ct=wt*s),1==P.dimension&&(wt=P.domainScale),k.L_x.value=wt,k.L_y.value=Ct,Vt=Math.max(wt,Ct)}function Di(){Fi(),0==P.spatialStep&&(alert("Oops! A spatial step of 0 would almost certainly crash your device. We've reset it to 1% of the maximum domain length to prevent this."),P.spatialStep=P.domainScale/100),St=Math.floor(wt/P.spatialStep),yt=Math.floor(Ct/P.spatialStep),0==St&&(St=1),0==yt&&(yt=1),1==P.dimension&&(yt=1),k.nXDisc.value=St,k.nYDisc.value=yt,A=new Array(St),T=new Array(St);let e=-.5,t=1/St;for(let n=0;n<A.length;n++)A[n]=e,e+=t;Aa(),Yt=new Float32Array(St*yt*4),tn=!1}function Ai(){Fi();let e=[1,1];It||(e=[St,yt]);const t=new Kn.PlaneGeometry(wt/Vt,Ct/Vt,e[0],e[1]);_=new Kn.Mesh(t,b),_.position.z=0,_.visible="line"!=P.plotType,_.matrixAutoUpdate=!1,a.add(_);const n=new Kn.PlaneGeometry(wt/Vt,Ct/Vt,1,1);F=new Kn.Mesh(n,g),F.position.z=0,F.visible=!1,F.matrixAutoUpdate=!1,a.add(F),Ti();const i=new ii;W=Math.round(devicePixelRatio*xt);const o=new Array(3*W).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),D=new ti(i,V),D.scale.set(1,1,1),D.visible="line"==P.plotType,a.add(D)}function Ti(){switch(P.plotType){case"plane":_.rotation.x=0,F.rotation.x=0;break;case"surface":_.rotation.x=-Math.PI/2,F.rotation.x=-Math.PI/2}_.updateMatrix(),F.updateMatrix()}function Wi(){P.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Ri(e){L=new dat.GUI({closeOnTop:!0,autoPlace:!1}),L.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(L.domElement),M=new dat.GUI({closeOnTop:!0,autoPlace:!1}),M.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(M.domElement),O=new dat.GUI({closeOnTop:!0,autoPlace:!1}),O.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(O.domElement),L.open(),M.open(),O.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),q=M.addFolder("Brush");Ga(Ba(q),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',null,null,"Toggle the brush on or off"),q.add(P,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(Pi),B=q.add(P,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Pi),q.add(P,"brushValue").name("Value").onFinishChange(Pi),q.add(P,"brushRadius").name("Radius").onChange(Pi),pe=q.add(P,"whatToDraw",fi).name("Species").onChange(Pi),q=M.addFolder("Domain"),q.add(P,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){ia(),sr()})),q.add(P,"domainScale").name("Largest side").onChange(Ui);const t=q.add(P,"spatialStep").name("Space step").onChange((function(){Ui()}));t.__precision=12,t.min(0),t.updateDisplay();const n=Ba(q);Ga(n,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Wi(),Ui(),_i()}),null,"Use a square domain"),Ga(n,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Implicit',(function(){xo(),Vo(),Ki(),wo()}),null,"Determine the domain implicitly"),X=q.add(P,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){xo(),Vo(),Ki(),vo()})),q=M.addFolder("Timestepping"),et=q.add(P,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),ar(et,1,400,1),me=q.add(P,"dt").name("Timestep").onChange((function(){Ei()})),me.__precision=12,me.min(0),me.updateDisplay(),q.add(P,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme");Ga(Ba(q),"timeDisplay",'<i class="fa-regular fa-stopwatch"></i> Elapsed time',qo,null,"Show/hide time display"),q=M.addFolder("Equations"),q.add(P,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(Uo),H=q.add(P,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){kt=!0,Uo(),kt=!1})),q.add(P,"speciesNames").name("Species names").onFinishChange((function(){ba()})),q.add(P,"reactionNames").name("Reactions").onFinishChange((function(){ba()}));Ga(Ba(q),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',Uo,"cross_diffusion_controller","Toggle cross diffusion"),q=L.addFolder("Definitions");Ga(Ba(q),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',$o,null,"Typeset the specified equations"),Z=q.add(P,"diffusionStrUU").onFinishChange((function(){Ki(),$o()})),Ca(Z,xa,["D","U","UU"]),Va(Z,Ua,["D","U","UU"]),Y=q.add(P,"diffusionStrUV").onFinishChange((function(){Ki(),$o()})),Ca(Y,xa,["UV"]),Va(Y,Ua,["UV"]),K=q.add(P,"diffusionStrUW").onFinishChange((function(){Ki(),$o()})),Ca(K,xa,["UW"]),Va(K,Ua,["UW"]),ee=q.add(P,"diffusionStrUQ").onFinishChange((function(){Ki(),$o()})),Ca(ee,xa,["UQ"]),Va(ee,Ua,["UQ"]),te=q.add(P,"diffusionStrVU").onFinishChange((function(){Ki(),$o()})),Ca(te,xa,["VU"]),Va(te,Ua,["VU"]),ne=q.add(P,"diffusionStrVV").onFinishChange((function(){Ki(),$o()})),Ca(ne,xa,["V","VV"]),Va(ne,Ua,["V","VV"]),ie=q.add(P,"diffusionStrVW").onFinishChange((function(){Ki(),$o()})),Ca(ie,xa,["VW"]),Va(ie,Ua,["VW"]),oe=q.add(P,"diffusionStrVQ").onFinishChange((function(){Ki(),$o()})),Ca(oe,xa,["VQ"]),Va(oe,Ua,["VQ"]),ae=q.add(P,"diffusionStrWU").onFinishChange((function(){Ki(),$o()})),Ca(ae,xa,["WU"]),Va(ae,Ua,["WU"]),re=q.add(P,"diffusionStrWV").onFinishChange((function(){Ki(),$o()})),Ca(re,xa,["WV"]),Va(re,Ua,["WV"]),le=q.add(P,"diffusionStrWW").onFinishChange((function(){Ki(),$o()})),Ca(le,xa,["W","WW"]),Va(le,Ua,["W","WW"]),se=q.add(P,"diffusionStrWQ").onFinishChange((function(){Ki(),$o()})),Ca(se,xa,["WQ"]),Va(se,Ua,["WQ"]),ue=q.add(P,"diffusionStrQU").onFinishChange((function(){Ki(),$o()})),Ca(ue,xa,["QU"]),Va(ue,Ua,["QU"]),ce=q.add(P,"diffusionStrQV").onFinishChange((function(){Ki(),$o()})),Ca(ce,xa,["QV"]),Va(ce,Ua,["QV"]),de=q.add(P,"diffusionStrQW").onFinishChange((function(){Ki(),$o()})),Ca(de,xa,["QW"]),Va(de,Ua,["QW"]),fe=q.add(P,"diffusionStrQQ").onFinishChange((function(){Ki(),$o()})),Ca(fe,xa,["Q","QQ"]),Va(fe,Ua,["Q","QQ"]),j=q.add(P,"reactionStrU").onFinishChange((function(){Ki(),$o()})),Ca(j,xa,["UFUN"]),Va(j,Ua,["UFUN"]),G=q.add(P,"reactionStrV").onFinishChange((function(){Ki(),$o()})),Ca(G,xa,["VFUN"]),Va(G,Ua,["VFUN"]),z=q.add(P,"reactionStrW").onFinishChange((function(){Ki(),$o()})),Ca(z,xa,["WFUN"]),Va(z,Ua,["WFUN"]),J=q.add(P,"reactionStrQ").onFinishChange((function(){Ki(),$o()})),Ca(J,xa,["QFUN"]),Va(J,Ua,["QFUN"]),$t=L.addFolder("Parameters"),function(){let e,t,n=P.kineticParams.split(";");for(var i=0;i<n.length;i++)t=Wo(n[i]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+qt,qt+=1,Mt.push(e),Lt[e]=t,Ro(e,!1));e="param"+qt,Mt.push(e),Lt[e]=t,Ro(e,!0)}(),q=L.addFolder("Boundary conditions"),Ie=q.add(P,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),Oe=q.add(P,"dirichletStrU").onFinishChange(Ki),Xe=q.add(P,"neumannStrU").onFinishChange(Ki),tt=q.add(P,"robinStrU").onFinishChange(Ki),Ge=q.add(P,"comboStrU").name("Details").onFinishChange(Ki),Ne=q.add(P,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),qe=q.add(P,"dirichletStrV").onFinishChange(Ki),Ze=q.add(P,"neumannStrV").onFinishChange(Ki),nt=q.add(P,"robinStrV").onFinishChange(Ki),ze=q.add(P,"comboStrV").name("Details").onFinishChange(Ki),Le=q.add(P,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){Ki(),fo()})),Be=q.add(P,"dirichletStrW").onFinishChange(Ki),Ye=q.add(P,"neumannStrW").onFinishChange(Ki),it=q.add(P,"robinStrW").onFinishChange(Ki),Je=q.add(P,"comboStrW").name("Details").onFinishChange(Ki),Me=q.add(P,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){Ki(),fo()})),je=q.add(P,"dirichletStrQ").onFinishChange(Ki),Ke=q.add(P,"neumannStrQ").onFinishChange(Ki),ot=q.add(P,"robinStrQ").onFinishChange(Ki),He=q.add(P,"comboStrQ").name("Details").onFinishChange(Ki),q=L.addFolder("Initial conditions"),Re=q.add(P,"clearValueU").onFinishChange(po),Qe=q.add(P,"clearValueV").onFinishChange(po),Pe=q.add(P,"clearValueW").onFinishChange(po),ke=q.add(P,"clearValueQ").onFinishChange(po),at=M.addFolder("Images"),q=at,bo(),q=M.addFolder("Checkpoints");const i=Ba(q);Ga(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),za(i),ja(i,'<i class="fa-regular fa-flag"></i> Set',$a,null,"Set a checkpoint at the current state",["narrow"]),ja(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',_a,null,"Download the last checkpoint as a file",["narrow"]),ja(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),q.add(P,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize"),q=M.addFolder("Misc."),q.addColor(P,"backgroundColour").name("Background").onChange((function(){a.background=new Kn.Color(P.backgroundColour),sr()}));const o=Ba(q);Ga(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){jo(),sr()}),null,"Compute the integral of the plotted expression over the domain"),Ga(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',Zo,"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),Ga(o,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',null,null,"Fix the random seed"),ja(o,'<i class="fa-regular fa-copy"></i> Copy code',Ja,null,"Copy the simulation configuration as JSON"),q=q.addFolder("Debug");ja(Ba(q),"Copy debug information",Ha);const r=document.createElement("div");r.innerHTML="Settings",r.classList.add("ui_title"),M.domElement.prepend(r);const l=document.createElement("div");l.innerHTML="Equations",l.classList.add("ui_title"),L.domElement.prepend(l);const s=document.createElement("div");s.id="views_list",O.domElement.prepend(s);const u=document.createElement("div");u.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",u.classList.add("ui_title"),O.domElement.prepend(u),st=O.addFolder("Edit view"),q=st;const c=Ba(q,"edit_view_buttons");ja(c,'<i class="fa-solid fa-pen-nib"></i> Rename',Pa,null,"Rename the current view"),ja(c,'<i class="fa-solid fa-xmark"></i> Delete',ka,"deleteViewButton","Delete view"),ct=q.add(P,"whatToPlot").name("Expression: ").onFinishChange((function(){vo(),sr(),Na(this.property)})),q.add(P,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){na(),document.activeElement.blur(),sr(),Na(this.property)})),q.add(P,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){ki(),No(),Na(this.property)})).name("Colour map"),Ve=q.add(P,"minColourValue").name("Min value").onChange((function(){Ei(),Lo(),sr(),Na(this.property)})),Ve.__precision=2,xe=q.add(P,"maxColourValue").name("Max value").onChange((function(){Ei(),Lo(),sr(),Na(this.property)})),xe.__precision=2;const d=Ba(q,"colour_map_buttons");ja(d,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Flip',(function(){P.flippedColourmap=!P.flippedColourmap,ki(),No(),Na("flippedColourmap")}),null,"Reverse colour map",["narrow"]),ja(d,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){ha(),Ni(),Na("minColourValue"),Na("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),Ga(d,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){No()}),null,"Display the colourbar",null,["narrow"]),za(d),Ga(d,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){P.autoSetColourRange&&(ha(),Ni()),Na("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),Ga(d,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){ki(),Na("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),Ga(d,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){ki(),Na("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),Ga(d,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){ki(),Na("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),q=st.addFolder("Contours"),q.domElement.id="contoursFolder",q.addColor(P,"contourColour").name("Colour").onChange((function(){rr(),sr()})),Ce=q.add(P,"contourNum").name("Number").onChange((function(){rr(),sr()})),ar(Ce,1,20,1),we=q.add(P,"contourEpsilon").name("Threshold").onChange((function(){rr(),sr()})),ar(we,.001,.05,.001),q=st.addFolder("Lighting"),q.domElement.id="embossFolder",Ee=q.add(P,"embossSmoothness").name("Smoothness").onChange((function(){or(),sr()})),ar(Ee,0,2,.001),Fe=q.add(P,"embossAmbient").name("Ambient").onChange((function(){or(),sr()})),ar(Fe,0,1,.001),De=q.add(P,"embossDiffuse").name("Diffuse").onChange((function(){or(),sr()})),ar(De,0,1,.001),Ae=q.add(P,"embossSpecular").name("Specular").onChange((function(){or(),sr()})),ar(Ae,0,1,.001),_e=q.add(P,"embossShiny").name("Precision").onChange((function(){or(),sr()})),ar(_e,0,100,1),Te=q.add(P,"embossTheta").name("Inclination").onChange((function(){or(),sr()})),ar(Te,0,1.5708,.001),We=q.add(P,"embossPhi").name("Direction").onChange((function(){or(),sr()})),ar(We,0,3.1456,.001),q=st.addFolder("Overlay"),q.domElement.id="overlayFolder",q.addColor(P,"overlayColour").name("Colour").onChange((function(){lr(),sr()})),q.add(P,"overlayExpr").name("Expression").onFinishChange((function(){ki(),Na(this.property)})),q.add(P,"overlayEpsilon").name("Threshold").onChange((function(){lr(),sr()})),ut=st.addFolder("3D"),q=ut;Ga(Ba(q),"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){k.customSurface.value=P.customSurface,dr(),fr(),Na("customSurface"),sr()}),"customSurfaceToggle","Plot the solution on a custom surface"),be=q.add(P,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){vo(),sr(),Na(this.property)})),ge=q.add(P,"threeDHeightScale").name("Max height").onChange(Ei),ve=q.add(P,"cameraTheta").name("View $\\theta$").onChange(_i),Se=q.add(P,"cameraPhi").name("View $\\phi$").onChange(_i),ye=q.add(P,"cameraZoom").name("Zoom").onChange(_i),he=q.add(P,"lineWidthMul",.1,2).name("Thickness").onChange((function(){wa(),Ni()}));document.querySelectorAll("input").forEach((e=>cr(e)))}function Qi(){ki(),No(),vo(),Pi()}function Pi(){let e=ua()+on(),t="float brushRadius = "+Zi(P.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(P.brushValue)&&(e+=kn()),/\bRANDN\b/.test(P.brushValue)&&(e+=In()),e+="float brushValue = "+Zi(P.brushValue)+";\n",e+=t,P.typeOfBrush){case"circle":e+=ln();break;case"hline":e+=un();break;case"vline":e+=sn()}switch(P.brushAction){case"replace":e+=cn(),e+=an();break;case"add":e+=cn(),e+=rn();break;case"smoothreplace":e+=dn(),e+=an();break;case"smoothadd":e+=dn(),e+=rn()}e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,co(P.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function ki(){R=Gn(P.colourmap),P.flippedColourmap&&(R.reverse(),R=R.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),k.colour1.value=new Kn.Vector4(...R[0]),k.colour2.value=new Kn.Vector4(...R[1]),k.colour3.value=new Kn.Vector4(...R[2]),k.colour4.value=new Kn.Vector4(...R[3]),k.colour5.value=new Kn.Vector4(...R[4]);let e=ua()+Nn();P.emboss&&(e+=Mn(),or()),P.contours&&(e+=On(),rr()),P.overlay&&(e+=jn().replaceAll("OVERLAYEXPR",Zi(P.overlayExpr)),lr()),e+=Ln(),b.fragmentShader=e,b.needsUpdate=!0,C.needsUpdate=!0,Q=R.map((e=>e[3])),R=R.map((e=>e.slice(0,-1))),Ni()}function Ii(){switch(P.timesteppingScheme){case"Euler":E.material=Et.FE,k.textureSource.value=_t[1].texture,k.textureSource1.value=_t[2].texture,k.dt.value=P.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),k.t.value+=P.dt;break;case"AB2":E.material=Et.AB2,k.textureSource.value=_t[1].texture,k.textureSource1.value=_t[2].texture,k.dt.value=P.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),k.t.value+=P.dt;break;case"Mid":E.material=Et.Mid1,k.textureSource.value=_t[1].texture,l.setRenderTarget(_t[2]),l.render(r,o),E.material=Et.Mid2,k.textureSource1.value=_t[2].texture,k.t.value+=.5*P.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1),k.t.value+=.5*P.dt;break;case"RK4":E.material=Et.RK41,k.textureSource.value=_t[1].texture,l.setRenderTarget(_t[2]),l.render(r,o),E.material=Et.RK42,k.textureSource1.value=_t[2].texture,k.t.value+=.5*P.dt,l.setRenderTarget(_t[3]),l.render(r,o),E.material=Et.RK43,k.textureSource2.value=_t[3].texture,l.setRenderTarget(_t[4]),l.render(r,o),E.material=Et.RK44,k.textureSource3.value=_t[4].texture,k.t.value+=.5*P.dt,l.setRenderTarget(_t[0]),l.render(r,o),_t.rotate(-1)}}function Ni(){if(P.autoSetColourRange&&ha(),P.brushEnabled&&"surface"==P.plotType){let e=0;P.maxColourValue-P.minColourValue>0&&(e=(function(){Ho();let e=0;for(let t=0;t<Yt.length;t+=4)e+=Yt[t];return e/(St*yt)}()-P.minColourValue)/(P.maxColourValue-P.minColourValue)-.5,e=e.clamp(-.5,.5)),F.position.y=P.threeDHeightScale*e,F.updateWorldMatrix()}if(Li(),"line"==P.plotType){Ho();let t,n=0;var e=P.maxColourValue-P.minColourValue;e=0==e?.5:e;for(let i=0;i<Yt.length;i+=4)t=(Yt[i]-P.minColourValue)/e-.5,T[n++]=t.clamp(-.5,.5);const i=new Kn.SplineCurve(A.map(((e,t)=>new Kn.Vector2(e,T[t])))),o=i.getSpacedPoints(W);!function(e){let t,n=D.geometry.attributes.instanceStart,i=D.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)t=e[o].toArray(),t[1]*=P.threeDHeightScale,o<e.length&&n.setXYZ(o,t[0],t[1],0),o>0&&i.setXYZ(o-1,t[0],t[1],0);n.needsUpdate=!0,i.needsUpdate=!0}(o),function(e){let t,n=D.geometry.attributes.instanceColorStart,i=D.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)t=Sa(e[o].toArray()[1]+.5),o<e.length&&n.setXYZ(o,t[0],t[1],t[2]),o>0&&i.setXYZ(o-1,t[0],t[1],t[2]);n.needsUpdate=!0}(o)}if(P.timeDisplay&&Bo(),P.integrate&&function(){if(P.integrate){let e;Ho(),1==P.dimension?e=k.dx.value:2==P.dimension&&(e=k.dx.value*k.dy.value);let t=0;for(let e=0;e<Yt.length;e+=4)t+=Yt[e];t*=e,$("#integralValue").html(Mo(t,4)),Xo()}}(),Yo()?(E.material=x,l.setRenderTarget(m),l.render(r,o),k.textureSource.value=m.texture,k.dxUpscaledScale.value=devicePixelRatio*xt/St,k.dyUpscaledScale.value=devicePixelRatio*Ut/yt):(k.dxUpscaledScale.value=1,k.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),en){en=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Di(),Ni()}}function Li(){E.material=C,k.textureSource.value=_t[1].texture,l.setRenderTarget(f),l.render(r,o),k.textureSource.value=f.texture,tn=!1,k.textureSource1.value=_t[1].texture}function Mi(t){ft=Bi(t,e),ft&&(P.brushEnabled&&"surface"==P.plotType?u.enabled=!1:P.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),ko("#top_message"),window.clearTimeout(gt),gt=setTimeout((function(){$("#top_message").hasClass("fading_out")||Io("#top_message")}),3e3)))}function Oi(e){ft=!1,"surface"==P.plotType&&(u.enabled=!0)}function qi(t){Bi(t,e)}function Bi(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==P.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(F,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==P.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*St)/St,a=Math.round(a*yt)/yt,k.brushCoords.value=new Kn.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function ji(){l.setSize(St,yt,!1),P.fixRandSeed||mo(),Qt&&P.resetFromCheckpoints?E.material=U:E.material=y,_t.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Aa(),Ni()}function Gi(){Rt||($("#pause").hide(),$("#play").show()),dt=!1}function zi(){Rt||($("#play").hide(),$("#pause").show()),dt=!0}function Ji(){ji(),k.t.value=0,Bo(),Ni(),window.clearTimeout(ht),Jo()}function Hi(){let e="";return e+="float UFUN = "+Zi(P.reactionStrU)+";\n",e+="float VFUN = "+Zi(P.reactionStrV)+";\n",e+="float WFUN = "+Zi(P.reactionStrW)+";\n",e+="float QFUN = "+Zi(P.reactionStrQ)+";\n",e}function Xi(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function Zi(e){if(!Wa(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])\b/g);let i,o,a,r,l,s,u,c,d,f,m,p,h=0;const g={S:"One",T:"Two"},b={R:"x",G:"y",B:"z",A:"w"};for(const v of n){for(i=v.index,m=g[v[1]],p=b[v[2]],o=i+v[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+h+1,a+h),l=fa(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+")/L_x",s[1]="("+s[1]+")/L_y",f="texture(imageSource"+m+",vec2("+s.join(",")+"))."+p,t=Ao(t,f,i+h,a+1+h),h+=f.length-a+i-1)}return t}(e=fa(e=(e=(e=(e=Yi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){switch(n){case"0":return"1";case"1":return"("+t+")";case"2":return"(("+t+")*("+t+"))";case"3":return"(("+t+")*("+t+")*("+t+"))";case"4":return"(("+t+")*("+t+")*("+t+")*("+t+"))";case"5":return"(("+t+")*("+t+")*("+t+")*("+t+")*("+t+"))";default:return"safepow("+t+","+n+")"}}))).replaceAll(RegExp("\\b("+pi[0]+")\\b","g"),(function(e,t){return"uvwq."+co(t)}))).replaceAll(RegExp("\\b("+pi[0]+")_([xy])\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+co(t)}))).replaceAll(RegExp("\\b("+pi[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+co(t)}))));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function Yi(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function Ki(){let e="",t="",n="",i="",o="",a="";const r=[P.boundaryConditionsU,P.boundaryConditionsV,P.boundaryConditionsW,P.boundaryConditionsQ],l=[P.neumannStrU,P.neumannStrV,P.neumannStrW,P.neumannStrQ],s=[P.comboStrU,P.comboStrV,P.comboStrW,P.comboStrQ].map((e=>e+";")),u=[P.dirichletStrU,P.dirichletStrV,P.dirichletStrW,P.dirichletStrQ],c=[P.robinStrU,P.robinStrV,P.robinStrW,P.robinStrQ];if(r.forEach((function(t,n){"neumann"==t?(e+=eo(l[n],fi[n]),e+=La(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=eo(t[2],fi[n],i),e+=La(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=uo(Rn(t),fi[e]),P.dimension>1&&(i+=uo(Qn(t),fi[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,Zi(e[2]))}))})),P.domainViaIndicatorFun){let e=Vn().replace(/indicatorFun/g,Zi(P.domainIndicatorFun));u.forEach((function(t,i){n+=uo(e,fi[i])+Zi(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=to(u[t],fi[t]),n+=Ma(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=to(e[2],fi[t],i),n+=Ma(t,i)}))}));r.forEach((function(e,t){"robin"==e?(i+=eo(c[t],fi[t]),i+=Oa(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=eo(e[2],fi[t],n),i+=Oa(t,n)}))}));let d=ua();if(o=function(){let e="";return e+=Xi(Zi(P.diffusionStrUU)+";\n","uu"),e+=Xi(Zi(P.diffusionStrVV)+";\n","vv"),e+=Xi(Zi(P.diffusionStrWW)+";\n","ww"),e+=Xi(Zi(P.diffusionStrQQ)+";\n","qq"),e}()+"\n",P.crossDiffusion?o+=function(){let e="";return e+=Xi(Zi(P.diffusionStrUV)+";\n","uv"),e+=Xi(Zi(P.diffusionStrUW)+";\n","uw"),e+=Xi(Zi(P.diffusionStrUQ)+";\n","uq"),e+=Xi(Zi(P.diffusionStrVU)+";\n","vu"),e+=Xi(Zi(P.diffusionStrVW)+";\n","vw"),e+=Xi(Zi(P.diffusionStrVQ)+";\n","vq"),e+=Xi(Zi(P.diffusionStrWU)+";\n","wu"),e+=Xi(Zi(P.diffusionStrWV)+";\n","wv"),e+=Xi(Zi(P.diffusionStrWQ)+";\n","wq"),e+=Xi(Zi(P.diffusionStrQU)+";\n","qu"),e+=Xi(Zi(P.diffusionStrQV)+";\n","qv"),e+=Xi(Zi(P.diffusionStrQW)+";\n","qw"),e}()+"\n"+_n():o+=$n(),Ht&&P.crossDiffusion&&(a+=uo(En(),fi[1])),Xt&&P.crossDiffusion&&(a+=uo(En(),fi[2])),Zt&&P.crossDiffusion&&(a+=uo(En(),fi[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void alert("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[Dn(),Tn(),e,t,i,An(),Wn(),Hi(),o].join(" "),m=/\bRAND\b/.test(f),p=/\bRANDN\b/.test(f);m&&(f=kn()+f),p&&(f=In()+f),At=m||p;let h=[n,a,yn()].join(" "),g="FE";Et[g].fragmentShader=[d,Sn(g),f,Pn(g),h].join(" "),g="AB2",Et[g].fragmentShader=[d,Sn(g),f,Pn(g),h].join(" "),g="Mid";for(let e=1;e<3;e++)Et[g+e.toString()].fragmentShader=[d,Sn(g+e.toString()),f,Pn(g+e.toString()),h].join(" ");g="RK4";for(let e=1;e<5;e++)Et[g+e.toString()].fragmentShader=[d,Sn(g+e.toString()),f,Pn(g+e.toString()),h].join(" ");if(Object.keys(Et).forEach((e=>Et[e].needsUpdate=!0)),pt=P.domainViaIndicatorFun||"dirichlet"==P.boundaryConditionsU||"dirichlet"==P.boundaryConditionsV||"dirichlet"==P.boundaryConditionsW||"dirichlet"==P.boundaryConditionsQ||/Dirichlet/.test(P.comboStrU)||/Dirichlet/.test(P.comboStrV)||/Dirichlet/.test(P.comboStrW)||/Dirichlet/.test(P.comboStrQ),pt){if(n=d+Fn(),P.domainViaIndicatorFun){let e=Vn().replace(/indicatorFun/g,Zi(P.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(t,i){n+=uo(e,fi[i])+Zi(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=to(u[t],fi[t]),n+=qa(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=to(e[2],fi[t],i),n+=qa(t,i)}))}));n+="}",S.fragmentShader=n,S.needsUpdate=!0}}function eo(e,t,n){return null==n?["L","R","T","B"].map((n=>eo(e,t,n))).join(""):"float robinRHS"+t+n+" = "+Zi(e)+";\n"}function to(e,t,n){return null==n?["L","R","T","B"].map((n=>to(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+Zi(e)+";\n"}function no(e){io("default"),io(e),null!=P.threeD&&(P.threeD&&(P.dimension=2,P.plotType="surface"),delete P.threeD),null!=P.oneDimensional&&(P.oneDimensional&&(P.dimension=1,P.plotType="line"),delete P.oneDimensional),P.domainScale*=Nt,function(){if(0==P.views.length){let e=Ia();e.name="1",P.views.push(e)}else P.views=P.views.map((function(e){let t=Ia();return Object.assign(t,e),t}));bt=P.views}(),ao(L,!0),ao(M,!0),ao(O,!0),Ri(),P.activeViewInd<P.views.length?Qa(P.views[P.activeViewInd],!1):Qa({},!0),Uo(),Wi(),Ui(),Ei(),a.background=new Kn.Color(P.backgroundColour),""!=P.initialState?fetch(P.initialState).then((e=>e.blob())).then((e=>Ea(e))):Ji(),_i(),rt.remove(),lt.remove(),bo(),Zo()}function io(e){let t;if(t=null==e?Jn(P.preset):"string"==typeof e?Jn(e):"object"==typeof e?e:Jn("default"),t.hasOwnProperty("parent")&&null!=t.parent&&io(t.parent),qt=0,Mt=[],Lt={},Object.assign(P,t),ba(!0),dt=P.runningOnLoad,dt?zi():Gi(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?P.tryClickingText=P.tryClickingText.replaceAll("clicking","tapping"):P.tryClickingText=P.tryClickingText.replaceAll("tapping","clicking"),P.brushRadius=P.brushRadius.toString(),P.hasOwnProperty("drawIn3D")&&(P.brushEnabled=P.drawIn3D),fi.includes("T")||Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=va(P[e],["T"],["I_T"],"[RGBA]"))})),!fi.includes("S")){Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=va(P[e],["S"],["I_S"],"[RGBA]"))}));var n=0;n+=P.hasOwnProperty("algebraicV"),n+=P.hasOwnProperty("algebraicW"),(n+=P.hasOwnProperty("algebraicQ"))&&!P.numAlgebraicSpecies&&(P.numAlgebraicSpecies=n),delete P.algebraicV,delete P.algebraicW,delete P.algebraicQ,null==P.minColourValue&&(P.minColourValue=0),null==P.maxColourValue&&(P.maxColourValue=1),N=P}let i=[P.clearValueU,P.clearValueV,P.clearValueW,P.clearValueQ,P.domainIndicatorFun,P.reactionStrU,P.reactionStrV,P.reactionStrW,P.reactionStrQ,P.diffusionStrUU,P.diffusionStrUV,P.diffusionStrUW,P.diffusionStrUQ,P.diffusionStrVU,P.diffusionStrVV,P.diffusionStrVW,P.diffusionStrVQ,P.diffusionStrWU,P.diffusionStrWV,P.diffusionStrWW,P.diffusionStrWQ,P.diffusionStrQU,P.diffusionStrQV,P.diffusionStrQW,P.diffusionStrQQ,P.dirichletStrU,P.dirichletStrV,P.dirichletStrW,P.dirichletStrQ,P.robinStrU,P.robinStrV,P.robinStrW,P.robinStrQ,P.comboStrU,P.comboStrV,P.comboStrW,P.comboStrQ,P.neumannStrU,P.neumannStrV,P.neumannStrW,P.neumannStrQ,P.brushValue,P.whatToPlot].join(" ");P.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function oo(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)oo(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function ao(e,t){if(null!=e){for(let t in e.__folders)ao(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function ro(e){null!=e&&(e.__li.style.display="none")}function lo(e){null!=e&&(e.__li.style.display="")}function so(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function uo(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=co(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function co(e){return"rgba"[function(e){return fi.indexOf(e)}(e)]}function fo(){"dirichlet"==P.boundaryConditionsU?lo(Oe):ro(Oe),"dirichlet"==P.boundaryConditionsV?lo(qe):ro(qe),"dirichlet"==P.boundaryConditionsW?lo(Be):ro(Be),"dirichlet"==P.boundaryConditionsQ?lo(je):ro(je),"neumann"==P.boundaryConditionsU?lo(Xe):ro(Xe),"neumann"==P.boundaryConditionsV?lo(Ze):ro(Ze),"neumann"==P.boundaryConditionsW?lo(Ye):ro(Ye),"neumann"==P.boundaryConditionsQ?lo(Ke):ro(Ke),"robin"==P.boundaryConditionsU?lo(tt):ro(tt),"robin"==P.boundaryConditionsV?lo(nt):ro(nt),"robin"==P.boundaryConditionsW?lo(it):ro(it),"robin"==P.boundaryConditionsQ?lo(ot):ro(ot),"combo"==P.boundaryConditionsU?lo(Ge):ro(Ge),"combo"==P.boundaryConditionsV?lo(ze):ro(ze),"combo"==P.boundaryConditionsW?lo(Je):ro(Je),"combo"==P.boundaryConditionsQ?lo(He):ro(He),P.domainViaIndicatorFun?(ro(Ie),ro(Ne),ro(Le),ro(Me)):lo(Ie)}function mo(){k.seed.value=performance.now()%1e6/1e6}function po(){let e=ua()+Yn(),t=[P.clearValueU,P.clearValueV,P.clearValueW,P.clearValueQ].join(" ");/\bRAND\b/.test(t)&&(e+=kn()),/\bRANDN\b/.test(t)&&(e+=In()),e+="float u = "+Zi(P.clearValueU)+";\n",e+="float v = "+Zi(P.clearValueV)+";\n",e+="float w = "+Zi(P.clearValueW)+";\n",e+="float q = "+Zi(P.clearValueQ)+";\n",e+=Zn(),y.fragmentShader=e,y.needsUpdate=!0}function ho(){let e=new Image;e.src=rt.__image.src;let t=new Kn.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,k.imageSourceOne.value=t,P.resetOnImageLoad&&Ji()}}function go(){let e=new Image;e.src=lt.__image.src;let t=new Kn.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,k.imageSourceTwo.value=t,P.resetOnImageLoad&&Ji()},t.dispose()}function bo(){q=at,rt=q.addImage(P,"imagePathOne").name("$I_S(x,y)$").onChange(ho),lt=q.addImage(P,"imagePathTwo").name("$I_T(x,y)$").onChange(go),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function vo(){"MAX"==P.whatToPlot?(C.fragmentShader=pn()+gn().replace(/indicatorFun/g,Zi(P.domainIndicatorFun))+hn(),C.needsUpdate=!0,P.minColourValue=0,P.maxColourValue=1,Ei(),ro(Ve),ro(xe),ro(Ue),ro($e),P.autoSetColourRange=!1,oo(M)):(wo(),lo(Ve),lo(xe),lo(Ue),lo($e)),No(),jo(),Ni()}function So(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function yo(){Ho();let e=1/0,t=-1/0;for(let n=0;n<Yt.length;n+=4)e=Math.min(e,Yt[n]),t=Math.max(t,Yt[n]);return[e,t]}function wo(){let e=ua()+fn();e+=mn(),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,Zi(P.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,Zi(P.surfaceFun))}(e),P.domainViaIndicatorFun&&(e+=gn().replace(/indicatorFun/g,Zi(P.domainIndicatorFun))),C.fragmentShader=e+hn(),C.needsUpdate=!0}function Co(){P.numAlgebraicSpecies=Math.min(parseInt(P.numAlgebraicSpecies),parseInt(P.numSpecies)-1),Ht=P.numAlgebraicSpecies>=P.numSpecies-1,Xt=P.numAlgebraicSpecies>=P.numSpecies-2&&P.numSpecies>=3,Zt=P.numAlgebraicSpecies>=P.numSpecies-3&&P.numSpecies>=4}function Vo(){let e="function of "+fi.slice(0,P.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+fi[1]+",",""),i=e.replace(" "+fi[2]+",",""),o=e.replace(" "+fi[3]+",","");switch(1==P.dimension&&(e=e.replace(" y,","")),P.crossDiffusion&&parseInt(P.numSpecies)>1?(kt||ga(H,Array.from(Array(parseInt(P.numSpecies)).keys())),lo(H)):ro(H),P.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),ro(Y),ro(te),ro(ne),ro(G),ro(Qe),ro(Ne),ro(K),ro(ie),ro(ae),ro(re),ro(le),ro(z),ro(Pe),ro(Le),ro(ee),ro(oe),ro(se),ro(ue),ro(ce),ro(de),ro(fe),ro(J),ro(ke),ro(Me),parseInt(P.numSpecies)){case 4:P.crossDiffusion?(lo(ee),lo(oe),lo(se),lo(ue),lo(ce),lo(de)):(ro(se),ro(ue),ro(oe),ro(ee),ro(ce),ro(de)),lo(fe),lo(J),lo(ke),lo(Me);case 3:P.crossDiffusion?(lo(K),lo(ie),lo(ae),lo(re)):(ro(K),ro(ie),ro(ae),ro(re)),lo(le),lo(z),lo(Pe),lo(Le);case 2:P.crossDiffusion?(lo(Y),lo(te)):(ro(Y),ro(te)),lo(ne),lo(G),lo(Qe),lo(Ne)}1==P.numSpecies?so(Z,gi.D,e):P.crossDiffusion?(so(Z,gi.Duu,e),so(Y,gi.Duv,e),so(K,gi.Duw,e),so(ee,gi.Duq,e),so(te,gi.Dvu,e),so(ne,gi.Dvv,e),so(ie,gi.Dvw,e),so(oe,gi.Dvq,e),so(ae,gi.Dwu,e),so(re,gi.Dwv,e),so(le,gi.Dww,e),so(se,gi.Dwq,e),so(ue,gi.Dqu,e),so(ce,gi.Dqv,e),so(de,gi.Dqw,e),so(fe,gi.Dqq,e)):(so(Z,gi.Du,e),so(ne,gi.Dv,e),so(le,gi.Dw,e),so(fe,gi.Dq,e)),so(j,gi.UFUN,e),so(G,gi.VFUN,e),so(z,gi.WFUN,e),so(J,gi.QFUN,e),Ht&&(so(te,gi.Dvu,t),so(ie,gi.Dvw,t),so(oe,gi.Dvq,t),so(G,gi.VFUN,t),ro(ne)),Xt&&(so(ae,gi.Dwu,o),so(re,gi.Dwv,o),so(se,gi.Dwq,o),so(z,gi.WFUN,o),ro(le)),Zt&&(so(ue,gi.Dqu,i),so(ce,gi.Dqv,i),so(de,gi.Dqw,i),so(J,gi.QFUN,i),ro(fe)),so(Ie,gi.u),so(Ne,gi.v),so(Le,gi.w),so(Me,gi.q),so(Oe,gi.uD),so(qe,gi.vD),so(Be,gi.wD),so(je,gi.qD),so(Xe,gi.uN),so(Ze,gi.vN),so(Ye,gi.wN),so(Ke,gi.qN),so(tt,gi.uN),so(nt,gi.vN),so(it,gi.wN),so(ot,gi.qN),so(Re,gi.uInit),so(Qe,gi.vInit),so(Pe,gi.wInit),so(ke,gi.qInit),P.domainViaIndicatorFun?lo(X):ro(X),fo(),"surface"==P.plotType?($("#contourButton").show(),$("#embossButton").show(),ut.name="3D options",ut.domElement.classList.remove("hidden"),P.customSurface&&lo(be),ro(he),lo(ge),lo(ve),lo(Se),lo(ye)):"line"==P.plotType?($("#contourButton").hide(),$("#embossButton").hide(),ut.name="Line options",ut.domElement.classList.remove("hidden"),lo(he),lo(ge),ro(ve),ro(Se),ro(ye)):($("#contourButton").show(),$("#embossButton").show(),ut.domElement.classList.add("hidden"),ro(he),ro(ge),ro(ve),ro(Se),ro(ye)),No(),qo(),jo(),$("#dataContainer").show(),fr(),"line"==P.plotType?(ro(B),$(":root").css("--ui-button-outline","black")):(lo(B),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),ga(pe,fi.slice(0,P.numSpecies)),_e.slider.style.setProperty("--value",P.embossShiny),Ee.slider.style.setProperty("--value",P.embossSmoothness),Fe.slider.style.setProperty("--value",P.embossAmbient),De.slider.style.setProperty("--value",P.embossDiffuse),Ae.slider.style.setProperty("--value",P.embossSpecular),Te.slider.style.setProperty("--value",P.embossTheta),We.slider.style.setProperty("--value",P.embossPhi),$(".toggle_button").each((function(){ur(this)})),Ra(),oo(L),oo(M),oo(O)}function xo(){let e;switch(Co(),P.domainViaIndicatorFun&&(P.boundaryConditionsU="dirichlet",P.boundaryConditionsV="dirichlet",P.boundaryConditionsW="dirichlet",P.boundaryConditionsQ="dirichlet"),parseInt(P.numSpecies)){case 1:P.crossDiffusion=!1,P.whatToDraw=fi[0],P.whatToPlot=fi[0],P.diffusionStrUV="0",P.diffusionStrUW="0",P.diffusionStrUQ="0",P.diffusionStrVU="0",P.diffusionStrVV="0",P.diffusionStrVW="0",P.diffusionStrVQ="0",P.diffusionStrWU="0",P.diffusionStrWV="0",P.diffusionStrWW="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsV="periodic",P.clearValueV="0",P.reactionStrV="0",P.boundaryConditionsW="periodic",P.clearValueW="0",P.reactionStrW="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+pi[1]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0");break;case 2:P.whatToDraw==fi[2]|P.whatToDraw==fi[3]&&(P.whatToDraw=fi[0]),P.whatToPlot==fi[2]|P.whatToPlot==fi[3]&&(P.whatToPlot=fi[0]),P.diffusionStrUW="0",P.diffusionStrUQ="0",P.diffusionStrVW="0",P.diffusionStrVQ="0",P.diffusionStrWU="0",P.diffusionStrWV="0",P.diffusionStrWW="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsW="periodic",P.clearValueW="0",P.reactionStrW="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+pi[2]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0"),e.test(P.reactionStrV)&&(P.reactionStrV="0");break;case 3:P.whatToDraw==fi[3]&&(P.whatToDraw=fi[0]),P.whatToPlot==fi[3]&&(P.whatToPlot=fi[0]),P.diffusionStrUQ="0",P.diffusionStrVQ="0",P.diffusionStrWQ="0",P.diffusionStrQU="0",P.diffusionStrQV="0",P.diffusionStrQW="0",P.diffusionStrQQ="0",P.boundaryConditionsQ="periodic",P.clearValueQ="0",P.reactionStrQ="0",e=new RegExp("\\b("+pi[3]+")\\b"),e.test(P.reactionStrU)&&(P.reactionStrU="0"),e.test(P.reactionStrV)&&(P.reactionStrV="0"),e.test(P.reactionStrW)&&(P.reactionStrW="0")}switch(Jt){case 3:P.diffusionStrVV="0";break;case 6:P.diffusionStrWW="0";break;case 7:P.diffusionStrVV="0",P.diffusionStrWW="0";break;case 10:P.diffusionStrQQ="0";break;case 11:P.diffusionStrWW="0",P.diffusionStrQQ="0";break;case 12:P.diffusionStrVV="0",P.diffusionStrWW="0",P.diffusionStrQQ="0"}oo(L),oo(M)}function Uo(){!function(){switch(Co(),parseInt(P.numSpecies)){case 1:Jt=0;break;case 2:Jt=P.crossDiffusion?1==P.numAlgebraicSpecies?3:2:1;break;case 3:if(P.crossDiffusion)switch(P.numAlgebraicSpecies){case 0:Jt=5;break;case 1:Jt=6;break;case 2:Jt=7}else Jt=4;break;case 4:if(P.crossDiffusion)switch(P.numAlgebraicSpecies){case 0:Jt=9;break;case 1:Jt=10;break;case 2:Jt=11;break;case 3:Jt=12}else Jt=8}}(),na(),ia(),xo(),Vo(),la(),da(),$o(),Ji()}function $o(){let e,t=hi[Jt];const n={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(P.typesetCustomEqs){let o={};o.D=P.diffusionStrUU,o.U=P.diffusionStrUU,o.UU=P.diffusionStrUU,o.V=P.diffusionStrVV,o.VV=P.diffusionStrVV,o.W=P.diffusionStrWW,o.WW=P.diffusionStrWW,o.Q=P.diffusionStrQQ,o.QQ=P.diffusionStrQQ,o.UV=P.diffusionStrUV,o.UW=P.diffusionStrUW,o.UQ=P.diffusionStrUQ,o.VU=P.diffusionStrVU,o.VW=P.diffusionStrVW,o.VQ=P.diffusionStrVQ,o.WU=P.diffusionStrWU,o.WV=P.diffusionStrWV,o.WQ=P.diffusionStrWQ,o.QU=P.diffusionStrQU,o.QV=P.diffusionStrQV,o.QW=P.diffusionStrQW,o.UFUN=P.reactionStrU,o.VFUN=P.reactionStrV,o.WFUN=P.reactionStrW,o.QFUN=P.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Wa(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=va(o[e],fi,Bt,"_[xy]")})),Ft.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){jt.includes(e)||(t=function(e,t,n,i){let o=n.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(t,"");if("1"==o||"1.0"==o)return e.replaceAll(t,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(t,"-$2");if(n.match(/[a-zA-Z]/))return n.match(/[\+-]/)&&null!=i?e.replaceAll(t,i[0]+n+i[1]+"$2"):e.replaceAll(t,n+"$2");return e}(t,n[e],o[e],"[]"))})),t=ta(t,n.UFUN,o.UFUN),t=ta(t,n.VFUN,o.VFUN),t=ta(t,n.WFUN,o.WFUN),t=ta(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b[xy]|[uvwq]\b/g.test(t)?e:t+" \\lap "+n})),e=/\b([uvwq])_([xy])\b/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{$2}"),e=/\b([uvwq])_(xx|yy)\b/g,t=t.replaceAll(e,(function(e,t,n){return"\\textstyle \\pdd{"+t+"}{"+n[0]+"}"})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Ft.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=va(t,["UFUN","VFUN","WFUN","QFUN"],mi,"_[xy]");1==P.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=va(t,Bt.concat(jt),fi.concat(mi),"_[xy]"),t=_o(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(ma)}function _o(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Eo(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Eo(e,"cos",!0),e=Eo(e,"tan",!0),e=Eo(e,"exp",!0),e=Eo(e,"log",!0),e=Eo(e,"sqrt",!1),e=Eo(e,"sinh",!0),e=Eo(e,"cosh",!0),e=Eo(e,"tanh",!0),e=Eo(e,"max",!0),e=Yi(e=(e=Eo(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=Fo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=di(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")}function Eo(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const m of o){for(a=m.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=To(i,"\\",a+f),f+=1,n?(i=To(i,"{",r+f),f+=1,i=To(i,"}",l+1+f),f+=1):(i=Ao(i,"{",r+f),i=Ao(i,"}",l+f)))}return i}function Fo(e,t){const n=["(","["],i=[")","]"];let o=Do(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=Ao(e,n[o],a),o+=1,o=Do(o,n.length)):i.includes(e[a])&&(o-=1,o=Do(o,n.length),e=Ao(e,i[o],a));return e}function Do(e,t){return(e%t+t)%t}function Ao(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function To(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Wo(e){return e=e.replace(/\s+/g,"  ").trim()}function Ro(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=Lt[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);Lt[e]=Lt[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),oo($t),Qo(),Ni(),(la()||Wt)&&(Wt=!1,da())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)Mt.push(e),Lt[e]="",n=$t.add(Lt,e).name(""),cr(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=Mt.indexOf(e);let n=Wo(Lt[Mt.at(t)]);if(""==n);else{let e=Ro(Mt.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);i&&(e.lastName=i[1],Ot[e.lastName]=e),qt+=1;let o="params"+qt;this.remove(),Ro(o,!0),Qo(),(la||Wt)&&(Wt=!1,da())}}));else{n=$t.add(Lt,e).name(""),cr(n.domElement),n.domElement.classList.add("params");const t=Lt[e].match(/\s*(\w+)\s*=/);t&&(n.lastName=t[1],Ot[n.lastName]=n),n.onFinishChange((function(){let t=Wo(Lt[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=Mt.indexOf(e);Mt.splice(t,1),delete Lt[e],n.hasOwnProperty("lastName")&&delete k[n.lastName]}else{i();const e=fa(t).match(/\s*(\w+)\s*=/);e&&n.hasOwnProperty("lastName")&&n.lastName!=e[1]&&(delete k[n.lastName],n.lastName=e[1],Ot[n.lastName]=n)}Qo(),la()&&da()})),Qo(),la()&&da()}return i(),n}function Qo(){P.kineticParams=Object.values(Lt).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Po(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function ko(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Io(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function No(){if(P.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+Sa(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==P.whatToPlot?($("#minLabel").html("$"+fi[0]+"$"),$("#midLabel").html("$"+fi[1]+"$"),$("#maxLabel").html("$"+fi[2]+"$")):Dt?$("#midLabel").html(P.views[P.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+_o(P.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),aa(),Lo()}else $("#colourbar").hide()}function Lo(){if("MAX"!=P.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[Oo(e,n),Oo(t,n)]}(P.minColourValue,P.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=pa(Sa(0)),t=pa(Sa(.5)),n=pa(Sa(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Mo(e,t){return e.toPrecision(t)}function Oo(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function qo(){P.timeDisplay?($("#timeDisplay").show(),Bo()):$("#timeDisplay").hide(),zo()}function Bo(){if(P.timeDisplay){let e=Mo(k.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," × 10<sup>$2$3<sup>"),$("#timeValue").html(e),Xo()}}function jo(){if(P.integrate){$("#integralDisplay").show();let e="";1==P.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+_o(P.whatToPlot)+"\\,\\d x",1==P.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();zo()}function Go(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function zo(){P.integrate&&P.timeDisplay?Go("#timeDisplay",10):Go("#timeDisplay",0)}function Jo(){let e=yo();isFinite(e[0])&&isFinite(e[1])?ht=setTimeout(Jo,1e3):(ko("#oops_hit_nan"),Gi(),$("#erase").one("click",(()=>Io("#oops_hit_nan"))))}function Ho(){if(!tn){try{l.readRenderTargetPixels(f,0,0,St,yt,Yt)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}tn=!0}}function Xo(){if(P.colourbar&&P.integrate|P.timeDisplay){let e,t=$("#colourbar")[0].getBoundingClientRect();e=P.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(Go("#dataContainer",40),Tt=!0):Tt&&(Go("#dataContainer",0),Tt=!1)}}function Zo(){Yo()?(_t.forEach((e=>{e.texture.magFilter=Kn.NearestFilter})),f.texture.magFilter=Kn.NearestFilter,m.texture.magFilter=Kn.NearestFilter):(_t.forEach((e=>{e.texture.magFilter=Kn.LinearFilter})),f.texture.magFilter=Kn.LinearFilter,m.texture.magFilter=Kn.LinearFilter),Vo(),Ni()}function Yo(){return n||P.forceManualInterpolation}function Ko(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function ea(e,t){return null==t&&(t=[]),function(e){return[...(Sn()+_n()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function ta(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function na(){"line"==P.plotType?(wa(),P.typeOfBrush="vline",Pi(),oo(M),_.visible=!1,D.visible=!0,P.contours=!1,P.emboss=!1):(_.visible=!0,D.visible=!1,"surface"==P.plotType?($("#simCanvas").css("outline","2px #000 solid"),It&&(It=!1,$i())):$("#simCanvas").css("outline","")),ki(),_i(),Vo()}function ia(){1!=P.dimension&&"line"==P.plotType&&(P.plotType="plane",na()),1==P.dimension&&"line"!=P.plotType&&(P.plotType="line",na()),Ui(),Ki(),$o(),Vo(),jo()}function oa(){const e=(new Kn.Vector3).setFromSphericalCoords(1,Math.PI/2-P.cameraTheta*Math.PI/180,-P.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function aa(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function ra(){let e=P.kineticParams.replaceAll(/\bin[^;]*;?/g,";");return e=fa(e),e}function la(){const e=function(e){let t={},n={},i=[];e.forEach((function(e){const[n,i]=e.split("=").map((e=>e.trim()));t[n]=i}));const o=e.map((e=>e.split("=").map((e=>e.trim())))),a=o.map((e=>e[0]));for(const e of o){let[o,r]=e;o in n||([n,,i]=ca(o,t,n,[o],a,[]))}i.length>0&&(Gi(),Ta("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+"."));return Object.keys(n).map((e=>[e,n[e]]))}(ra().split(";").filter((e=>e.length>0)));let t=!1;for(const n of e)t|=sa(n[0],n[1]);return t}function sa(e,t){let n=!1;const i=fa(e);return ea(i)?alert("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."):(n=!k.hasOwnProperty(i),k[i]={type:"float",value:t}),n}function ua(){return fa(ra().replaceAll(/;?\s*(\w+)\s*=[^;]*;?/g,"uniform float $1;\n"))}function ca(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(l)):([n,,a]=ca(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));return n[e]=vi.evaluate(t[e]),[n,i.slice(0,-1),a]}function da(){Ki(),po(),Pi(),vo(),Qi(),wo()}function fa(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+nn[e])););return n}function ma(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function pa(e){return e.reduce(((e,t)=>e+t),0)/3}function ha(){let e=yo();P.minColourValue=e[0],P.maxColourValue=e[1],k.maxColourValue.value=P.maxColourValue,k.minColourValue.value=P.minColourValue,xe.updateDisplay(),Ve.updateDisplay(),Lo()}function ga(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function ba(e){let t;null!=fi&&(t=fi);const n=P.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Bt.length),i=P.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,jt.length),o=n.concat(Gt.slice(n.length)),a=i.concat(zt.slice(i.length)),r=function(){const e=/(\w+)\s*=/;return ra().split(";").filter((e=>e.length>0)).map((t=>t.replace(e,"$1").trim()))}();let l;for(var s=0;s<o.length;s++)if(ea(o[s],r.concat(a)))return l=r.includes(o[s])?"as a parameter":a.includes(o[s])?"as a reaction":"under the hood",void alert("The name '"+o[s]+"' is used "+l+", so can't be used as a species name. Please use a different name for "+o[s]+".");for(s=0;s<a.length;s++)if(ea(a[s],r.concat(o[s])))return l=r.includes(a[s])?"as a parameter":o.includes(a[s])?"as a reaction":"under the hood",void alert("The name '"+a[s]+"' is used "+l+", so can't be used as a function name. Please use a different name for "+a[s]+".");fi=o,mi=a,function(){pi=[];for(let e=0;e<fi.length;e++)pi.push("(?:"+fi.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let u={...si(),...ci()};Object.keys(u).forEach((function(e){gi[e]=_o(va(u[e],Bt,fi,"_[xy]"))})),u=ui(),Object.keys(u).forEach((function(e){gi[e]=_o(va(u[e],jt,mi))})),e||(Object.keys(P).forEach((function(e){Si.includes(e)&&(P[e]=va(P[e],t,fi,"_[xy]"))})),P.views=P.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){Si.includes(i)&&(n[i]=va(e[i],t,fi,"_[xy]"))})),n})),Object.keys(N).forEach((function(e){Si.includes(e)&&(N[e]=va(N[e],t,fi,"_[xy]"))})),N.views=N.views.map((function(e){let n={};return n.name=e.name,Object.keys(e).forEach((function(i){Si.includes(i)&&(n[i]=va(e[i],t,fi,"_[xy]"))})),n})),xo(),Vo(),da(),$o())}function va(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Sa(e){e=e.clamp(0,1);let t=0;for(;e>=Q[t+1]&&t<R.length-2;)t+=1;return Q[t+1]==Q[t]?R[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=ya(e[o],t[o],n);return i}(R[t],R[t+1],(e-Q[t])/(Q[t+1]-Q[t])).map((e=>e.clamp(0,1)))}function ya(e,t,n){return(1-n)*e+n*t}function wa(){V.linewidth=.01*P.lineWidthMul,V.needsUpdate=!0}function Ca(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function Va(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function xa(e){e.forEach((function(e){Ft.add(e)})),$o()}function Ua(e){e.forEach((function(e){Ft.delete(e)})),$o()}function $a(){Kt=new Float32Array(St*yt*4),l.readRenderTargetPixels(_t[1],0,0,St,yt,Kt),Da(Kt),Qt=!0}function _a(){Qt||$a();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([St,yt]),Kt])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function Ea(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Da(e.slice(2),e.slice(0,2)),Fa(h),Qt=!0,Ji()},t.readAsArrayBuffer(e)}function Fa(e){if(null!=e)if("crop"==P.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Da(e,t){null!=h&&h.dispose(),null==t&&(t=[St,yt]),h=new Kn.DataTexture(e,t[0],t[1],Kn.RGBAFormat,Kn.FloatType),h.needsUpdate=!0,h.magFilter=n?Kn.NearestFilter:Kn.LinearFilter,null!=U&&(U.map=h,U.needsUpdate)}function Aa(){l.setSize(Math.round(devicePixelRatio*xt),Math.round(devicePixelRatio*Ut),!1)}function Ta(e){$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),ko("#error"),$("#error").one("click",(function(){Io("#error")})))}function Wa(e){if(/\(\s*\)/.test(e))return Ta("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Ta("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Ta("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Ra(){let e;$("#views_list").empty();for(let t=0;t<P.views.length;t++)e=document.createElement("a"),e.onclick=function(){P.activeViewInd=t,Qa(P.views[t])},e.innerHTML="<div class='view_label'>"+P.views[t].name+"</div>",t==P.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Pt=Math.max(P.views.length,Pt),P.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),P.views.length}function Qa(e,t){Object.assign(P,e),delete P.name,oo(O),(null==t||t)&&(vo(),na(),ki(),Ei(),Lo(),No(),Ni())}function Pa(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",P.views[P.activeViewInd].name);null!=e&&(P.views[P.activeViewInd].name=e,Ra(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function ka(){P.views.length>1?(P.views.splice(P.activeViewInd,1),P.activeViewInd<1?P.activeViewInd=0:P.activeViewInd-=1):P.views[P.activeViewInd].name="Custom",Qa(P.views[P.activeViewInd])}function Ia(){let e={};return bi.forEach((function(t){e[t]=N[t]})),e}function Na(e){P.activeViewInd<P.views.length&&(P.views[P.activeViewInd][e]=P[e])}function La(e,t){let n="";return n+=uo(xn(t),fi[e]),P.dimension>1&&(n+=uo(Un(t),fi[e])),n}function Ma(e,t){let n="";return n+=uo(wn(t),fi[e]),P.dimension>1&&(n+=uo(Cn(t),fi[e])),n}function Oa(e,t){let n="";return n+=uo(xn(t),fi[e]),P.dimension>1&&(n+=uo(Un(t),fi[e])),n}function qa(e,t){let n="";return n+=uo(wn(t).replaceAll(/updated/g,"gl_FragColor"),fi[e]),P.dimension>1&&(n+=uo(Cn(t).replaceAll(/updated/g,"gl_FragColor"),fi[e])),n}function Ba(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function ja(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function Ga(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){P[s.getAttribute("property")]=!P[s.getAttribute("property")],ur(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),ur(s),s}function za(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function Ja(){let e=So(P,Jn("default"));e.preset="PRESETNAME";let t=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");t='case "PRESETNAME":\n\toptions = '+t+";\nbreak;",navigator.clipboard.writeText(t)}function Ha(){let t="";t+=JSON.stringify(P),t+=JSON.stringify(k),t+=JSON.stringify({nXDisc:St,nYDisc:yt,domainHeight:Ct,domainWidth:wt,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function Xa(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function Za(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function Ya(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function Ka(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function er(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function tr(){let e=So(P,Jn("default"));return e.preset="Custom",e=oi(e),[location.href.replace(location.search,""),"?options=",ri.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function nr(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function ir(e){const t=Ot[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function or(){k.embossAmbient.value=P.embossAmbient,k.embossDiffuse.value=P.embossDiffuse,k.embossShiny.value=P.embossShiny,k.embossSmoothness.value=P.embossSmoothness,k.embossSpecular.value=P.embossSpecular,k.embossLightDir.value=new Kn.Vector3(Math.sin(P.embossTheta)*Math.cos(P.embossPhi),Math.sin(P.embossTheta)*Math.sin(P.embossPhi),Math.cos(P.embossTheta))}function ar(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function rr(){k.contourColour.value=new Kn.Color(P.contourColour),k.contourEpsilon.value=P.contourEpsilon,k.contourStep.value=1/(P.contourNum+1)}function lr(){k.overlayColour.value=new Kn.Color(P.overlayColour),k.overlayEpsilon.value=P.overlayEpsilon}function sr(){dt||Ni()}function ur(e){P[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function cr(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function dr(){P.customSurface?b.vertexShader=Bn():b.vertexShader=qn(),b.needsUpdate=!0}function fr(){"surface"==P.plotType?($("#customSurfaceToggle").show(),P.customSurface?(lo(be),ro(ge)):(ro(be),lo(ge))):($("#customSurfaceToggle").hide(),ro(be))}Vi&&no("GrayScott"),Dt=Ci.has("story"),Dt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),st.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),No(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),vt=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Po()||Vi||P.forceTryClickingPopup)&&!P.suppressTryClickingPopup&&P.brushEnabled&&($("#top_message").html("<p>"+P.tryClickingText+"</p>"),ko("#top_message"),setTimeout((()=>Io("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Io("#top_message")))),$("#settings").click((function(){Xa(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&Ka(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&er(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&Za(),$("#views_ui").is(":visible")&&Ya()),$("#left_ui").is(":visible")&&ma()})),$("#equations").click((function(){Za(),ma(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&Xa(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ya()})),$("#pause").click((function(){Gi()})),$("#play").click((function(){zi()})),$("#erase").click((function(){Ji()})),$("#warning_restart").click((function(){$("#oops_hit_nan").hide(),Ji()})),$("#share").click((function(){er(),$("#help_panel").is(":visible")&&Ka()})),$("#help").click((function(){Ka(),$("#share_panel").is(":visible")&&er()})),$("#screenshot").click((function(){en=!0,Ni(),er()})),$("#link").click((function(){I.copyConfigAsURL(),er()})),$("#embed").click((function(){!function(){let e=tr();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}nr('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),er()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){Ka()})),$("#views").click((function(){Ya(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&Xa(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Za()})),$(document).on("click","#add_view",(function(){!function(){let e=Ia();e.name=++Pt,P.views.push(e),P.activeViewInd=P.views.length-1,Ra()}()})),function e(){requestAnimationFrame(e),mt=ft,ft&&P.brushEnabled&&function(){!P.fixRandSeed&&P.brushValue.includes("RAND")&&mo();E.material=v;for(let e=1;e<_t.length;e++)k.textureSource.value=_t[e].texture,l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1)}();if(dt){!pt||function(){E.material=S;for(let e=1;e<_t.length;e++)k.textureSource.value=_t[e].texture,l.setRenderTarget(_t[e-1]),l.render(r,o);_t.rotate(-1)}();for(let e=0;e<P.numTimestepsPerFrame;e++)At&&!P.fixRandSeed&&mo(),Ii()}(mt||dt)&&Ni()}();