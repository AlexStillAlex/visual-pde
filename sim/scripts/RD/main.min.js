let e,t,n,i,o,a,r,l,s,u,c,d,f,p,m,h,g,b,v,y,S,w,C,x,V,F,U,E,_,D,A,T,W,P,Q,R,k,M,I,L,N,O,q,B,j,z,G,J,H,X,Y,Z,K,ee,te,ne,ie,oe,ae,re,le,se,ue,ce,de,fe,pe,me,he,ge,be,ve,ye,Se,we,Ce,xe,Ve,Fe,Ue,$e,Ee,_e,De,Ae,Te,We,Pe,Qe,Re,ke,Me,Ie,Le,Ne,Oe,qe,Be,je,ze,Ge,Je,He,Xe,Ye,Ze,Ke,et,tt,nt,it,ot,at,rt,lt,st,ut,ct,dt,ft,pt,mt,ht,gt,bt,vt,yt,St,wt,Ct,xt,Vt,Ft,Ut,$t,Et,_t,Dt,At,Tt=[],Wt={},Pt=[],Qt=[],Rt=new Set,kt=!0,Mt=!1,It=!0,Lt=!0,Nt=!1,Ot=!1,qt=!1,Bt=!1,jt=!1,zt=!1,Gt=0,Jt=!1,Ht=!0,Xt=1,Yt=1,Zt=.15,Kt={},en=[],tn={},nn=0;const on=["u","v","w","q"],an=["UFUN","VFUN","WFUN","QFUN"],rn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"];let ln,sn,un,cn,dn,fn,pn,mn=!1,hn=!1;const gn=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as bn,drawShaderBotReplace as vn,drawShaderBotAdd as yn,drawShaderShapeDisc as Sn,drawShaderShapeVLine as wn,drawShaderShapeHLine as Cn,drawShaderFactorSharp as xn,drawShaderFactorSmooth as Vn}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as Fn,computeDisplayFunShaderMid as Un,computeMaxSpeciesShaderMid as $n,postGenericShaderBot as En,postShaderDomainIndicator as _n,interpolationShader as Dn}from"./post_shaders.js";import{copyShader as An}from"../copy_shader.js";import{RDShaderTop as Tn,RDShaderBot as Wn,RDShaderDirichletX as Pn,RDShaderDirichletY as Qn,RDShaderDirichletIndicatorFun as Rn,RDShaderRobinX as kn,RDShaderRobinY as Mn,RDShaderUpdateNormal as In,RDShaderUpdateCross as Ln,RDShaderAlgebraicSpecies as Nn,RDShaderEnforceDirichletTop as On,RDShaderAdvectionPreBC as qn,RDShaderAdvectionPostBC as Bn,RDShaderDiffusionPreBC as jn,RDShaderDiffusionPostBC as zn,RDShaderGhostX as Gn,RDShaderGhostY as Jn,RDShaderMain as Hn}from"./simulation_shaders.js";import{randShader as Xn,randNShader as Yn}from"../rand_shader.js";import{fiveColourDisplayTop as Zn,fiveColourDisplayBot as Kn,embossShader as ei,contourShader as ti,surfaceVertexShaderColour as ni,surfaceVertexShaderCustom as ii,overlayShader as oi}from"./display_shaders.js";import{getColours as ai}from"../colourmaps.js";import{genericVertexShader as ri}from"../generic_shaders.js";import{getPreset as li,getUserTextFields as si,getFieldsInView as ui,getListOfPresets as ci}from"./presets.js";import{clearShaderBot as di,clearShaderTop as fi}from"./clear_shader.js";import*as pi from"../three.module.min.js";import{OrbitControls as mi}from"../OrbitControls.js";import{Line2 as hi}from"../lines/Line2.js";import{LineMaterial as gi}from"../lines/LineMaterial.js";import{LineGeometry as bi}from"../lines/LineGeometry.js";import{minifyPreset as vi,maxifyPreset as yi}from"./minify_preset.js";import{LZString as Si}from"../lz-string.min.js";import{equationTEXFun as wi,getDefaultTeXLabelsDiffusion as Ci,getDefaultTeXLabelsReaction as xi,getDefaultTeXLabelsBCsICs as Vi,substituteGreek as Fi}from"./TEX.js";let Ui,$i,Ei,_i=wi(),Di={...Ci(),...xi(),...Vi()};const Ai=ui();let Ti=new exprEval.Parser;Ti.consts.pi=Math.PI,Ti.consts.Pi=Math.PI,Ti.consts.e=Math.exp(1),O={};const Wi=si();var Pi,Qi;B={reset:function(){so()},toggleRunning:function(){mt?ro():lo()},copyConfigAsURL:function(){yr(vr())},saveSimState:function(){qa()},exportSimState:function(){Ba()},clearCheckpoints:function(){zt&&(h.dispose(),h=null,zt=!1)},restoreCurrentView:function(){var e;O.activeViewInd<O.views.length&&(e=O.activeViewInd,O.views[e]=St[e],Za(O.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Array.prototype.rotate=(Pi=Array.prototype.push,Qi=Array.prototype.splice,function(e){var t=this.length>>>0;return e=((e>>=0)%t+t)%t,Pi.apply(this,Qi.call(this,0,e)),this}),Array.prototype.last=function(){return this[this.length-1]},e=document.getElementById("simCanvas"),console.error=function(e){Bt=!0;let t=e.toString();console.log(t);let n=/ERROR.*/;!n.test(t)||(t=t.match(n)),Ha(t)},Xo()||$("#logo").hide();const Ri=new URLSearchParams(window.location.search);if(Ri.has("no_ui")?($(".ui").addClass("hidden"),jt=!0):$(".ui").removeClass("hidden"),Ri.has("logo_only")&&($(".ui").addClass("hidden"),$("#logo").removeClass("hidden"),jt=!0),Ri.has("sf")&&(Yt=parseFloat(Ri.get("sf")),(isNaN(Yt)||Yt<=0)&&(Yt=1)),!function(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){if("warning"==e[t].split("=")[0].trim())return!0}return!1}()&&!jt){$("#warning").css("display","block");await Promise.race([pa(document.getElementById("warning_ok"),"click",!0),pa(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let t="expires="+e.toUTCString();document.cookie="warning=true;"+t+";path=/"}(),$("#warning").css("display","none")}vo("default"),function(){q={brushCoords:{type:"v2",value:new pi.Vector2(.5,.5)},colour1:{type:"v4",value:new pi.Vector4(0,0,0,0)},colour2:{type:"v4",value:new pi.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new pi.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new pi.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new pi.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},customSurface:{type:"bool"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dxUpscaledScale:{type:"f"},dy:{type:"f"},dyUpscaledScale:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},overlayColour:{type:"v4"},overlayEpsilon:{type:"f"},overlayLine:{type:"bool",value:!0},seed:{type:"f",value:0},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},vectorField:{type:"bool",value:!1}},ht=!1,c=new pi.Raycaster,d=new pi.Vector2,l=new pi.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),l.autoClear=!0,t=l.getContext(),Et=t.getParameter(t.MAX_TEXTURE_SIZE),n=!(t.getExtension("OES_texture_float_linear")&&t.getExtension("EXT_float_blend")),m={format:pi.RGBAFormat,type:pi.FloatType,minFilter:pi.NearestFilter},n|=/android/i.test(navigator.userAgent),m.magFilter=n?pi.NearestFilter:pi.LinearFilter,Tt.push(new pi.WebGLRenderTarget(O.maxDisc,O.maxDisc,m)),Tt.push(Tt[0].clone()),Tt.push(Tt[0].clone()),Tt.push(Tt[0].clone()),Tt.push(Tt[0].clone()),f=Tt[0].clone(),p=Tt[0].clone(),Tt.forEach((e=>{e.texture.wrapS=pi.RepeatWrapping,e.texture.wrapT=pi.RepeatWrapping})),f.texture.wrapS=pi.ClampToEdgeWrapping,f.texture.wrapT=pi.ClampToEdgeWrapping,p.texture.wrapS=pi.ClampToEdgeWrapping,p.texture.wrapT=pi.ClampToEdgeWrapping,i=new pi.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new mi(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==O.plotType&&(O.cameraTheta=90-180*Math.acos(i.position.y)/Math.PI,O.cameraPhi=-180*Math.atan2(i.position.x,i.position.z)/Math.PI,O.cameraZoom=i.zoom,nr("cameraTheta"),nr("cameraPhi"),nr("cameraZoom"),yo(J),Ur())})),o=new pi.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new pi.Scene,r=new pi.Scene,a.add(i),a.background=new pi.Color(O.backgroundColour),g=new pi.MeshBasicMaterial({side:pi.DoubleSide}),b=new pi.ShaderMaterial({uniforms:q,vertexShader:ri(),transparent:!0,side:pi.DoubleSide}),C=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()}),U=new pi.ShaderMaterial({uniforms:q,vertexShader:ri(),fragmentShader:Dn()}),v=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()}),Wt.FE=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()}),Wt.AB2=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()});for(let e=1;e<3;e++)Wt["Mid"+e.toString()]=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()});for(let e=1;e<5;e++)Wt["RK4"+e.toString()]=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()});w=new pi.ShaderMaterial({uniforms:q,vertexShader:ri(),fragmentShader:An()}),S=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()}),y=new pi.ShaderMaterial({uniforms:q,vertexShader:ri()}),x=new gi({vertexColors:!0,linewidth:.01}),V=new gi({color:0,linewidth:.01}),F=new pi.MeshBasicMaterial({color:O.arrowColour,side:pi.DoubleSide}),E=new pi.MeshBasicMaterial,_=new pi.CylinderGeometry(.008,.008,.1),D=new pi.ConeGeometry(.04,.04,4);const s=new pi.PlaneGeometry(1,1);T=new pi.Mesh(s,Wt[0]),T.position.z=0,r.add(T),Bi(),ji(),Ni(),Gi(),Ii(),Ji(),ko(),Io(),Xi(),Hi(),Eo(),da(),so(),e.addEventListener("pointerdown",to),e.addEventListener("pointerup",no),e.addEventListener("pointermove",io),document.addEventListener("keypress",(function(e){var t=(e=e||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===e.key&&$("#erase").click()," "===e.key&&(B.toggleRunning(),e.preventDefault()),"h"===e.key&&(jt?(jt=!1,$(".ui").removeClass("hidden"),ct.domElement.classList.remove("hidden"),$("#add_view").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",wt),mt?lo():ro(),ca(),ya(),_a()):(jt=!0,$(".ui").addClass("hidden"))),"s"==e.key&&qa(),"c"==e.key&&(O.resetFromCheckpoints=!O.resetFromCheckpoints,$r($("#checkpointButton")[0])))})),window.addEventListener("resize",(function(){Ii(),Ur()}),!1),window.addEventListener("message",Sr),$("#checkpointInput").change((function(){ja(this.files[0]),this.value=null}))}();let ki=!0;if(Ri.has("preset")&&(bo(Ri.get("preset")),ki=!1),Ri.has("options")){var Mi=JSON.parse(Si.decompressFromEncodedURIComponent(Ri.get("options")));Mi.hasOwnProperty("p")&&(Mi=yi(Mi)),bo(Mi),ki=!1}function Ii(){Bi(),function(){T.material=w;for(let e=1;e<Tt.length;e++)q.textureSource.value=Tt[e].texture,Tt[e-1].setSize(xt,Vt),l.setRenderTarget(Tt[e-1]),l.render(r,o);Tt.rotate(-1),Tt[0].dispose(),Tt[0]=Tt[1].clone(),f.setSize(xt,Vt),eo(),p.setSize(Math.round(devicePixelRatio*_t),Math.round(devicePixelRatio*Dt))}(),za(h),Oi(),Li(),Pr(),Ni(),ya(),_a()}function Li(){A.geometry.dispose(),a.remove(A),W.geometry.dispose(),a.remove(W),P.geometry.dispose(),a.remove(P),Q.geometry.dispose(),a.remove(Q),ji()}function Ni(){switch(qi(),O.plotType){case"line":O.cameraTheta=0,O.cameraPhi=0,u.enabled=!1,i.zoom=1,va(),b.vertexShader=ni();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=ri();break;case"surface":u.enabled=!0,i.zoom=O.cameraZoom,va(),_r()}b.needsUpdate=!0,i.left=-Ft/(2*$t),i.right=Ft/(2*$t),i.top=Ut/(2*$t),i.bottom=-Ut/(2*$t),i.updateProjectionMatrix(),zi()}function Oi(){q.L.value=Xt,q.L_y.value=Ut,q.L_x.value=Ft,q.L_min.value=Math.min(Ut,Ft),q.dt.value=O.dt,q.dx.value=Ct,q.dy.value=Ct,q.heightScale.value=O.threeDHeightScale,q.maxColourValue.value=O.maxColourValue,q.minColourValue.value=O.minColourValue,q.customSurface.value=O.customSurface,q.vectorField.value=O.vectorField,wr(),O.fixRandSeed||$o()}function qi(){try{Xt=Ti.evaluate(O.domainScale)}catch(e){Ha("Unable to evaluate the domain length. Please check the definition."),Xt=100}_t=Math.round(e.getBoundingClientRect().width),Dt=Math.round(e.getBoundingClientRect().height),s=Dt/_t,s<=0&&(s=.1),s>=1?(Ut=Xt,Ft=Ut/s):(Ft=Xt,Ut=Ft*s),1==O.dimension&&(Ft=Xt),q.L_x.value=Ft,q.L_y.value=Ut,$t=Math.max(Ft,Ut)}function Bi(){qi(),Ct=Xt/100;try{Ct=Ti.evaluate(O.spatialStep)}catch(e){Ha("Unable to evaluate the spatial step. Please check the definition.")}Ct<=0&&(Ha("Oops! A spatial step less than or equal to 0 would almost certainly crash your device. Please check the definition."),Ct=Xt/100),xt=Math.floor(Ft/Ct),Vt=Math.floor(Ut/Ct),(xt>Et||Vt>Et)&&(Ha("Your device does not support a discretisation this fine (maximum "+Et+"). Please increase the space step to at least "+(Math.ceil(1e4*Xt/Et)/1e4).toPrecision(4)+" or reduce the domain size to at most "+(Math.floor(1e4*Et*Ct)/1e4).toPrecision(4)+"."),xt=Math.min(xt,Et),Vt=Math.min(Vt,Et)),0==xt&&(xt=1),0==Vt&&(Vt=1),1==O.dimension&&(Vt=1),q.nXDisc.value=xt,q.nYDisc.value=Vt,R=new Array(xt),k=new Array(xt);let e=-.5,t=1/xt;for(let n=0;n<R.length;n++)R[n]=e,e+=t;R=R.map((e=>e*Ft/$t)),Ja(),dn=new Float32Array(xt*Vt*4),hn=!1}function ji(){qi();let e=[1,1];Ht||(e=[xt,Vt]);const t=new pi.PlaneGeometry(Ft/$t,Ut/$t,e[0],e[1]);A=new pi.Mesh(t,b),A.position.z=0,A.visible="line"!=O.plotType,A.matrixAutoUpdate=!1,a.add(A);const n=new pi.PlaneGeometry(Ft/$t,Ut/$t,1,1);W=new pi.Mesh(n,g),W.position.z=0,W.visible=!1,W.matrixAutoUpdate=!1,a.add(W),zi();const i=new bi;M=Math.round(2*devicePixelRatio*_t);const o=new Array(3*M).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),P=new hi(i,x),P.scale.set(1,1,1),P.visible="line"==O.plotType,a.add(P);const l=new bi,s=new Array(3*M).fill(0);l.setPositions(s),Q=new hi(l,V),Q.scale.set(1,1,1),Q.visible="line"==O.plotType&&O.overlay,a.add(Q)}function zi(){switch(O.plotType){case"plane":A.rotation.x=0,W.rotation.x=0;break;case"surface":A.rotation.x=-Math.PI/2,W.rotation.x=-Math.PI/2}A.updateMatrix(),W.updateMatrix()}function Gi(){O.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Ji(e){z=new dat.GUI({closeOnTop:!0,autoPlace:!1}),z.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(z.domElement),G=new dat.GUI({closeOnTop:!0,autoPlace:!1}),G.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(G.domElement),J=new dat.GUI({closeOnTop:!0,autoPlace:!1}),J.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(J.domElement),z.open(),G.open(),J.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),H=G.addFolder("Brush");ur(lr(H),"brushEnabled",'<i class="fa-regular fa-brush"></i> Enable brush',null,null,"Toggle the brush on or off");H.add(O,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange((function(){Xi(),document.activeElement.blur()}));X=H.add(O,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Xi),H.add(O,"brushValue").name("Value").onFinishChange(Xi),H.add(O,"brushRadius").name("Radius").onFinishChange(Xi),we=H.add(O,"whatToDraw",Ui).name("Species").onChange(Xi),H=G.addFolder("Domain"),H.add(O,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){ba(),document.activeElement.blur(),Ur()})),H.add(O,"domainScale").name("Largest side").onFinishChange((function(){Ii(),Ur()})),H.add(O,"spatialStep").name("Space step").onFinishChange((function(){Ii(),Ur()}));const t=lr(H);ur(t,"squareCanvas",'<i class="fa-regular fa-square"></i> Square',(function(){Gi(),Ii(),Ni(),Ur()}),null,"Use a square domain"),ur(t,"domainViaIndicatorFun",'<i class="fa-regular fa-circle"></i> Implicit',(function(){Mo(),ko(),mo(),Qo(),Ur()}),null,"Determine the domain implicitly"),ne=H.add(O,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){Mo(),ko(),mo(),To(),Ur()})),H=G.addFolder("Timestepping"),Ze=H.add(O,"numTimestepsPerFrame",1,1e3,1).name("Steps/frame"),Cr(Ze,1,400,1),ye=H.add(O,"dt").name("Timestep").onChange((function(){Oi()})),ye.__precision=12,ye.min(0),ye.updateDisplay(),H.add(O,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme").onChange((function(){document.activeElement.blur()}));const n=lr(H);ur(n,"timeDisplay",'<i class="fa-regular fa-hourglass-half"></i> Elapsed time',ia,null,"Show/hide time display"),ur(n,"autoPause",'<i class="fa-regular fa-hourglass-end"></i> Auto pause',(function(){It=q.t.value<O.autoPauseAt,ko()}),null,"Toggle automatic pausing"),Se=H.add(O,"autoPauseAt").name("Pause at $t=$").onFinishChange((function(){It=q.t.value<O.autoPauseAt,Se.domElement.blur()})),H=G.addFolder("Equations"),H.add(O,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange((function(){document.activeElement.blur(),Io(),so()})),te=H.add(O,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Jt=!0,Io(),Jt=!1,so()})),H.add(O,"speciesNames").name("Species names").onFinishChange((function(){Wa()}));ur(lr(H),"crossDiffusion",'<i class="fa-regular fa-arrow-down-up-across-line"></i> Cross diffusion',(function(){Io()}),"cross_diffusion_controller","Toggle cross diffusion"),H=z.addFolder("Definitions");ur(lr(H),"typesetCustomEqs",'<i class="fa-regular fa-square-root-variable"></i> Typeset',Lo,null,"Typeset the specified equations"),ie=H.add(O,"diffusionStrUU").onFinishChange((function(){mo(),Lo()})),Ia(ie,Na,["U","UU"]),La(ie,Oa,["U","UU"]),oe=H.add(O,"diffusionStrUV").onFinishChange((function(){mo(),Lo()})),Ia(oe,Na,["UV"]),La(oe,Oa,["UV"]),ae=H.add(O,"diffusionStrUW").onFinishChange((function(){mo(),Lo()})),Ia(ae,Na,["UW"]),La(ae,Oa,["UW"]),re=H.add(O,"diffusionStrUQ").onFinishChange((function(){mo(),Lo()})),Ia(re,Na,["UQ"]),La(re,Oa,["UQ"]),le=H.add(O,"diffusionStrVU").onFinishChange((function(){mo(),Lo()})),Ia(le,Na,["VU"]),La(le,Oa,["VU"]),se=H.add(O,"diffusionStrVV").onFinishChange((function(){mo(),Lo()})),Ia(se,Na,["V","VV"]),La(se,Oa,["V","VV"]),ue=H.add(O,"diffusionStrVW").onFinishChange((function(){mo(),Lo()})),Ia(ue,Na,["VW"]),La(ue,Oa,["VW"]),ce=H.add(O,"diffusionStrVQ").onFinishChange((function(){mo(),Lo()})),Ia(ce,Na,["VQ"]),La(ce,Oa,["VQ"]),de=H.add(O,"diffusionStrWU").onFinishChange((function(){mo(),Lo()})),Ia(de,Na,["WU"]),La(de,Oa,["WU"]),fe=H.add(O,"diffusionStrWV").onFinishChange((function(){mo(),Lo()})),Ia(fe,Na,["WV"]),La(fe,Oa,["WV"]),pe=H.add(O,"diffusionStrWW").onFinishChange((function(){mo(),Lo()})),Ia(pe,Na,["W","WW"]),La(pe,Oa,["W","WW"]),me=H.add(O,"diffusionStrWQ").onFinishChange((function(){mo(),Lo()})),Ia(me,Na,["WQ"]),La(me,Oa,["WQ"]),he=H.add(O,"diffusionStrQU").onFinishChange((function(){mo(),Lo()})),Ia(he,Na,["QU"]),La(he,Oa,["QU"]),ge=H.add(O,"diffusionStrQV").onFinishChange((function(){mo(),Lo()})),Ia(ge,Na,["QV"]),La(ge,Oa,["QV"]),be=H.add(O,"diffusionStrQW").onFinishChange((function(){mo(),Lo()})),Ia(be,Na,["QW"]),La(be,Oa,["QW"]),ve=H.add(O,"diffusionStrQQ").onFinishChange((function(){mo(),Lo()})),Ia(ve,Na,["Q","QQ"]),La(ve,Oa,["Q","QQ"]),Y=H.add(O,"reactionStrU").onFinishChange((function(){mo(),Lo()})),Ia(Y,Na,["UFUN"]),La(Y,Oa,["UFUN"]),Z=H.add(O,"reactionStrV").onFinishChange((function(){mo(),Lo()})),Ia(Z,Na,["VFUN"]),La(Z,Oa,["VFUN"]),K=H.add(O,"reactionStrW").onFinishChange((function(){mo(),Lo()})),Ia(K,Na,["WFUN"]),La(K,Oa,["WFUN"]),ee=H.add(O,"reactionStrQ").onFinishChange((function(){mo(),Lo()})),Ia(ee,Na,["QFUN"]),La(ee,Oa,["QFUN"]),At=z.addFolder("Parameters"),function(){let e,t,n=[],i=O.kineticParams.split(";");for(var o=0;o<i.length;o++)t=Go(i[o]),""==t||(t=t.replace(/(\S)=/,"$1 ="),t=t.replace(/=(\S)/,"= $1"),t=t.replaceAll(/,(\S)/g,", $1"),e="param"+nn,nn+=1,en.push(e),Kt[e]=t,n.push(e));for(const e of n)Jo(e,!1);e="param"+nn,en.push(e),Kt[e]=t,Jo(e,!0)}(),H=z.addFolder("Boundary conditions"),Re=H.add(O,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){mo(),Uo(),document.activeElement.blur()})),Le=H.add(O,"dirichletStrU").onFinishChange(mo),Je=H.add(O,"neumannStrU").onFinishChange(mo),Ke=H.add(O,"robinStrU").onFinishChange(mo),Be=H.add(O,"comboStrU").name("Details").onFinishChange(mo),ke=H.add(O,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){mo(),Uo(),document.activeElement.blur()})),Ne=H.add(O,"dirichletStrV").onFinishChange(mo),He=H.add(O,"neumannStrV").onFinishChange(mo),et=H.add(O,"robinStrV").onFinishChange(mo),je=H.add(O,"comboStrV").name("Details").onFinishChange(mo),Me=H.add(O,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){mo(),Uo(),document.activeElement.blur()})),Oe=H.add(O,"dirichletStrW").onFinishChange(mo),Xe=H.add(O,"neumannStrW").onFinishChange(mo),tt=H.add(O,"robinStrW").onFinishChange(mo),ze=H.add(O,"comboStrW").name("Details").onFinishChange(mo),Ie=H.add(O,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){mo(),Uo(),document.activeElement.blur()})),qe=H.add(O,"dirichletStrQ").onFinishChange(mo),Ye=H.add(O,"neumannStrQ").onFinishChange(mo),nt=H.add(O,"robinStrQ").onFinishChange(mo),Ge=H.add(O,"comboStrQ").name("Details").onFinishChange(mo),H=z.addFolder("Initial conditions"),Te=H.add(O,"clearValueU").onFinishChange(Eo),We=H.add(O,"clearValueV").onFinishChange(Eo),Pe=H.add(O,"clearValueW").onFinishChange(Eo),Qe=H.add(O,"clearValueQ").onFinishChange(Eo),it=G.addFolder("Images"),H=it,Ao(),H=G.addFolder("Checkpoints");const i=lr(H);ur(i,"resetFromCheckpoints","Enable checkpoints",null,"checkpointButton"),cr(i),sr(i,'<i class="fa-regular fa-flag"></i> Set',qa,null,"Set a checkpoint at the current state",["narrow"]),sr(i,'<i class="fa-regular fa-file-arrow-down"></i> Export',Ba,null,"Download the last checkpoint as a file",["narrow"]),sr(i,'<i class="fa-regular fa-file-arrow-up"></i> Import',(function(){$("#checkpointInput").click()}),null,"Upload a checkpoint file",["narrow"]),H.add(O,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize").onChange((function(){document.activeElement.blur()})),H=G.addFolder("Misc."),H.addColor(O,"backgroundColour").name("Background").onChange((function(){a.background=new pi.Color(O.backgroundColour),Ur()}));const o=lr(H);ur(o,"integrate",'<i class="fa-regular fa-chart-area"></i> Integrate',(function(){aa(),Ur()}),null,"Compute the integral of the plotted expression over the domain"),ur(o,"forceManualInterpolation",'<i class="fa-regular fa-bezier-curve"></i> Interpolate',(function(){da(),Ur()}),"interpController","Override your device's default smoothing and perform bilinear interpolation of the display"),ur(o,"fixRandSeed",'<i class="fa-regular fa-shuffle"></i> Fix seed',null,null,"Fix the random seed"),H=H.addFolder("Dev");const r=lr(H);sr(r,'<i class="fa-regular fa-copy"></i> Copy code',dr,null,"Copy the simulation configuration as JSON to the clipboard"),sr(r,'<i class="fa-regular fa-bug"></i> Copy debug',fr,null,"Copy debug information to the clipboard");let l=ci();var s;Object.keys(l).forEach((function(e){l[e]=e})),l.default=null,H.add(O,"parent",(s=l,Object.keys(s).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})).reduce((function(e,t){return e[t]=s[t],e}),{}))).name("Parent preset").onChange((function(){document.activeElement.blur()}));const u=document.createElement("div");u.innerHTML="Settings",u.classList.add("ui_title"),G.domElement.prepend(u);const c=document.createElement("div");c.innerHTML="Equations",c.classList.add("ui_title"),z.domElement.prepend(c);const d=document.createElement("div");d.id="views_list",J.domElement.prepend(d);const f=document.createElement("div");f.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",f.classList.add("ui_title"),J.domElement.prepend(f),ct=J.addFolder("Edit view"),H=ct;const p=lr(H,"edit_view_buttons");sr(p,'<i class="fa-solid fa-pen-nib"></i> Rename',Ka,null,"Rename the current view"),sr(p,'<i class="fa-solid fa-xmark"></i> Delete',er,"deleteViewButton","Delete view"),pt=H.add(O,"whatToPlot").name("Expression: ").onFinishChange((function(){To(),Ur(),nr(this.property)})),H.add(O,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){ga(),document.activeElement.blur(),Ur(),nr(this.property)})),H.add(O,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Yi(),Ko(),document.activeElement.blur(),Ur(),nr(this.property)})).name("Colour map"),Ee=H.add(O,"minColourValue").name("Min value").onChange((function(){Oi(),ea(),Ur(),nr(this.property)})),Ee.__precision=2,_e=H.add(O,"maxColourValue").name("Max value").onChange((function(){Oi(),ea(),Ur(),nr(this.property)})),_e.__precision=2;const m=lr(H,"colour_map_buttons");sr(m,'<i class="fa-regular fa-arrows-rotate"></i> Flip',(function(){O.flippedColourmap=!O.flippedColourmap,Yi(),Ko(),Ur(),nr("flippedColourmap")}),null,"Reverse colour map",["narrow"]),sr(m,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){Aa(),Ki(),nr("minColourValue"),nr("maxColourValue")}),null,"Snap min/max to visible",["narrow"]),ur(m,"colourbar",'<i class="fa-solid fa-bars-progress"></i> Bar',(function(){Ko(),nr("colourbar")}),null,"Display the colourbar",null,["narrow"]),cr(m),ur(m,"autoSetColourRange",'<i class="fa-solid fa-wand-magic-sparkles"></i> Auto snap',(function(){O.autoSetColourRange&&(Aa(),Ki()),nr("autoSetColourRange")}),null,"Automatically snap range",null,["wide"]),ur(m,"contours",'<i class="fa-solid fa-bullseye"></i> Contours',(function(){Yi(),Ur(),nr("contours")}),"contourButton","Toggle contours","contoursFolder",["wide"]),ur(m,"emboss",'<i class="fa-solid fa-lightbulb"></i> Lighting',(function(){Yi(),Ur(),nr("emboss")}),"embossButton","Toggle lighting","embossFolder",["wide"]),ur(m,"overlay",'<i class="fa-solid fa-chart-line"></i> Overlay',(function(){Yi(),Ur(),nr("overlay")}),null,"Toggle overlay","overlayFolder",["wide"]),ur(m,"vectorField",'<i class="fa-solid fa-arrow-right-arrow-left"></i> Vector field',(function(){Pr(),Ur(),nr("vectorField")}),"vectorFieldButton","Toggle vector field","vectorFieldFolder",["wide"]),H=ct.addFolder("Contours"),H.domElement.id="contoursFolder",H.addColor(O,"contourColour").name("Colour").onChange((function(){Vr(),Ur(),nr(this.property)})),Pt.push(H.add(O,"contourNum").name("Number").onChange((function(){Vr(),Ur(),nr(this.property)}))),Cr(Pt.last(),1,20,1),Pt.push(H.add(O,"contourEpsilon").name("Threshold").onChange((function(){Vr(),Ur(),nr(this.property)}))),Cr(Pt.last(),.001,.05,.001),H=ct.addFolder("Lighting"),H.domElement.id="embossFolder",Qt.push(H.add(O,"embossSmoothness").name("Smoothness").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,2,.001),Qt.push(H.add(O,"embossAmbient").name("Ambient").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,1,.001),Qt.push(H.add(O,"embossDiffuse").name("Diffuse").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,1,.001),Qt.push(H.add(O,"embossSpecular").name("Specular").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,1,.001),Qt.push(H.add(O,"embossShiny").name("Precision").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,100,1),Qt.push(H.add(O,"embossTheta").name("Inclination").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,1.5708,.001),Qt.push(H.add(O,"embossPhi").name("Direction").onChange((function(){wr(),Ur(),nr(this.property)}))),Cr(Qt.last(),0,3.1456,.001),H=ct.addFolder("Overlay"),H.domElement.id="overlayFolder",H.addColor(O,"overlayColour").name("Colour").onChange((function(){Fr(),Ur(),nr(this.property)})),H.add(O,"overlayExpr").name("Expression").onFinishChange((function(){Yi(),"line"==O.plotType&&Qo(),Ur(),nr(this.property)})),st=H.add(O,"overlayEpsilon").name("Threshold").onChange((function(){Fr(),Ur(),nr(this.property)})),ut=H.add(O,"overlayLineWidthMul",.1,2).name("Thickness").onChange((function(){Ma(),Ur(),nr(this.property)})),dt=ct.addFolder("3D"),H=dt;ur(lr(H),"customSurface",'<i class="fa-regular fa-wave-square"></i> Custom surface',(function(){q.customSurface.value=O.customSurface,_r(),Dr(),Ur(),nr("customSurface")}),"customSurfaceToggle","Plot the solution on a custom surface"),Ve=H.add(O,"surfaceFun").name("Surface $z=$ ").onFinishChange((function(){To(),Ur(),nr(this.property)})),xe=H.add(O,"threeDHeightScale").name("Height scale").onChange((function(){Oi(),Ur(),nr(this.property)})),Fe=H.add(O,"cameraTheta").name("View $\\theta$").onChange((function(){Ni(),Ur(),nr(this.property)})),Ue=H.add(O,"cameraPhi").name("View $\\phi$").onChange((function(){Ni(),Ur(),nr(this.property)})),$e=H.add(O,"cameraZoom").name("Zoom").onChange((function(){Ni(),Ur(),nr(this.property)})),Ce=H.add(O,"lineWidthMul",.1,2).name("Thickness").onChange((function(){Ma(),Ur(),nr(this.property)})),ft=ct.addFolder("Vector field"),H=ft,H.domElement.id="vectorFieldFolder",H.addColor(O,"arrowColour").name("Colour").onChange((function(){Qr(),Ur(),nr(this.property)})),H.add(O,"arrowX").onFinishChange((function(){Qo(),Ur(),nr(this.property)})).name("$x$ component"),H.add(O,"arrowY").onFinishChange((function(){Qo(),Ur(),nr(this.property)})).name("$y$ component"),rt=H.add(O,"arrowDensity").onChange((function(){Pr(),Ur(),nr(this.property)})).name("Density"),rt.__precision=2,Cr(rt,0,1,.001),H.add(O,"arrowScale",{None:"none",Relative:"relative",Auto:"auto"}).onFinishChange((function(){ko(),Ur(),nr(this.property)})).name("Scaling"),lt=H.add(O,"arrowLengthMax").onFinishChange((function(){Pr(),Ur(),nr(this.property)})).name("Max length");document.querySelectorAll("input").forEach((e=>Er(e)))}function Hi(){Yi(),Ko(),To(),Xi()}function Xi(){let e=Fa()+bn(),t="float brushRadius = "+fo(O.brushRadius.toString())+";\n";switch(t=t.replace(/\buvwq\./g,"uvwqBrush."),t=t.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),/\bRAND\b/.test(O.brushValue)&&(e+=Xn()),/\bRANDN\b/.test(O.brushValue)&&(e+=Yn()),e+="float brushValue = "+fo(O.brushValue)+";\n",e+=t,O.typeOfBrush){case"circle":e+=Sn();break;case"hline":e+=Cn();break;case"vline":e+=wn()}switch(O.brushAction){case"replace":e+=xn(),e+=vn();break;case"add":e+=xn(),e+=yn();break;case"smoothreplace":e+=Vn(),e+=vn();break;case"smoothadd":e+=Vn(),e+=yn()}e=function(e){let t=/COLOURSPEC/g;return e=e.replace(t,Fo(O.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function Yi(){L=ai(O.colourmap),O.flippedColourmap&&(L.reverse(),L=L.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),q.colour1.value=new pi.Vector4(...L[0]),q.colour2.value=new pi.Vector4(...L[1]),q.colour3.value=new pi.Vector4(...L[2]),q.colour4.value=new pi.Vector4(...L[3]),q.colour5.value=new pi.Vector4(...L[4]);let e=Fa()+Zn();O.emboss&&(e+=ei(),wr()),O.contours&&(e+=ti(),Vr()),O.overlay&&(e+=oi().replaceAll("OVERLAYEXPR",fo(O.overlayExpr)),Fr()),Q.visible=O.overlay&&"line"==O.plotType,e+=Kn(),b.fragmentShader=e,b.needsUpdate=!0,C.needsUpdate=!0,N=L.map((e=>e[3])),L=L.map((e=>e.slice(0,-1)))}function Zi(){switch(O.timesteppingScheme){case"Euler":T.material=Wt.FE,q.textureSource.value=Tt[1].texture,q.textureSource1.value=Tt[2].texture,q.dt.value=O.dt,l.setRenderTarget(Tt[0]),l.render(r,o),Tt.rotate(-1),q.t.value+=O.dt;break;case"AB2":T.material=Wt.AB2,q.textureSource.value=Tt[1].texture,q.textureSource1.value=Tt[2].texture,q.dt.value=O.dt,l.setRenderTarget(Tt[0]),l.render(r,o),Tt.rotate(-1),q.t.value+=O.dt;break;case"Mid":T.material=Wt.Mid1,q.textureSource.value=Tt[1].texture,l.setRenderTarget(Tt[2]),l.render(r,o),T.material=Wt.Mid2,q.textureSource1.value=Tt[2].texture,q.t.value+=.5*O.dt,l.setRenderTarget(Tt[0]),l.render(r,o),Tt.rotate(-1),q.t.value+=.5*O.dt;break;case"RK4":T.material=Wt.RK41,q.textureSource.value=Tt[1].texture,l.setRenderTarget(Tt[2]),l.render(r,o),T.material=Wt.RK42,q.textureSource1.value=Tt[2].texture,q.t.value+=.5*O.dt,l.setRenderTarget(Tt[3]),l.render(r,o),T.material=Wt.RK43,q.textureSource2.value=Tt[3].texture,l.setRenderTarget(Tt[4]),l.render(r,o),T.material=Wt.RK44,q.textureSource3.value=Tt[4].texture,q.t.value+=.5*O.dt,l.setRenderTarget(Tt[0]),l.render(r,o),Tt.rotate(-1)}}function Ki(){if(O.autoSetColourRange&&Aa(),O.brushEnabled&&"surface"==O.plotType){let e=0;O.maxColourValue-O.minColourValue>0&&(e=(function(){ua();let e=0;for(let t=0;t<dn.length;t+=4)e+=dn[t];return e/(xt*Vt)}()-O.minColourValue)/(O.maxColourValue-O.minColourValue)-.5,e=e.clamp(-.5,.5)),W.position.y=O.threeDHeightScale*e,W.updateWorldMatrix()}if(eo(),"line"==O.plotType){ua();let t,n=0;var e=O.maxColourValue-O.minColourValue;e=0==e?.5:e;for(let i=0;i<dn.length;i+=4)t=(dn[i]-O.minColourValue)/e-.5,k[n++]=t*Ut/$t;let i=new pi.SplineCurve(R.map(((e,t)=>new pi.Vector2(e,k[t])))),o=i.getSpacedPoints(M);if(Qa(P,o),function(e,t){let n,i=e.geometry.attributes.instanceColorStart,o=e.geometry.attributes.instanceColorEnd;for(let e=0;e<t.length;e++)n=Ra(t[e].toArray()[1]+.5),e<t.length&&i.setXYZ(e,n[0],n[1],n[2]),e>0&&o.setXYZ(e-1,n[0],n[1],n[2]);i.needsUpdate=!0}(P,o),O.overlay){n=0;for(let i=2;i<4*xt;i+=4)t=(dn[i]-O.minColourValue)/e-.5,k[n++]=t.clamp(-.5,.5)*Ut/$t;i=new pi.SplineCurve(R.map(((e,t)=>new pi.Vector2(e,k[t])))),o=i.getSpacedPoints(M),Qa(Q,o)}}if(O.vectorField&&I){pn=new Float32Array(xt*Vt*4),l.readRenderTargetPixels(f,0,0,xt,Vt,pn);let e,t,n,i=[];for(const o of I.children)e=4*o.ind,t=pn[e+2],n=pn[e+3],o.visible=pn[e+1]<=.5,o.lookAt(o.position.x+t,o.position.y+n,o.position.z),o.size=t**2+n**2,i.push(o.size);let o=1;switch(O.arrowScale){case"auto":o=Math.sqrt(Math.max(...i)),0==o&&(o=1);for(const e of I.children){const t=Zt*ka(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"relative":o=I.customMax>0?I.customMax:1;for(const e of I.children){const t=Zt*ka(.1,1.5,Math.sqrt(e.size)/o);e.scale.set(t,t,t)}break;case"none":for(const e of I.children)e.scale.set(Zt,Zt,Zt)}}if(O.timeDisplay&&oa(),O.integrate&&function(){if(O.integrate){let e;ua(),1==O.dimension?e=q.dx.value:2==O.dimension&&(e=q.dx.value*q.dy.value);let t=0;for(let e=0;e<dn.length;e+=4)t+=dn[e];t*=e,$("#integralValue").html(ta(t,4)),ca()}}(),fa()?(T.material=U,l.setRenderTarget(p),l.render(r,o),q.textureSource.value=p.texture,q.dxUpscaledScale.value=devicePixelRatio*_t/xt,q.dyUpscaledScale.value=devicePixelRatio*Dt/Vt):(q.dxUpscaledScale.value=1,q.dyUpscaledScale.value=1),l.setRenderTarget(null),l.render(a,i),mn){mn=!1;var t=document.createElement("a");t.download="VisualPDEScreenshot",l.render(a,i),t.href=l.domElement.toDataURL(),document.body.appendChild(t),t.click(),document.body.removeChild(t),Bi(),Ki()}}function eo(){T.material=C,q.textureSource.value=Tt[1].texture,l.setRenderTarget(f),l.render(r,o),q.textureSource.value=f.texture,hn=!1,q.textureSource1.value=Tt[1].texture}function to(t){ht=oo(t,e),ht&&(O.brushEnabled&&"surface"==O.plotType?u.enabled=!1:O.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Yo("#top_message"),window.clearTimeout(yt),yt=setTimeout((function(){$("#top_message").hasClass("fading_out")||Zo("#top_message")}),3e3)))}function no(e){ht=!1,"surface"==O.plotType&&(u.enabled=!0)}function io(t){oo(t,e)}function oo(e,t){var n=t.getBoundingClientRect();let o=(e.clientX-n.x)/n.width,a=1-(e.clientY-n.y)/n.height;if("surface"==O.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(W,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==O.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*xt)/xt,a=Math.round(a*Vt)/Vt,q.brushCoords.value=new pi.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function ao(){l.setSize(xt,Vt,!1),O.fixRandSeed||$o(),zt&&O.resetFromCheckpoints?T.material=E:T.material=S,Tt.forEach((e=>{l.setRenderTarget(e),l.render(r,o)})),Ja(),Ki()}function ro(){jt||($("#pause").hide(),$("#play").show()),mt=!1}function lo(){jt||($("#play").hide(),$("#pause").show()),Lt=!0,window.clearTimeout(vt),vt=setTimeout(sa,1e3),mt=!0}function so(){ao(),q.t.value=0,It=!0,oa(),Ki(),Lt=!0,window.clearTimeout(vt),sa()}function uo(){let e="";return e+="float UFUN = "+fo(O.reactionStrU)+";\n",e+="float VFUN = "+fo(O.reactionStrV)+";\n",e+="float WFUN = "+fo(O.reactionStrW)+";\n",e+="float QFUN = "+fo(O.reactionStrQ)+";\n",e}function co(e,t){let n="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return n+="float D"+t+" = "+e,n+="float D"+t+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),n+="float D"+t+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),n+="float D"+t+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),n+="float D"+t+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),n}function fo(e){if(!Xa(e=" "+e+" "))return" 0.0 ";for(e=function(e){var t=e;const n=e.matchAll(/\bI_([TS])([RGBA])\b/g);let i,o,a,r,l,s,u,c,d,f,p,m,h=0;const g={S:"One",T:"Two"},b={R:"x",G:"y",B:"z",A:"w"};for(const v of n){for(i=v.index,p=g[v[1]],m=b[v[2]],o=i+v[0].length,r=e.slice(o),d=0,u=0,c=!1;d<=r.length&(!c|!(c&&0==u));)u+=["("].includes(r[d]),u-=[")"].includes(r[d]),c|=u,d+=1;c&&0==u&&(a=d-1+o,l=t.slice(o+h+1,a+h),l=Ea(l),s=l.split(","),1!=s.length&&0!=s[1].trim().length||(s[1]="0"),s[0]="("+s[0]+")/L_x",s[1]="("+s[1]+")/L_y",f="texture(imageSource"+p+",vec2("+s.join(",")+"))."+m,t=jo(t,f,i+h,a+1+h),h+=f.length-a+i-1)}return t}(e=wa(e=(e=(e=(e=po(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,t,n){if("0"==n)return"1";const i=Number(n);return Number.isInteger(i&&i>0&&i<101)?"(("+t+")"+("*("+t+")").repeat(i-1)+")":"safepow("+t+","+n+")"}))).replaceAll(RegExp("\\b("+Ei[0]+")\\b","g"),(function(e,t){return"uvwq."+Fo(t)}))).replaceAll(RegExp("\\b("+Ei[0]+")_([xy][fb]?2?)\\b","g"),(function(e,t,n){return n.includes("2")&&(n=n.slice(0,-1).repeat(2)),"uvwq"+n.toUpperCase()+"."+Fo(t)}))).replaceAll(RegExp("\\b("+Ei[0]+")_(xx|yy)\\b","g"),(function(e,t,n){return"uvwq"+n.toUpperCase()+"."+Fo(t)}))));e!=(e=e.replace(/([^.0-9a-zA-Z])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function po(e,t,n){const i="^*".includes(t);if(e.indexOf(t)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,t){return a.push(t),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+t+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+t+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,t){return a[t].replace(o,n)}))}return e}function mo(){let e="",t="",n="",i="",o="",a="";const r=[O.boundaryConditionsU,O.boundaryConditionsV,O.boundaryConditionsW,O.boundaryConditionsQ],l=[O.neumannStrU,O.neumannStrV,O.neumannStrW,O.neumannStrQ],s=[O.comboStrU,O.comboStrV,O.comboStrW,O.comboStrQ].map((e=>e+";")),u=[O.dirichletStrU,O.dirichletStrV,O.dirichletStrW,O.dirichletStrQ],c=[O.robinStrU,O.robinStrV,O.robinStrW,O.robinStrQ];if(r.forEach((function(t,n){"neumann"==t?(e+=ho(l[n],Ui[n]),e+=ir(n)):"combo"==t&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(t){const i=t[1][0].toUpperCase();e+=ho(t[2],Ui[n],i),e+=ir(n,i)}))})),r.forEach((function(e,n){"combo"==e&&[...s[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=function(e,t,n){let i="";i+=Vo(Gn(t),Ui[e]),O.dimension>1&&(i+=Vo(Jn(t),Ui[e]));return i=i.replaceAll("GHOSTSPECIES",n),i}(n,i,fo(e[2]))}))})),O.domainViaIndicatorFun){let e=Rn().replace(/indicatorFun/g,fo(O.domainIndicatorFun));u.forEach((function(t,i){n+=Vo(e,Ui[i])+fo(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=go(u[t],Ui[t]),n+=or(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=go(e[2],Ui[t],i),n+=or(t,i)}))}));r.forEach((function(e,t){"robin"==e?(i+=ho(c[t],Ui[t]),i+=ar(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const n=e[1][0].toUpperCase();i+=ho(e[2],Ui[t],n),i+=ar(t,n)}))}));let d=Fa();if(o=function(){let e="";return e+=co(fo(O.diffusionStrUU)+";\n","uu"),e+=co(fo(O.diffusionStrVV)+";\n","vv"),e+=co(fo(O.diffusionStrWW)+";\n","ww"),e+=co(fo(O.diffusionStrQQ)+";\n","qq"),e}()+"\n",O.crossDiffusion?o+=function(){let e="";return e+=co(fo(O.diffusionStrUV)+";\n","uv"),e+=co(fo(O.diffusionStrUW)+";\n","uw"),e+=co(fo(O.diffusionStrUQ)+";\n","uq"),e+=co(fo(O.diffusionStrVU)+";\n","vu"),e+=co(fo(O.diffusionStrVW)+";\n","vw"),e+=co(fo(O.diffusionStrVQ)+";\n","vq"),e+=co(fo(O.diffusionStrWU)+";\n","wu"),e+=co(fo(O.diffusionStrWV)+";\n","wv"),e+=co(fo(O.diffusionStrWQ)+";\n","wq"),e+=co(fo(O.diffusionStrQU)+";\n","qu"),e+=co(fo(O.diffusionStrQV)+";\n","qv"),e+=co(fo(O.diffusionStrQW)+";\n","qw"),e}()+"\n"+Ln():o+=In(),sn&&O.crossDiffusion&&(a+=Vo(Nn(),Ui[1])),un&&O.crossDiffusion&&(a+=Vo(Nn(),Ui[2])),cn&&O.crossDiffusion&&(a+=Vo(Nn(),Ui[3])),o.match(/\buvwq[XY]\.[rgba]\b/))return void Ha("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");let f=[qn(),jn(),e,t,i,Bn(),zn(),uo(),o].join(" "),p=/\bRAND\b/.test(f),m=/\bRANDN\b/.test(f);p&&(f=Xn()+f),m&&(f=Yn()+f),Ot=p||m;let h=[n,a,Wn()].join(" "),g="FE";Wt[g].fragmentShader=[d,Tn(g),f,Hn(g),h].join(" "),g="AB2",Wt[g].fragmentShader=[d,Tn(g),f,Hn(g),h].join(" "),g="Mid";for(let e=1;e<3;e++)Wt[g+e.toString()].fragmentShader=[d,Tn(g+e.toString()),f,Hn(g+e.toString()),h].join(" ");g="RK4";for(let e=1;e<5;e++)Wt[g+e.toString()].fragmentShader=[d,Tn(g+e.toString()),f,Hn(g+e.toString()),h].join(" ");if(Object.keys(Wt).forEach((e=>Wt[e].needsUpdate=!0)),bt=O.domainViaIndicatorFun||"dirichlet"==O.boundaryConditionsU||"dirichlet"==O.boundaryConditionsV||"dirichlet"==O.boundaryConditionsW||"dirichlet"==O.boundaryConditionsQ||/Dirichlet/.test(O.comboStrU)||/Dirichlet/.test(O.comboStrV)||/Dirichlet/.test(O.comboStrW)||/Dirichlet/.test(O.comboStrQ),bt){if(n=d+On(),O.domainViaIndicatorFun){let e=Rn().replace(/indicatorFun/g,fo(O.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(t,i){n+=Vo(e,Ui[i])+fo(t)+";\n}\n"}))}else r.forEach((function(e,t){"dirichlet"==e?(n+=go(u[t],Ui[t]),n+=rr(t)):"combo"==e&&[...s[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=go(e[2],Ui[t],i),n+=rr(t,i)}))}));n+="}",y.fragmentShader=n,y.needsUpdate=!0}}function ho(e,t,n){return null==n?["L","R","T","B"].map((n=>ho(e,t,n))).join(""):"float robinRHS"+t+n+" = "+fo(e)+";\n"}function go(e,t,n){return null==n?["L","R","T","B"].map((n=>go(e,t,n))).join(""):"float dirichletRHS"+t+n+" = "+fo(e)+";\n"}function bo(e){vo("default"),vo(e),null!=O.threeD&&(O.threeD&&(O.dimension=2,O.plotType="surface"),delete O.threeD),null!=O.oneDimensional&&(O.oneDimensional&&(O.dimension=1,O.plotType="line"),delete O.oneDimensional),Xt*=Yt,function(){if(0==O.views.length){let e=tr();e.name="1",O.views.push(e)}else O.views=O.views.map((function(e){let t=tr();return Object.assign(t,e),t}));St=O.views}(),So(z,!0),So(G,!0),So(J,!0),Ji(),O.activeViewInd<O.views.length?Za(O.views[O.activeViewInd],!1):Za({},!0),Io(),Gi(),Ii(),Oi(),a.background=new pi.Color(O.backgroundColour),""!=O.initialState?fetch(O.initialState).then((e=>e.blob())).then((e=>ja(e))):so(),Ni(),ot.remove(),at.remove(),Ao(),da()}function vo(e){let t;t=null==e?li(O.preset):"string"==typeof e?li(e):"object"==typeof e?e:li("default"),t.hasOwnProperty("parent")&&null!=t.parent&&vo(t.parent),nn=0,en=[],Kt={},Object.assign(O,t),mt=O.runningOnLoad,Wa(),mt?lo():ro(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?O.tryClickingText=O.tryClickingText.replaceAll("clicking","tapping"):O.tryClickingText=O.tryClickingText.replaceAll("tapping","clicking"),O.brushRadius=O.brushRadius.toString(),O.hasOwnProperty("drawIn3D")&&(O.brushEnabled=O.drawIn3D);var n=0;n+=O.hasOwnProperty("algebraicV"),n+=O.hasOwnProperty("algebraicW"),(n+=O.hasOwnProperty("algebraicQ"))&&!O.numAlgebraicSpecies&&(O.numAlgebraicSpecies=n),delete O.algebraicV,delete O.algebraicW,delete O.algebraicQ,null==O.minColourValue&&(O.minColourValue=0),null==O.maxColourValue&&(O.maxColourValue=1),O.domainScale=O.domainScale.toString(),O.spatialStep=O.spatialStep.toString(),j=JSON.parse(JSON.stringify(O));let i=[O.clearValueU,O.clearValueV,O.clearValueW,O.clearValueQ,O.domainIndicatorFun,O.reactionStrU,O.reactionStrV,O.reactionStrW,O.reactionStrQ,O.diffusionStrUU,O.diffusionStrUV,O.diffusionStrUW,O.diffusionStrUQ,O.diffusionStrVU,O.diffusionStrVV,O.diffusionStrVW,O.diffusionStrVQ,O.diffusionStrWU,O.diffusionStrWV,O.diffusionStrWW,O.diffusionStrWQ,O.diffusionStrQU,O.diffusionStrQV,O.diffusionStrQW,O.diffusionStrQQ,O.dirichletStrU,O.dirichletStrV,O.dirichletStrW,O.dirichletStrQ,O.robinStrU,O.robinStrV,O.robinStrW,O.robinStrQ,O.comboStrU,O.comboStrV,O.comboStrW,O.comboStrQ,O.neumannStrU,O.neumannStrV,O.neumannStrW,O.neumannStrQ,O.brushValue,O.whatToPlot].join(" ");O.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function yo(e,t){if(null==t&&(t=!0),null!=e){for(let t in e.__folders)yo(e.__folders[t],!1);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].updateDisplay()}t&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function So(e,t){if(null!=e){for(let t in e.__folders)So(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let t=0;t<e.__controllers.length;t++)e.__controllers[t].remove();null!=t&&t&&(e.domElement.remove(),e.destroy())}}function wo(e){null!=e&&(e.__li.style.display="none")}function Co(e){null!=e&&(e.__li.style.display="")}function xo(e,t,n){null!=e&&(e.name(t),null!=n&&e.title(n))}function Vo(e,t){if(0==t.length)return"";let n=/\bSPECIES\b/g,i=Fo(t);return e=e.replace(n,i),n=/\brobinRHSSPECIES/g,e=e.replace(n,"robinRHS"+t),n=/\bdirichletRHSSPECIES/g,e=e.replace(n,"dirichletRHS"+t)}function Fo(e){return"rgba"[function(e){return Ui.indexOf(e)}(e)]}function Uo(){"dirichlet"==O.boundaryConditionsU?Co(Le):wo(Le),"dirichlet"==O.boundaryConditionsV?Co(Ne):wo(Ne),"dirichlet"==O.boundaryConditionsW?Co(Oe):wo(Oe),"dirichlet"==O.boundaryConditionsQ?Co(qe):wo(qe),"neumann"==O.boundaryConditionsU?Co(Je):wo(Je),"neumann"==O.boundaryConditionsV?Co(He):wo(He),"neumann"==O.boundaryConditionsW?Co(Xe):wo(Xe),"neumann"==O.boundaryConditionsQ?Co(Ye):wo(Ye),"robin"==O.boundaryConditionsU?Co(Ke):wo(Ke),"robin"==O.boundaryConditionsV?Co(et):wo(et),"robin"==O.boundaryConditionsW?Co(tt):wo(tt),"robin"==O.boundaryConditionsQ?Co(nt):wo(nt),"combo"==O.boundaryConditionsU?Co(Be):wo(Be),"combo"==O.boundaryConditionsV?Co(je):wo(je),"combo"==O.boundaryConditionsW?Co(ze):wo(ze),"combo"==O.boundaryConditionsQ?Co(Ge):wo(Ge),O.domainViaIndicatorFun?(wo(Re),wo(ke),wo(Me),wo(Ie)):Co(Re)}function $o(){q.seed.value=performance.now()%1e6/1e6}function Eo(){let e=Fa()+fi(),t=[O.clearValueU,O.clearValueV,O.clearValueW,O.clearValueQ].join(" ");/\bRAND\b/.test(t)&&(e+=Xn()),/\bRANDN\b/.test(t)&&(e+=Yn()),e+="float u = "+fo(O.clearValueU)+";\n",e+="float v = "+fo(O.clearValueV)+";\n",e+="float w = "+fo(O.clearValueW)+";\n",e+="float q = "+fo(O.clearValueQ)+";\n",e+=di(),S.fragmentShader=e,S.needsUpdate=!0}function _o(){let e=new Image;e.src=ot.__image.src;let t=new pi.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,q.imageSourceOne.value=t,O.resetOnImageLoad&&so()}}function Do(){let e=new Image;e.src=at.__image.src;let t=new pi.Texture;t.image=e,e.onload=function(){t.needsUpdate=!0,q.imageSourceTwo.value=t,O.resetOnImageLoad&&so()},t.dispose()}function Ao(){H=it,ot=H.addImage(O,"imagePathOne").name("$I_S(x,y)$").onChange(_o),at=H.addImage(O,"imagePathTwo").name("$I_T(x,y)$").onChange(Do),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function To(){"MAX"==O.whatToPlot?(C.fragmentShader=$n()+_n().replace(/indicatorFun/g,fo(O.domainIndicatorFun))+En(),C.needsUpdate=!0,O.minColourValue=0,O.maxColourValue=1,Oi(),wo(Ee),wo(_e),wo(De),wo(Ae),O.autoSetColourRange=!1,yo(G)):(Qo(),Co(Ee),Co(_e),Co(De),Co(Ae)),Ko(),aa()}function Wo(e,t){return Object.fromEntries(Object.entries(e).filter((([e,n])=>JSON.stringify(t[e])!==JSON.stringify(n))))}function Po(){ua();let e=1/0,t=-1/0;for(let n=0;n<dn.length;n+=4)e=Math.min(e,dn[n]),t=Math.max(t,dn[n]);return[e,t]}function Qo(){let e=Fa()+Fn();e+=Un().replace(/\bXVECFUN\b/,fo(O.arrowX)).replace(/\bYVECFUN\b/,fo(O.arrowY)),e=function(e){let t=/\bFUN\b/g;return e=e.replace(t,fo(O.whatToPlot)),t=/\bHEIGHT\b/g,e.replace(t,fo(O.surfaceFun))}(e),O.domainViaIndicatorFun&&(e+=_n().replace(/indicatorFun/g,fo(O.domainIndicatorFun))),e=e.replaceAll("OVERLAYEXPR",fo(O.overlayExpr)),Fr(),C.fragmentShader=e+En(),C.needsUpdate=!0}function Ro(){O.numAlgebraicSpecies=Math.min(parseInt(O.numAlgebraicSpecies),parseInt(O.numSpecies)-1),sn=O.numAlgebraicSpecies>=O.numSpecies-1,un=O.numAlgebraicSpecies>=O.numSpecies-2&&O.numSpecies>=3,cn=O.numAlgebraicSpecies>=O.numSpecies-3&&O.numSpecies>=4}function ko(){let e="function of "+Ui.slice(0,O.numSpecies).join(", ")+", x, y, t",t=e.replace(" "+Ui[1]+",",""),i=e.replace(" "+Ui[2]+",",""),o=e.replace(" "+Ui[3]+",","");switch(1==O.dimension&&(e=e.replace(" y,","")),O.crossDiffusion&&parseInt(O.numSpecies)>1?(Jt||Ta(te,Array.from(Array(parseInt(O.numSpecies)).keys())),Co(te)):wo(te),O.numSpecies>1?$("#cross_diffusion_controller").show():$("#cross_diffusion_controller").hide(),wo(oe),wo(le),wo(se),wo(Z),wo(We),wo(ke),wo(ae),wo(ue),wo(de),wo(fe),wo(pe),wo(K),wo(Pe),wo(Me),wo(re),wo(ce),wo(me),wo(he),wo(ge),wo(be),wo(ve),wo(ee),wo(Qe),wo(Ie),parseInt(O.numSpecies)){case 4:O.crossDiffusion?(Co(re),Co(ce),Co(me),Co(he),Co(ge),Co(be)):(wo(me),wo(he),wo(ce),wo(re),wo(ge),wo(be)),Co(ve),Co(ee),Co(Qe),Co(Ie);case 3:O.crossDiffusion?(Co(ae),Co(ue),Co(de),Co(fe)):(wo(ae),wo(ue),wo(de),wo(fe)),Co(pe),Co(K),Co(Pe),Co(Me);case 2:O.crossDiffusion?(Co(oe),Co(le)):(wo(oe),wo(le)),Co(se),Co(Z),Co(We),Co(ke)}O.crossDiffusion?(xo(ie,Di.Duu,e),xo(oe,Di.Duv,e),xo(ae,Di.Duw,e),xo(re,Di.Duq,e),xo(le,Di.Dvu,e),xo(se,Di.Dvv,e),xo(ue,Di.Dvw,e),xo(ce,Di.Dvq,e),xo(de,Di.Dwu,e),xo(fe,Di.Dwv,e),xo(pe,Di.Dww,e),xo(me,Di.Dwq,e),xo(he,Di.Dqu,e),xo(ge,Di.Dqv,e),xo(be,Di.Dqw,e),xo(ve,Di.Dqq,e)):(xo(ie,Di.Du,e),xo(se,Di.Dv,e),xo(pe,Di.Dw,e),xo(ve,Di.Dq,e)),xo(Y,Di.UFUN,e),xo(Z,Di.VFUN,e),xo(K,Di.WFUN,e),xo(ee,Di.QFUN,e),sn&&(xo(le,Di.Dvu,t),xo(ue,Di.Dvw,t),xo(ce,Di.Dvq,t),xo(Z,Di.VFUN,t),wo(se)),un&&(xo(de,Di.Dwu,o),xo(fe,Di.Dwv,o),xo(me,Di.Dwq,o),xo(K,Di.WFUN,o),wo(pe)),cn&&(xo(he,Di.Dqu,i),xo(ge,Di.Dqv,i),xo(be,Di.Dqw,i),xo(ee,Di.QFUN,i),wo(ve)),xo(Re,Di.u),xo(ke,Di.v),xo(Me,Di.w),xo(Ie,Di.q),xo(Le,Di.uD),xo(Ne,Di.vD),xo(Oe,Di.wD),xo(qe,Di.qD),xo(Je,Di.uN),xo(He,Di.vN),xo(Xe,Di.wN),xo(Ye,Di.qN),xo(Ke,Di.uN),xo(et,Di.vN),xo(tt,Di.wN),xo(nt,Di.qN),xo(Te,Di.uInit),xo(We,Di.vInit),xo(Pe,Di.wInit),xo(Qe,Di.qInit),O.domainViaIndicatorFun?Co(ne):wo(ne),Uo(),"surface"==O.plotType?($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").hide(),dt.name="3D options",dt.domElement.classList.remove("hidden"),O.customSurface&&Co(Ve),wo(Ce),Co(xe),Co(Fe),Co(Ue),Co($e)):"line"==O.plotType?($("#contourButton").hide(),$("#embossButton").hide(),$("#vectorFieldButton").hide(),dt.name="Line options",dt.domElement.classList.remove("hidden"),Co(Ce),Co(xe),wo(Fe),wo(Ue),wo($e)):($("#contourButton").show(),$("#embossButton").show(),$("#vectorFieldButton").show(),dt.domElement.classList.add("hidden"),wo(Ce),wo(xe),wo(Fe),wo(Ue),wo($e)),1==O.dimension&&$("#vectorFieldButton").hide(),Ko(),ia(),aa(),$("#dataContainer").show(),Dr(),"line"==O.plotType?(wo(X),$(":root").css("--ui-button-outline","black")):(Co(X),$(":root").css("--ui-button-outline","white")),n?$("#interpController").hide():$("#interpController").show(),"relative"==O.arrowScale?Co(lt):wo(lt),Ta(we,Ui.slice(0,O.numSpecies)),xr(),O.autoPause?Co(Se):wo(Se),"line"==O.plotType?(wo(st),Co(ut)):(Co(st),wo(ut)),$(".toggle_button").each((function(){$r(this)})),Ya(),yo(z),yo(G),yo(J)}function Mo(){let e;switch(Ro(),O.domainViaIndicatorFun&&(O.boundaryConditionsU="dirichlet",O.boundaryConditionsV="dirichlet",O.boundaryConditionsW="dirichlet",O.boundaryConditionsQ="dirichlet"),parseInt(O.numSpecies)){case 1:O.crossDiffusion=!1,O.whatToDraw=Ui[0],O.whatToPlot=Ui[0],O.diffusionStrUV="0",O.diffusionStrUW="0",O.diffusionStrUQ="0",O.diffusionStrVU="0",O.diffusionStrVV="0",O.diffusionStrVW="0",O.diffusionStrVQ="0",O.diffusionStrWU="0",O.diffusionStrWV="0",O.diffusionStrWW="0",O.diffusionStrWQ="0",O.diffusionStrQU="0",O.diffusionStrQV="0",O.diffusionStrQW="0",O.diffusionStrQQ="0",O.boundaryConditionsV="periodic",O.clearValueV="0",O.reactionStrV="0",O.boundaryConditionsW="periodic",O.clearValueW="0",O.reactionStrW="0",O.boundaryConditionsQ="periodic",O.clearValueQ="0",O.reactionStrQ="0",e=new RegExp("\\b("+Ei[1]+")\\b"),e.test(O.reactionStrU)&&(O.reactionStrU="0");break;case 2:O.whatToDraw==Ui[2]|O.whatToDraw==Ui[3]&&(O.whatToDraw=Ui[0]),O.whatToPlot==Ui[2]|O.whatToPlot==Ui[3]&&(O.whatToPlot=Ui[0]),O.diffusionStrUW="0",O.diffusionStrUQ="0",O.diffusionStrVW="0",O.diffusionStrVQ="0",O.diffusionStrWU="0",O.diffusionStrWV="0",O.diffusionStrWW="0",O.diffusionStrWQ="0",O.diffusionStrQU="0",O.diffusionStrQV="0",O.diffusionStrQW="0",O.diffusionStrQQ="0",O.boundaryConditionsW="periodic",O.clearValueW="0",O.reactionStrW="0",O.boundaryConditionsQ="periodic",O.clearValueQ="0",O.reactionStrQ="0",e=new RegExp("\\b("+Ei[2]+")\\b"),e.test(O.reactionStrU)&&(O.reactionStrU="0"),e.test(O.reactionStrV)&&(O.reactionStrV="0");break;case 3:O.whatToDraw==Ui[3]&&(O.whatToDraw=Ui[0]),O.whatToPlot==Ui[3]&&(O.whatToPlot=Ui[0]),O.diffusionStrUQ="0",O.diffusionStrVQ="0",O.diffusionStrWQ="0",O.diffusionStrQU="0",O.diffusionStrQV="0",O.diffusionStrQW="0",O.diffusionStrQQ="0",O.boundaryConditionsQ="periodic",O.clearValueQ="0",O.reactionStrQ="0",e=new RegExp("\\b("+Ei[3]+")\\b"),e.test(O.reactionStrU)&&(O.reactionStrU="0"),e.test(O.reactionStrV)&&(O.reactionStrV="0"),e.test(O.reactionStrW)&&(O.reactionStrW="0")}switch(ln){case 3:O.diffusionStrVV="0";break;case 6:O.diffusionStrWW="0";break;case 7:O.diffusionStrVV="0",O.diffusionStrWW="0";break;case 10:O.diffusionStrQQ="0";break;case 11:O.diffusionStrWW="0",O.diffusionStrQQ="0";break;case 12:O.diffusionStrVV="0",O.diffusionStrWW="0",O.diffusionStrQQ="0"}yo(z),yo(G)}function Io(){!function(){switch(Ro(),parseInt(O.numSpecies)){case 1:ln=0;break;case 2:ln=O.crossDiffusion?1==O.numAlgebraicSpecies?3:2:1;break;case 3:if(O.crossDiffusion)switch(O.numAlgebraicSpecies){case 0:ln=5;break;case 1:ln=6;break;case 2:ln=7}else ln=4;break;case 4:if(O.crossDiffusion)switch(O.numAlgebraicSpecies){case 0:ln=9;break;case 1:ln=10;break;case 2:ln=11;break;case 3:ln=12}else ln=8}}(),ga(),ba(),Mo(),ko(),xa(),$a(),Lo()}function Lo(){let e,t=_i[ln];const n={U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(O.typesetCustomEqs){let o={};o.U=O.diffusionStrUU,o.UU=O.diffusionStrUU,o.V=O.diffusionStrVV,o.VV=O.diffusionStrVV,o.W=O.diffusionStrWW,o.WW=O.diffusionStrWW,o.Q=O.diffusionStrQQ,o.QQ=O.diffusionStrQQ,o.UV=O.diffusionStrUV,o.UW=O.diffusionStrUW,o.UQ=O.diffusionStrUQ,o.VU=O.diffusionStrVU,o.VW=O.diffusionStrVW,o.VQ=O.diffusionStrVQ,o.WU=O.diffusionStrWU,o.WV=O.diffusionStrWV,o.WQ=O.diffusionStrWQ,o.QU=O.diffusionStrQU,o.QV=O.diffusionStrQV,o.QW=O.diffusionStrQW,o.UFUN=O.reactionStrU,o.VFUN=O.reactionStrV,o.WFUN=O.reactionStrW,o.QFUN=O.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Xa(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=Pa(o[e],Ui,on,"_(?:[xy][xybf]?)")})),Rt.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){an.includes(e)||(t=function(e,t,n,i){let o=n.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(t,"");if("1"==o||"1.0"==o)return e.replaceAll(t,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(t,"-$2");if(n.match(/[a-zA-Z]/))return n.match(/[\+-]/)&&null!=i?e.replaceAll(t,i[0]+n+i[1]+"$2"):e.replaceAll(t,n+"$2");return e}(t,n[e],o[e],"[]"))})),t=ha(t,n.UFUN,o.UFUN),t=ha(t,n.VFUN,o.VFUN),t=ha(t,n.WFUN,o.WFUN),t=ha(t,n.QFUN,o.QFUN),e=/\(\s*\+/g;t!=(t=t.replace(e,"(")););for(e=/\[\s*\+/g;t!=(t=t.replace(e,"[")););for(e=/\+\s*\)/g;t!=(t=t.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,t=t.replaceAll(e,""),e=/=\s*\+/g,t=t.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,t=t.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,t=t.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,t=t.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,t=t.replaceAll(e,(function(e,t,n){return/\b[xy]|[uvwq]\b/g.test(t)?e:t+" \\lap "+n})),e=/(\(?)\b([uvwq])_([xy])[fb]?2?\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pd{"+n+"}{"+i+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/(\(?)\b([uvwq])_(xx|yy)\s*(\)?)\s*(\^?)\b/g,t=t.replaceAll(e,(function(e,t,n,i,o,a){let r=t+"\\textstyle \\pdd{"+n+"}{"+i[0]+"\\vphantom{y}}"+o;return""==a||""!=t&&""!=o?r+=a:r="("+r+")"+a,r})),e=/\bRAND\b/g,t=t.replaceAll(e,"\\mathcal{U}"),e=/\bRANDN\b/g,t=t.replaceAll(e,"\\mathcal{Z}")}else Rt.forEach((function(e){t=t.replaceAll(n[e],(function(e,t,n){let i="\\selected{ "+t+" ";return"string"==typeof n&&(i+=n),i+" }"}))})),t=Pa(t,["UFUN","VFUN","WFUN","QFUN"],an);1==O.dimension&&(t=t.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,t=t.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),t=Pa(t,on.concat(an),Ui.concat($i),"_(?:[xy][xybf]?)"),t=No(t),$("#typeset_equation").html(t),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(_a)}function No(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Oo(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Oo(e,"cos",!0),e=Oo(e,"tan",!0),e=Oo(e,"exp",!0),e=Oo(e,"log",!0),e=Oo(e,"sqrt",!1),e=Oo(e,"sinh",!0),e=Oo(e,"cosh",!0),e=Oo(e,"tanh",!0),e=Oo(e,"max",!0),e=po(e=(e=Oo(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=(e=function(e){const t=["(","["],n=[")","]"];let i=0,o=0,a=0,r="",l="";for(var s=0;s<e.length;s++)t.includes(e[s])?(i+=1,o+=1):n.includes(e[s])&&(i-=1),0==i&&o>0&&(r=e.slice(a,s+1),l+=qo(r,o),o=0,a=s+1);return l+=e.slice(a),l}(e=Fi(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")).replaceAll(/\b([a-zA-Z]+)([0-9]+)\b/g,"$1_{$2}")}function Oo(e,t,n){var i=e;const o=e.matchAll(new RegExp("\\b"+t+"\\b","g"));let a,r,l,s,u,c,d,f=0;for(const p of o){for(a=p.index,r=a+t.length,s=e.slice(r),d=0,u=0,c=!1;d<=s.length&(!c|!(c&&0==u));)u+=["(","["].includes(s[d]),u-=[")","]"].includes(s[d]),c|=u,d+=1;c&&0==u&&(l=d-1+r,i=zo(i,"\\",a+f),f+=1,n?(i=zo(i,"{",r+f),f+=1,i=zo(i,"}",l+1+f),f+=1):(i=jo(i,"{",r+f),i=jo(i,"}",l+f)))}return i}function qo(e,t){const n=["(","["],i=[")","]"];let o=Bo(1-t,n.length);for(var a=0;a<e.length;a++)n.includes(e[a])?(e=jo(e,n[o],a),o+=1,o=Bo(o,n.length)):i.includes(e[a])&&(o-=1,o=Bo(o,n.length),e=jo(e,i[o],a));return e}function Bo(e,t){return(e%t+t)%t}function jo(e,t,n,i){return null==i&&(i=n+1),e.slice(0,n)+t+e.slice(i,e.length)}function zo(e,t,n){return e.slice(0,n)+t+e.slice(n,e.length)}function Go(e){return e=e.replace(/\s+/g,"  ").trim()}function Jo(e,t){let n;function i(){n.hasOwnProperty("slider")&&(n.slider.remove(),delete n.slider,n.domElement.closest("li").classList.remove("parameterSlider"));let t=Kt[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(t){let i;n.domElement.parentElement.parentElement.classList.add("parameterSlider"),n.slider=document.createElement("input"),n.slider.classList.add("styled-slider"),n.slider.classList.add("slider-progress"),n.slider.type="range",n.slider.min=t[3],n.slider.max=t[5],null==t[4]?(t[4]="",n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=Math.min((parseFloat(t[5])-parseFloat(t[3]))/20,10**-n.slider.precision)):(n.slider.precision=Math.max(parseFloat(t[2]).countDecimals(),parseFloat(t[3]).countDecimals(),parseFloat(t[4]).countDecimals(),parseFloat(t[5]).countDecimals())+1,i=t[4],t[4]+=", "),n.slider.precision=Math.max(n.slider.precision,parseFloat(i).countDecimals()),n.slider.step=i.toString(),n.slider.value=t[2],n.slider.addEventListener("input",(function(){n.slider.style.setProperty("--value",n.slider.value);Kt[e]=Kt[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,t[1]+" = "+parseFloat(n.slider.value).toFixed(n.slider.precision).toString()+" "),yo(At),Ho(),Ki(),(xa()||Bt)&&(Bt=!1,$a())})),n.__oldOnFinishChange=n.onFinishChange,n.onFinishChange=function(){n.__oldOnFinishChange(),n.slider.value=t[2]},n.slider.style.setProperty("--value",n.slider.value),n.slider.style.setProperty("--min",n.slider.min),n.slider.style.setProperty("--max",n.slider.max),n.domElement.appendChild(n.slider)}}if(t)en.push(e),Kt[e]="",n=At.add(Kt,e).name(""),Er(n.domElement),n.domElement.classList.add("params"),n.onFinishChange((function(){const t=en.indexOf(e);let n=Go(Kt[en.at(t)]);if(""==n);else{let e=Jo(en.at(t),!1);const i=n.match(/\s*(\w+)\s*=/);if(i){let t=i[1];Rr(t),e.lastName=t,tn[t]=e}nn+=1;let o="params"+nn;this.remove(),Jo(o,!0),Ho(),(xa()||Bt)&&(Bt=!1,$a())}}));else{n=At.add(Kt,e).name(""),Er(n.domElement),n.domElement.classList.add("params");const t=Kt[e].match(/\s*(\w+)\s*=/);if(t){let e=t[1];Rr(e),n.lastName=e,tn[e]=n}n.onFinishChange((function(){let t=Go(Kt[e]);if(""==t){n.domElement.closest("li").hasOwnProperty("parameterSlider")&&(n.slider.remove(),n.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const t=en.indexOf(e);en.splice(t,1),delete Kt[e],n.hasOwnProperty("lastName")&&!ma(n.lastName)&&delete q[n.lastName]}else{i();const e=Ea(t).match(/\s*(\w+)\s*=/);if(e){let t=e[1];Rr(t),n.hasOwnProperty("lastName")&&n.lastName!=t&&!ma(n.lastName)&&(delete q[n.lastName],n.lastName=t,tn[t]=n)}}Ho(),xa()&&$a()})),Ho(),xa()&&$a()}return i(),n}function Ho(){O.kineticParams=Object.values(Kt).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Xo(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Yo(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function Zo(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Ko(){if(O.colourbar){$("#colourbar").show();let t="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)t+="rgb("+Ra(e).map((e=>255*e))+") "+100*e+"%,";t=t.slice(0,-1)+")",$("#colourbar").css("background",t),"MAX"==O.whatToPlot?($("#minLabel").html("$"+Ui[0]+"$"),$("#midLabel").html("$"+Ui[1]+"$"),$("#maxLabel").html("$"+Ui[2]+"$")):Nt?$("#midLabel").html(O.views[O.activeViewInd].name.replaceAll(/\s*<br \/>\s*/g," ")):$("#midLabel").html("$"+No(O.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),ya(),ea()}else $("#colourbar").hide()}function ea(){if("MAX"!=O.whatToPlot){let e,t;[e,t]=function(e,t){const n=3;if(Math.abs(e)<.001&&Math.abs(t)<.001)return[e.toExponential(n-1),t.toExponential(n-1)];return[na(e,n),na(t,n)]}(O.minColourValue,O.maxColourValue);const n=/[1-9]/;n.test(e)||(e="0"),n.test(t)||(t="0"),$("#minLabel").html(e),$("#maxLabel").html(t)}let e=Da(Ra(0)),t=Da(Ra(.5)),n=Da(Ra(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),t<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),n<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function ta(e,t){return e.toPrecision(t)}function na(e,t){const n=e.toFixed(t),i=e.toPrecision(t);return n.length<i.length?n:i}function ia(){O.timeDisplay?($("#timeDisplay").show(),oa()):$("#timeDisplay").hide(),la()}function oa(){if(O.timeDisplay){let e=ta(q.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," × 10<sup>$2$3<sup>"),$("#timeValue").html(e),ca()}}function aa(){if(O.integrate){$("#integralDisplay").show();let e="";1==O.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+No(O.whatToPlot)+"\\,\\d x",1==O.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();la()}function ra(e,t){$(e).css("bottom",""),$(e).css("bottom","+="+t.toString())}function la(){O.integrate&&O.timeDisplay?ra("#timeDisplay",10):ra("#timeDisplay",0)}function sa(){let e=Po();!Lt||isFinite(e[0])&&isFinite(e[1])?vt=setTimeout(sa,1e3):(Lt=!1,Yo("#oops_hit_nan"),ro(),$("#oops_hit_nan").one("click",(function(){Zo("#oops_hit_nan"),Lt=!0})),$("#erase").one("pointerdown",(function(){Zo("#oops_hit_nan"),Lt=!0,window.clearTimeout(vt),vt=setTimeout(sa,1e3)})))}function ua(){if(!hn){try{l.readRenderTargetPixels(f,0,0,xt,Vt,dn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}hn=!0}}function ca(){if(O.colourbar&&O.integrate|O.timeDisplay){let e,t=$("#colourbar")[0].getBoundingClientRect();e=O.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let n=e.getBoundingClientRect();t.right>=n.left?t.top<=n.bottom&&(ra("#dataContainer",40),qt=!0):qt&&(ra("#dataContainer",0),qt=!1)}}function da(){fa()?(Tt.forEach((e=>{e.texture.magFilter=pi.NearestFilter})),f.texture.magFilter=pi.NearestFilter,p.texture.magFilter=pi.NearestFilter):(Tt.forEach((e=>{e.texture.magFilter=pi.LinearFilter})),f.texture.magFilter=pi.LinearFilter,p.texture.magFilter=pi.LinearFilter),ko()}function fa(){return n||O.forceManualInterpolation}function pa(e,t,n){return new Promise((function(i,o){var a=o=>{e.removeEventListener(t,a),i(n)};e.addEventListener(t,a)}))}function ma(e,t){return null==t&&(t=[]),function(e){return[...(Tn()+Ln()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(t).some((function(t){return new RegExp("\\b"+t+"\\b","g").test(e)}))}function ha(e,t,n){return"0"==n.replace(/\s+/g,"  ").trim()?e.replaceAll(t,""):n.match(/[a-zA-Z]/)?e.replaceAll(t,n):e}function ga(){"line"==O.plotType?(Ma(),O.typeOfBrush="vline",Xi(),yo(G),A.visible=!1,P.visible=!0,O.contours=!1,O.emboss=!1,O.vectorField=!1,Pr()):(A.visible=!0,P.visible=!1,"surface"==O.plotType?($("#simCanvas").css("outline","2px #000 solid"),Ht&&(Ht=!1,Li()),O.vectorField=!1,Pr()):$("#simCanvas").css("outline","")),Q.visible=O.overlay&&"line"==O.plotType,Yi(),Ni(),ko()}function ba(){kt||(1!=O.dimension&&"line"==O.plotType&&(O.plotType="plane",nr("plotType"),ga()),1==O.dimension&&"line"!=O.plotType&&(O.plotType="line",O.vectorField=!1,nr("plotType"),ga())),Ii(),mo(),Lo(),ko(),aa()}function va(){const e=(new pi.Vector3).setFromSphericalCoords(1,Math.PI/2-O.cameraTheta*Math.PI/180,-O.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function ya(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function Sa(){return O.kineticParams.replaceAll(/\bin[^;]*;?/g,";")}function wa(e){return Ea(e)}function Ca(){const e=/^\s*(\w+)\b/;let t=[];return Sa().split(";").filter((e=>e.length>0)).forEach((function(n){n.match(e)&&t.push(n.match(e)[1].trim())})),t}function xa(){const e=function(e){let t={},n={},i=[];e.forEach((function(e){const[n,i]=e.split("=").map((e=>e.trim()));t[n]=i}));const o=e.map((e=>e.split("=").map((e=>e.trim())))),a=o.map((e=>e[0]));for(const e of o){let[o,r]=e;o in n||([n,,i]=Ua(o,t,n,[o],a,[]))}i.length>0&&Ha("Cyclic parameters detected. Please check the definition(s) of "+i.join(", ")+".");return Object.keys(n).map((e=>[e,n[e]]))}(Sa().split(";").filter((e=>e.length>0))),t=function(e){const t={};let n=[];return e.forEach((e=>t[e]?n.push(e):t[e]=!0)),Array.from(new Set(n))}(Ca());if(t.length>0)return Ha("It looks like there are multiple definitions of '"+t.join("', '")+"'. Please check your parameters to ensure everything has a unique definition."),!1;let n=!1,i=!1;for(const t of e){let[e,o]=Va(t[0],t[1]);n|=e,i|=o}return n&&!i}function Va(e,t){let n=!1,i=!1;const o=wa(e);return ma(o)?(Ha("The name '"+e+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+e+"."),i=!0):(n=!q.hasOwnProperty(o),q[o]={type:"float",value:t}),[n,i]}function Fa(){return wa(Ca().map((e=>"uniform float "+e+";")).join("\n"))}function Ua(e,t,n,i,o,a){if(e in n)return[n,i.slice(0,-1),a];let r;for(const l of o)r=new RegExp("\\b"+l+"\\b","g"),r.test(t[e])&&(i.includes(l)?(n[l]=0,t[l]="0",t[e]="0",a.push(l)):([n,,a]=Ua(l,t,n,[...i,l],o,a),t[e]=t[e].replaceAll(r,n[l].toString())));try{n[e]=Ti.evaluate(t[e])}catch(t){Ha("Unable to evaluate the definition of "+e+". Please check for syntax errors or undefined parameters."),n[e]=0}return[n,i.slice(0,-1),a]}function $a(){mo(),Eo(),Xi(),To(),Hi(),Qo()}function Ea(e){let t,n=e;for(let e=0;e<10;e++)for(t=new RegExp("([a-zA-Z_]+[0-9]*)("+e.toString()+")","g");n!=(n=n.replace(t,"$1"+gn[e])););return n}function _a(){const e=$("#equation_display div mjx-container").children("mjx-math");var t;e.css("font-size","");var n=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);n<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)t=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",t),n+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function Da(e){return e.reduce(((e,t)=>e+t),0)/3}function Aa(){let e=Po();O.minColourValue=e[0],O.maxColourValue=e[1],q.maxColourValue.value=O.maxColourValue,q.minColourValue.value=O.minColourValue,_e.updateDisplay(),Ee.updateDisplay(),ea()}function Ta(e,t,n){null==n&&(n=t);let i="";for(var o=0;o<t.length;o++){i+="<option value='"+n[o].toString()+"'>"+t[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function Wa(){let e;null!=Ui&&(e=Ui);const t=O.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,on.length),n=t.concat(rn.slice(t.length)),i=Ca();let o;for(var a=0;a<n.length;a++)if(ma(n[a],i))return o=i.includes(n[a])?"as a parameter":"under the hood",void Ha("The name '"+n[a]+"' is used "+o+", so can't be used as a species name. Please use a different name for "+n[a]+".");Ui=n,$i=Ui.map((e=>"f_{"+e+"}")),function(){Ei=[];for(let e=0;e<Ui.length;e++)Ei.push("(?:"+Ui.slice(e).sort(((e,t)=>t.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let r={...Ci(),...Vi()};Object.keys(r).forEach((function(e){Di[e]=No(Pa(r[e],on,Ui,"_(?:[xy][xybf]?)"))})),r=xi(),Object.keys(r).forEach((function(e){Di[e]=No(Pa(r[e],an,$i))})),kt||(Object.keys(O).forEach((function(t){Wi.includes(t)&&(O[t]=Pa(O[t],e,Ui,"_(?:[xy][xybf]?)"))})),O.views=O.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Wi.includes(i)&&(n[i]=Pa(t[i],e,Ui,"_(?:[xy][xybf]?)"))})),n})),Object.keys(j).forEach((function(t){Wi.includes(t)&&(j[t]=Pa(j[t],e,Ui,"_(?:[xy][xybf]?)"))})),j.views=j.views.map((function(t){let n={};return n.name=t.name,Object.keys(t).forEach((function(i){Wi.includes(i)&&(n[i]=Pa(t[i],e,Ui,"_(?:[xy][xybf]?)"))})),n})),Mo(),ko(),$a(),Lo())}function Pa(e,t,n,i){null==i&&(i="");const o=new Array(t.length).fill(0).map(((e,t)=>"PLACE"+t.toString()));let a;for(var r=0;r<t.length;r++)a=new RegExp("\\b("+t[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,n[r]+"$2");return e}function Qa(e,t){let n,i=e.geometry.attributes.instanceStart,o=e.geometry.attributes.instanceEnd;for(let e=0;e<t.length;e++)n=t[e].toArray(),n[1]*=O.threeDHeightScale,e<t.length&&i.setXYZ(e,n[0],n[1],0),e>0&&o.setXYZ(e-1,n[0],n[1],0);i.needsUpdate=!0,o.needsUpdate=!0}function Ra(e){e=e.clamp(0,1);let t=0;for(;e>=N[t+1]&&t<L.length-2;)t+=1;return N[t+1]==N[t]?L[t]:function(e,t,n){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=ka(e[o],t[o],n);return i}(L[t],L[t+1],(e-N[t])/(N[t+1]-N[t])).map((e=>e.clamp(0,1)))}function ka(e,t,n){return(1-(n=n.clamp(0,1)))*e+n*t}function Ma(){x.linewidth=.01*O.lineWidthMul,V.linewidth=.01*O.overlayLineWidthMul,x.needsUpdate=!0,V.needsUpdate=!0}function Ia(e,t,n){e.domElement.firstChild.onfocus=()=>t(n)}function La(e,t,n){e.domElement.firstChild.onblur=()=>t(n)}function Na(e){e.forEach((function(e){Rt.add(e)})),Lo()}function Oa(e){e.forEach((function(e){Rt.delete(e)})),Lo()}function qa(){fn=new Float32Array(xt*Vt*4),l.readRenderTargetPixels(Tt[1],0,0,xt,Vt,fn),Ga(fn),zt=!0}function Ba(){zt||qa();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([xt,Vt]),fn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function ja(e){const t=new FileReader;t.onload=function(){const e=new Float32Array(t.result);Ga(e.slice(2),e.slice(0,2)),za(h),zt=!0,so()},t.readAsArrayBuffer(e)}function za(e){if(null!=e)if("crop"==O.resizeCheckpoints){let t=e.source.data.height/e.source.data.width,n=1,i=s/t;i>1&&(n=t/s,i=1),e.repeat.set(n,i),e.offset.set((1-n)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Ga(e,t){null!=h&&h.dispose(),null==t&&(t=[xt,Vt]),h=new pi.DataTexture(e,t[0],t[1],pi.RGBAFormat,pi.FloatType),h.needsUpdate=!0,h.magFilter=n?pi.NearestFilter:pi.LinearFilter,null!=E&&(E.map=h,E.needsUpdate)}function Ja(){l.setSize(Math.round(devicePixelRatio*_t),Math.round(devicePixelRatio*Dt),!1)}function Ha(e){ro(),kt&&Mt||(Mt=!0,$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Yo("#error"),$("#error").one("click",(function(){Zo("#error")}))))}function Xa(e){if(/\(\s*\)/.test(e))return Ha("Empty parentheses in "+e.trim()+"."),!1;let t=0;for(var n=0;n<e.length;n++)"("==e[n]?t+=1:")"==e[n]&&(t-=1);return 0!=t?(Ha("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(Ha("A binary operator is missing an operand in "+e.trim()+"."),!1)}function Ya(){let e;$("#views_list").empty();for(let t=0;t<O.views.length;t++)e=document.createElement("a"),e.onclick=function(){O.activeViewInd=t,Za(O.views[t])},e.innerHTML="<div class='view_label'>"+O.views[t].name+"</div>",t==O.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);Gt=Math.max(O.views.length,Gt),O.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),O.views.length}function Za(e,t){Object.assign(O,e),delete O.name,yo(J),(null==t||t)&&(To(),ga(),Yi(),Oi(),ea(),Ko(),Pr(),xr(),Ki())}function Ka(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",O.views[O.activeViewInd].name);null!=e&&(O.views[O.activeViewInd].name=e,Ya(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function er(){O.views.length>1?(O.views.splice(O.activeViewInd,1),O.activeViewInd<1?O.activeViewInd=0:O.activeViewInd-=1):O.views[O.activeViewInd].name="Custom",Za(O.views[O.activeViewInd])}function tr(){let e={};return Ai.forEach((function(t){e[t]=j[t]})),e}function nr(e){O.activeViewInd<O.views.length&&(O.views[O.activeViewInd][e]=O[e])}function ir(e,t){let n="";return n+=Vo(kn(t),Ui[e]),O.dimension>1&&(n+=Vo(Mn(t),Ui[e])),n}function or(e,t){let n="";return n+=Vo(Pn(t),Ui[e]),O.dimension>1&&(n+=Vo(Qn(t),Ui[e])),n}function ar(e,t){let n="";return n+=Vo(kn(t),Ui[e]),O.dimension>1&&(n+=Vo(Mn(t),Ui[e])),n}function rr(e,t){let n="";return n+=Vo(Pn(t).replaceAll(/updated/g,"gl_FragColor"),Ui[e]),O.dimension>1&&(n+=Vo(Qn(t).replaceAll(/updated/g,"gl_FragColor"),Ui[e])),n}function lr(e,t){const n=document.createElement("li");return null!=t&&(n.id=t),n.classList.add("button_list"),e.domElement.children[0].appendChild(n),n}function sr(e,t,n,i,o,a){const r=document.createElement("a");if(null!=n&&(r.onclick=n),null!=i&&(r.id=i),null!=o&&(r.title=o),null!=t&&(r.innerHTML=t),null!=a)for(const e of a)r.classList.add(e);e.appendChild(r)}function ur(e,t,n,i,o,a,r,l){const s=document.createElement("a");if(s.classList.add("toggle_button"),s.setAttribute("property",t),null==i&&(i=()=>{}),s.onclick=function(){O[s.getAttribute("property")]=!O[s.getAttribute("property")],$r(s),i()},null!=o&&(s.id=o),null!=a&&(s.title=a),null!=n&&(s.innerHTML=n),null!=r&&s.setAttribute("folderID",r),null!=l)for(const e of l)s.classList.add(e);return e.appendChild(s),$r(s),s}function cr(e){const t=document.createElement("div");t.classList.add("break"),e.appendChild(t)}function dr(){const e=Object.assign(li("default"),li(O.parent));let t=Wo(O,e);1==O.views.length&&"1"==O.views[0].name&&delete t.views;for(const e of Object.keys(O.views[0]))O.hasOwnProperty(e)&&O.views.map((t=>t[e])).every((t=>t==O[e]))&&O.views.forEach((t=>delete t[e]));t.preset="PRESETNAME";let n=JSON.stringify(t).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replaceAll("{","{\n\t").replaceAll("}",",\n}");n='listOfPresets["PRESETNAME"] = '+n+";\n",navigator.clipboard.writeText(n)}function fr(){let t="";t+=JSON.stringify(O),t+=JSON.stringify(q),t+=JSON.stringify({nXDisc:xt,nYDisc:Vt,domainHeight:Ut,domainWidth:Ft,aspectRatio:s,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(t)}function pr(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function mr(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function hr(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function gr(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function br(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function vr(){let e=Wo(O,li("default"));return e.preset="Custom",e=vi(e),[location.href.replace(location.search,""),"?options=",Si.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function yr(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Sr(e){const t=tn[e.data.name];if(null!=t)if(null!=t.slider)t.slider.value=e.data.value,t.slider.dispatchEvent(new Event("input"));else{const n=t.object[t.property].split("=")[0]+"= "+e.data.value.toString();t.setValue(n),t.__onFinishChange(t,n)}}function wr(){q.embossAmbient.value=O.embossAmbient,q.embossDiffuse.value=O.embossDiffuse,q.embossShiny.value=O.embossShiny,q.embossSmoothness.value=O.embossSmoothness,q.embossSpecular.value=O.embossSpecular,q.embossLightDir.value=new pi.Vector3(Math.sin(O.embossTheta)*Math.cos(O.embossPhi),Math.sin(O.embossTheta)*Math.sin(O.embossPhi),Math.cos(O.embossTheta))}function Cr(e,t,n,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=t,e.slider.max=n,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}));let o=!0;null!=e.__onChange&&(o=!1,e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(o=!1,e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),o&&e.onChange((function(){e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)})),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function xr(){for(const e of[...Qt,...Pt]){let t=e.getValue();e.slider.style.setProperty("--value",t),e.slider.value=t}}function Vr(){q.contourColour.value=new pi.Color(O.contourColour),q.contourEpsilon.value=O.contourEpsilon,q.contourStep.value=1/(O.contourNum+1)}function Fr(){q.overlayColour.value=new pi.Color(O.overlayColour),q.overlayEpsilon.value=O.overlayEpsilon,q.overlayLine.value=O.overlay&&"line"==O.plotType,V.color=new pi.Color(O.overlayColour),V.needsUpdate=!0}function Ur(){mt||Ki()}function $r(e){O[e.getAttribute("property")]?(e.classList.add("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).removeClass("hidden")):(e.classList.remove("toggled_on"),e.getAttribute("folderID")&&$("#"+e.getAttribute("folderID")).addClass("hidden"))}function Er(e){e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!1)}function _r(){O.customSurface?b.vertexShader=ii():b.vertexShader=ni(),b.needsUpdate=!0}function Dr(){"surface"==O.plotType?($("#customSurfaceToggle").show(),O.customSurface?(Co(Ve),wo(xe)):(wo(Ve),Co(xe))):($("#customSurfaceToggle").hide(),wo(Ve))}function Ar(){I=new pi.Group,a.add(I);const e=Math.max(xt,Vt),t=Math.round(ka(3,window.width<629?20:32,O.arrowDensity));let n=Math.max(Math.floor(e/t),1);const i=Math.floor(xt/n),o=Math.floor(Vt/n),r=Math.floor((xt-n*(i-1))/2),l=Math.floor((Vt-n*(o-1))/2);let s,u,c,d,f,p;for(let e=0;e<o;e++){u=l+e*n,p=((u+.5)/Vt-.5)*A.geometry.parameters.height;for(let e=0;e<i;e++)c=r+e*n,f=((c+.5)/xt-.5)*A.geometry.parameters.width,s=c+u*xt,d=Tr([f,p,1],[0,0,0]),d.ind=s,I.add(d)}}function Tr(e,t){const n=new pi.Group,i=new pi.Mesh(_,F);i.rotation.x=Math.PI/2;const o=new pi.Mesh(D,F);return o.rotation.x=Math.PI/2,o.rotation.y=Math.PI/4,o.position.z=_.parameters.height/2,n.add(i),n.add(o),n.scale.multiplyScalar(Zt),n.position.set(e[0],e[1],e[2]),n.lookAt(e[0]+t[0],e[1]+t[1],e[2]+t[2]),n}function Wr(){if(I)for(a.remove(I);I.children.length;)I.remove(I.children[0])}function Pr(){if(q.vectorField.value=O.vectorField,O.vectorField){if(Wr(),Ar(),Qr(),"relative"==O.arrowScale)try{I.customMax=Ti.evaluate(O.arrowLengthMax)}catch(e){Ha("Unable to evaluate the maximum arrow length. Please check the definition."),I.customMax=1}}else Wr()}function Qr(){F.color=new pi.Color(O.arrowColour)}function Rr(e){const t=ma(e,Ui.concat($i));return t&&Ha("The name '"+e+"' is already in use, so can't be used as a parameter name. Please use a different name for "+e+"."),!t}ki&&bo("GrayScott"),Nt=Ri.has("story"),Nt&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),ct.domElement.classList.add("hidden"),$("#add_view").addClass("hidden"),Ko(),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),wt=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),(Xo()||ki||O.forceTryClickingPopup)&&!O.suppressTryClickingPopup&&O.brushEnabled&&($("#top_message").html("<p>"+O.tryClickingText+"</p>"),Yo("#top_message"),setTimeout((()=>Zo("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>Zo("#top_message")))),$("#settings").click((function(){pr(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&gr(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&br(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&mr(),$("#views_ui").is(":visible")&&hr()),$("#left_ui").is(":visible")&&_a()})),$("#equations").click((function(){mr(),_a(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&pr(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&hr()})),$("#pause").click((function(){ro()})),$("#play").click((function(){lo()})),$("#erase").click((function(){so()})),$("#share").click((function(){br(),$("#help_panel").is(":visible")&&gr()})),$("#help").click((function(){gr(),$("#share_panel").is(":visible")&&br()})),$("#screenshot").click((function(){mn=!0,Ki(),br()})),$("#link").click((function(){B.copyConfigAsURL(),br()})),$("#embed").click((function(){!function(){let e=vr();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&logo_only"}yr('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0"></iframe>')}(),br()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){gr()})),$("#views").click((function(){hr(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&pr(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&mr()})),$(document).on("click","#add_view",(function(){!function(){let e=tr();e.name=++Gt,O.views.push(e),O.activeViewInd=O.views.length-1,Ya()}()})),kt=!1,function e(){requestAnimationFrame(e),gt=ht,ht&&O.brushEnabled&&function(){!O.fixRandSeed&&O.brushValue.includes("RAND")&&$o();T.material=v;for(let e=1;e<Tt.length;e++)q.textureSource.value=Tt[e].texture,l.setRenderTarget(Tt[e-1]),l.render(r,o);Tt.rotate(-1)}();if(mt){!bt||function(){T.material=y;for(let e=1;e<Tt.length;e++)q.textureSource.value=Tt[e].texture,l.setRenderTarget(Tt[e-1]),l.render(r,o);Tt.rotate(-1)}();for(let e=0;e<O.numTimestepsPerFrame;e++){if(O.autoPause&&It&&q.t.value>=O.autoPauseAt){It=!1,ro();break}Ot&&!O.fixRandSeed&&$o(),Zi()}}(gt||mt)&&Ki()}();