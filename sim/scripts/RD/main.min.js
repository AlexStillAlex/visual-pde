let canvas,gl,manualInterpolationNeeded,camera,simCamera,scene,simScene,renderer,aspectRatio,controls,raycaster,clampedCoords,simTextures=[],postTexture,interpolationTexture,simTextureOpts,checkpointTexture,basicMaterial,displayMaterial,drawMaterial,simMaterial,dirichletMaterial,clearMaterial,copyMaterial,postMaterial,lineMaterial,interpolationMaterial,checkpointMaterial,domain,simDomain,clickDomain,line,xDisplayDomainCoords,yDisplayDomainCoords,numPointsInLine,colourmap,colourmapEndpoints,options,uniforms,funsObj,savedOptions,leftGUI,rightGUI,viewsGUI,root,typeOfBrushController,fController,gController,hController,jController,algebraicSpeciesController,crossDiffusionController,domainIndicatorFunController,DuuController,DuvController,DuwController,DuqController,DvuController,DvvController,DvwController,DvqController,DwuController,DwvController,DwwController,DwqController,DquController,DqvController,DqwController,DqqController,dtController,whatToDrawController,lineWidthMulController,threeDHeightScaleController,cameraThetaController,cameraPhiController,cameraZoomController,forceManualInterpolationController,smoothingScaleController,embossController,contourController,contourEpsilonController,contourNumController,minColourValueController,maxColourValueController,setColourRangeController,autoSetColourRangeController,embossShinyController,embossSmoothnessController,embossAmbientController,embossDiffuseController,embossSpecularController,embossThetaController,embossPhiController,clearValueUController,clearValueVController,clearValueWController,clearValueQController,uBCsController,vBCsController,wBCsController,qBCsController,dirichletUController,dirichletVController,dirichletWController,dirichletQController,comboUController,comboVController,comboWController,comboQController,neumannUController,neumannVController,neumannWController,neumannQController,robinUController,robinVController,robinWController,robinQController,fIm,imControllerOne,imControllerTwo,whatToPlotController,deleteViewController,selectedEntries=new Set,isRunning,isDrawing,hasDrawn,anyDirichletBCs,dataNudgedUp=!1,compileErrorOccurred=!1,NaNTimer,topMessageTimer,uiHidden=!1,checkpointExists=!1,savedViews,updatingAlgebraicSpecies=!1,viewUIOffsetInit,inTex,outTex,nXDisc,nYDisc,domainWidth,domainHeight,maxDim,canvasWidth,canvasHeight,usingLowResDomain=!0,domainScaleFactor=1,parametersFolder,kineticParamsStrs={},kineticParamsLabels=[],kineticNameToCont={},kineticParamsCounter=0,defaultSpecies=["u","v","w","q"],defaultReactions=["UFUN","VFUN","WFUN","QFUN"],placeholderSp=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],placeholderRe=["REACT1","REACT2","REACT3","REACT4"],listOfTypes=["1Species","2Species","2SpeciesCrossDiffusion","2SpeciesCrossDiffusionAlgebraicV","3Species","3SpeciesCrossDiffusion","3SpeciesCrossDiffusionAlgebraicW","3SpeciesCrossDiffusionAlgebraicVW","4Species","4SpeciesCrossDiffusion","4SpeciesCrossDiffusionAlgebraicQ","4SpeciesCrossDiffusionAlgebraicWQ","4SpeciesCrossDiffusionAlgebraicVWQ"],equationType,savedHTML,algebraicV,algebraicW,algebraicQ,takeAScreenshot=!1,buffer,checkpointBuffer,bufferFilled=!1,numsAsWords=["zero","one","two","three","four","five","six","seven","eight","nine",];import{drawShaderTop as e,drawShaderBotReplace as o,drawShaderBotAdd as t,drawShaderShapeDisc as n,drawShaderShapeVLine as i,drawShaderShapeHLine as r,drawShaderFactorSharp as s,drawShaderFactorSmooth as l}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as a,computeDisplayFunShaderMid as c,computeMaxSpeciesShaderMid as u,postGenericShaderBot as p,postShaderDomainIndicator as d,interpolationShader as m}from"./post_shaders.js";import{copyShader as f}from"../copy_shader.js";import{RDShaderTop as h,RDShaderBot as C,RDShaderDirichletX as g,RDShaderDirichletY as S,RDShaderDirichletIndicatorFun as b,RDShaderRobinX as D,RDShaderRobinY as U,RDShaderUpdateNormal as v,RDShaderUpdateCross as w,RDShaderAlgebraicV as y,RDShaderAlgebraicW as I,RDShaderAlgebraicQ as T,RDShaderEnforceDirichletTop as V,RDShaderAdvectionPreBC as _,RDShaderAdvectionPostBC as G,RDShaderDiffusionPreBC as E,RDShaderDiffusionPostBC as x,RDShaderGhostX as F,RDShaderGhostY as R}from"./simulation_shaders.js";import{randShader as P}from"../rand_shader.js";import{fiveColourDisplayTop as W,fiveColourDisplayBot as q,embossShader as k,contourShader as O,surfaceVertexShader as N}from"./display_shaders.js";import{getColours as A}from"../colourmaps.js";import{genericVertexShader as Q}from"../generic_shaders.js";import{getPreset as X,getUserTextFields as L,getFieldsInView as B}from"./presets.js";import{clearShaderBot as M,clearShaderTop as H}from"./clear_shader.js";import*as z from"../three.module.min.js";import{OrbitControls as j}from"../OrbitControls.js";import{Line2 as Y}from"../lines/Line2.js";import{LineMaterial as K}from"../lines/LineMaterial.js";import{LineGeometry as Z}from"../lines/LineGeometry.js";import{minifyPreset as J,maxifyPreset as ee}from"./minify_preset.js";import{LZString as eo}from"../lz-string.min.js";import{equationTEXFun as et,getDefaultTeXLabelsDiffusion as en,getDefaultTeXLabelsReaction as ei,getDefaultTeXLabelsBCsICs as er,substituteGreek as es}from"./TEX.js";let equationTEX=et(),TeXStrings={...en(),...ei(),...er()},listOfSpecies,listOfReactions,anySpeciesRegexStrs,fieldsInView=B();options={};let userTextFields=L();funsObj={reset:function(){resetSim()},toggleRunning:function(){isRunning?pauseSim():playSim()},copyConfigAsURL:function(){let e=getSimURL();copyLinkToClipboard(e)},saveSimState:function(){saveSimState()},exportSimState:function(){exportSimState()},clearCheckpoints:function(){checkpointExists&&(checkpointTexture.dispose(),checkpointTexture=null,checkpointExists=!1)},restoreCurrentView:function(){restoreCurrentView()}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();if(-1!==e.indexOf(".")&&-1!==e.indexOf("-"));else if(-1!==e.indexOf("."))return e.split(".")[1].length||0;return e.split("-")[1]||0},Number.prototype.clamp=function(e,o){return Math.min(Math.max(this,e),o)},Array.prototype.rotate=function(){var e=Array.prototype.push,o=Array.prototype.splice;return function(t){var n=this.length>>>0,t=t>>0;return t=(t%n+n)%n,e.apply(this,o.call(this,0,t)),this}}(),canvas=document.getElementById("simCanvas"),console.error=function(e){compileErrorOccurred=!0;let o=e.toString();console.log(o);let t=/ERROR.*/;t.test(o)&&(o=o.match(t)),throwError(o)},fromExternalLink()||$("#logo").hide();let params=new URLSearchParams(window.location.search);if(params.has("no_ui")?($(".ui").addClass("hidden"),uiHidden=!0):$(".ui").removeClass("hidden"),params.has("sf")&&(isNaN(domainScaleFactor=parseFloat(params.get("sf")))||domainScaleFactor<=0)&&(domainScaleFactor=1),params.has("story")&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),viewUIOffsetInit=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),!warningCookieExists()&&!uiHidden){$("#warning").css("display","block");let el=await Promise.race([waitListener(document.getElementById("warning_ok"),"click",!0),waitListener(document.getElementById("warning_no"),"click",!1),]);el&&setWarningCookie(),$("#warning").css("display","none")}loadOptions("default"),init();let shouldLoadDefault=!0;if(params.has("preset")&&(loadPreset(params.get("preset")),shouldLoadDefault=!1),params.has("options")){var ea=JSON.parse(eo.decompressFromEncodedURIComponent(params.get("options")));ea.hasOwnProperty("p")&&(ea=ee(ea)),loadPreset(ea),shouldLoadDefault=!1}function init(){initUniforms(),isDrawing=!1,raycaster=new z.Raycaster,clampedCoords=new z.Vector2,(renderer=new z.WebGLRenderer({canvas:canvas,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1})).autoClear=!0,manualInterpolationNeeded=!((gl=renderer.getContext()).getExtension("OES_texture_float_linear")&&gl.getExtension("EXT_float_blend")),simTextureOpts={format:z.RGBAFormat,type:z.FloatType,minFilter:z.NearestFilter},(manualInterpolationNeeded|=/android/i.test(navigator.userAgent))?simTextureOpts.magFilter=z.NearestFilter:simTextureOpts.magFilter=z.LinearFilter,simTextures.push(new z.WebGLRenderTarget(options.maxDisc,options.maxDisc,simTextureOpts)),simTextures.push(simTextures[0].clone()),postTexture=simTextures[0].clone(),interpolationTexture=simTextures[0].clone(),simTextures.forEach(e=>{e.texture.wrapS=z.RepeatWrapping,e.texture.wrapT=z.RepeatWrapping}),postTexture.texture.wrapS=z.ClampToEdgeWrapping,postTexture.texture.wrapT=z.ClampToEdgeWrapping,interpolationTexture.texture.wrapS=z.ClampToEdgeWrapping,interpolationTexture.texture.wrapT=z.ClampToEdgeWrapping,camera=new z.OrthographicCamera(-.5,.5,.5,-.5,-1,10),(controls=new j(camera,canvas)).listenToKeyEvents(document),controls.addEventListener("change",function(){"surface"==options.plotType&&(options.cameraTheta=90-180*Math.atan2(camera.position.z,camera.position.y)/Math.PI,options.cameraPhi=180*Math.atan2(camera.position.x,camera.position.z)/Math.PI,options.cameraZoom=camera.zoom,refreshGUI(rightGUI),render())}),(simCamera=new z.OrthographicCamera(-.5,.5,.5,-.5,-1,10)).position.z=1,scene=new z.Scene,simScene=new z.Scene,scene.add(camera),scene.background=new z.Color(options.backgroundColour),basicMaterial=new z.MeshBasicMaterial({side:z.DoubleSide}),displayMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q(),transparent:!0,side:z.DoubleSide}),postMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q()}),interpolationMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q(),fragmentShader:m()}),drawMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q()}),simMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q()}),copyMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q(),fragmentShader:f()}),clearMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q()}),dirichletMaterial=new z.ShaderMaterial({uniforms:uniforms,vertexShader:Q()}),lineMaterial=new K({vertexColors:!0,linewidth:.01}),checkpointMaterial=new z.MeshBasicMaterial;let e=new z.PlaneGeometry(1,1);(simDomain=new z.Mesh(e,simMaterial)).position.z=0,simScene.add(simDomain),setSizes(),createDisplayDomains(),configureCameraAndClicks(),setCanvasShape(),resize(),initGUI(),configureGUI(),updateProblem(),setBrushType(),setDrawAndDisplayShaders(),setClearShader(),configureManualInterpolation(),resetSim(),canvas.addEventListener("pointerdown",onDocumentPointerDown),canvas.addEventListener("pointerup",onDocumentPointerUp),canvas.addEventListener("pointermove",onDocumentPointerMove),document.addEventListener("keypress",function e(o){var t=(o=o||window.event).target,n=1==t.nodeType?t.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(n)||("r"===o.key&&$("#erase").click()," "===o.key&&funsObj.toggleRunning(),"h"===o.key&&(uiHidden?(uiHidden=!1,$(".ui").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",viewUIOffsetInit),isRunning?playSim():pauseSim(),checkColourbarPosition(),checkColourbarLogoCollision(),resizeEquationDisplay()):(uiHidden=!0,$(".ui").addClass("hidden"))),"s"==o.key&&saveSimState(),"c"==o.key&&(options.resetFromCheckpoints=!options.resetFromCheckpoints,refreshGUI(rightGUI)))}),window.addEventListener("resize",resize,!1),window.addEventListener("message",updateParamFromMessage),$("#checkpointInput").change(function(){loadSimState(this.files[0]),this.value=null})}function resize(){setSizes(),resizeTextures(),setStretchOrCropTexture(checkpointTexture),updateUniforms(),replaceDisplayDomains(),configureCameraAndClicks(),checkColourbarLogoCollision(),resizeEquationDisplay(),render()}function replaceDisplayDomains(){domain.geometry.dispose(),scene.remove(domain),clickDomain.geometry.dispose(),scene.remove(clickDomain),line.geometry.dispose(),scene.remove(line),createDisplayDomains()}function configureCameraAndClicks(){switch(computeCanvasSizesAndAspect(),options.plotType){case"line":options.cameraTheta=0,options.cameraPhi=0,controls.enabled=!1,camera.zoom=1,setCameraPos(),displayMaterial.vertexShader=N();break;case"plane":controls.enabled=!1,controls.reset(),displayMaterial.vertexShader=Q();break;case"surface":controls.enabled=!0,camera.zoom=options.cameraZoom,setCameraPos(),displayMaterial.vertexShader=N()}displayMaterial.needsUpdate=!0,camera.left=-domainWidth/(2*maxDim),camera.right=domainWidth/(2*maxDim),camera.top=domainHeight/(2*maxDim),camera.bottom=-domainHeight/(2*maxDim),camera.updateProjectionMatrix(),setDomainOrientation()}function updateUniforms(){uniforms.L.value=options.domainScale,uniforms.L_y.value=domainHeight,uniforms.L_x.value=domainWidth,uniforms.L_min.value=Math.min(domainHeight,domainWidth),uniforms.dt.value=options.dt,uniforms.dx.value=domainWidth/nXDisc,uniforms.dy.value=domainHeight/nYDisc,uniforms.heightScale.value=options.threeDHeightScale,uniforms.maxColourValue.value=options.maxColourValue,uniforms.minColourValue.value=options.minColourValue,setEmbossUniforms(),options.fixRandSeed||updateRandomSeed()}function computeCanvasSizesAndAspect(){canvasWidth=Math.round(canvas.getBoundingClientRect().width),(aspectRatio=(canvasHeight=Math.round(canvas.getBoundingClientRect().height))/canvasWidth)<=0&&(aspectRatio=.1),aspectRatio>=1?domainWidth=(domainHeight=options.domainScale)/aspectRatio:domainHeight=(domainWidth=options.domainScale)*aspectRatio,1==options.dimension&&(domainWidth=options.domainScale),uniforms.L_x.value=domainWidth,uniforms.L_y.value=domainHeight,maxDim=Math.max(domainWidth,domainHeight)}function setSizes(){computeCanvasSizesAndAspect(),0==options.spatialStep&&(alert("Oops! A spatial step of 0 would almost certainly crash your device. We've reset it to 1% of the maximum domain length to prevent this."),options.spatialStep=options.domainScale/100),nXDisc=Math.floor(domainWidth/options.spatialStep),nYDisc=Math.floor(domainHeight/options.spatialStep),0==nXDisc&&(nXDisc=1),0==nYDisc&&(nYDisc=1),1==options.dimension&&(nYDisc=1),uniforms.nXDisc.value=nXDisc,uniforms.nYDisc.value=nYDisc,xDisplayDomainCoords=Array(nXDisc),yDisplayDomainCoords=Array(nXDisc);let e=-.5,o=1/nXDisc;for(let t=0;t<xDisplayDomainCoords.length;t++)xDisplayDomainCoords[t]=e,e+=o;setDefaultRenderSize(),buffer=new Float32Array(nXDisc*nYDisc*4),bufferFilled=!1}function createDisplayDomains(){computeCanvasSizesAndAspect();let e=[1,1];usingLowResDomain||(e=[nXDisc,nYDisc]);let o=new z.PlaneGeometry(domainWidth/maxDim,domainHeight/maxDim,e[0],e[1]);(domain=new z.Mesh(o,displayMaterial)).position.z=0,domain.visible="line"!=options.plotType,domain.matrixAutoUpdate=!1,scene.add(domain);let t=new z.PlaneGeometry(domainWidth/maxDim,domainHeight/maxDim,1,1);(clickDomain=new z.Mesh(t,basicMaterial)).position.z=0,clickDomain.visible=!1,clickDomain.matrixAutoUpdate=!1,scene.add(clickDomain),setDomainOrientation();let n=new Z;numPointsInLine=Math.round(devicePixelRatio*canvasWidth);let i=Array(3*numPointsInLine).fill(0),r=Array(i.length).fill(0);n.setPositions(i),n.setColors(r),(line=new Y(n,lineMaterial)).scale.set(1,1,1),line.visible="line"==options.plotType,scene.add(line)}function setDomainOrientation(){switch(options.plotType){case"plane":domain.rotation.x=0,clickDomain.rotation.x=0;break;case"surface":domain.rotation.x=-Math.PI/2,clickDomain.rotation.x=-Math.PI/2}domain.updateMatrix(),clickDomain.updateMatrix()}function setCanvasShape(){options.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function resizeTextures(){simDomain.material=copyMaterial;for(let e=1;e<simTextures.length;e++)uniforms.textureSource.value=simTextures[e].texture,simTextures[e-1].setSize(nXDisc,nYDisc),renderer.setRenderTarget(simTextures[e-1]),renderer.render(simScene,simCamera);simTextures.rotate(-1),simTextures[0].dispose(),simTextures[0]=simTextures[1].clone(),postTexture.setSize(nXDisc,nYDisc),interpolationTexture.setSize((options.smoothingScale+1)*nXDisc,(options.smoothingScale+1)*nYDisc)}function initUniforms(){uniforms={brushCoords:{type:"v2",value:new z.Vector2(.5,.5)},colour1:{type:"v4",value:new z.Vector4(0,0,0,0)},colour2:{type:"v4",value:new z.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new z.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new z.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new z.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dy:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},seed:{type:"f",value:0},smoothingScale:{type:"f",value:options.smoothingScale+1},textureSource:{type:"t"},t:{type:"f",value:0}}}function initGUI(e){(leftGUI=new dat.GUI({closeOnTop:!0,autoPlace:!1})).domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(leftGUI.domElement),(rightGUI=new dat.GUI({closeOnTop:!0,autoPlace:!1})).domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(rightGUI.domElement),(viewsGUI=new dat.GUI({closeOnTop:!0,autoPlace:!1})).domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(viewsGUI.domElement),leftGUI.open(),rightGUI.open(),viewsGUI.open(),void 0!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),(root=rightGUI.addFolder("Brush")).add(options,"brushEnabled").name("Enabled"),root.add(options,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(setBrushType),typeOfBrushController=root.add(options,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(setBrushType),root.add(options,"brushValue").name("Value").onFinishChange(setBrushType),root.add(options,"brushRadius").name("Radius").onChange(setBrushType),whatToDrawController=root.add(options,"whatToDraw",listOfSpecies).name("Species").onChange(setBrushType),(root=rightGUI.addFolder("Domain")).add(options,"dimension",{1:1,2:2}).name("Dimension").onChange(function(){configureDimension(),render()}),root.add(options,"domainScale").name("Largest side").onChange(resize);let o=root.add(options,"spatialStep").name("Space step").onChange(function(){resize()});o.__precision=12,o.min(0),o.updateDisplay(),root.add(options,"squareCanvas").name("Square").onFinishChange(function(){setCanvasShape(),resize(),configureCameraAndClicks()}),root.add(options,"domainViaIndicatorFun").name("Implicit").onFinishChange(function(){configureOptions(),configureGUI(),setRDEquations(),setPostFunFragShader()}),domainIndicatorFunController=root.add(options,"domainIndicatorFun").name("Ind. fun").onFinishChange(function(){configureOptions(),configureGUI(),setRDEquations(),updateWhatToPlot()}),(root=rightGUI.addFolder("Timestepping")).add(options,"numTimestepsPerFrame",1,400,1).name("Steps/frame"),(dtController=root.add(options,"dt").name("Timestep").onChange(function(){updateUniforms()})).__precision=12,dtController.min(0),dtController.updateDisplay(),root.add(options,"timeDisplay").name("Show time").onChange(configureTimeDisplay),(root=rightGUI.addFolder("Equations")).add(options,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(updateProblem),crossDiffusionController=root.add(options,"crossDiffusion").name("Cross diffusion").onChange(updateProblem),algebraicSpeciesController=root.add(options,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange(function(){updatingAlgebraicSpecies=!0,updateProblem(),updatingAlgebraicSpecies=!1}),root.add(options,"speciesNames").name("Species names").onFinishChange(function(){setCustomNames()}),root.add(options,"reactionNames").name("Reactions").onFinishChange(function(){setCustomNames()}),(root=leftGUI.addFolder("Definitions")).add(options,"typesetCustomEqs").name("Typeset").onChange(setEquationDisplayType),DuuController=root.add(options,"diffusionStrUU").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DuuController,selectTeX,["D","U","UU"]),setOnblur(DuuController,deselectTeX,["D","U","UU"]),DuvController=root.add(options,"diffusionStrUV").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DuvController,selectTeX,["UV"]),setOnblur(DuvController,deselectTeX,["UV"]),DuwController=root.add(options,"diffusionStrUW").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DuwController,selectTeX,["UW"]),setOnblur(DuwController,deselectTeX,["UW"]),DuqController=root.add(options,"diffusionStrUQ").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DuqController,selectTeX,["UQ"]),setOnblur(DuqController,deselectTeX,["UQ"]),DvuController=root.add(options,"diffusionStrVU").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DvuController,selectTeX,["VU"]),setOnblur(DvuController,deselectTeX,["VU"]),DvvController=root.add(options,"diffusionStrVV").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DvvController,selectTeX,["V","VV"]),setOnblur(DvvController,deselectTeX,["V","VV"]),DvwController=root.add(options,"diffusionStrVW").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DvwController,selectTeX,["VW"]),setOnblur(DvwController,deselectTeX,["VW"]),DvqController=root.add(options,"diffusionStrVQ").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DvqController,selectTeX,["VQ"]),setOnblur(DvqController,deselectTeX,["VQ"]),DwuController=root.add(options,"diffusionStrWU").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DwuController,selectTeX,["WU"]),setOnblur(DwuController,deselectTeX,["WU"]),DwvController=root.add(options,"diffusionStrWV").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DwvController,selectTeX,["WV"]),setOnblur(DwvController,deselectTeX,["WV"]),DwwController=root.add(options,"diffusionStrWW").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DwwController,selectTeX,["W","WW"]),setOnblur(DwwController,deselectTeX,["W","WW"]),DwqController=root.add(options,"diffusionStrWQ").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DwqController,selectTeX,["WQ"]),setOnblur(DwqController,deselectTeX,["WQ"]),DquController=root.add(options,"diffusionStrQU").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DquController,selectTeX,["QU"]),setOnblur(DquController,deselectTeX,["QU"]),DqvController=root.add(options,"diffusionStrQV").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DqvController,selectTeX,["QV"]),setOnblur(DqvController,deselectTeX,["QV"]),DqwController=root.add(options,"diffusionStrQW").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DqwController,selectTeX,["QW"]),setOnblur(DqwController,deselectTeX,["QW"]),DqqController=root.add(options,"diffusionStrQQ").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(DqqController,selectTeX,["Q","QQ"]),setOnblur(DqqController,deselectTeX,["Q","QQ"]),fController=root.add(options,"reactionStrU").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(fController,selectTeX,["UFUN"]),setOnblur(fController,deselectTeX,["UFUN"]),gController=root.add(options,"reactionStrV").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(gController,selectTeX,["VFUN"]),setOnblur(gController,deselectTeX,["VFUN"]),hController=root.add(options,"reactionStrW").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(hController,selectTeX,["WFUN"]),setOnblur(hController,deselectTeX,["WFUN"]),jController=root.add(options,"reactionStrQ").onFinishChange(function(){setRDEquations(),setEquationDisplayType()}),setOnfocus(jController,selectTeX,["QFUN"]),setOnblur(jController,deselectTeX,["QFUN"]),parametersFolder=leftGUI.addFolder("Parameters"),setParamsFromKineticString(),uBCsController=(root=leftGUI.addFolder("Boundary conditions")).add(options,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange(function(){setRDEquations(),setBCsGUI()}),dirichletUController=root.add(options,"dirichletStrU").onFinishChange(setRDEquations),neumannUController=root.add(options,"neumannStrU").onFinishChange(setRDEquations),robinUController=root.add(options,"robinStrU").onFinishChange(setRDEquations),comboUController=root.add(options,"comboStrU").name("Details").onFinishChange(setRDEquations),vBCsController=root.add(options,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange(function(){setRDEquations(),setBCsGUI()}),dirichletVController=root.add(options,"dirichletStrV").onFinishChange(setRDEquations),neumannVController=root.add(options,"neumannStrV").onFinishChange(setRDEquations),robinVController=root.add(options,"robinStrV").onFinishChange(setRDEquations),comboVController=root.add(options,"comboStrV").name("Details").onFinishChange(setRDEquations),wBCsController=root.add(options,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange(function(){setRDEquations(),setBCsGUI()}),dirichletWController=root.add(options,"dirichletStrW").onFinishChange(setRDEquations),neumannWController=root.add(options,"neumannStrW").onFinishChange(setRDEquations),robinWController=root.add(options,"robinStrW").onFinishChange(setRDEquations),comboWController=root.add(options,"comboStrW").name("Details").onFinishChange(setRDEquations),qBCsController=root.add(options,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange(function(){setRDEquations(),setBCsGUI()}),dirichletQController=root.add(options,"dirichletStrQ").onFinishChange(setRDEquations),neumannQController=root.add(options,"neumannStrQ").onFinishChange(setRDEquations),robinQController=root.add(options,"robinStrQ").onFinishChange(setRDEquations),comboQController=root.add(options,"comboStrQ").name("Details").onFinishChange(setRDEquations),clearValueUController=(root=leftGUI.addFolder("Initial conditions")).add(options,"clearValueU").onFinishChange(setClearShader),clearValueVController=root.add(options,"clearValueV").onFinishChange(setClearShader),clearValueWController=root.add(options,"clearValueW").onFinishChange(setClearShader),clearValueQController=root.add(options,"clearValueQ").onFinishChange(setClearShader),lineWidthMulController=(root=rightGUI.addFolder("Plotting")).add(options,"lineWidthMul",.1,2).name("Thickness").onChange(function(){setLineWidth(),render()}),threeDHeightScaleController=root.add(options,"threeDHeightScale").name("Max height").onChange(updateUniforms),cameraThetaController=root.add(options,"cameraTheta").name("View $\\theta$").onChange(configureCameraAndClicks),cameraPhiController=root.add(options,"cameraPhi").name("View $\\phi$").onChange(configureCameraAndClicks),cameraZoomController=root.add(options,"cameraZoom").name("Zoom").onChange(configureCameraAndClicks),forceManualInterpolationController=root.add(options,"forceManualInterpolation").name("Man. smooth").onChange(configureManualInterpolation),smoothingScaleController=root.add(options,"smoothingScale",0,16,1).name("Smoothing").onChange(function(){resizeTextures(),uniforms.smoothingScale.value=options.smoothingScale+1,render()}),contourNumController=(root=root.addFolder("Contours")).add(options,"contourNum").name("Number").onChange(function(){setContourUniforms(),renderIfNotRunning()}),createOptionSlider(contourNumController,1,20,1),contourEpsilonController=root.add(options,"contourEpsilon").name("Threshold").onChange(function(){setContourUniforms(),renderIfNotRunning()}),createOptionSlider(contourEpsilonController,.001,.05,.001),root.addColor(options,"contourColour").name("Colour").onChange(function(){setContourUniforms(),renderIfNotRunning()}),(root=rightGUI.addFolder("Colour")).add(options,"colourbar").name("Colour bar").onChange(configureColourbar),root.addColor(options,"backgroundColour").name("Background").onChange(function(){scene.background=new z.Color(options.backgroundColour),render()}),embossSmoothnessController=(root=root.addFolder("Lighting")).add(options,"embossSmoothness").name("Smoothness").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossSmoothnessController,0,10,.001),embossAmbientController=root.add(options,"embossAmbient").name("Ambient").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossAmbientController,0,1,.001),embossDiffuseController=root.add(options,"embossDiffuse").name("Diffuse").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossDiffuseController,0,1,.001),embossSpecularController=root.add(options,"embossSpecular").name("Specular").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossSpecularController,0,1,.001),embossShinyController=root.add(options,"embossShiny").name("Precision").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossShinyController,0,100,1),embossThetaController=root.add(options,"embossTheta").name("Inclination").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossThetaController,0,1.5708,.001),embossPhiController=root.add(options,"embossPhi").name("Direction").onChange(function(){setEmbossUniforms(),renderIfNotRunning()}),createOptionSlider(embossPhiController,0,3.1456,.001),root=fIm=rightGUI.addFolder("Images"),createImageControllers(),(root=rightGUI.addFolder("Checkpoints")).add(options,"resetFromCheckpoints").name("Enabled"),root.add(options,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize");let t=document.createElement("li");t.classList.add("button_list"),root.domElement.children[0].appendChild(t),addButton(t,"Set",saveSimState),addButton(t,"Export",exportSimState),addButton(t,"Import",function(){$("#checkpointInput").click()}),(root=rightGUI.addFolder("Misc.")).add(options,"integrate").name("Integrate").onChange(function(){configureIntegralDisplay(),render()}),root.add(options,"fixRandSeed").name("Fix random seed");let n=document.createElement("li");n.classList.add("button_list"),root.domElement.children[0].appendChild(n),addButton(n,'<i class="fa-regular fa-copy"></i> Copy code',copyConfigAsJSON),root=root.addFolder("Debug");let i=document.createElement("li");i.classList.add("button_list"),root.domElement.children[0].appendChild(i),addButton(i,"Copy debug information",copyDebug);let r=document.createElement("div");r.innerHTML="Settings",r.classList.add("ui_title"),rightGUI.domElement.prepend(r);let s=document.createElement("div");s.innerHTML="Equations",s.classList.add("ui_title"),leftGUI.domElement.prepend(s);let l=document.createElement("div");l.id="views_list",viewsGUI.domElement.prepend(l);let a=document.createElement("div");a.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",a.classList.add("ui_title"),viewsGUI.domElement.prepend(a),root=viewsGUI.addFolder("Edit view");let c=document.createElement("li");c.id="edit_view_buttons",c.classList.add("button_list"),root.domElement.children[0].appendChild(c),addButton(c,'<i class="fa-solid fa-pen-nib"></i> Rename',editCurrentViewName,null,"Rename view"),addButton(c,'<i class="fa-solid fa-xmark"></i> Delete',deleteView,"deleteViewButton","Delete view"),whatToPlotController=root.add(options,"whatToPlot").name("Expression: ").onFinishChange(function(){updateWhatToPlot(),render(),updateView(this.property)}),root.add(options,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange(function(){configurePlotType(),document.activeElement.blur(),render(),updateView(this.property)}),root.add(options,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange(function(){setDisplayColourAndType(),configureColourbar(),updateView(this.property)}).name("Colour map"),(minColourValueController=root.add(options,"minColourValue").name("Min value").onChange(function(){updateUniforms(),updateColourbarLims(),render(),updateView(this.property)})).__precision=2,(maxColourValueController=root.add(options,"maxColourValue").name("Max value").onChange(function(){updateUniforms(),updateColourbarLims(),render(),updateView(this.property)})).__precision=2,autoSetColourRangeController=root.add(options,"autoSetColourRange").name("Auto snap").onChange(function(){options.autoSetColourRange&&(setColourRange(),render()),updateView(this.property)}),contourController=root.add(options,"contours").name("Contours").onChange(function(){setDisplayColourAndType(),updateView(this.property)}),embossController=root.add(options,"emboss").name("Lighting").onChange(function(){setDisplayColourAndType(),updateView(this.property)});let u=document.createElement("li");u.id="colour_map_buttons",u.classList.add("button_list"),root.domElement.children[0].appendChild(u),addButton(u,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Reverse',function(){options.flippedColourmap=!options.flippedColourmap,setDisplayColourAndType(),configureColourbar(),updateView("flippedColourmap")},null,"Reverse colour map"),addButton(u,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',function(){setColourRange(),render(),updateView("minColourValue"),updateView("maxColourValue")},null,"Snap min/max to visible")}function animate(){if(requestAnimationFrame(animate),hasDrawn=isDrawing,isDrawing&&options.brushEnabled&&draw(),isRunning){anyDirichletBCs&&enforceDirichlet();for(let e=0;e<options.numTimestepsPerFrame;e++)timestep(),uniforms.t.value+=options.dt}(hasDrawn||isRunning)&&render()}function setDrawAndDisplayShaders(){setDisplayColourAndType(),configureColourbar(),updateWhatToPlot(),setBrushType()}function setBrushType(){let a=kineticUniformsForShader()+e(),c="float brushRadius = "+parseShaderString(options.brushRadius.toString())+";\n";switch(c=(c=c.replace(/\buvwq\./g,"uvwqBrush.")).replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),options.brushValue.includes("RAND")&&(a+=P()),a+="float brushValue = "+parseShaderString(options.brushValue)+";\n",a+=c,options.typeOfBrush){case"circle":a+=n();break;case"hline":a+=r();break;case"vline":a+=i()}switch(options.brushAction){case"replace":a+=s(),a+=o();break;case"add":a+=s(),a+=t();break;case"smoothreplace":a+=l(),a+=o();break;case"smoothadd":a+=l(),a+=t()}a=selectColourspecInShaderStr(a),drawMaterial.fragmentShader=a,drawMaterial.needsUpdate=!0}function setDisplayColourAndType(){colourmap=A(options.colourmap),options.flippedColourmap&&(colourmap.reverse(),colourmap=colourmap.map(e=>e.slice(0,-1).concat([1-e.slice(-1)]))),uniforms.colour1.value=new z.Vector4(...colourmap[0]),uniforms.colour2.value=new z.Vector4(...colourmap[1]),uniforms.colour3.value=new z.Vector4(...colourmap[2]),uniforms.colour4.value=new z.Vector4(...colourmap[3]),uniforms.colour5.value=new z.Vector4(...colourmap[4]);let e=W();options.emboss&&(e+=k(),setEmbossUniforms()),options.contours&&(e+=O(),setContourUniforms()),e+=q(),displayMaterial.fragmentShader=e,displayMaterial.needsUpdate=!0,postMaterial.needsUpdate=!0,colourmapEndpoints=colourmap.map(e=>e[3]),colourmap=colourmap.map(e=>e.slice(0,-1)),render()}function selectColourspecInShaderStr(e){return e=e.replace(/COLOURSPEC/g,speciesToChannelChar(options.whatToDraw))}function setDisplayFunInShader(e){return e=e.replace(/FUN/g,parseShaderString(options.whatToPlot))}function draw(){!options.fixRandSeed&&options.brushValue.includes("RAND")&&updateRandomSeed(),simDomain.material=drawMaterial;for(let e=1;e<simTextures.length;e++)uniforms.textureSource.value=simTextures[e].texture,renderer.setRenderTarget(simTextures[e-1]),renderer.render(simScene,simCamera);simTextures.rotate(-1)}function timestep(){simDomain.material=simMaterial,uniforms.textureSource.value=simTextures[1].texture,renderer.setRenderTarget(simTextures[0]),renderer.render(simScene,simCamera),simTextures.rotate(-1)}function enforceDirichlet(){simDomain.material=dirichletMaterial;for(let e=1;e<simTextures.length;e++)uniforms.textureSource.value=simTextures[e].texture,renderer.setRenderTarget(simTextures[e-1]),renderer.render(simScene,simCamera);simTextures.rotate(-1)}function render(){if(options.autoSetColourRange&&setColourRange(),options.brushEnabled&&"surface"==options.plotType){let e=(getMeanVal()-options.minColourValue)/(options.maxColourValue-options.minColourValue)-.5;clickDomain.position.y=options.threeDHeightScale*e.clamp(-.5,.5),clickDomain.updateWorldMatrix()}if(simDomain.material=postMaterial,uniforms.textureSource.value=simTextures[1].texture,renderer.setRenderTarget(postTexture),renderer.render(simScene,simCamera),uniforms.textureSource.value=postTexture.texture,bufferFilled=!1,"line"==options.plotType){fillBuffer();let o,t=0;for(let n=0;n<buffer.length;n+=4)o=(buffer[n]-options.minColourValue)/(options.maxColourValue-options.minColourValue)-.5,yDisplayDomainCoords[t++]=o.clamp(-.5,.5);let i=new z.SplineCurve(xDisplayDomainCoords.map((e,o)=>new z.Vector2(e,yDisplayDomainCoords[o]))),r=i.getSpacedPoints(numPointsInLine);setLineXY(r),setLineColour(r)}if(options.timeDisplay&&updateTimeDisplay(),options.integrate&&updateIntegralDisplay(),isManuallyInterpolating()&&(simDomain.material=interpolationMaterial,renderer.setRenderTarget(interpolationTexture),renderer.render(simScene,simCamera),uniforms.textureSource.value=interpolationTexture.texture),renderer.setRenderTarget(null),renderer.render(scene,camera),takeAScreenshot){takeAScreenshot=!1;var s=document.createElement("a");s.download="VisualPDEScreenshot",renderer.render(scene,camera),s.href=renderer.domElement.toDataURL(),document.body.appendChild(s),s.click(),document.body.removeChild(s),setSizes(),render()}}function onDocumentPointerDown(e){(isDrawing=setBrushCoords(e,canvas))&&(options.brushEnabled&&"surface"==options.plotType?controls.enabled=!1:options.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),fadein("#top_message"),window.clearTimeout(topMessageTimer),topMessageTimer=setTimeout(function(){$("#top_message").hasClass("fading_out")||fadeout("#top_message")},3e3)))}function onDocumentPointerUp(e){isDrawing=!1,"surface"==options.plotType&&(controls.enabled=!0)}function onDocumentPointerMove(e){setBrushCoords(e,canvas)}function setBrushCoords(e,o){var t=o.getBoundingClientRect();let n=(e.clientX-t.x)/t.width,i=1-(e.clientY-t.y)/t.height;if("surface"==options.plotType){clampedCoords.x=2*n-1,clampedCoords.y=2*i-1,raycaster.setFromCamera(clampedCoords,camera);var r=raycaster.intersectObject(clickDomain,!1);r.length>0?(n=r[0].uv.x,i=r[0].uv.y):(n=-1,i=-1)}else"line"==options.plotType&&(n=(n-.5)/camera.zoom+.5,i=.5);return n=Math.round(n*nXDisc)/nXDisc,i=Math.round(i*nYDisc)/nYDisc,uniforms.brushCoords.value=new z.Vector2(n,i),0<=n&&n<=1&&0<=i&&i<=1}function clearTextures(){setRenderSizeToDisc(),options.fixRandSeed||updateRandomSeed(),checkpointExists&&options.resetFromCheckpoints?simDomain.material=checkpointMaterial:simDomain.material=clearMaterial,simTextures.forEach(e=>{renderer.setRenderTarget(e),renderer.render(simScene,simCamera)}),setDefaultRenderSize(),render()}function pauseSim(){uiHidden||($("#pause").hide(),$("#play").show()),isRunning=!1}function playSim(){uiHidden||($("#play").hide(),$("#pause").show()),isRunning=!0}function resetSim(){clearTextures(),uniforms.t.value=0,updateTimeDisplay(),render(),window.clearTimeout(NaNTimer),checkForNaN()}function parseReactionStrings(){let e="";return e+="float UFUN = "+parseShaderString(options.reactionStrU)+";\n",e+="float VFUN = "+parseShaderString(options.reactionStrV)+";\n",e+="float WFUN = "+parseShaderString(options.reactionStrW)+";\n",e+="float QFUN = "+parseShaderString(options.reactionStrQ)+";\n"}function parseNormalDiffusionStrings(){let e="";return e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrUU)+";\n","uu"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrVV)+";\n","vv"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrWW)+";\n","ww"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrQQ)+";\n","qq")}function parseCrossDiffusionStrings(){let e="";return e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrUV)+";\n","uv"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrUW)+";\n","uw"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrUQ)+";\n","uq"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrVU)+";\n","vu"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrVW)+";\n","vw"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrVQ)+";\n","vq"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrWU)+";\n","wu"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrWV)+";\n","wv"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrWQ)+";\n","wq"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrQU)+";\n","qu"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrQV)+";\n","qv"),e+=nonConstantDiffusionEvaluateInSpaceStr(parseShaderString(options.diffusionStrQW)+";\n","qw")}function nonConstantDiffusionEvaluateInSpaceStr(e,o){let t="",n=/\bx\b/g,i=/\by\b/g,r=/\buvwq\.\b/g;return t+="float D"+o+" = "+e,t+="float D"+o+"L = "+e.replaceAll(n,"(x-dx)").replaceAll(r,"uvwqL."),t+="float D"+o+"R = "+e.replaceAll(n,"(x+dx)").replaceAll(r,"uvwqR."),t+="float D"+o+"T = "+e.replaceAll(i,"(y+dy)").replaceAll(r,"uvwqT."),t+="float D"+o+"B = "+e.replaceAll(i,"(y-dy)").replaceAll(r,"uvwqB.")}function parseShaderString(e){if(!isValidSyntax(e=" "+e+" "))return" 0.0 ";for(e=replaceDigitsWithWords(e=(e=(e=(e=replaceBinOperator(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",function(e,o,t){switch(t){case"0":return"1";case"1":return"("+o+")";case"2":return"(("+o+")*("+o+"))";case"3":return"(("+o+")*("+o+")*("+o+"))";case"4":return"(("+o+")*("+o+")*("+o+")*("+o+"))";case"5":return"(("+o+")*("+o+")*("+o+")*("+o+")*("+o+"))";default:return"safepow("+o+","+t+")"}})).replaceAll(RegExp("\\b("+anySpeciesRegexStrs[0]+")\\b","g"),function(e,o){return"uvwq."+speciesToChannelChar(o)})).replaceAll(RegExp("\\b("+anySpeciesRegexStrs[0]+")_([xy])\\b","g"),function(e,o,t){return"uvwq"+t.toUpperCase()+"."+speciesToChannelChar(o)})).replaceAll(RegExp("\\b("+anySpeciesRegexStrs[0]+")_(xx|yy)\\b","g"),function(e,o,t){return"uvwq"+t.toUpperCase()+"."+speciesToChannelChar(o)}));e!=(e=e.replace(/([^.0-9])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function replaceBinOperator(e,o,t){let n="^*".includes(o);if(e.indexOf(o)>-1){let i=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,function(e,o){return i.push(o),r+(i.length-1)});i.push(e),e=r+(i.length-1);let s;for(s=n?RegExp("([\\w.]*)\\s*\\"+o+"\\s*([\\w.]*)","g"):RegExp("([\\w.]*)\\s*"+o+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(RegExp(r+"(\\w+)","g"),function(e,o){return i[o].replace(s,t)})}return e}function setRDEquations(){let e="",o="",t="",n="",i="",r=[options.boundaryConditionsU,options.boundaryConditionsV,options.boundaryConditionsW,options.boundaryConditionsQ,],s=[options.neumannStrU,options.neumannStrV,options.neumannStrW,options.neumannStrQ,],l=[options.comboStrU,options.comboStrV,options.comboStrW,options.comboStrQ,].map(e=>e+";"),a=[options.dirichletStrU,options.dirichletStrV,options.dirichletStrW,options.dirichletStrQ,],c=[options.robinStrU,options.robinStrV,options.robinStrW,options.robinStrQ,];if(r.forEach(function(o,t){"neumann"==o?(e+=parseRobinRHS(s[t],listOfSpecies[t]),e+=neumannUpdateShader(t)):"combo"==o&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g),].forEach(function(o){let n=o[1][0].toUpperCase();e+=parseRobinRHS(o[2],listOfSpecies[t],n),e+=neumannUpdateShader(t,n)})}),r.forEach(function(e,t){"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g),].forEach(function(e){let n=e[1][0].toUpperCase();o+=ghostUpdateShader(t,n,parseShaderString(e[2]))})}),options.domainViaIndicatorFun){let u=b().replace(/indicatorFun/g,parseShaderString(options.domainIndicatorFun));a.forEach(function(e,o){t+=selectSpeciesInShaderStr(u,listOfSpecies[o])+parseShaderString(e)+";\n}\n"})}else r.forEach(function(e,o){"dirichlet"==e?(t+=parseDirichletRHS(a[o],listOfSpecies[o]),t+=dirichletUpdateShader(o)):"combo"==e&&[...l[o].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g),].forEach(function(e){let n=e[1][0].toUpperCase();t+=parseDirichletRHS(e[2],listOfSpecies[o],n),t+=dirichletUpdateShader(o,n)})});r.forEach(function(e,o){"robin"==e?(n+=parseRobinRHS(c[o],listOfSpecies[o]),n+=robinUpdateShader(o)):"combo"==e&&[...l[o].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g),].forEach(function(e){let t=e[1][0].toUpperCase();n+=parseRobinRHS(e[2],listOfSpecies[o],t),n+=robinUpdateShader(o,t)})});let p=kineticUniformsForShader();i=parseNormalDiffusionStrings()+"\n",options.crossDiffusion?i+=parseCrossDiffusionStrings()+"\n"+w():i+=v(),algebraicV&&options.crossDiffusion&&(i+=selectSpeciesInShaderStr(y(),listOfSpecies[1])),algebraicW&&options.crossDiffusion&&(i+=selectSpeciesInShaderStr(I(),listOfSpecies[2])),algebraicQ&&options.crossDiffusion&&(i+=selectSpeciesInShaderStr(T(),listOfSpecies[3]));if(i.match(/\buvwq[XY]\.[rgba]\b/)){alert("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");return}if(simMaterial.fragmentShader=[p,h(),_(),E(),e,o,n,G(),x(),parseReactionStrings(),i,t,C(),].join(" "),simMaterial.needsUpdate=!0,checkForAnyDirichletBCs(),anyDirichletBCs){if(t=p+V(),options.domainViaIndicatorFun){let d=b().replace(/indicatorFun/g,parseShaderString(options.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");a.forEach(function(e,o){t+=selectSpeciesInShaderStr(d,listOfSpecies[o])+parseShaderString(e)+";\n}\n"})}else r.forEach(function(e,o){"dirichlet"==e?(t+=parseDirichletRHS(a[o],listOfSpecies[o]),t+=dirichletEnforceShader(o)):"combo"==e&&[...l[o].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g),].forEach(function(e){let n=e[1][0].toUpperCase();t+=parseDirichletRHS(e[2],listOfSpecies[o],n),t+=dirichletEnforceShader(o,n)})});t+="}",dirichletMaterial.fragmentShader=t,dirichletMaterial.needsUpdate=!0}}function checkForAnyDirichletBCs(){anyDirichletBCs=options.domainViaIndicatorFun||"dirichlet"==options.boundaryConditionsU||"dirichlet"==options.boundaryConditionsV||"dirichlet"==options.boundaryConditionsW||"dirichlet"==options.boundaryConditionsQ||/Dirichlet/.test(options.comboStrU)||/Dirichlet/.test(options.comboStrV)||/Dirichlet/.test(options.comboStrW)||/Dirichlet/.test(options.comboStrQ)}function parseRobinRHS(e,o,t){return void 0==t?["L","R","T","B"].map(t=>parseRobinRHS(e,o,t)).join(""):"float robinRHS"+o+t+" = "+parseShaderString(e)+";\n"}function parseDirichletRHS(e,o,t){return void 0==t?["L","R","T","B"].map(t=>parseDirichletRHS(e,o,t)).join(""):"float dirichletRHS"+o+t+" = "+parseShaderString(e)+";\n"}function loadPreset(e){loadOptions("default"),loadOptions(e),void 0!=options.threeD&&(options.threeD&&(options.dimension=2,options.plotType="surface"),delete options.threeD),void 0!=options.oneDimensional&&(options.oneDimensional&&(options.dimension=1,options.plotType="line"),delete options.oneDimensional),options.domainScale*=domainScaleFactor,configureViews(),deleteGUIs(),initGUI(),options.activeViewInd<options.views.length?applyView(options.views[options.activeViewInd],!1,!1):applyView({},!0,!1),updateProblem(),setCanvasShape(),resize(),updateUniforms(),scene.background=new z.Color(options.backgroundColour),""!=options.initialState?fetch(options.initialState).then(e=>e.blob()).then(e=>loadSimState(e)):resetSim(),configureCameraAndClicks(),imControllerOne.remove(),imControllerTwo.remove(),createImageControllers(),configureManualInterpolation()}function loadOptions(e){let o;if((o=void 0==e?X(options.preset):"string"==typeof e?X(e):"object"==typeof e?e:X("default")).hasOwnProperty("parent")&&null!=o.parent&&loadOptions(o.parent),kineticParamsCounter=0,kineticParamsLabels=[],kineticParamsStrs={},Object.assign(options,o),setCustomNames(!0),(isRunning=options.runningOnLoad)?playSim():pauseSim(),onMobile()?options.tryClickingText=options.tryClickingText.replaceAll("clicking","tapping"):options.tryClickingText=options.tryClickingText.replaceAll("tapping","clicking"),options.brushRadius=options.brushRadius.toString(),options.hasOwnProperty("drawIn3D")&&(options.brushEnabled=options.drawIn3D),listOfSpecies.includes("T")||Object.keys(options).forEach(function(e){userTextFields.includes(e)&&(options[e]=replaceSymbolsInStr(options[e],["T"],["I_T"],"[RGBA]"))}),!listOfSpecies.includes("S")){Object.keys(options).forEach(function(e){userTextFields.includes(e)&&(options[e]=replaceSymbolsInStr(options[e],["S"],["I_S"],"[RGBA]"))});var t=0;t+=options.hasOwnProperty("algebraicV"),t+=options.hasOwnProperty("algebraicW"),(t+=options.hasOwnProperty("algebraicQ"))&&!options.numAlgebraicSpecies&&(options.numAlgebraicSpecies=t),delete options.algebraicV,delete options.algebraicW,delete options.algebraicQ,savedOptions=options}let n=[options.clearValueU,options.clearValueV,options.clearValueW,options.clearValueQ,options.domainIndicatorFun,options.reactionStrU,options.reactionStrV,options.reactionStrW,options.reactionStrQ,options.diffusionStrUU,options.diffusionStrUV,options.diffusionStrUW,options.diffusionStrUQ,options.diffusionStrVU,options.diffusionStrVV,options.diffusionStrVW,options.diffusionStrVQ,options.diffusionStrWU,options.diffusionStrWV,options.diffusionStrWW,options.diffusionStrWQ,options.diffusionStrQU,options.diffusionStrQV,options.diffusionStrQW,options.diffusionStrQQ,options.dirichletStrU,options.dirichletStrV,options.dirichletStrW,options.dirichletStrQ,options.robinStrU,options.robinStrV,options.robinStrW,options.robinStrQ,options.comboStrU,options.comboStrV,options.comboStrW,options.comboStrQ,options.neumannStrU,options.neumannStrV,options.neumannStrW,options.neumannStrQ,options.brushValue,options.whatToPlot,].join(" ");options.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(n)}function refreshGUI(e,o){if(void 0==o&&(o=!0),void 0!=e){for(let t in e.__folders)refreshGUI(e.__folders[t],!1);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].updateDisplay()}o&&void 0!=MathJax.typesetPromise&&MathJax.typesetPromise()}function deleteGUIs(){deleteGUI(leftGUI,!0),deleteGUI(rightGUI,!0),deleteGUI(viewsGUI,!0)}function deleteGUI(e,o){if(void 0!=e){for(let t in e.__folders)deleteGUI(e.__folders[t]),e.removeFolder(e.__folders[t]);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].remove();void 0!=o&&o&&(e.domElement.remove(),e.destroy())}}function hideGUIController(e){void 0!=e&&(e.__li.style.display="none")}function showGUIController(e){void 0!=e&&(e.__li.style.display="")}function setGUIControllerName(e,o,t){void 0!=e&&(e.name(o),void 0!=t&&e.title(t))}function selectSpeciesInShaderStr(e,o){if(0==o.length)return"";let t=/\bSPECIES\b/g,n=speciesToChannelChar(o);return e=e.replace(t,n),t=/\brobinRHSSPECIES/g,e=e.replace(t,"robinRHS"+o),t=/\bdirichletRHSSPECIES/g,e=e.replace(t,"dirichletRHS"+o)}function speciesToChannelChar(e){return"rgba"[speciesToChannelInd(e)]}function speciesToChannelInd(e){return listOfSpecies.indexOf(e)}function setBCsGUI(){"dirichlet"==options.boundaryConditionsU?showGUIController(dirichletUController):hideGUIController(dirichletUController),"dirichlet"==options.boundaryConditionsV?showGUIController(dirichletVController):hideGUIController(dirichletVController),"dirichlet"==options.boundaryConditionsW?showGUIController(dirichletWController):hideGUIController(dirichletWController),"dirichlet"==options.boundaryConditionsQ?showGUIController(dirichletQController):hideGUIController(dirichletQController),"neumann"==options.boundaryConditionsU?showGUIController(neumannUController):hideGUIController(neumannUController),"neumann"==options.boundaryConditionsV?showGUIController(neumannVController):hideGUIController(neumannVController),"neumann"==options.boundaryConditionsW?showGUIController(neumannWController):hideGUIController(neumannWController),"neumann"==options.boundaryConditionsQ?showGUIController(neumannQController):hideGUIController(neumannQController),"robin"==options.boundaryConditionsU?showGUIController(robinUController):hideGUIController(robinUController),"robin"==options.boundaryConditionsV?showGUIController(robinVController):hideGUIController(robinVController),"robin"==options.boundaryConditionsW?showGUIController(robinWController):hideGUIController(robinWController),"robin"==options.boundaryConditionsQ?showGUIController(robinQController):hideGUIController(robinQController),"combo"==options.boundaryConditionsU?showGUIController(comboUController):hideGUIController(comboUController),"combo"==options.boundaryConditionsV?showGUIController(comboVController):hideGUIController(comboVController),"combo"==options.boundaryConditionsW?showGUIController(comboWController):hideGUIController(comboWController),"combo"==options.boundaryConditionsQ?showGUIController(comboQController):hideGUIController(comboQController),options.domainViaIndicatorFun?(hideGUIController(uBCsController),hideGUIController(vBCsController),hideGUIController(wBCsController),hideGUIController(qBCsController)):showGUIController(uBCsController)}function updateRandomSeed(){uniforms.seed.value=performance.now()%1e3}function setClearShader(){let e=kineticUniformsForShader()+H();(options.clearValueU.includes("RAND")||options.clearValueV.includes("RAND")||options.clearValueW.includes("RAND")||options.clearValueQ.includes("RAND"))&&(e+=P()),e+="float u = "+parseShaderString(options.clearValueU)+";\n",e+="float v = "+parseShaderString(options.clearValueV)+";\n",e+="float w = "+parseShaderString(options.clearValueW)+";\n",e+="float q = "+parseShaderString(options.clearValueQ)+";\n",e+=M(),clearMaterial.fragmentShader=e,clearMaterial.needsUpdate=!0}function loadImageSourceOne(){let e=new Image;e.src=imControllerOne.__image.src;let o=new z.Texture;o.image=e,e.onload=function(){o.needsUpdate=!0,uniforms.imageSourceOne.value=o,options.resetOnImageLoad&&resetSim()}}function loadImageSourceTwo(){let e=new Image;e.src=imControllerTwo.__image.src;let o=new z.Texture;o.image=e,e.onload=function(){o.needsUpdate=!0,uniforms.imageSourceTwo.value=o,options.resetOnImageLoad&&resetSim()},o.dispose()}function createImageControllers(){imControllerOne=(root=fIm).addImage(options,"imagePathOne").name("$I_S(x,y)$").onChange(loadImageSourceOne),imControllerTwo=root.addImage(options,"imagePathTwo").name("$I_T(x,y)$").onChange(loadImageSourceTwo),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise()}function updateWhatToPlot(){"MAX"==options.whatToPlot?(setPostFunMaxFragShader(),hideGUIController(minColourValueController),hideGUIController(maxColourValueController),hideGUIController(setColourRangeController),hideGUIController(autoSetColourRangeController),options.autoSetColourRange=!1,refreshGUI(rightGUI)):(setPostFunFragShader(),showGUIController(minColourValueController),showGUIController(maxColourValueController),showGUIController(setColourRangeController),showGUIController(autoSetColourRangeController)),configureColourbar(),configureIntegralDisplay(),render()}function showVGUIPanels(){options.crossDiffusion?(showGUIController(DuvController),showGUIController(DvuController)):(hideGUIController(DuvController),hideGUIController(DvuController)),showGUIController(DvvController),showGUIController(gController),showGUIController(clearValueVController),showGUIController(vBCsController)}function showWGUIPanels(){options.crossDiffusion?(showGUIController(DuwController),showGUIController(DvwController),showGUIController(DwuController),showGUIController(DwvController)):(hideGUIController(DuwController),hideGUIController(DvwController),hideGUIController(DwuController),hideGUIController(DwvController)),showGUIController(DwwController),showGUIController(hController),showGUIController(clearValueWController),showGUIController(wBCsController)}function showQGUIPanels(){options.crossDiffusion?(showGUIController(DuqController),showGUIController(DvqController),showGUIController(DwqController),showGUIController(DquController),showGUIController(DqvController),showGUIController(DqwController)):(hideGUIController(DwqController),hideGUIController(DquController),hideGUIController(DvqController),hideGUIController(DuqController),hideGUIController(DqvController),hideGUIController(DqwController)),showGUIController(DqqController),showGUIController(jController),showGUIController(clearValueQController),showGUIController(qBCsController)}function hideVGUIPanels(){hideGUIController(DuvController),hideGUIController(DvuController),hideGUIController(DvvController),hideGUIController(gController),hideGUIController(clearValueVController),hideGUIController(vBCsController)}function hideWGUIPanels(){hideGUIController(DuwController),hideGUIController(DvwController),hideGUIController(DwuController),hideGUIController(DwvController),hideGUIController(DwwController),hideGUIController(hController),hideGUIController(clearValueWController),hideGUIController(wBCsController)}function hideQGUIPanels(){hideGUIController(DuqController),hideGUIController(DvqController),hideGUIController(DwqController),hideGUIController(DquController),hideGUIController(DqvController),hideGUIController(DqwController),hideGUIController(DqqController),hideGUIController(jController),hideGUIController(clearValueQController),hideGUIController(qBCsController)}function diffObjects(e,o){return Object.fromEntries(Object.entries(e).filter(([e,t])=>JSON.stringify(o[e])!==JSON.stringify(t)))}function getMinMaxVal(){fillBuffer();let e=1/0,o=-1/0;for(let t=0;t<buffer.length;t+=4)e=Math.min(e,buffer[t]),o=Math.max(o,buffer[t]);return[e,o]}function getMeanVal(){fillBuffer();let e=0;for(let o=0;o<buffer.length;o+=4)e+=buffer[o];return e/(nXDisc*nYDisc)}function setPostFunFragShader(){let e=kineticUniformsForShader()+a();e+=c(),e=setDisplayFunInShader(e),options.domainViaIndicatorFun&&(e+=d().replace(/indicatorFun/g,parseShaderString(options.domainIndicatorFun))),postMaterial.fragmentShader=e+p(),postMaterial.needsUpdate=!0}function setPostFunMaxFragShader(){postMaterial.fragmentShader=u()+d().replace(/indicatorFun/g,parseShaderString(options.domainIndicatorFun))+p(),postMaterial.needsUpdate=!0,options.minColourValue=0,options.maxColourValue=1,updateUniforms()}function setAlgebraicVarsFromOptions(){options.numAlgebraicSpecies=Math.min(parseInt(options.numAlgebraicSpecies),parseInt(options.numSpecies)-1),algebraicV=options.numAlgebraicSpecies>=options.numSpecies-1,algebraicW=options.numAlgebraicSpecies>=options.numSpecies-2,algebraicQ=options.numAlgebraicSpecies>=options.numSpecies-3}function problemTypeFromOptions(){switch(setAlgebraicVarsFromOptions(),parseInt(options.numSpecies)){case 1:equationType=0;break;case 2:equationType=options.crossDiffusion?1==options.numAlgebraicSpecies?3:2:1;break;case 3:if(options.crossDiffusion)switch(options.numAlgebraicSpecies){case 0:equationType=5;break;case 1:equationType=6;break;case 2:equationType=7}else equationType=4;break;case 4:if(options.crossDiffusion)switch(options.numAlgebraicSpecies){case 0:equationType=9;break;case 1:equationType=10;break;case 2:equationType=11;break;case 3:equationType=12}else equationType=8}}function configureGUI(){let e="function of "+listOfSpecies.slice(0,options.numSpecies).join(", ")+", x, y, t",o=e.replace(" "+listOfSpecies[1]+",",""),t=e.replace(" "+listOfSpecies[2]+",",""),n=e.replace(" "+listOfSpecies[3]+",","");switch(1==options.dimension&&(e=e.replace(" y,","")),options.crossDiffusion&&parseInt(options.numSpecies)>1?(updatingAlgebraicSpecies||updateGUIDropdown(algebraicSpeciesController,Array.from(Array(parseInt(options.numSpecies)).keys())),showGUIController(algebraicSpeciesController)):hideGUIController(algebraicSpeciesController),options.numSpecies>1?showGUIController(crossDiffusionController):hideGUIController(crossDiffusionController),hideVGUIPanels(),hideWGUIPanels(),hideQGUIPanels(),parseInt(options.numSpecies)){case 4:showQGUIPanels();case 3:showWGUIPanels();case 2:showVGUIPanels()}1==options.numSpecies?setGUIControllerName(DuuController,TeXStrings.D,e):options.crossDiffusion?(setGUIControllerName(DuuController,TeXStrings.Duu,e),setGUIControllerName(DuvController,TeXStrings.Duv,e),setGUIControllerName(DuwController,TeXStrings.Duw,e),setGUIControllerName(DuqController,TeXStrings.Duq,e),setGUIControllerName(DvuController,TeXStrings.Dvu,e),setGUIControllerName(DvvController,TeXStrings.Dvv,e),setGUIControllerName(DvwController,TeXStrings.Dvw,e),setGUIControllerName(DvqController,TeXStrings.Dvq,e),setGUIControllerName(DwuController,TeXStrings.Dwu,e),setGUIControllerName(DwvController,TeXStrings.Dwv,e),setGUIControllerName(DwwController,TeXStrings.Dww,e),setGUIControllerName(DwqController,TeXStrings.Dwq,e),setGUIControllerName(DquController,TeXStrings.Dqu,e),setGUIControllerName(DqvController,TeXStrings.Dqv,e),setGUIControllerName(DqwController,TeXStrings.Dqw,e),setGUIControllerName(DqqController,TeXStrings.Dqq,e)):(setGUIControllerName(DuuController,TeXStrings.Du,e),setGUIControllerName(DvvController,TeXStrings.Dv,e),setGUIControllerName(DwwController,TeXStrings.Dw,e),setGUIControllerName(DqqController,TeXStrings.Dq,e)),setGUIControllerName(fController,TeXStrings.UFUN,e),setGUIControllerName(gController,TeXStrings.VFUN,e),setGUIControllerName(hController,TeXStrings.WFUN,e),setGUIControllerName(jController,TeXStrings.QFUN,e),algebraicV&&(setGUIControllerName(DvuController,TeXStrings.Dvu,o),setGUIControllerName(DvwController,TeXStrings.Dvw,o),setGUIControllerName(DvqController,TeXStrings.Dvq,o),setGUIControllerName(gController,TeXStrings.VFUN,o),hideGUIController(DvvController)),algebraicW&&(setGUIControllerName(DwuController,TeXStrings.Dwu,n),setGUIControllerName(DwvController,TeXStrings.Dwv,n),setGUIControllerName(DwqController,TeXStrings.Dwq,n),setGUIControllerName(hController,TeXStrings.WFUN,n),hideGUIController(DwwController)),algebraicQ&&(setGUIControllerName(DquController,TeXStrings.Dqu,t),setGUIControllerName(DqvController,TeXStrings.Dqv,t),setGUIControllerName(DqwController,TeXStrings.Dqw,t),setGUIControllerName(jController,TeXStrings.QFUN,t),hideGUIController(DqqController)),setGUIControllerName(uBCsController,TeXStrings.u),setGUIControllerName(vBCsController,TeXStrings.v),setGUIControllerName(wBCsController,TeXStrings.w),setGUIControllerName(qBCsController,TeXStrings.q),setGUIControllerName(dirichletUController,TeXStrings.uD),setGUIControllerName(dirichletVController,TeXStrings.vD),setGUIControllerName(dirichletWController,TeXStrings.wD),setGUIControllerName(dirichletQController,TeXStrings.qD),setGUIControllerName(neumannUController,TeXStrings.uN),setGUIControllerName(neumannVController,TeXStrings.vN),setGUIControllerName(neumannWController,TeXStrings.wN),setGUIControllerName(neumannQController,TeXStrings.qN),setGUIControllerName(robinUController,TeXStrings.uN),setGUIControllerName(robinVController,TeXStrings.vN),setGUIControllerName(robinWController,TeXStrings.wN),setGUIControllerName(robinQController,TeXStrings.qN),setGUIControllerName(clearValueUController,TeXStrings.uInit),setGUIControllerName(clearValueVController,TeXStrings.vInit),setGUIControllerName(clearValueWController,TeXStrings.wInit),setGUIControllerName(clearValueQController,TeXStrings.qInit),options.domainViaIndicatorFun?showGUIController(domainIndicatorFunController):hideGUIController(domainIndicatorFunController),setBCsGUI(),"surface"==options.plotType?(hideGUIController(contourController),showGUIController(embossController),hideGUIController(lineWidthMulController),showGUIController(threeDHeightScaleController),showGUIController(cameraThetaController),showGUIController(cameraPhiController),showGUIController(cameraZoomController)):"line"==options.plotType?(hideGUIController(contourController),hideGUIController(embossController),showGUIController(lineWidthMulController),showGUIController(threeDHeightScaleController),hideGUIController(cameraThetaController),hideGUIController(cameraPhiController),hideGUIController(cameraZoomController)):(showGUIController(contourController),showGUIController(embossController),hideGUIController(lineWidthMulController),hideGUIController(threeDHeightScaleController),hideGUIController(cameraThetaController),hideGUIController(cameraPhiController),hideGUIController(cameraZoomController)),configureColourbar(),configureTimeDisplay(),configureIntegralDisplay(),configureDataContainer(),"line"==options.plotType?(hideGUIController(typeOfBrushController),$(":root").css("--ui-button-outline","black")):(showGUIController(typeOfBrushController),$(":root").css("--ui-button-outline","white")),manualInterpolationNeeded?hideGUIController(forceManualInterpolationController):showGUIController(forceManualInterpolationController),isManuallyInterpolating()?showGUIController(smoothingScaleController):hideGUIController(smoothingScaleController),updateGUIDropdown(whatToDrawController,listOfSpecies.slice(0,options.numSpecies)),updateEmbossSliders(),configureViewsGUI(),refreshGUI(leftGUI),refreshGUI(rightGUI),refreshGUI(viewsGUI)}function configureOptions(){let e;switch(setAlgebraicVarsFromOptions(),options.domainViaIndicatorFun&&(options.boundaryConditionsU="dirichlet",options.boundaryConditionsV="dirichlet",options.boundaryConditionsW="dirichlet",options.boundaryConditionsQ="dirichlet"),parseInt(options.numSpecies)){case 1:options.crossDiffusion=!1,options.whatToDraw=listOfSpecies[0],options.whatToPlot=listOfSpecies[0],options.diffusionStrUV="0",options.diffusionStrUW="0",options.diffusionStrUQ="0",options.diffusionStrVU="0",options.diffusionStrVV="0",options.diffusionStrVW="0",options.diffusionStrVQ="0",options.diffusionStrWU="0",options.diffusionStrWV="0",options.diffusionStrWW="0",options.diffusionStrWQ="0",options.diffusionStrQU="0",options.diffusionStrQV="0",options.diffusionStrQW="0",options.diffusionStrQQ="0",options.boundaryConditionsV="periodic",options.clearValueV="0",options.reactionStrV="0",options.boundaryConditionsW="periodic",options.clearValueW="0",options.reactionStrW="0",options.boundaryConditionsQ="periodic",options.clearValueQ="0",options.reactionStrQ="0",(e=RegExp("\\b("+anySpeciesRegexStrs[1]+")\\b")).test(options.reactionStrU)&&(options.reactionStrU="0");break;case 2:options.whatToDraw==listOfSpecies[2]|options.whatToDraw==listOfSpecies[3]&&(options.whatToDraw=listOfSpecies[0]),options.whatToPlot==listOfSpecies[2]|options.whatToPlot==listOfSpecies[3]&&(options.whatToPlot=listOfSpecies[0]),options.diffusionStrUW="0",options.diffusionStrUQ="0",options.diffusionStrVW="0",options.diffusionStrVQ="0",options.diffusionStrWU="0",options.diffusionStrWV="0",options.diffusionStrWW="0",options.diffusionStrWQ="0",options.diffusionStrQU="0",options.diffusionStrQV="0",options.diffusionStrQW="0",options.diffusionStrQQ="0",options.boundaryConditionsW="periodic",options.clearValueW="0",options.reactionStrW="0",options.boundaryConditionsQ="periodic",options.clearValueQ="0",options.reactionStrQ="0",(e=RegExp("\\b("+anySpeciesRegexStrs[2]+")\\b")).test(options.reactionStrU)&&(options.reactionStrU="0"),e.test(options.reactionStrV)&&(options.reactionStrV="0");break;case 3:options.whatToDraw==listOfSpecies[3]&&(options.whatToDraw=listOfSpecies[0]),options.whatToPlot==listOfSpecies[3]&&(options.whatToPlot=listOfSpecies[0]),options.diffusionStrUQ="0",options.diffusionStrVQ="0",options.diffusionStrWQ="0",options.diffusionStrQU="0",options.diffusionStrQV="0",options.diffusionStrQW="0",options.diffusionStrQQ="0",options.boundaryConditionsQ="periodic",options.clearValueQ="0",options.reactionStrQ="0",(e=RegExp("\\b("+anySpeciesRegexStrs[3]+")\\b")).test(options.reactionStrU)&&(options.reactionStrU="0"),e.test(options.reactionStrV)&&(options.reactionStrV="0"),e.test(options.reactionStrW)&&(options.reactionStrW="0")}switch(equationType){case 3:options.diffusionStrVV="0";break;case 6:options.diffusionStrWW="0";break;case 7:options.diffusionStrVV="0",options.diffusionStrWW="0";break;case 10:options.diffusionStrQQ="0";break;case 11:options.diffusionStrWW="0",options.diffusionStrQQ="0";break;case 12:options.diffusionStrVV="0",options.diffusionStrWW="0",options.diffusionStrQQ="0"}refreshGUI(leftGUI),refreshGUI(rightGUI)}function updateProblem(){problemTypeFromOptions(),configurePlotType(),configureDimension(),configureOptions(),configureGUI(),setKineticUniforms(),updateShaders(),setEquationDisplayType(),resetSim()}function setEquationDisplayType(){let e=equationTEX[equationType],o,t={};if(t.D=/\b(D) (\\vnabla u)/g,t.U=/\b(D_{u}) (\\vnabla u)/g,t.UU=/\b(D_{u u}) (\\vnabla u)/g,t.V=/\b(D_{v}) (\\vnabla v)/g,t.VV=/\b(D_{v v}) (\\vnabla v)/g,t.W=/\b(D_{w}) (\\vnabla w)/g,t.WW=/\b(D_{w w}) (\\vnabla w)/g,t.Q=/\b(D_{q}) (\\vnabla q)/g,t.QQ=/\b(D_{q q}) (\\vnabla q)/g,t.UV=/\b(D_{u v}) (\\vnabla v)/g,t.UW=/\b(D_{u w}) (\\vnabla w)/g,t.UQ=/\b(D_{u q}) (\\vnabla q)/g,t.VU=/\b(D_{v u}) (\\vnabla u)/g,t.VW=/\b(D_{v w}) (\\vnabla w)/g,t.VQ=/\b(D_{v q}) (\\vnabla q)/g,t.WU=/\b(D_{w u}) (\\vnabla u)/g,t.WV=/\b(D_{w v}) (\\vnabla v)/g,t.WQ=/\b(D_{w q}) (\\vnabla q)/g,t.QU=/\b(D_{q u}) (\\vnabla u)/g,t.QV=/\b(D_{q v}) (\\vnabla v)/g,t.QW=/\b(D_{q w}) (\\vnabla w)/g,t.UFUN=/\b(UFUN)/g,t.VFUN=/\b(VFUN)/g,t.WFUN=/\b(WFUN)/g,t.QFUN=/\b(QFUN)/g,options.typesetCustomEqs){let n={};n.D=options.diffusionStrUU,n.U=options.diffusionStrUU,n.UU=options.diffusionStrUU,n.V=options.diffusionStrVV,n.VV=options.diffusionStrVV,n.W=options.diffusionStrWW,n.WW=options.diffusionStrWW,n.Q=options.diffusionStrQQ,n.QQ=options.diffusionStrQQ,n.UV=options.diffusionStrUV,n.UW=options.diffusionStrUW,n.UQ=options.diffusionStrUQ,n.VU=options.diffusionStrVU,n.VW=options.diffusionStrVW,n.VQ=options.diffusionStrVQ,n.WU=options.diffusionStrWU,n.WV=options.diffusionStrWV,n.WQ=options.diffusionStrWQ,n.QU=options.diffusionStrQU,n.QV=options.diffusionStrQV,n.QW=options.diffusionStrQW,n.UFUN=options.reactionStrU,n.VFUN=options.reactionStrV,n.WFUN=options.reactionStrW,n.QFUN=options.reactionStrQ;var i=!1;if(Object.keys(n).forEach(function(e){i||(i|=!isValidSyntax(n[e]))}),i)return;for(Object.keys(n).forEach(function(e){var o;n[e]=replaceSymbolsInStr(o=n[e],listOfSpecies,defaultSpecies,"_[xy]")}),selectedEntries.forEach(function(e){n[e]="\\selected{ "+n[e]+" }"}),Object.keys(n).forEach(function(o){defaultReactions.includes(o)||(e=replaceUserDefDiff(e,t[o],n[o],"[]"))}),e=replaceUserDefReac(e,t.UFUN,n.UFUN),e=replaceUserDefReac(e,t.VFUN,n.VFUN),e=replaceUserDefReac(e,t.WFUN,n.WFUN),e=replaceUserDefReac(e,t.QFUN,n.QFUN),o=/\(\s*\+/g;e!=(e=e.replace(o,"(")););for(o=/\[\s*\+/g;e!=(e=e.replace(o,"[")););for(o=/\+\s*\)/g;e!=(e=e.replace(o,")")););o=/\\vnabla\s*\\cdot\s*\(\s*\)/g,e=e.replaceAll(o,""),o=/=\s*\+/g,e=e.replaceAll(o,"="),o=/\+\s*(\\\\|\n)/g,e=e.replaceAll(o,"$1"),o=/=\s*(\\\\|\n)/g,e=e.replaceAll(o,"=0$1"),o=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,e=e.replaceAll(o,"-$1$2$3"),o=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,e=e.replaceAll(o,"$1 \\lap $2"),o=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,e=e.replaceAll(o,function(e,o,t){return/\b[xy]|[uvwq]\b/g.test(o)?e:o+" \\lap "+t}),o=/\b([uvwq])_([xy])\b/g,e=e.replaceAll(o,"\\textstyle \\pd{$1}{$2}"),o=/\b([uvwq])_(xx|yy)\b/g,e=e.replaceAll(o,function(e,o,t){return"\\textstyle \\pdd{"+o+"}{"+t[0]+"}"})}else selectedEntries.forEach(function(o){e=e.replaceAll(t[o],function(e,o,t){let n="\\selected{ "+o+" ";return"string"==typeof t&&(n+=t),n+" }"})}),e=replaceSymbolsInStr(e,["UFUN","VFUN","WFUN","QFUN"],listOfReactions,"_[xy]");1==options.dimension&&(e=e.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),o=/\\vnabla\s*([uvwq])/g,e=e.replaceAll(o,"\\textstyle \\pd{$1}{x}"),o=/\\lap\s*([uvwq])/g,e=e.replaceAll(o,"\\textstyle \\pdd{$1}{x}")),e=parseStringToTEX(e=replaceSymbolsInStr(e,defaultSpecies.concat(defaultReactions),listOfSpecies.concat(listOfReactions),"_[xy]")),$("#typeset_equation").html(e),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise().then(resizeEquationDisplay)}function parseStringToTEX(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=replaceFunctionInTeX(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=replaceFunctionInTeX(e,"cos",!0),e=replaceFunctionInTeX(e,"tan",!0),e=replaceFunctionInTeX(e,"exp",!0),e=replaceFunctionInTeX(e,"log",!0),e=replaceFunctionInTeX(e,"sqrt",!1),e=replaceFunctionInTeX(e,"sinh",!0),e=replaceFunctionInTeX(e,"cosh",!0),e=replaceFunctionInTeX(e,"tanh",!0),e=replaceFunctionInTeX(e,"max",!0),e=es(e=replaceBinOperator(e=(e=replaceFunctionInTeX(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}")),e=(e=(e=(e=alternateBrackets(e)).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")}function replaceFunctionInTeX(e,o,t){var n=e;let i=e.matchAll(RegExp("\\b"+o+"\\b","g")),r,s,l,a,c,u,p,d=0;for(let m of i){for(s=(r=m.index)+o.length,a=e.slice(s),p=0,c=0,u=!1;p<=a.length&(!u|!(u&&0==c));)c+=["(","["].includes(a[p]),c-=[")","]"].includes(a[p]),u|=c,p+=1;u&&0==c&&(l=p-1+s,n=insertStrAtIndex(n,"\\",r+d),d+=1,t?(n=insertStrAtIndex(n,"{",s+d),d+=1,n=insertStrAtIndex(n,"}",l+1+d),d+=1):(n=replaceStrAtIndex(n,"{",s+d),n=replaceStrAtIndex(n,"}",l+d)))}return n}function alternateBrackets(e){let o=["(","["],t=[")","]"],n=0,i=0,r=0,s="",l="";for(var a=0;a<e.length;a++)o.includes(e[a])?(n+=1,i+=1):t.includes(e[a])&&(n-=1),0==n&&i>0&&(l+=alternateBracketsGivenDepth(s=e.slice(r,a+1),i),i=0,r=a+1);return l+e.slice(r)}function alternateBracketsGivenDepth(e,o){let t=["(","["],n=[")","]"],i=modulo(-o+1,t.length);for(var r=0;r<e.length;r++)t.includes(e[r])?(e=replaceStrAtIndex(e,t[i],r),i+=1,i=modulo(i,t.length)):n.includes(e[r])&&(i-=1,e=replaceStrAtIndex(e,n[i=modulo(i,t.length)],r));return e}function modulo(e,o){return(e%o+o)%o}function replaceStrAtIndex(e,o,t){return e.slice(0,t)+o+e.slice(t+1,e.length)}function insertStrAtIndex(e,o,t){return e.slice(0,t)+o+e.slice(t,e.length)}function removeWhitespace(e){return e=e.replace(/\s+/g,"  ").trim()}function createParameterController(e,o){let t;function n(){t.hasOwnProperty("slider")&&(t.slider.remove(),delete t.slider,t.domElement.closest("li").classList.remove("parameterSlider"));let o=kineticParamsStrs[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(o){t.domElement.parentElement.parentElement.classList.add("parameterSlider"),t.slider=document.createElement("input"),t.slider.classList.add("styled-slider"),t.slider.classList.add("slider-progress"),t.slider.type="range",t.slider.min=o[3],t.slider.max=o[5];let n;void 0==o[4]?(o[4]="",!kineticParamsStrs[e].includes(".")&parseFloat(o[5])-parseFloat(o[3])>1?n=1:(t.slider.precision=Math.max(parseFloat(o[2]).countDecimals(),parseFloat(o[3]).countDecimals(),parseFloat(o[5]).countDecimals())+1,n=Math.min((parseFloat(o[5])-parseFloat(o[3]))/20,10**-t.slider.precision))):(t.slider.precision=Math.max(parseFloat(o[2]).countDecimals(),parseFloat(o[3]).countDecimals(),parseFloat(o[4]).countDecimals(),parseFloat(o[5]).countDecimals())+1,n=o[4],o[4]+=", "),t.slider.step=n.toString(),t.slider.value=o[2],t.slider.addEventListener("input",function(){t.slider.style.setProperty("--value",t.slider.value),kineticParamsStrs[e]=kineticParamsStrs[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,o[1]+" = "+parseFloat(t.slider.value).toFixed(t.slider.precision).toString()+" "),refreshGUI(parametersFolder),setKineticStringFromParams(),render(),(setKineticUniformFromString(kineticParamsStrs[e])||compileErrorOccurred)&&(compileErrorOccurred=!1,updateShaders())}),t.__oldOnFinishChange=t.onFinishChange,t.onFinishChange=function(){t.__oldOnFinishChange(),t.slider.value=o[2]},t.slider.style.setProperty("--value",t.slider.value),t.slider.style.setProperty("--min",t.slider.min),t.slider.style.setProperty("--max",t.slider.max),t.domElement.appendChild(t.slider)}}if(o)kineticParamsLabels.push(e),kineticParamsStrs[e]="",(t=parametersFolder.add(kineticParamsStrs,e).name("")).domElement.classList.add("params"),t.onFinishChange(function(){let o=kineticParamsLabels.indexOf(e),t=removeWhitespace(kineticParamsStrs[kineticParamsLabels.at(o)]);if(""==t);else{let n=createParameterController(kineticParamsLabels.at(o),!1),i=t.match(/\s*(\w+)\s*=/);i&&(n.lastName=i[1],kineticNameToCont[n.lastName]=n);let r="params"+(kineticParamsCounter+=1);this.remove(),createParameterController(r,!0),setKineticStringFromParams(),(setKineticUniformFromString(t)||compileErrorOccurred)&&(compileErrorOccurred=!1,updateShaders())}});else{(t=parametersFolder.add(kineticParamsStrs,e).name("")).domElement.classList.add("params");let i=kineticParamsStrs[e].match(/\s*(\w+)\s*=/);i&&(t.lastName=i[1],kineticNameToCont[t.lastName]=t),t.onFinishChange(function(){let o=removeWhitespace(kineticParamsStrs[e]);if(""==o){t.domElement.closest("li").hasOwnProperty("parameterSlider")&&(t.slider.remove(),t.domElement.closest("li").classList.remove("parameterSlider")),this.remove();let i=kineticParamsLabels.indexOf(e);kineticParamsLabels.splice(i,1),delete kineticParamsStrs[e],t.hasOwnProperty("lastName")&&delete uniforms[t.lastName]}else{n();let r=replaceDigitsWithWords(o).match(/\s*(\w+)\s*=/);r&&t.hasOwnProperty("lastName")&&t.lastName!=r[1]&&(delete uniforms[t.lastName],t.lastName=r[1],kineticNameToCont[t.lastName]=t)}setKineticStringFromParams(),setKineticUniformFromString(o)&&updateShaders()})}return n(),t}function setParamsFromKineticString(){let e,o,t=options.kineticParams.split(";");for(var n=0;n<t.length;n++)""==(o=removeWhitespace(t[n]))||(o=(o=(o=o.replace(/(\S)=/,"$1 =")).replace(/=(\S)/,"= $1")).replaceAll(/,(\S)/g,", $1"),e="param"+kineticParamsCounter,kineticParamsCounter+=1,kineticParamsLabels.push(e),kineticParamsStrs[e]=o,createParameterController(e,!1));e="param"+kineticParamsCounter,kineticParamsLabels.push(e),kineticParamsStrs[e]=o,createParameterController(e,!0)}function setKineticStringFromParams(){options.kineticParams=Object.values(kineticParamsStrs).map(function(e){return e.replaceAll(/"\s+"/g," ")}).join(";")}function fromExternalLink(){let e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function fadein(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function fadeout(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout(function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())},1e3)}function configureColourbar(){if(options.colourbar){$("#colourbar").show();let e="linear-gradient(90deg, ";for(var o=0;o<1;o+=.01)e+="rgb("+colourFromValue(o).map(e=>255*e)+") "+100*o+"%,";e=e.slice(0,-1)+")",$("#colourbar").css("background",e),"MAX"==options.whatToPlot?($("#minLabel").html("$"+listOfSpecies[0]+"$"),$("#midLabel").html("$"+listOfSpecies[1]+"$"),$("#maxLabel").html("$"+listOfSpecies[2]+"$")):$("#midLabel").html("$"+parseStringToTEX(options.whatToPlot)+"$"),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),checkColourbarLogoCollision(),updateColourbarLims()}else $("#colourbar").hide()}function updateColourbarLims(){if("MAX"!=options.whatToPlot){let e,o;[e,o]=formatColourbarLabels(options.minColourValue,options.maxColourValue);let t=/[1-9]/;t.test(e)||(e="0"),t.test(o)||(o="0"),$("#minLabel").html(e),$("#maxLabel").html(o)}let n=computeColourBrightness(colourFromValue(0)),i=computeColourBrightness(colourFromValue(.5)),r=computeColourBrightness(colourFromValue(1));n<.51?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),i<.51?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),r<.51?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function formatLabelNum(e,o){return e.toPrecision(o)}function shortestStringNum(e,o){let t=e.toFixed(o),n=e.toPrecision(o);return t.length<n.length?t:n}function formatColourbarLabels(e,o){return .001>Math.abs(e)&&.001>Math.abs(o)?[e.toExponential(2),o.toExponential(2)]:[shortestStringNum(e,3),shortestStringNum(o,3)]}function configureTimeDisplay(){options.timeDisplay?($("#timeDisplay").show(),updateTimeDisplay()):$("#timeDisplay").hide(),orderTimeIntegralDisplays()}function updateTimeDisplay(){if(options.timeDisplay){let e=formatLabelNum(uniforms.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," \xd7 10<sup>$2$3<sup>"),$("#timeValue").html(e),checkColourbarPosition()}}function configureIntegralDisplay(){if(options.integrate){$("#integralDisplay").show();let e="";1==options.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+parseStringToTEX(options.whatToPlot)+"\\,\\d x",1==options.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();orderTimeIntegralDisplays()}function configureDataContainer(){$("#dataContainer").show()}function nudgeUIUp(e,o){$(e).css("bottom",""),$(e).css("bottom","+="+o.toString())}function orderTimeIntegralDisplays(){options.integrate&&options.timeDisplay?nudgeUIUp("#timeDisplay",10):nudgeUIUp("#timeDisplay",0)}function updateIntegralDisplay(){if(options.integrate){fillBuffer();let e;1==options.dimension?e=uniforms.dx.value:2==options.dimension&&(e=uniforms.dx.value*uniforms.dy.value);let o=0;for(let t=0;t<buffer.length;t+=4)o+=buffer[t];o*=e,$("#integralValue").html(formatLabelNum(o,4)),checkColourbarPosition()}}function checkForNaN(){let e=getMinMaxVal();isFinite(e[0])&&isFinite(e[1])?NaNTimer=setTimeout(checkForNaN,1e3):(fadein("#oops_hit_nan"),$("#erase").one("click",()=>fadeout("#oops_hit_nan")))}function fillBuffer(){if(!bufferFilled){try{renderer.readRenderTargetPixels(postTexture,0,0,nXDisc,nYDisc,buffer)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}bufferFilled=!0}}function checkColourbarPosition(){if(options.colourbar&&options.integrate|options.timeDisplay){let e=$("#colourbar")[0].getBoundingClientRect(),o,t=(o=options.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0]).getBoundingClientRect();e.right>=t.left?e.top<=t.bottom&&(nudgeUIUp("#dataContainer",40),dataNudgedUp=!0):dataNudgedUp&&(nudgeUIUp("#dataContainer",0),dataNudgedUp=!1)}}function configureManualInterpolation(){isManuallyInterpolating()?(simTextures[0].texture.magFilter=z.NearestFilter,simTextures[1].texture.magFilter=z.NearestFilter,postTexture.texture.magFilter=z.NearestFilter,interpolationTexture.texture.magFilter=z.NearestFilter):(simTextures[0].texture.magFilter=z.LinearFilter,simTextures[1].texture.magFilter=z.LinearFilter,postTexture.texture.magFilter=z.LinearFilter,interpolationTexture.texture.magFilter=z.LinearFilter),configureGUI()}function isManuallyInterpolating(){return manualInterpolationNeeded||options.forceManualInterpolation}function warningCookieExists(){for(var e=document.cookie.split(";"),o=0;o<e.length;o++)if("warning"==e[o].split("=")[0].trim())return!0;return!1}function setWarningCookie(){let e=new Date;e.setTime(e.getTime()+31536e6);let o="expires="+e.toUTCString();document.cookie="warning=true;"+o+";path=/"}function waitListener(e,o,t){return new Promise(function(n,i){var r=i=>{e.removeEventListener(o,r),n(t)};e.addEventListener(o,r)})}function getReservedStrs(e){return[...(h()+w()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map(e=>e[1]).concat(e)}function isReservedName(e,o){return void 0==o&&(o=[]),getReservedStrs(o).some(function(o){return RegExp("\\b"+o+"\\b","g").test(e)})}function replaceUserDefReac(e,o,t){return"0"==t.replace(/\s+/g,"  ").trim()?e.replaceAll(o,""):t.match(/[a-zA-Z]/)?e.replaceAll(o,t):e}function replaceUserDefDiff(e,o,t,n){let i=t.replace(/\s+/g,"  ").trim();return"0"==i||"0.0"==i?e.replaceAll(o,""):"1"==i||"1.0"==i?e.replaceAll(o,"$2"):"-1"==i||"-1.0"==i?e.replaceAll(o,"-$2"):t.match(/[a-zA-Z]/)?t.match(/[\+-]/)&&void 0!=n?e.replaceAll(o,n[0]+t+n[1]+"$2"):e.replaceAll(o,t+"$2"):e}function configurePlotType(){"line"==options.plotType?(setLineWidth(),options.typeOfBrush="vline",setBrushType(),refreshGUI(rightGUI),domain.visible=!1,line.visible=!0,options.contours=!1,options.emboss=!1):(domain.visible=!0,line.visible=!1,"surface"==options.plotType?(options.contours=!1,$("#simCanvas").css("outline","2px #000 solid"),usingLowResDomain&&(usingLowResDomain=!1,replaceDisplayDomains())):$("#simCanvas").css("outline","")),setDisplayColourAndType(),configureCameraAndClicks(),configureGUI()}function configureDimension(){1!=options.dimension&&"line"==options.plotType&&(options.plotType="plane",configurePlotType()),1==options.dimension&&"line"!=options.plotType&&(options.plotType="line",configurePlotType()),resize(),setRDEquations(),setEquationDisplayType(),configureGUI(),configureIntegralDisplay()}function setCameraPos(){let e=new z.Vector3().setFromSphericalCoords(1,Math.PI/2-options.cameraTheta*Math.PI/180,options.cameraPhi*Math.PI/180);camera.position.set(e.x,e.y,e.z),camera.lookAt(0,0,0)}function checkColourbarLogoCollision(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function sanitisedKineticParams(){let e=options.kineticParams.replaceAll(/\bin[^;]*;?/g,";");return replaceDigitsWithWords(e)}function getKineticParamNames(){let e=/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/;return sanitisedKineticParams().split(";").filter(e=>e.length>0).map(o=>o.replace(e,"$1").trim())}function setKineticUniforms(){let e=sanitisedKineticParams().split(";"),o=!1;for(let t of e)o|=setKineticUniformFromString(t);return o}function setKineticUniformFromString(e){let o=e.match(/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/),t=!1;return o&&(o[1]=replaceDigitsWithWords(o[1]),isReservedName(o[1])?alert("The name '"+o[1]+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+o[1]+"."):(t=!uniforms.hasOwnProperty(o[1]),uniforms[o[1]]={type:"float",value:parseFloat(o[2]+o[3])})),t}function kineticUniformsForShader(){return replaceDigitsWithWords(sanitisedKineticParams().replaceAll(/;?\s*(\w+)\s*=\s*[\+\-]?\s*([0-9\.]+)\s*;?/g,"uniform float $1;\n"))}function updateShaders(){setRDEquations(),setClearShader(),setBrushType(),updateWhatToPlot(),setDrawAndDisplayShaders(),setPostFunFragShader()}function replaceDigitsWithWords(e){let o,t=e;for(let n=0;n<10;n++)for(o=RegExp("([a-zA-Z_]+)("+n.toString()+")","g");t!=(t=t.replace(o,"$1"+numsAsWords[n])););return t}function resizeEquationDisplay(){let e=$("#equation_display div mjx-container").children("mjx-math");e.css("font-size","");var o,t=0;if(void 0==$("#leftGUI")[0])return;let n=$("#rightGUI")[0];var i=0;for(void 0!=n&&(i=n.getBoundingClientRect().width);t<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-i&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)o=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",o),t+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function computeColourBrightness(e){return e.reduce((e,o)=>e+o,0)/3}function setColourRange(){let e=getMinMaxVal();if(.005>Math.abs(e[0]-e[1])){let o=(e[0]+e[1])/2;e[0]=o-.0025,e[1]=o+.0025}options.minColourValue=e[0],options.maxColourValue=e[1],uniforms.maxColourValue.value=options.maxColourValue,uniforms.minColourValue.value=options.minColourValue,maxColourValueController.updateDisplay(),minColourValueController.updateDisplay(),updateColourbarLims()}function updateGUIDropdown(e,o,t){void 0==t&&(t=o);let n="";for(var i=0;i<o.length;i++)n+="<option value='"+t[i].toString()+"'>"+o[i].toString()+"</option>";e.domElement.children[0].innerHTML=n}function setCustomNames(e){let o;void 0!=listOfSpecies&&(o=listOfSpecies);let t=options.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,defaultSpecies.length),n=options.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,defaultReactions.length),i=t.concat(placeholderSp.slice(t.length)),r=n.concat(placeholderRe.slice(n.length)),s=getKineticParamNames(),l;for(var a=0;a<i.length;a++)if(isReservedName(i[a],s.concat(r))){l=s.includes(i[a])?"as a parameter":r.includes(i[a])?"as a reaction":"under the hood",alert("The name '"+i[a]+"' is used "+l+", so can't be used as a species name. Please use a different name for "+i[a]+".");return}for(var a=0;a<r.length;a++)if(isReservedName(r[a],s.concat(i[a]))){l=s.includes(r[a])?"as a parameter":i.includes(r[a])?"as a reaction":"under the hood",alert("The name '"+r[a]+"' is used "+l+", so can't be used as a function name. Please use a different name for "+r[a]+".");return}listOfSpecies=i,listOfReactions=r,genAnySpeciesRegexStrs();let c={...en(),...er()};Object.keys(c).forEach(function(e){TeXStrings[e]=parseStringToTEX(replaceSymbolsInStr(c[e],defaultSpecies,listOfSpecies,"_[xy]"))}),Object.keys(c=ei()).forEach(function(e){TeXStrings[e]=parseStringToTEX(replaceSymbolsInStr(c[e],defaultReactions,listOfReactions))}),e||(Object.keys(options).forEach(function(e){userTextFields.includes(e)&&(options[e]=replaceSymbolsInStr(options[e],o,listOfSpecies,"_[xy]"))}),options.views=options.views.map(function(e){let t={};return t.name=e.name,Object.keys(e).forEach(function(n){userTextFields.includes(n)&&(t[n]=replaceSymbolsInStr(e[n],o,listOfSpecies,"_[xy]"))}),t}),Object.keys(savedOptions).forEach(function(e){userTextFields.includes(e)&&(savedOptions[e]=replaceSymbolsInStr(savedOptions[e],o,listOfSpecies,"_[xy]"))}),savedOptions.views=savedOptions.views.map(function(e){let t={};return t.name=e.name,Object.keys(e).forEach(function(n){userTextFields.includes(n)&&(t[n]=replaceSymbolsInStr(e[n],o,listOfSpecies,"_[xy]"))}),t}),configureOptions(),configureGUI(),updateShaders(),setEquationDisplayType())}function genAnySpeciesRegexStrs(){anySpeciesRegexStrs=[];for(let e=0;e<listOfSpecies.length;e++)anySpeciesRegexStrs.push("(?:"+listOfSpecies.slice(e).sort((e,o)=>o.length-e.length).map(e=>"(?:"+e+")").join("|")+")")}function replaceSymbolsInStr(e,o,t,n){void 0==n&&(n="");let i=Array(o.length).fill(0).map((e,o)=>"PLACE"+o.toString()),r;for(var s=0;s<o.length;s++)r=RegExp("\\b("+o[s]+")("+n+")?\\b","g"),e=e.replaceAll(r,i[s]+"$2");for(var s=0;s<i.length;s++)r=RegExp("\\b("+i[s]+")("+n+")?\\b","g"),e=e.replaceAll(r,t[s]+"$2");return e}function setLineXY(e){let o=line.geometry.attributes.instanceStart,t=line.geometry.attributes.instanceEnd,n;for(let i=0;i<e.length;i++)n=e[i].toArray(),n[1]*=options.threeDHeightScale,i<e.length&&o.setXYZ(i,n[0],n[1],0),i>0&&t.setXYZ(i-1,n[0],n[1],0);o.needsUpdate=!0,t.needsUpdate=!0}function setLineColour(e){let o=line.geometry.attributes.instanceColorStart,t=line.geometry.attributes.instanceColorEnd,n;for(let i=0;i<e.length;i++)n=colourFromValue(e[i].toArray()[1]+.5),i<e.length&&o.setXYZ(i,n[0],n[1],n[2]),i>0&&t.setXYZ(i-1,n[0],n[1],n[2]);o.needsUpdate=!0}function colourFromValue(e){e=e.clamp(0,1);let o=0;for(;e>=colourmapEndpoints[o+1]&&o<colourmap.length-2;)o+=1;return colourmapEndpoints[o+1]==colourmapEndpoints[o]?colourmap[o]:lerpArrays(colourmap[o],colourmap[o+1],(e-colourmapEndpoints[o])/(colourmapEndpoints[o+1]-colourmapEndpoints[o])).map(e=>e.clamp(0,1))}function lerpArrays(e,o,t){let n=Array(e.length);for(let i=0;i<n.length;i++)n[i]=lerp(e[i],o[i],t);return n}function lerp(e,o,t){return(1-t)*e+t*o}function setLineWidth(){lineMaterial.linewidth=.01*options.lineWidthMul,lineMaterial.needsUpdate=!0}function setOnfocus(e,o,t){e.domElement.firstChild.onfocus=()=>o(t)}function setOnblur(e,o,t){e.domElement.firstChild.onblur=()=>o(t)}function selectTeX(e){e.forEach(function(e){selectedEntries.add(e)}),setEquationDisplayType()}function deselectTeX(e){e.forEach(function(e){selectedEntries.delete(e)}),setEquationDisplayType()}function getRawState(){checkpointBuffer=new Float32Array(nXDisc*nYDisc*4),renderer.readRenderTargetPixels(simTextures[1],0,0,nXDisc,nYDisc,checkpointBuffer)}function saveSimState(){getRawState(),createCheckpointTexture(checkpointBuffer),checkpointExists=!0}function exportSimState(){checkpointExists||saveSimState();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([nXDisc,nYDisc]),checkpointBuffer])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function loadSimState(e){let o=new FileReader;o.onload=function(){let e=new Float32Array(o.result);createCheckpointTexture(e.slice(2),e.slice(0,2)),setStretchOrCropTexture(checkpointTexture),checkpointExists=!0,resetSim()},o.readAsArrayBuffer(e)}function setStretchOrCropTexture(e){if(null!=e){if("crop"==options.resizeCheckpoints){let o=e.source.data.height/e.source.data.width,t=1,n=aspectRatio/o;n>1&&(t=o/aspectRatio,n=1),e.repeat.set(t,n),e.offset.set((1-t)/2,(1-n)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}}function createCheckpointTexture(e,o){null!=checkpointTexture&&checkpointTexture.dispose(),void 0==o&&(o=[nXDisc,nYDisc]),(checkpointTexture=new z.DataTexture(e,o[0],o[1],z.RGBAFormat,z.FloatType)).needsUpdate=!0,manualInterpolationNeeded?checkpointTexture.magFilter=z.NearestFilter:checkpointTexture.magFilter=z.LinearFilter,null!=checkpointMaterial&&(checkpointMaterial.map=checkpointTexture,checkpointMaterial.needsUpdate)}function setRenderSizeToDisc(){renderer.setSize(nXDisc,nYDisc,!1)}function setDefaultRenderSize(){renderer.setSize(Math.round(devicePixelRatio*canvasWidth),Math.round(devicePixelRatio*canvasHeight),!1)}function throwError(e){$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),fadein("#error"),$("#error").one("click",function(){fadeout("#error")}))}function isValidSyntax(e){if(/\(\s*\)/.test(e))return throwError("Empty parentheses in "+e.trim()+"."),!1;let o=0;for(var t=0;t<e.length;t++)"("==e[t]?o+=1:")"==e[t]&&(o-=1);return 0!=o?(throwError("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(throwError("A binary operator is missing an operand in "+e.trim()+"."),!1)}function configureViews(){if(0==options.views.length){let e=buildViewFromOptions();e.name="1",options.views.push(e)}else options.views=options.views.map(function(e){let o=buildViewFromOptions();return Object.assign(o,e),o});savedViews=options.views}function configureViewsGUI(){$("#views_list").empty();let e;for(let o=0;o<options.views.length;o++)(e=document.createElement("a")).onclick=function(){options.activeViewInd=o,applyView(options.views[o])},e.innerHTML="<div class='view_label'>"+options.views[o].name+"</div>",o==options.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);options.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise(),options.views.length}function applyView(e,o){Object.assign(options,e),delete options.name,refreshGUI(viewsGUI),(void 0==o||o)&&(updateWhatToPlot(),configurePlotType(),setDisplayColourAndType(),updateUniforms(),updateColourbarLims(),configureColourbar(),render())}function editCurrentViewName(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",options.views[options.activeViewInd].name);null!=e&&(options.views[options.activeViewInd].name=e,configureViewsGUI(),void 0!=MathJax.typesetPromise&&MathJax.typesetPromise())}function addView(){let e=buildViewFromOptions();e.name=options.views.length+1,options.views.push(e),options.activeViewInd=options.views.length-1,configureViewsGUI()}function deleteView(){options.views.length>1?(options.views.splice(options.activeViewInd,1),options.activeViewInd<1?options.activeViewInd=0:options.activeViewInd-=1):options.views[options.activeViewInd].name="Custom",configureViewsGUI()}function buildViewFromOptions(){let e={};return fieldsInView.forEach(function(o){e[o]=savedOptions[o]}),e}function restoreView(e){options.views[e]=savedViews[e],applyView(options.views[e])}function restoreCurrentView(){options.activeViewInd<options.views.length&&restoreView(options.activeViewInd)}function updateView(e){options.activeViewInd<options.views.length&&(options.views[options.activeViewInd][e]=options[e])}function neumannUpdateShader(e,o){let t="";return t+=selectSpeciesInShaderStr(D(o),listOfSpecies[e]),options.dimension>1&&(t+=selectSpeciesInShaderStr(U(o),listOfSpecies[e])),t}function ghostUpdateShader(e,o,t){let n="";return n+=selectSpeciesInShaderStr(F(o),listOfSpecies[e]),options.dimension>1&&(n+=selectSpeciesInShaderStr(R(o),listOfSpecies[e])),n=n.replaceAll("GHOSTSPECIES",t)}function dirichletUpdateShader(e,o){let t="";return t+=selectSpeciesInShaderStr(g(o),listOfSpecies[e]),options.dimension>1&&(t+=selectSpeciesInShaderStr(S(o),listOfSpecies[e])),t}function robinUpdateShader(e,o){let t="";return t+=selectSpeciesInShaderStr(D(o),listOfSpecies[e]),options.dimension>1&&(t+=selectSpeciesInShaderStr(U(o),listOfSpecies[e])),t}function dirichletEnforceShader(e,o){let t="";return t+=selectSpeciesInShaderStr(g(o).replaceAll(/updated/g,"gl_FragColor"),listOfSpecies[e]),options.dimension>1&&(t+=selectSpeciesInShaderStr(S(o).replaceAll(/updated/g,"gl_FragColor"),listOfSpecies[e])),t}function addButton(e,o,t,n,i){let r=document.createElement("a");void 0!=t&&(r.onclick=t),void 0!=n&&(r.id=n),void 0!=i&&(r.title=i),void 0!=o&&(r.innerHTML=o),e.appendChild(r)}function copyConfigAsJSON(){let e=diffObjects(options,X("default"));e.preset="PRESETNAME";let o=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n	$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n	").replace("}",",\n}");o='case "PRESETNAME":\n	options = '+o+";\nbreak;",navigator.clipboard.writeText(o)}function copyDebug(){let e="";e+=JSON.stringify(options),e+=JSON.stringify(uniforms),e+=JSON.stringify({nXDisc:nXDisc,nYDisc:nYDisc,domainHeight:domainHeight,domainWidth:domainWidth,aspectRatio:aspectRatio,canvas:canvas.getBoundingClientRect()}),navigator.clipboard.writeText(e)}function toggleRightUI(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function toggleLeftUI(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function toggleViewsUI(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function toggleHelpPanel(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function toggleSharePanel(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function onMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function copyIframe(){let e=getSimURL();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&no_ui"}copyLinkToClipboard('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0" loading="lazy"></iframe>')}function getSimURL(){let e=diffObjects(options,X("default"));return e.preset="Custom",e=J(e),[location.href.replace(location.search,""),"?options=",eo.compressToEncodedURIComponent(JSON.stringify(e)),].join("")}function copyLinkToClipboard(e){navigator.clipboard.writeText(e).then(()=>{$("#link_copied").fadeIn(1e3),setTimeout(()=>$("#link_copied").fadeOut(1e3),2e3)},()=>{})}function updateParamFromMessage(e){let o=kineticNameToCont[e.data.name];if(void 0!=o){if(void 0!=o.slider)o.slider.value=e.data.value,o.slider.dispatchEvent(new Event("input"));else{let t=o.object[o.property].split("=")[0]+"= "+e.data.value.toString();o.setValue(t),o.__onFinishChange(o,t)}}}function setEmbossUniforms(){uniforms.embossAmbient.value=options.embossAmbient,uniforms.embossDiffuse.value=options.embossDiffuse,uniforms.embossShiny.value=options.embossShiny,uniforms.embossSmoothness.value=options.embossSmoothness,uniforms.embossSpecular.value=options.embossSpecular,uniforms.embossLightDir.value=new z.Vector3(Math.sin(options.embossTheta)*Math.cos(options.embossPhi),Math.sin(options.embossTheta)*Math.sin(options.embossPhi),Math.cos(options.embossTheta))}function createOptionSlider(e,o,t,n){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=o,e.slider.max=t,e.slider.step=n,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))}),void 0!=e.__onChange&&(e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),void 0!=e.__onFinishChange&&(e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function updateEmbossSliders(){embossShinyController.slider.style.setProperty("--value",options.embossShiny),embossSmoothnessController.slider.style.setProperty("--value",options.embossSmoothness),embossAmbientController.slider.style.setProperty("--value",options.embossAmbient),embossDiffuseController.slider.style.setProperty("--value",options.embossDiffuse),embossSpecularController.slider.style.setProperty("--value",options.embossSpecular),embossThetaController.slider.style.setProperty("--value",options.embossTheta),embossPhiController.slider.style.setProperty("--value",options.embossPhi)}function setContourUniforms(){uniforms.contourColour.value=new z.Color(options.contourColour),uniforms.contourEpsilon.value=options.contourEpsilon,uniforms.contourStep.value=1/(options.contourNum+1)}function renderIfNotRunning(){isRunning||render()}shouldLoadDefault&&loadPreset("GrayScott"),(fromExternalLink()||shouldLoadDefault||options.forceTryClickingPopup)&&!options.suppressTryClickingPopup&&options.brushEnabled&&($("#top_message").html("<p>"+options.tryClickingText+"</p>"),fadein("#top_message"),setTimeout(()=>fadeout("#top_message"),5e3),$("#simCanvas").one("pointerdown touchstart",()=>fadeout("#top_message"))),$("#settings").click(function(){toggleRightUI(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&toggleHelpPanel(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&toggleSharePanel(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&toggleLeftUI(),$("#views_ui").is(":visible")&&toggleViewsUI()),$("#left_ui").is(":visible")&&resizeEquationDisplay()}),$("#equations").click(function(){toggleLeftUI(),resizeEquationDisplay(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&toggleRightUI(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&toggleViewsUI()}),$("#pause").click(function(){pauseSim()}),$("#play").click(function(){playSim()}),$("#erase").click(function(){resetSim()}),$("#warning_restart").click(function(){$("#oops_hit_nan").hide(),resetSim()}),$("#share").click(function(){toggleSharePanel(),$("#help_panel").is(":visible")&&toggleHelpPanel()}),$("#help").click(function(){toggleHelpPanel(),$("#share_panel").is(":visible")&&toggleSharePanel()}),$("#screenshot").click(function(){takeAScreenshot=!0,render(),toggleSharePanel()}),$("#link").click(function(){funsObj.copyConfigAsURL(),toggleSharePanel()}),$("#embed").click(function(){copyIframe(),toggleSharePanel()}),$("#embed_ui_type").change(function(){$("#embed_ui_type").blur()}),$("#help_panel .container .button").click(function(){toggleHelpPanel()}),$("#views").click(function(){toggleViewsUI(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&toggleRightUI(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&toggleLeftUI()}),$(document).on("click","#add_view",function(){addView()}),animate();