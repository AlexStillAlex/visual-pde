let e,n,t,i,o,a,r,s,l,u,c,d,f,m,p,h,g,b,v,S,w,y,C,V,x,U,_,F,E,D,W,T,Q,A,R,P,k,N,I,L,M,q,O,B,j,G,z,J,H,X,Y,Z,K,ee,ne,te,ie,oe,ae,re,se,le,ue,ce,de,fe,me,pe,he,ge,be,ve,Se,we,ye,Ce,Ve,xe,Ue,_e,$e,Fe,Ee,De,We,Te,Qe,Ae,Re,Pe,ke,Ne,Ie,Le,Me,qe,Oe,Be,je,Ge,ze,Je,He,Xe,Ye,Ze,Ke,en,nn,tn,on,an,rn,sn,ln,un,cn,dn,fn,mn,pn,hn,gn,bn,vn,Sn,wn,yn,Cn,Vn,xn,Un,_n,$n,Fn,En,Dn=[],Wn=new Set,Tn=!1,Qn=!1,An=!1,Rn=!1,Pn=!1,kn=!0,Nn=1,In={},Ln=[],Mn={},qn=0;const On=["u","v","w","q"],Bn=["UFUN","VFUN","WFUN","QFUN"],jn=["SPECIES1","SPECIES2","SPECIES3","SPECIES4"],Gn=["REACT1","REACT2","REACT3","REACT4"];let zn,Jn,Hn,Xn,Yn,Zn,Kn=!1,et=!1;const nt=["zero","one","two","three","four","five","six","seven","eight","nine"];import{drawShaderTop as tt,drawShaderBotReplace as it,drawShaderBotAdd as ot,drawShaderShapeDisc as at,drawShaderShapeVLine as rt,drawShaderShapeHLine as st,drawShaderFactorSharp as lt,drawShaderFactorSmooth as ut}from"./drawing_shaders.js";import{computeDisplayFunShaderTop as ct,computeDisplayFunShaderMid as dt,computeMaxSpeciesShaderMid as ft,postGenericShaderBot as mt,postShaderDomainIndicator as pt,interpolationShader as ht}from"./post_shaders.js";import{copyShader as gt}from"../copy_shader.js";import{RDShaderTop as bt,RDShaderBot as vt,RDShaderDirichletX as St,RDShaderDirichletY as wt,RDShaderDirichletIndicatorFun as yt,RDShaderRobinX as Ct,RDShaderRobinY as Vt,RDShaderUpdateNormal as xt,RDShaderUpdateCross as Ut,RDShaderAlgebraicSpecies as _t,RDShaderEnforceDirichletTop as $t,RDShaderAdvectionPreBC as Ft,RDShaderAdvectionPostBC as Et,RDShaderDiffusionPreBC as Dt,RDShaderDiffusionPostBC as Wt,RDShaderGhostX as Tt,RDShaderGhostY as Qt,RDShaderMain as At}from"./simulation_shaders.js";import{randShader as Rt}from"../rand_shader.js";import{fiveColourDisplayTop as Pt,fiveColourDisplayBot as kt,embossShader as Nt,contourShader as It,surfaceVertexShader as Lt}from"./display_shaders.js";import{getColours as Mt}from"../colourmaps.js";import{genericVertexShader as qt}from"../generic_shaders.js";import{getPreset as Ot,getUserTextFields as Bt,getFieldsInView as jt}from"./presets.js";import{clearShaderBot as Gt,clearShaderTop as zt}from"./clear_shader.js";import*as Jt from"../three.module.min.js";import{OrbitControls as Ht}from"../OrbitControls.js";import{Line2 as Xt}from"../lines/Line2.js";import{LineMaterial as Yt}from"../lines/LineMaterial.js";import{LineGeometry as Zt}from"../lines/LineGeometry.js";import{minifyPreset as Kt,maxifyPreset as ei}from"./minify_preset.js";import{LZString as ni}from"../lz-string.min.js";import{equationTEXFun as ti,getDefaultTeXLabelsDiffusion as ii,getDefaultTeXLabelsReaction as oi,getDefaultTeXLabelsBCsICs as ai,substituteGreek as ri}from"./TEX.js";let si,li,ui,ci=ti(),di={...ii(),...oi(),...ai()};const fi=jt();k={};const mi=Bt();var pi,hi;I={reset:function(){qi()},toggleRunning:function(){pn?Li():Mi()},copyConfigAsURL:function(){ja(Ba())},saveSimState:function(){va()},exportSimState:function(){Sa()},clearCheckpoints:function(){Rn&&(h.dispose(),h=null,Rn=!1)},restoreCurrentView:function(){var e;k.activeViewInd<k.views.length&&(e=k.activeViewInd,k.views[e]=wn[e],$a(k.views[e]))}},Number.prototype.countDecimals=function(){if(Math.floor(this.valueOf())===this.valueOf())return 0;var e=this.toString();return-1!==e.indexOf(".")&&-1!==e.indexOf("-")?e.split("-")[1]||0:-1!==e.indexOf(".")?e.split(".")[1].length||0:e.split("-")[1]||0},Number.prototype.clamp=function(e,n){return Math.min(Math.max(this,e),n)},Array.prototype.rotate=(pi=Array.prototype.push,hi=Array.prototype.splice,function(e){var n=this.length>>>0;return e=((e>>=0)%n+n)%n,pi.apply(this,hi.call(this,0,e)),this}),e=document.getElementById("simCanvas"),console.error=function(e){Qn=!0;let n=e.toString();console.log(n);let t=/ERROR.*/;!t.test(n)||(n=n.match(t)),xa(n)},Do()||$("#logo").hide();const gi=new URLSearchParams(window.location.search);if(gi.has("no_ui")?($(".ui").addClass("hidden"),An=!0):$(".ui").removeClass("hidden"),gi.has("sf")&&(Nn=parseFloat(gi.get("sf")),(isNaN(Nn)||Nn<=0)&&(Nn=1)),gi.has("story")&&($("#settings").addClass("hidden"),$("#equations").addClass("hidden"),$("#help").addClass("hidden"),$("#share").addClass("hidden"),$("#play").css("top","-=50"),$("#pause").css("top","-=50"),$("#erase").css("top","-=50"),$("#views").css("top","-=50"),$("#views_ui").css("top","-=50"),yn=$(":root").css("--views-ui-offset"),$(":root").css("--views-ui-offset","-=50")),!function(){for(var e=document.cookie.split(";"),n=0;n<e.length;n++){if("warning"==e[n].split("=")[0].trim())return!0}return!1}()&&!An){$("#warning").css("display","block");await Promise.race([zo(document.getElementById("warning_ok"),"click",!0),zo(document.getElementById("warning_no"),"click",!1)])&&function(){const e=new Date;e.setTime(e.getTime()+31536e6);let n="expires="+e.toUTCString();document.cookie="warning=true;"+n+";path=/"}(),$("#warning").css("display","none")}Yi("default"),function(){N={brushCoords:{type:"v2",value:new Jt.Vector2(.5,.5)},colour1:{type:"v4",value:new Jt.Vector4(0,0,0,0)},colour2:{type:"v4",value:new Jt.Vector4(0,1,0,.2)},colour3:{type:"v4",value:new Jt.Vector4(1,1,0,.21)},colour4:{type:"v4",value:new Jt.Vector4(1,0,0,.4)},colour5:{type:"v4",value:new Jt.Vector4(1,1,1,.6)},contourColour:{type:"v4"},contourEpsilon:{type:"f"},contourStep:{type:"f"},embossAmbient:{type:"f"},embossDiffuse:{type:"f"},embossShiny:{type:"f"},embossSmoothness:{type:"f"},embossSpecular:{type:"f"},embossLightDir:{type:"vec3"},L:{type:"f"},L_x:{type:"f"},L_y:{type:"f"},L_min:{type:"f"},dt:{type:"f",value:.01},dx:{type:"f"},dy:{type:"f"},heightScale:{type:"f"},imageSourceOne:{type:"t"},imageSourceTwo:{type:"t"},L:{type:"f"},maxColourValue:{type:"f",value:1},minColourValue:{type:"f",value:0},nXDisc:{type:"i"},nYDisc:{type:"i"},seed:{type:"f",value:0},smoothingScale:{type:"f",value:k.smoothingScale+1},textureSource:{type:"t"},textureSource1:{type:"t"},textureSource2:{type:"t"},textureSource3:{type:"t"},t:{type:"f",value:0},timesteppingScheme:{type:"i"}},hn=!1,c=new Jt.Raycaster,d=new Jt.Vector2,s=new Jt.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance",antialias:!1,alpha:!0,premultipliedAlpha:!1,stencilBuffer:!1}),s.autoClear=!0,n=s.getContext(),t=!(n.getExtension("OES_texture_float_linear")&&n.getExtension("EXT_float_blend")),p={format:Jt.RGBAFormat,type:Jt.FloatType,minFilter:Jt.NearestFilter},t|=/android/i.test(navigator.userAgent),p.magFilter=t?Jt.NearestFilter:Jt.LinearFilter,Dn.push(new Jt.WebGLRenderTarget(k.maxDisc,k.maxDisc,p)),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),Dn.push(Dn[0].clone()),f=Dn[0].clone(),m=Dn[0].clone(),Dn.forEach((e=>{e.texture.wrapS=Jt.RepeatWrapping,e.texture.wrapT=Jt.RepeatWrapping})),f.texture.wrapS=Jt.ClampToEdgeWrapping,f.texture.wrapT=Jt.ClampToEdgeWrapping,m.texture.wrapS=Jt.ClampToEdgeWrapping,m.texture.wrapT=Jt.ClampToEdgeWrapping,i=new Jt.OrthographicCamera(-.5,.5,.5,-.5,-1,10),u=new Ht(i,e),u.listenToKeyEvents(document),u.addEventListener("change",(function(){"surface"==k.plotType&&(k.cameraTheta=90-180*Math.atan2(i.position.z,i.position.y)/Math.PI,k.cameraPhi=180*Math.atan2(i.position.x,i.position.z)/Math.PI,k.cameraZoom=i.zoom,Zi(q),Ai())})),o=new Jt.OrthographicCamera(-.5,.5,.5,-.5,-1,10),o.position.z=1,a=new Jt.Scene,r=new Jt.Scene,a.add(i),a.background=new Jt.Color(k.backgroundColour),g=new Jt.MeshBasicMaterial({side:Jt.DoubleSide}),b=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt(),transparent:!0,side:Jt.DoubleSide}),V=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt()}),U=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt(),fragmentShader:ht()}),v=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt()}),S=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt()}),C=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt(),fragmentShader:gt()}),y=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt()}),w=new Jt.ShaderMaterial({uniforms:N,vertexShader:qt()}),x=new Yt({vertexColors:!0,linewidth:.01}),_=new Jt.MeshBasicMaterial;const l=new Jt.PlaneGeometry(1,1);E=new Jt.Mesh(l,S),E.position.z=0,r.add(E),xi(),Ui(),yi(),$i(),Si(),Ei(),bo(),So(),Wi(),Di(),so(),jo(),qi(),e.addEventListener("pointerdown",Ri),e.addEventListener("pointerup",Pi),e.addEventListener("pointermove",ki),document.addEventListener("keypress",(function(e){var n=(e=e||window.event).target,t=1==n.nodeType?n.nodeName.toUpperCase():"";/INPUT|SELECT|TEXTAREA/.test(t)||("r"===e.key&&$("#erase").click()," "===e.key&&I.toggleRunning(),"h"===e.key&&(An?(An=!1,$(".ui").removeClass("hidden"),$(".ui").css("top",""),$(":root").css("--views-ui-offset",yn),pn?Mi():Li(),Bo(),Ko(),aa()):(An=!0,$(".ui").addClass("hidden"))),"s"==e.key&&va(),"c"==e.key&&(k.resetFromCheckpoints=!k.resetFromCheckpoints,Zi(q)))})),window.addEventListener("resize",Si,!1),window.addEventListener("message",Ga),$("#checkpointInput").change((function(){wa(this.files[0]),this.value=null}))}();let bi=!0;if(gi.has("preset")&&(Xi(gi.get("preset")),bi=!1),gi.has("options")){var vi=JSON.parse(ni.decompressFromEncodedURIComponent(gi.get("options")));vi.hasOwnProperty("p")&&(vi=ei(vi)),Xi(vi),bi=!1}function Si(){xi(),Fi(),ya(h),Ci(),wi(),yi(),Ko(),aa(),Ai()}function wi(){F.geometry.dispose(),a.remove(F),D.geometry.dispose(),a.remove(D),W.geometry.dispose(),a.remove(W),Ui()}function yi(){switch(Vi(),k.plotType){case"line":k.cameraTheta=0,k.cameraPhi=0,u.enabled=!1,i.zoom=1,Zo(),b.vertexShader=Lt();break;case"plane":u.enabled=!1,u.reset(),b.vertexShader=qt();break;case"surface":u.enabled=!0,i.zoom=k.cameraZoom,Zo(),b.vertexShader=Lt()}b.needsUpdate=!0,i.left=-xn/(2*_n),i.right=xn/(2*_n),i.top=Un/(2*_n),i.bottom=-Un/(2*_n),i.updateProjectionMatrix(),_i()}function Ci(){N.L.value=k.domainScale,N.L_y.value=Un,N.L_x.value=xn,N.L_min.value=Math.min(Un,xn),N.dt.value=k.dt,N.dx.value=xn/Cn,N.dy.value=Un/Vn,N.heightScale.value=k.threeDHeightScale,N.maxColourValue.value=k.maxColourValue,N.minColourValue.value=k.minColourValue,za(),k.fixRandSeed||ro()}function Vi(){$n=Math.round(e.getBoundingClientRect().width),Fn=Math.round(e.getBoundingClientRect().height),l=Fn/$n,l<=0&&(l=.1),l>=1?(Un=k.domainScale,xn=Un/l):(xn=k.domainScale,Un=xn*l),1==k.dimension&&(xn=k.domainScale),N.L_x.value=xn,N.L_y.value=Un,_n=Math.max(xn,Un)}function xi(){Vi(),0==k.spatialStep&&(alert("Oops! A spatial step of 0 would almost certainly crash your device. We've reset it to 1% of the maximum domain length to prevent this."),k.spatialStep=k.domainScale/100),Cn=Math.floor(xn/k.spatialStep),Vn=Math.floor(Un/k.spatialStep),0==Cn&&(Cn=1),0==Vn&&(Vn=1),1==k.dimension&&(Vn=1),N.nXDisc.value=Cn,N.nYDisc.value=Vn,T=new Array(Cn),Q=new Array(Cn);let e=-.5,n=1/Cn;for(let t=0;t<T.length;t++)T[t]=e,e+=n;Va(),Yn=new Float32Array(Cn*Vn*4),et=!1}function Ui(){Vi();let e=[1,1];kn||(e=[Cn,Vn]);const n=new Jt.PlaneGeometry(xn/_n,Un/_n,e[0],e[1]);F=new Jt.Mesh(n,b),F.position.z=0,F.visible="line"!=k.plotType,F.matrixAutoUpdate=!1,a.add(F);const t=new Jt.PlaneGeometry(xn/_n,Un/_n,1,1);D=new Jt.Mesh(t,g),D.position.z=0,D.visible=!1,D.matrixAutoUpdate=!1,a.add(D),_i();const i=new Zt;A=Math.round(devicePixelRatio*$n);const o=new Array(3*A).fill(0),r=new Array(o.length).fill(0);i.setPositions(o),i.setColors(r),W=new Xt(i,x),W.scale.set(1,1,1),W.visible="line"==k.plotType,a.add(W)}function _i(){switch(k.plotType){case"plane":F.rotation.x=0,D.rotation.x=0;break;case"surface":F.rotation.x=-Math.PI/2,D.rotation.x=-Math.PI/2}F.updateMatrix(),D.updateMatrix()}function $i(){k.squareCanvas?$("#simCanvas").addClass("squareCanvas"):$("#simCanvas").removeClass("squareCanvas")}function Fi(){E.material=C;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,Dn[e-1].setSize(Cn,Vn),s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1),Dn[0].dispose(),Dn[0]=Dn[1].clone(),f.setSize(Cn,Vn),m.setSize((k.smoothingScale+1)*Cn,(k.smoothingScale+1)*Vn)}function Ei(e){M=new dat.GUI({closeOnTop:!0,autoPlace:!1}),M.domElement.id="leftGUI",document.getElementById("leftGUIContainer").appendChild(M.domElement),q=new dat.GUI({closeOnTop:!0,autoPlace:!1}),q.domElement.id="rightGUI",document.getElementById("rightGUIContainer").appendChild(q.domElement),O=new dat.GUI({closeOnTop:!0,autoPlace:!1}),O.domElement.id="viewsGUI",document.getElementById("viewsGUIContainer").appendChild(O.domElement),M.open(),q.open(),O.open(),null!=e&&e?($("#right_ui").show(),$("#left_ui").show()):($("#left_ui").hide(),$("#right_ui").hide()),B=q.addFolder("Brush"),B.add(k,"brushEnabled").name("Enabled"),B.add(k,"brushAction",{Replace:"replace",Add:"add","Replace (smooth)":"smoothreplace","Add (smooth)":"smoothadd"}).name("Action").onChange(Wi),j=B.add(k,"typeOfBrush",{Disk:"circle","Horizontal line":"hline","Vertical line":"vline"}).name("Shape").onChange(Wi),B.add(k,"brushValue").name("Value").onFinishChange(Wi),B.add(k,"brushRadius").name("Radius").onChange(Wi),ge=B.add(k,"whatToDraw",si).name("Species").onChange(Wi),B=q.addFolder("Domain"),B.add(k,"dimension",{1:1,2:2}).name("Dimension").onChange((function(){Yo(),Ai()})),B.add(k,"domainScale").name("Largest side").onChange(Si);const n=B.add(k,"spatialStep").name("Space step").onChange((function(){Si()}));n.__precision=12,n.min(0),n.updateDisplay(),B.add(k,"squareCanvas").name("Square").onFinishChange((function(){$i(),Si(),yi()})),B.add(k,"domainViaIndicatorFun").name("Implicit").onFinishChange((function(){vo(),bo(),zi(),ho()})),Z=B.add(k,"domainIndicatorFun").name("Ind. fun").onFinishChange((function(){vo(),bo(),zi(),fo()})),B=q.addFolder("Timestepping"),B.add(k,"numTimestepsPerFrame",1,400,1).name("Steps/frame"),he=B.add(k,"dt").name("Timestep").onChange((function(){Ci()})),he.__precision=12,he.min(0),he.updateDisplay(),B.add(k,"timesteppingScheme",{"Forward Euler":"Euler","Adams-Bashforth 2":"AB2","Midpoint Method":"Mid","Runge-Kutta 4":"RK4"}).name("Scheme"),B.add(k,"timeDisplay").name("Show time").onChange(ko),B=q.addFolder("Equations"),B.add(k,"numSpecies",{1:1,2:2,3:3,4:4}).name("No. species").onChange(So),Y=B.add(k,"crossDiffusion").name("Cross diffusion").onChange(So),X=B.add(k,"numAlgebraicSpecies",{0:0,1:1,2:2,3:3}).name("No. algebraic").onChange((function(){Pn=!0,So(),Pn=!1})),B.add(k,"speciesNames").name("Species names").onFinishChange((function(){ua()})),B.add(k,"reactionNames").name("Reactions").onFinishChange((function(){ua()})),B=M.addFolder("Definitions"),B.add(k,"typesetCustomEqs").name("Typeset").onChange(wo),K=B.add(k,"diffusionStrUU").onFinishChange((function(){zi(),wo()})),pa(K,ga,["D","U","UU"]),ha(K,ba,["D","U","UU"]),ee=B.add(k,"diffusionStrUV").onFinishChange((function(){zi(),wo()})),pa(ee,ga,["UV"]),ha(ee,ba,["UV"]),ne=B.add(k,"diffusionStrUW").onFinishChange((function(){zi(),wo()})),pa(ne,ga,["UW"]),ha(ne,ba,["UW"]),te=B.add(k,"diffusionStrUQ").onFinishChange((function(){zi(),wo()})),pa(te,ga,["UQ"]),ha(te,ba,["UQ"]),ie=B.add(k,"diffusionStrVU").onFinishChange((function(){zi(),wo()})),pa(ie,ga,["VU"]),ha(ie,ba,["VU"]),oe=B.add(k,"diffusionStrVV").onFinishChange((function(){zi(),wo()})),pa(oe,ga,["V","VV"]),ha(oe,ba,["V","VV"]),ae=B.add(k,"diffusionStrVW").onFinishChange((function(){zi(),wo()})),pa(ae,ga,["VW"]),ha(ae,ba,["VW"]),re=B.add(k,"diffusionStrVQ").onFinishChange((function(){zi(),wo()})),pa(re,ga,["VQ"]),ha(re,ba,["VQ"]),se=B.add(k,"diffusionStrWU").onFinishChange((function(){zi(),wo()})),pa(se,ga,["WU"]),ha(se,ba,["WU"]),le=B.add(k,"diffusionStrWV").onFinishChange((function(){zi(),wo()})),pa(le,ga,["WV"]),ha(le,ba,["WV"]),ue=B.add(k,"diffusionStrWW").onFinishChange((function(){zi(),wo()})),pa(ue,ga,["W","WW"]),ha(ue,ba,["W","WW"]),ce=B.add(k,"diffusionStrWQ").onFinishChange((function(){zi(),wo()})),pa(ce,ga,["WQ"]),ha(ce,ba,["WQ"]),de=B.add(k,"diffusionStrQU").onFinishChange((function(){zi(),wo()})),pa(de,ga,["QU"]),ha(de,ba,["QU"]),fe=B.add(k,"diffusionStrQV").onFinishChange((function(){zi(),wo()})),pa(fe,ga,["QV"]),ha(fe,ba,["QV"]),me=B.add(k,"diffusionStrQW").onFinishChange((function(){zi(),wo()})),pa(me,ga,["QW"]),ha(me,ba,["QW"]),pe=B.add(k,"diffusionStrQQ").onFinishChange((function(){zi(),wo()})),pa(pe,ga,["Q","QQ"]),ha(pe,ba,["Q","QQ"]),G=B.add(k,"reactionStrU").onFinishChange((function(){zi(),wo()})),pa(G,ga,["UFUN"]),ha(G,ba,["UFUN"]),z=B.add(k,"reactionStrV").onFinishChange((function(){zi(),wo()})),pa(z,ga,["VFUN"]),ha(z,ba,["VFUN"]),J=B.add(k,"reactionStrW").onFinishChange((function(){zi(),wo()})),pa(J,ga,["WFUN"]),ha(J,ba,["WFUN"]),H=B.add(k,"reactionStrQ").onFinishChange((function(){zi(),wo()})),pa(H,ga,["QFUN"]),ha(H,ba,["QFUN"]),En=M.addFolder("Parameters"),function(){let e,n,t=k.kineticParams.split(";");for(var i=0;i<t.length;i++)n=$o(t[i]),""==n||(n=n.replace(/(\S)=/,"$1 ="),n=n.replace(/=(\S)/,"= $1"),n=n.replaceAll(/,(\S)/g,", $1"),e="param"+qn,qn+=1,Ln.push(e),In[e]=n,Fo(e,!1));e="param"+qn,Ln.push(e),In[e]=n,Fo(e,!0)}(),B=M.addFolder("Boundary conditions"),Oe=B.add(k,"boundaryConditionsU",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),ze=B.add(k,"dirichletStrU").onFinishChange(zi),nn=B.add(k,"neumannStrU").onFinishChange(zi),rn=B.add(k,"robinStrU").onFinishChange(zi),Ye=B.add(k,"comboStrU").name("Details").onFinishChange(zi),Be=B.add(k,"boundaryConditionsV",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),Je=B.add(k,"dirichletStrV").onFinishChange(zi),tn=B.add(k,"neumannStrV").onFinishChange(zi),sn=B.add(k,"robinStrV").onFinishChange(zi),Ze=B.add(k,"comboStrV").name("Details").onFinishChange(zi),je=B.add(k,"boundaryConditionsW",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).onChange((function(){zi(),ao()})),He=B.add(k,"dirichletStrW").onFinishChange(zi),on=B.add(k,"neumannStrW").onFinishChange(zi),ln=B.add(k,"robinStrW").onFinishChange(zi),Ke=B.add(k,"comboStrW").name("Details").onFinishChange(zi),Ge=B.add(k,"boundaryConditionsQ",{Periodic:"periodic",Dirichlet:"dirichlet",Neumann:"neumann",Robin:"robin",Combination:"combo"}).name("$q$").onChange((function(){zi(),ao()})),Xe=B.add(k,"dirichletStrQ").onFinishChange(zi),an=B.add(k,"neumannStrQ").onFinishChange(zi),un=B.add(k,"robinStrQ").onFinishChange(zi),en=B.add(k,"comboStrQ").name("Details").onFinishChange(zi),B=M.addFolder("Initial conditions"),Ie=B.add(k,"clearValueU").onFinishChange(so),Le=B.add(k,"clearValueV").onFinishChange(so),Me=B.add(k,"clearValueW").onFinishChange(so),qe=B.add(k,"clearValueQ").onFinishChange(so),B=q.addFolder("Plotting"),be=B.add(k,"lineWidthMul",.1,2).name("Thickness").onChange((function(){ma(),Ai()})),ve=B.add(k,"threeDHeightScale").name("Max height").onChange(Ci),Se=B.add(k,"cameraTheta").name("View $\\theta$").onChange(yi),we=B.add(k,"cameraPhi").name("View $\\phi$").onChange(yi),ye=B.add(k,"cameraZoom").name("Zoom").onChange(yi),Ce=B.add(k,"forceManualInterpolation").name("Man. smooth").onChange(jo),Ve=B.add(k,"smoothingScale",0,16,1).name("Smoothing").onChange((function(){Fi(),N.smoothingScale.value=k.smoothingScale+1,Ai()})),B=B.addFolder("Contours"),$e=B.add(k,"contourNum").name("Number").onChange((function(){Ha(),Xa()})),Ja($e,1,20,1),_e=B.add(k,"contourEpsilon").name("Threshold").onChange((function(){Ha(),Xa()})),Ja(_e,.001,.05,.001),B.addColor(k,"contourColour").name("Colour").onChange((function(){Ha(),Xa()})),B=q.addFolder("Colour"),B.add(k,"colourbar").name("Colour bar").onChange(Qo),B.addColor(k,"backgroundColour").name("Background").onChange((function(){a.background=new Jt.Color(k.backgroundColour),Ai()})),B=B.addFolder("Lighting"),Qe=B.add(k,"embossSmoothness").name("Smoothness").onChange((function(){za(),Xa()})),Ja(Qe,0,10,.001),Ae=B.add(k,"embossAmbient").name("Ambient").onChange((function(){za(),Xa()})),Ja(Ae,0,1,.001),Re=B.add(k,"embossDiffuse").name("Diffuse").onChange((function(){za(),Xa()})),Ja(Re,0,1,.001),Pe=B.add(k,"embossSpecular").name("Specular").onChange((function(){za(),Xa()})),Ja(Pe,0,1,.001),Te=B.add(k,"embossShiny").name("Precision").onChange((function(){za(),Xa()})),Ja(Te,0,100,1),ke=B.add(k,"embossTheta").name("Inclination").onChange((function(){za(),Xa()})),Ja(ke,0,1.5708,.001),Ne=B.add(k,"embossPhi").name("Direction").onChange((function(){za(),Xa()})),Ja(Ne,0,3.1456,.001),cn=q.addFolder("Images"),B=cn,co(),B=q.addFolder("Checkpoints"),B.add(k,"resetFromCheckpoints").name("Enabled"),B.add(k,"resizeCheckpoints",{Stretch:"stretch",Crop:"crop"}).name("Resize");const t=document.createElement("li");t.classList.add("button_list"),B.domElement.children[0].appendChild(t),Pa(t,"Set",va),Pa(t,"Export",Sa),Pa(t,"Import",(function(){$("#checkpointInput").click()})),B=q.addFolder("Misc."),B.add(k,"integrate").name("Integrate").onChange((function(){Io(),Ai()})),B.add(k,"fixRandSeed").name("Fix random seed");const i=document.createElement("li");i.classList.add("button_list"),B.domElement.children[0].appendChild(i),Pa(i,'<i class="fa-regular fa-copy"></i> Copy code',ka),B=B.addFolder("Debug");const o=document.createElement("li");o.classList.add("button_list"),B.domElement.children[0].appendChild(o),Pa(o,"Copy debug information",Na);const r=document.createElement("div");r.innerHTML="Settings",r.classList.add("ui_title"),q.domElement.prepend(r);const s=document.createElement("div");s.innerHTML="Equations",s.classList.add("ui_title"),M.domElement.prepend(s);const l=document.createElement("div");l.id="views_list",O.domElement.prepend(l);const u=document.createElement("div");u.innerHTML="Views<a id='add_view' title='New view'><i class='fa-solid fa-plus'></i></a>",u.classList.add("ui_title"),O.domElement.prepend(u),B=O.addFolder("Edit view");const c=document.createElement("li");c.id="edit_view_buttons",c.classList.add("button_list"),B.domElement.children[0].appendChild(c),Pa(c,'<i class="fa-solid fa-pen-nib"></i> Rename',Fa,null,"Rename view"),Pa(c,'<i class="fa-solid fa-xmark"></i> Delete',Ea,"deleteViewButton","Delete view"),mn=B.add(k,"whatToPlot").name("Expression: ").onFinishChange((function(){fo(),Ai(),Wa(this.property)})),B.add(k,"plotType",{Line:"line",Plane:"plane",Surface:"surface"}).name("Plot type").onChange((function(){Xo(),document.activeElement.blur(),Ai(),Wa(this.property)})),B.add(k,"colourmap",{BlckGrnYllwRdWht:"BlackGreenYellowRedWhite","Blue-Magenta":"blue-magenta",Diverging:"diverging",Greyscale:"greyscale",Foliage:"foliage",Ice:"ice","Lava flow":"lavaflow",Midnight:"midnight",Pastels:"pastels","Simply blue":"blue","Snow Ghost":"snowghost",Thermal:"thermal",Turbo:"turbo",Viridis:"viridis",Water:"water"}).onChange((function(){Ti(),Qo(),Wa(this.property)})).name("Colour map"),Fe=B.add(k,"minColourValue").name("Min value").onChange((function(){Ci(),Ao(),Ai(),Wa(this.property)})),Fe.__precision=2,Ee=B.add(k,"maxColourValue").name("Max value").onChange((function(){Ci(),Ao(),Ai(),Wa(this.property)})),Ee.__precision=2,We=B.add(k,"autoSetColourRange").name("Auto snap").onChange((function(){k.autoSetColourRange&&(sa(),Ai()),Wa(this.property)})),Ue=B.add(k,"contours").name("Contours").onChange((function(){Ti(),Wa(this.property)})),xe=B.add(k,"emboss").name("Lighting").onChange((function(){Ti(),Wa(this.property)}));const d=document.createElement("li");d.id="colour_map_buttons",d.classList.add("button_list"),B.domElement.children[0].appendChild(d),Pa(d,'<i class="fa-solid fa-arrow-right-arrow-left"></i> Reverse',(function(){k.flippedColourmap=!k.flippedColourmap,Ti(),Qo(),Wa("flippedColourmap")}),null,"Reverse colour map"),Pa(d,'<i class="fa-solid fa-arrows-left-right-to-line"></i> Snap',(function(){sa(),Ai(),Wa("minColourValue"),Wa("maxColourValue")}),null,"Snap min/max to visible")}function Di(){Ti(),Qo(),fo(),Wi()}function Wi(){let e=ta()+tt(),n="float brushRadius = "+ji(k.brushRadius.toString())+";\n";switch(n=n.replace(/\buvwq\./g,"uvwqBrush."),n=n.replace(/\b(I_[ST])([RGBA]?)\b/g,"$1Brush$2"),k.brushValue.includes("RAND")&&(e+=Rt()),e+="float brushValue = "+ji(k.brushValue)+";\n",e+=n,k.typeOfBrush){case"circle":e+=at();break;case"hline":e+=st();break;case"vline":e+=rt()}switch(k.brushAction){case"replace":e+=lt(),e+=it();break;case"add":e+=lt(),e+=ot();break;case"smoothreplace":e+=ut(),e+=it();break;case"smoothadd":e+=ut(),e+=ot()}e=function(e){let n=/COLOURSPEC/g;return e=e.replace(n,oo(k.whatToDraw)),e}(e),v.fragmentShader=e,v.needsUpdate=!0}function Ti(){R=Mt(k.colourmap),k.flippedColourmap&&(R.reverse(),R=R.map((e=>e.slice(0,-1).concat([1-e.slice(-1)])))),N.colour1.value=new Jt.Vector4(...R[0]),N.colour2.value=new Jt.Vector4(...R[1]),N.colour3.value=new Jt.Vector4(...R[2]),N.colour4.value=new Jt.Vector4(...R[3]),N.colour5.value=new Jt.Vector4(...R[4]);let e=Pt();k.emboss&&(e+=Nt(),za()),k.contours&&(e+=It(),Ha()),e+=kt(),b.fragmentShader=e,b.needsUpdate=!0,V.needsUpdate=!0,P=R.map((e=>e[3])),R=R.map((e=>e.slice(0,-1))),Ai()}function Qi(){switch(k.timesteppingScheme){case"Euler":N.textureSource.value=Dn[1].texture,N.textureSource1.value=Dn[2].texture,N.textureSource2.value=void 0,N.textureSource3.value=void 0,N.dt.value=k.dt,N.timesteppingScheme.value=0,s.setRenderTarget(Dn[0]),s.render(r,o),Dn.rotate(-1),N.t.value+=k.dt;break;case"AB2":N.textureSource.value=Dn[1].texture,N.textureSource1.value=Dn[2].texture,N.textureSource2.value=void 0,N.textureSource3.value=void 0,N.dt.value=k.dt,N.timesteppingScheme.value=1,s.setRenderTarget(Dn[0]),s.render(r,o),Dn.rotate(-1),N.t.value+=k.dt;break;case"Mid":N.textureSource2.value=void 0,N.textureSource3.value=void 0,N.timesteppingScheme.value=3,N.textureSource.value=Dn[1].texture,s.setRenderTarget(Dn[2]),s.render(r,o),N.timesteppingScheme.value=2,N.textureSource1.value=Dn[2].texture,N.t.value+=.5*k.dt,s.setRenderTarget(Dn[0]),s.render(r,o),Dn.rotate(-1),N.t.value+=.5*k.dt;break;case"RK4":N.timesteppingScheme.value=3,N.textureSource.value=Dn[1].texture,s.setRenderTarget(Dn[2]),s.render(r,o),N.timesteppingScheme.value=4,N.textureSource1.value=Dn[2].texture,N.t.value+=.5*k.dt,s.setRenderTarget(Dn[3]),s.render(r,o),N.timesteppingScheme.value=5,N.textureSource2.value=Dn[3].texture,s.setRenderTarget(Dn[4]),s.render(r,o),N.timesteppingScheme.value=6,N.textureSource3.value=Dn[4].texture,N.t.value+=.5*k.dt,s.setRenderTarget(Dn[0]),s.render(r,o),Dn.rotate(-1)}}function Ai(){if(k.autoSetColourRange&&sa(),k.brushEnabled&&"surface"==k.plotType){let e=(function(){Oo();let e=0;for(let n=0;n<Yn.length;n+=4)e+=Yn[n];return e/(Cn*Vn)}()-k.minColourValue)/(k.maxColourValue-k.minColourValue)-.5;D.position.y=k.threeDHeightScale*e.clamp(-.5,.5),D.updateWorldMatrix()}if(E.material=V,N.textureSource.value=Dn[1].texture,s.setRenderTarget(f),s.render(r,o),N.textureSource.value=f.texture,et=!1,"line"==k.plotType){Oo();let e,n=0;for(let t=0;t<Yn.length;t+=4)e=(Yn[t]-k.minColourValue)/(k.maxColourValue-k.minColourValue)-.5,Q[n++]=e.clamp(-.5,.5);const t=new Jt.SplineCurve(T.map(((e,n)=>new Jt.Vector2(e,Q[n])))),i=t.getSpacedPoints(A);!function(e){let n,t=W.geometry.attributes.instanceStart,i=W.geometry.attributes.instanceEnd;for(let o=0;o<e.length;o++)n=e[o].toArray(),n[1]*=k.threeDHeightScale,o<e.length&&t.setXYZ(o,n[0],n[1],0),o>0&&i.setXYZ(o-1,n[0],n[1],0);t.needsUpdate=!0,i.needsUpdate=!0}(i),function(e){let n,t=W.geometry.attributes.instanceColorStart,i=W.geometry.attributes.instanceColorEnd;for(let o=0;o<e.length;o++)n=da(e[o].toArray()[1]+.5),o<e.length&&t.setXYZ(o,n[0],n[1],n[2]),o>0&&i.setXYZ(o-1,n[0],n[1],n[2]);t.needsUpdate=!0}(i)}if(k.timeDisplay&&No(),k.integrate&&function(){if(k.integrate){let e;Oo(),1==k.dimension?e=N.dx.value:2==k.dimension&&(e=N.dx.value*N.dy.value);let n=0;for(let e=0;e<Yn.length;e+=4)n+=Yn[e];n*=e,$("#integralValue").html(Ro(n,4)),Bo()}}(),Go()&&(E.material=U,s.setRenderTarget(m),s.render(r,o),N.textureSource.value=m.texture),s.setRenderTarget(null),s.render(a,i),Kn){Kn=!1;var e=document.createElement("a");e.download="VisualPDEScreenshot",s.render(a,i),e.href=s.domElement.toDataURL(),document.body.appendChild(e),e.click(),document.body.removeChild(e),xi(),Ai()}}function Ri(n){hn=Ni(n,e),hn&&(k.brushEnabled&&"surface"==k.plotType?u.enabled=!1:k.brushEnabled||($("#top_message").html("<p>Brush disabled</p>"),Wo("#top_message"),window.clearTimeout(Sn),Sn=setTimeout((function(){$("#top_message").hasClass("fading_out")||To("#top_message")}),3e3)))}function Pi(e){hn=!1,"surface"==k.plotType&&(u.enabled=!0)}function ki(n){Ni(n,e)}function Ni(e,n){var t=n.getBoundingClientRect();let o=(e.clientX-t.x)/t.width,a=1-(e.clientY-t.y)/t.height;if("surface"==k.plotType){d.x=2*o-1,d.y=2*a-1,c.setFromCamera(d,i);var r=c.intersectObject(D,!1);r.length>0?(o=r[0].uv.x,a=r[0].uv.y):(o=-1,a=-1)}else"line"==k.plotType&&(o=(o-.5)/i.zoom+.5,a=.5);return o=Math.round(o*Cn)/Cn,a=Math.round(a*Vn)/Vn,N.brushCoords.value=new Jt.Vector2(o,a),0<=o&&o<=1&&0<=a&&a<=1}function Ii(){s.setSize(Cn,Vn,!1),k.fixRandSeed||ro(),Rn&&k.resetFromCheckpoints?E.material=_:E.material=y,Dn.forEach((e=>{s.setRenderTarget(e),s.render(r,o)})),Va(),Ai()}function Li(){An||($("#pause").hide(),$("#play").show()),pn=!1}function Mi(){An||($("#play").hide(),$("#pause").show()),pn=!0}function qi(){Ii(),N.t.value=0,No(),Ai(),window.clearTimeout(vn),qo()}function Oi(){let e="";return e+="float UFUN = "+ji(k.reactionStrU)+";\n",e+="float VFUN = "+ji(k.reactionStrV)+";\n",e+="float WFUN = "+ji(k.reactionStrW)+";\n",e+="float QFUN = "+ji(k.reactionStrQ)+";\n",e}function Bi(e,n){let t="",i=/\bx\b/g,o=/\by\b/g,a=/\buvwq\.\b/g;return t+="float D"+n+" = "+e,t+="float D"+n+"L = "+e.replaceAll(i,"(x-dx)").replaceAll(a,"uvwqL."),t+="float D"+n+"R = "+e.replaceAll(i,"(x+dx)").replaceAll(a,"uvwqR."),t+="float D"+n+"T = "+e.replaceAll(o,"(y+dy)").replaceAll(a,"uvwqT."),t+="float D"+n+"B = "+e.replaceAll(o,"(y-dy)").replaceAll(a,"uvwqB."),t}function ji(e){if(!Ua(e=" "+e+" "))return" 0.0 ";for(e=oa(e=(e=(e=(e=Gi(e=e.replaceAll(/\btanh\b/g,"safetanh"),"^",(function(e,n,t){switch(t){case"0":return"1";case"1":return"("+n+")";case"2":return"(("+n+")*("+n+"))";case"3":return"(("+n+")*("+n+")*("+n+"))";case"4":return"(("+n+")*("+n+")*("+n+")*("+n+"))";case"5":return"(("+n+")*("+n+")*("+n+")*("+n+")*("+n+"))";default:return"safepow("+n+","+t+")"}}))).replaceAll(RegExp("\\b("+ui[0]+")\\b","g"),(function(e,n){return"uvwq."+oo(n)}))).replaceAll(RegExp("\\b("+ui[0]+")_([xy])\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+oo(n)}))).replaceAll(RegExp("\\b("+ui[0]+")_(xx|yy)\\b","g"),(function(e,n,t){return"uvwq"+t.toUpperCase()+"."+oo(n)})));e!=(e=e.replace(/([^.0-9])(\d+)([^.0-9])/g,"$1$2.$3")););return e}function Gi(e,n,t){const i="^*".includes(n);if(e.indexOf(n)>-1){let o,a=[],r="___joker___";for(;e.indexOf("(")>-1;)e=e.replace(/(\([^\(\)]*\))/g,(function(e,n){return a.push(n),r+(a.length-1)}));for(a.push(e),e=r+(a.length-1),o=i?new RegExp("([\\w.]*)\\s*\\"+n+"\\s*([\\w.]*)","g"):new RegExp("([\\w.]*)\\s*"+n+"\\s*([\\w.]*)","g");e.indexOf(r)>-1;)e=e.replace(new RegExp(r+"(\\w+)","g"),(function(e,n){return a[n].replace(o,t)}))}return e}function zi(){let e="",n="",t="",i="",o="",a="";const r=[k.boundaryConditionsU,k.boundaryConditionsV,k.boundaryConditionsW,k.boundaryConditionsQ],s=[k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ],l=[k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ].map((e=>e+";")),u=[k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ],c=[k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ];if(r.forEach((function(n,t){"neumann"==n?(e+=Ji(s[t],si[t]),e+=Ta(t)):"combo"==n&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Neumann\s*=([^;]*);/g)].forEach((function(n){const i=n[1][0].toUpperCase();e+=Ji(n[2],si[t],i),e+=Ta(t,i)}))})),r.forEach((function(e,t){"combo"==e&&[...l[t].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Ghost\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();n+=function(e,n,t){let i="";i+=io(Tt(n),si[e]),k.dimension>1&&(i+=io(Qt(n),si[e]));return i=i.replaceAll("GHOSTSPECIES",t),i}(t,i,ji(e[2]))}))})),k.domainViaIndicatorFun){let e=yt().replace(/indicatorFun/g,ji(k.domainIndicatorFun));u.forEach((function(n,i){t+=io(e,si[i])+ji(n)+";\n}\n"}))}else r.forEach((function(e,n){"dirichlet"==e?(t+=Hi(u[n],si[n]),t+=Qa(n)):"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=Hi(e[2],si[n],i),t+=Qa(n,i)}))}));r.forEach((function(e,n){"robin"==e?(i+=Ji(c[n],si[n]),i+=Aa(n)):"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Robin\s*=([^;]*);/g)].forEach((function(e){const t=e[1][0].toUpperCase();i+=Ji(e[2],si[n],t),i+=Aa(n,t)}))}));let d=ta();if(o=function(){let e="";return e+=Bi(ji(k.diffusionStrUU)+";\n","uu"),e+=Bi(ji(k.diffusionStrVV)+";\n","vv"),e+=Bi(ji(k.diffusionStrWW)+";\n","ww"),e+=Bi(ji(k.diffusionStrQQ)+";\n","qq"),e}()+"\n",k.crossDiffusion?o+=function(){let e="";return e+=Bi(ji(k.diffusionStrUV)+";\n","uv"),e+=Bi(ji(k.diffusionStrUW)+";\n","uw"),e+=Bi(ji(k.diffusionStrUQ)+";\n","uq"),e+=Bi(ji(k.diffusionStrVU)+";\n","vu"),e+=Bi(ji(k.diffusionStrVW)+";\n","vw"),e+=Bi(ji(k.diffusionStrVQ)+";\n","vq"),e+=Bi(ji(k.diffusionStrWU)+";\n","wu"),e+=Bi(ji(k.diffusionStrWV)+";\n","wv"),e+=Bi(ji(k.diffusionStrWQ)+";\n","wq"),e+=Bi(ji(k.diffusionStrQU)+";\n","qu"),e+=Bi(ji(k.diffusionStrQV)+";\n","qv"),e+=Bi(ji(k.diffusionStrQW)+";\n","qw"),e}()+"\n"+Ut():o+=xt(),Jn&&k.crossDiffusion&&(a+=io(_t(),si[1])),Hn&&k.crossDiffusion&&(a+=io(_t(),si[2])),Xn&&k.crossDiffusion&&(a+=io(_t(),si[3])),o.match(/\buvwq[XY]\.[rgba]\b/))alert("Including derivatives in the diffusion coefficients is not supported. Try casting your PDE in another form.");else if(S.fragmentShader=[d,bt(),Ft(),Dt(),e,n,i,Et(),Wt(),Oi(),o,At(),t,a,vt()].join(" "),S.needsUpdate=!0,bn=k.domainViaIndicatorFun||"dirichlet"==k.boundaryConditionsU||"dirichlet"==k.boundaryConditionsV||"dirichlet"==k.boundaryConditionsW||"dirichlet"==k.boundaryConditionsQ||/Dirichlet/.test(k.comboStrU)||/Dirichlet/.test(k.comboStrV)||/Dirichlet/.test(k.comboStrW)||/Dirichlet/.test(k.comboStrQ),bn){if(t=d+$t(),k.domainViaIndicatorFun){let e=yt().replace(/indicatorFun/g,ji(k.domainIndicatorFun)).replace(/updated/g,"gl_FragColor");u.forEach((function(n,i){t+=io(e,si[i])+ji(n)+";\n}\n"}))}else r.forEach((function(e,n){"dirichlet"==e?(t+=Hi(u[n],si[n]),t+=Ra(n)):"combo"==e&&[...l[n].matchAll(/(Left|Right|Top|Bottom)\s*:\s*Dirichlet\s*=([^;]*);/g)].forEach((function(e){const i=e[1][0].toUpperCase();t+=Hi(e[2],si[n],i),t+=Ra(n,i)}))}));t+="}",w.fragmentShader=t,w.needsUpdate=!0}}function Ji(e,n,t){return null==t?["L","R","T","B"].map((t=>Ji(e,n,t))).join(""):"float robinRHS"+n+t+" = "+ji(e)+";\n"}function Hi(e,n,t){return null==t?["L","R","T","B"].map((t=>Hi(e,n,t))).join(""):"float dirichletRHS"+n+t+" = "+ji(e)+";\n"}function Xi(e){Yi("default"),Yi(e),null!=k.threeD&&(k.threeD&&(k.dimension=2,k.plotType="surface"),delete k.threeD),null!=k.oneDimensional&&(k.oneDimensional&&(k.dimension=1,k.plotType="line"),delete k.oneDimensional),k.domainScale*=Nn,function(){if(0==k.views.length){let e=Da();e.name="1",k.views.push(e)}else k.views=k.views.map((function(e){let n=Da();return Object.assign(n,e),n}));wn=k.views}(),Ki(M,!0),Ki(q,!0),Ki(O,!0),Ei(),k.activeViewInd<k.views.length?$a(k.views[k.activeViewInd],!1):$a({},!0),So(),$i(),Si(),Ci(),a.background=new Jt.Color(k.backgroundColour),""!=k.initialState?fetch(k.initialState).then((e=>e.blob())).then((e=>wa(e))):qi(),yi(),dn.remove(),fn.remove(),co(),jo()}function Yi(e){let n;if(n=null==e?Ot(k.preset):"string"==typeof e?Ot(e):"object"==typeof e?e:Ot("default"),n.hasOwnProperty("parent")&&null!=n.parent&&Yi(n.parent),qn=0,Ln=[],In={},Object.assign(k,n),ua(!0),pn=k.runningOnLoad,pn?Mi():Li(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?k.tryClickingText=k.tryClickingText.replaceAll("clicking","tapping"):k.tryClickingText=k.tryClickingText.replaceAll("tapping","clicking"),k.brushRadius=k.brushRadius.toString(),k.hasOwnProperty("drawIn3D")&&(k.brushEnabled=k.drawIn3D),si.includes("T")||Object.keys(k).forEach((function(e){mi.includes(e)&&(k[e]=ca(k[e],["T"],["I_T"],"[RGBA]"))})),!si.includes("S")){Object.keys(k).forEach((function(e){mi.includes(e)&&(k[e]=ca(k[e],["S"],["I_S"],"[RGBA]"))}));var t=0;t+=k.hasOwnProperty("algebraicV"),t+=k.hasOwnProperty("algebraicW"),(t+=k.hasOwnProperty("algebraicQ"))&&!k.numAlgebraicSpecies&&(k.numAlgebraicSpecies=t),delete k.algebraicV,delete k.algebraicW,delete k.algebraicQ,L=k}let i=[k.clearValueU,k.clearValueV,k.clearValueW,k.clearValueQ,k.domainIndicatorFun,k.reactionStrU,k.reactionStrV,k.reactionStrW,k.reactionStrQ,k.diffusionStrUU,k.diffusionStrUV,k.diffusionStrUW,k.diffusionStrUQ,k.diffusionStrVU,k.diffusionStrVV,k.diffusionStrVW,k.diffusionStrVQ,k.diffusionStrWU,k.diffusionStrWV,k.diffusionStrWW,k.diffusionStrWQ,k.diffusionStrQU,k.diffusionStrQV,k.diffusionStrQW,k.diffusionStrQQ,k.dirichletStrU,k.dirichletStrV,k.dirichletStrW,k.dirichletStrQ,k.robinStrU,k.robinStrV,k.robinStrW,k.robinStrQ,k.comboStrU,k.comboStrV,k.comboStrW,k.comboStrQ,k.neumannStrU,k.neumannStrV,k.neumannStrW,k.neumannStrQ,k.brushValue,k.whatToPlot].join(" ");k.resetOnImageLoad=/\bI_[ST][RGBA]?\b/.test(i)}function Zi(e,n){if(null==n&&(n=!0),null!=e){for(let n in e.__folders)Zi(e.__folders[n],!1);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].updateDisplay()}n&&null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function Ki(e,n){if(null!=e){for(let n in e.__folders)Ki(e.__folders[n]),e.removeFolder(e.__folders[n]);for(let n=0;n<e.__controllers.length;n++)e.__controllers[n].remove();null!=n&&n&&(e.domElement.remove(),e.destroy())}}function eo(e){null!=e&&(e.__li.style.display="none")}function no(e){null!=e&&(e.__li.style.display="")}function to(e,n,t){null!=e&&(e.name(n),null!=t&&e.title(t))}function io(e,n){if(0==n.length)return"";let t=/\bSPECIES\b/g,i=oo(n);return e=e.replace(t,i),t=/\brobinRHSSPECIES/g,e=e.replace(t,"robinRHS"+n),t=/\bdirichletRHSSPECIES/g,e=e.replace(t,"dirichletRHS"+n)}function oo(e){return"rgba"[function(e){return si.indexOf(e)}(e)]}function ao(){"dirichlet"==k.boundaryConditionsU?no(ze):eo(ze),"dirichlet"==k.boundaryConditionsV?no(Je):eo(Je),"dirichlet"==k.boundaryConditionsW?no(He):eo(He),"dirichlet"==k.boundaryConditionsQ?no(Xe):eo(Xe),"neumann"==k.boundaryConditionsU?no(nn):eo(nn),"neumann"==k.boundaryConditionsV?no(tn):eo(tn),"neumann"==k.boundaryConditionsW?no(on):eo(on),"neumann"==k.boundaryConditionsQ?no(an):eo(an),"robin"==k.boundaryConditionsU?no(rn):eo(rn),"robin"==k.boundaryConditionsV?no(sn):eo(sn),"robin"==k.boundaryConditionsW?no(ln):eo(ln),"robin"==k.boundaryConditionsQ?no(un):eo(un),"combo"==k.boundaryConditionsU?no(Ye):eo(Ye),"combo"==k.boundaryConditionsV?no(Ze):eo(Ze),"combo"==k.boundaryConditionsW?no(Ke):eo(Ke),"combo"==k.boundaryConditionsQ?no(en):eo(en),k.domainViaIndicatorFun?(eo(Oe),eo(Be),eo(je),eo(Ge)):no(Oe)}function ro(){N.seed.value=performance.now()%1e3}function so(){let e=ta()+zt();(k.clearValueU.includes("RAND")||k.clearValueV.includes("RAND")||k.clearValueW.includes("RAND")||k.clearValueQ.includes("RAND"))&&(e+=Rt()),e+="float u = "+ji(k.clearValueU)+";\n",e+="float v = "+ji(k.clearValueV)+";\n",e+="float w = "+ji(k.clearValueW)+";\n",e+="float q = "+ji(k.clearValueQ)+";\n",e+=Gt(),y.fragmentShader=e,y.needsUpdate=!0}function lo(){let e=new Image;e.src=dn.__image.src;let n=new Jt.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,N.imageSourceOne.value=n,k.resetOnImageLoad&&qi()}}function uo(){let e=new Image;e.src=fn.__image.src;let n=new Jt.Texture;n.image=e,e.onload=function(){n.needsUpdate=!0,N.imageSourceTwo.value=n,k.resetOnImageLoad&&qi()},n.dispose()}function co(){B=cn,dn=B.addImage(k,"imagePathOne").name("$I_S(x,y)$").onChange(lo),fn=B.addImage(k,"imagePathTwo").name("$I_T(x,y)$").onChange(uo),null!=MathJax.typesetPromise&&MathJax.typesetPromise()}function fo(){"MAX"==k.whatToPlot?(V.fragmentShader=ft()+pt().replace(/indicatorFun/g,ji(k.domainIndicatorFun))+mt(),V.needsUpdate=!0,k.minColourValue=0,k.maxColourValue=1,Ci(),eo(Fe),eo(Ee),eo(De),eo(We),k.autoSetColourRange=!1,Zi(q)):(ho(),no(Fe),no(Ee),no(De),no(We)),Qo(),Io(),Ai()}function mo(e,n){return Object.fromEntries(Object.entries(e).filter((([e,t])=>JSON.stringify(n[e])!==JSON.stringify(t))))}function po(){Oo();let e=1/0,n=-1/0;for(let t=0;t<Yn.length;t+=4)e=Math.min(e,Yn[t]),n=Math.max(n,Yn[t]);return[e,n]}function ho(){let e=ta()+ct();e+=dt(),e=function(e){return e.replace(/FUN/g,ji(k.whatToPlot))}(e),k.domainViaIndicatorFun&&(e+=pt().replace(/indicatorFun/g,ji(k.domainIndicatorFun))),V.fragmentShader=e+mt(),V.needsUpdate=!0}function go(){k.numAlgebraicSpecies=Math.min(parseInt(k.numAlgebraicSpecies),parseInt(k.numSpecies)-1),Jn=k.numAlgebraicSpecies>=k.numSpecies-1,Hn=k.numAlgebraicSpecies>=k.numSpecies-2,Xn=k.numAlgebraicSpecies>=k.numSpecies-3}function bo(){let e="function of "+si.slice(0,k.numSpecies).join(", ")+", x, y, t",n=e.replace(" "+si[1]+",",""),i=e.replace(" "+si[2]+",",""),o=e.replace(" "+si[3]+",","");switch(1==k.dimension&&(e=e.replace(" y,","")),k.crossDiffusion&&parseInt(k.numSpecies)>1?(Pn||la(X,Array.from(Array(parseInt(k.numSpecies)).keys())),no(X)):eo(X),k.numSpecies>1?no(Y):eo(Y),eo(ee),eo(ie),eo(oe),eo(z),eo(Le),eo(Be),eo(ne),eo(ae),eo(se),eo(le),eo(ue),eo(J),eo(Me),eo(je),eo(te),eo(re),eo(ce),eo(de),eo(fe),eo(me),eo(pe),eo(H),eo(qe),eo(Ge),parseInt(k.numSpecies)){case 4:k.crossDiffusion?(no(te),no(re),no(ce),no(de),no(fe),no(me)):(eo(ce),eo(de),eo(re),eo(te),eo(fe),eo(me)),no(pe),no(H),no(qe),no(Ge);case 3:k.crossDiffusion?(no(ne),no(ae),no(se),no(le)):(eo(ne),eo(ae),eo(se),eo(le)),no(ue),no(J),no(Me),no(je);case 2:k.crossDiffusion?(no(ee),no(ie)):(eo(ee),eo(ie)),no(oe),no(z),no(Le),no(Be)}1==k.numSpecies?to(K,di.D,e):k.crossDiffusion?(to(K,di.Duu,e),to(ee,di.Duv,e),to(ne,di.Duw,e),to(te,di.Duq,e),to(ie,di.Dvu,e),to(oe,di.Dvv,e),to(ae,di.Dvw,e),to(re,di.Dvq,e),to(se,di.Dwu,e),to(le,di.Dwv,e),to(ue,di.Dww,e),to(ce,di.Dwq,e),to(de,di.Dqu,e),to(fe,di.Dqv,e),to(me,di.Dqw,e),to(pe,di.Dqq,e)):(to(K,di.Du,e),to(oe,di.Dv,e),to(ue,di.Dw,e),to(pe,di.Dq,e)),to(G,di.UFUN,e),to(z,di.VFUN,e),to(J,di.WFUN,e),to(H,di.QFUN,e),Jn&&(to(ie,di.Dvu,n),to(ae,di.Dvw,n),to(re,di.Dvq,n),to(z,di.VFUN,n),eo(oe)),Hn&&(to(se,di.Dwu,o),to(le,di.Dwv,o),to(ce,di.Dwq,o),to(J,di.WFUN,o),eo(ue)),Xn&&(to(de,di.Dqu,i),to(fe,di.Dqv,i),to(me,di.Dqw,i),to(H,di.QFUN,i),eo(pe)),to(Oe,di.u),to(Be,di.v),to(je,di.w),to(Ge,di.q),to(ze,di.uD),to(Je,di.vD),to(He,di.wD),to(Xe,di.qD),to(nn,di.uN),to(tn,di.vN),to(on,di.wN),to(an,di.qN),to(rn,di.uN),to(sn,di.vN),to(ln,di.wN),to(un,di.qN),to(Ie,di.uInit),to(Le,di.vInit),to(Me,di.wInit),to(qe,di.qInit),k.domainViaIndicatorFun?no(Z):eo(Z),ao(),"surface"==k.plotType?(eo(Ue),no(xe),eo(be),no(ve),no(Se),no(we),no(ye)):"line"==k.plotType?(eo(Ue),eo(xe),no(be),no(ve),eo(Se),eo(we),eo(ye)):(no(Ue),no(xe),eo(be),eo(ve),eo(Se),eo(we),eo(ye)),Qo(),ko(),Io(),$("#dataContainer").show(),"line"==k.plotType?(eo(j),$(":root").css("--ui-button-outline","black")):(no(j),$(":root").css("--ui-button-outline","white")),t?eo(Ce):no(Ce),Go()?no(Ve):eo(Ve),la(ge,si.slice(0,k.numSpecies)),Te.slider.style.setProperty("--value",k.embossShiny),Qe.slider.style.setProperty("--value",k.embossSmoothness),Ae.slider.style.setProperty("--value",k.embossAmbient),Re.slider.style.setProperty("--value",k.embossDiffuse),Pe.slider.style.setProperty("--value",k.embossSpecular),ke.slider.style.setProperty("--value",k.embossTheta),Ne.slider.style.setProperty("--value",k.embossPhi),_a(),Zi(M),Zi(q),Zi(O)}function vo(){let e;switch(go(),k.domainViaIndicatorFun&&(k.boundaryConditionsU="dirichlet",k.boundaryConditionsV="dirichlet",k.boundaryConditionsW="dirichlet",k.boundaryConditionsQ="dirichlet"),parseInt(k.numSpecies)){case 1:k.crossDiffusion=!1,k.whatToDraw=si[0],k.whatToPlot=si[0],k.diffusionStrUV="0",k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVU="0",k.diffusionStrVV="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsV="periodic",k.clearValueV="0",k.reactionStrV="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[1]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0");break;case 2:k.whatToDraw==si[2]|k.whatToDraw==si[3]&&(k.whatToDraw=si[0]),k.whatToPlot==si[2]|k.whatToPlot==si[3]&&(k.whatToPlot=si[0]),k.diffusionStrUW="0",k.diffusionStrUQ="0",k.diffusionStrVW="0",k.diffusionStrVQ="0",k.diffusionStrWU="0",k.diffusionStrWV="0",k.diffusionStrWW="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsW="periodic",k.clearValueW="0",k.reactionStrW="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[2]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0");break;case 3:k.whatToDraw==si[3]&&(k.whatToDraw=si[0]),k.whatToPlot==si[3]&&(k.whatToPlot=si[0]),k.diffusionStrUQ="0",k.diffusionStrVQ="0",k.diffusionStrWQ="0",k.diffusionStrQU="0",k.diffusionStrQV="0",k.diffusionStrQW="0",k.diffusionStrQQ="0",k.boundaryConditionsQ="periodic",k.clearValueQ="0",k.reactionStrQ="0",e=new RegExp("\\b("+ui[3]+")\\b"),e.test(k.reactionStrU)&&(k.reactionStrU="0"),e.test(k.reactionStrV)&&(k.reactionStrV="0"),e.test(k.reactionStrW)&&(k.reactionStrW="0")}switch(zn){case 3:k.diffusionStrVV="0";break;case 6:k.diffusionStrWW="0";break;case 7:k.diffusionStrVV="0",k.diffusionStrWW="0";break;case 10:k.diffusionStrQQ="0";break;case 11:k.diffusionStrWW="0",k.diffusionStrQQ="0";break;case 12:k.diffusionStrVV="0",k.diffusionStrWW="0",k.diffusionStrQQ="0"}Zi(M),Zi(q)}function So(){!function(){switch(go(),parseInt(k.numSpecies)){case 1:zn=0;break;case 2:zn=k.crossDiffusion?1==k.numAlgebraicSpecies?3:2:1;break;case 3:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:zn=5;break;case 1:zn=6;break;case 2:zn=7}else zn=4;break;case 4:if(k.crossDiffusion)switch(k.numAlgebraicSpecies){case 0:zn=9;break;case 1:zn=10;break;case 2:zn=11;break;case 3:zn=12}else zn=8}}(),Xo(),Yo(),vo(),bo(),function(){const e=ea().split(";");let n=!1;for(const t of e)n|=na(t)}(),ia(),wo(),qi()}function wo(){let e,n=ci[zn];const t={D:/\b(D) (\\vnabla u)/g,U:/\b(D_{u}) (\\vnabla u)/g,UU:/\b(D_{u u}) (\\vnabla u)/g,V:/\b(D_{v}) (\\vnabla v)/g,VV:/\b(D_{v v}) (\\vnabla v)/g,W:/\b(D_{w}) (\\vnabla w)/g,WW:/\b(D_{w w}) (\\vnabla w)/g,Q:/\b(D_{q}) (\\vnabla q)/g,QQ:/\b(D_{q q}) (\\vnabla q)/g,UV:/\b(D_{u v}) (\\vnabla v)/g,UW:/\b(D_{u w}) (\\vnabla w)/g,UQ:/\b(D_{u q}) (\\vnabla q)/g,VU:/\b(D_{v u}) (\\vnabla u)/g,VW:/\b(D_{v w}) (\\vnabla w)/g,VQ:/\b(D_{v q}) (\\vnabla q)/g,WU:/\b(D_{w u}) (\\vnabla u)/g,WV:/\b(D_{w v}) (\\vnabla v)/g,WQ:/\b(D_{w q}) (\\vnabla q)/g,QU:/\b(D_{q u}) (\\vnabla u)/g,QV:/\b(D_{q v}) (\\vnabla v)/g,QW:/\b(D_{q w}) (\\vnabla w)/g,UFUN:/\b(UFUN)/g,VFUN:/\b(VFUN)/g,WFUN:/\b(WFUN)/g,QFUN:/\b(QFUN)/g};if(k.typesetCustomEqs){let o={};o.D=k.diffusionStrUU,o.U=k.diffusionStrUU,o.UU=k.diffusionStrUU,o.V=k.diffusionStrVV,o.VV=k.diffusionStrVV,o.W=k.diffusionStrWW,o.WW=k.diffusionStrWW,o.Q=k.diffusionStrQQ,o.QQ=k.diffusionStrQQ,o.UV=k.diffusionStrUV,o.UW=k.diffusionStrUW,o.UQ=k.diffusionStrUQ,o.VU=k.diffusionStrVU,o.VW=k.diffusionStrVW,o.VQ=k.diffusionStrVQ,o.WU=k.diffusionStrWU,o.WV=k.diffusionStrWV,o.WQ=k.diffusionStrWQ,o.QU=k.diffusionStrQU,o.QV=k.diffusionStrQV,o.QW=k.diffusionStrQW,o.UFUN=k.reactionStrU,o.VFUN=k.reactionStrV,o.WFUN=k.reactionStrW,o.QFUN=k.reactionStrQ;var i=!1;if(Object.keys(o).forEach((function(e){i||(i|=!Ua(o[e]))})),i)return;for(Object.keys(o).forEach((function(e){o[e]=ca(o[e],si,On,"_[xy]")})),Wn.forEach((function(e){o[e]="\\selected{ "+o[e]+" }"})),Object.keys(o).forEach((function(e){Bn.includes(e)||(n=function(e,n,t,i){let o=t.replace(/\s+/g,"  ").trim();if("0"==o||"0.0"==o)return e.replaceAll(n,"");if("1"==o||"1.0"==o)return e.replaceAll(n,"$2");if("-1"==o||"-1.0"==o)return e.replaceAll(n,"-$2");if(t.match(/[a-zA-Z]/))return t.match(/[\+-]/)&&null!=i?e.replaceAll(n,i[0]+t+i[1]+"$2"):e.replaceAll(n,t+"$2");return e}(n,t[e],o[e],"[]"))})),n=Ho(n,t.UFUN,o.UFUN),n=Ho(n,t.VFUN,o.VFUN),n=Ho(n,t.WFUN,o.WFUN),n=Ho(n,t.QFUN,o.QFUN),e=/\(\s*\+/g;n!=(n=n.replace(e,"(")););for(e=/\[\s*\+/g;n!=(n=n.replace(e,"[")););for(e=/\+\s*\)/g;n!=(n=n.replace(e,")")););e=/\\vnabla\s*\\cdot\s*\(\s*\)/g,n=n.replaceAll(e,""),e=/=\s*\+/g,n=n.replaceAll(e,"="),e=/\+\s*(\\\\|\n)/g,n=n.replaceAll(e,"$1"),e=/=\s*(\\\\|\n)/g,n=n.replaceAll(e,"=0$1"),e=/(\\vnabla\s*\\cdot\s*\()\[-([\w\{\}]*)\]\s*(\\vnabla\s*([uvwq])\s*\))/g,n=n.replaceAll(e,"-$1$2$3"),e=/\\vnabla\s*\\cdot\s*\((D_\{\w+(?: \w+)?\})\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,"$1 \\lap $2"),e=/\\vnabla\s*\\cdot\s*\(([\w\{\}\*\^]*)\s*\\vnabla\s*([uvwq])\s*\)/g,n=n.replaceAll(e,(function(e,n,t){return/\b[xy]|[uvwq]\b/g.test(n)?e:n+" \\lap "+t})),e=/\b([uvwq])_([xy])\b/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{$2}"),e=/\b([uvwq])_(xx|yy)\b/g,n=n.replaceAll(e,(function(e,n,t){return"\\textstyle \\pdd{"+n+"}{"+t[0]+"}"}))}else Wn.forEach((function(e){n=n.replaceAll(t[e],(function(e,n,t){let i="\\selected{ "+n+" ";return"string"==typeof t&&(i+=t),i+" }"}))})),n=ca(n,["UFUN","VFUN","WFUN","QFUN"],li,"_[xy]");1==k.dimension&&(n=n.replaceAll(/\\vnabla\s*\\cdot/g,"\\textstyle \\pd{}{x}"),e=/\\vnabla\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pd{$1}{x}"),e=/\\lap\s*([uvwq])/g,n=n.replaceAll(e,"\\textstyle \\pdd{$1}{x}")),n=ca(n,On.concat(Bn),si.concat(li),"_[xy]"),n=yo(n),$("#typeset_equation").html(n),null!=MathJax.typesetPromise&&MathJax.typesetPromise().then(aa)}function yo(e){for(e=e.replaceAll(/\[([\+-]?[\w\{\}]*)\]/g,"$1");e!=(e=e.replace(/\+\s*\+/g,"+")););return e=Co(e=(e=e.replaceAll(/\+\s*-/g,"-")).replaceAll(/-\s*\+/g,"-"),"sin",!0),e=Co(e,"cos",!0),e=Co(e,"tan",!0),e=Co(e,"exp",!0),e=Co(e,"log",!0),e=Co(e,"sqrt",!1),e=Co(e,"sinh",!0),e=Co(e,"cosh",!0),e=Co(e,"tanh",!0),e=Co(e,"max",!0),e=Gi(e=(e=Co(e,"min",!0)).replaceAll(/\*/g," "),"^","{$1}^{$2}"),e=(e=(e=(e=function(e){const n=["(","["],t=[")","]"];let i=0,o=0,a=0,r="",s="";for(var l=0;l<e.length;l++)n.includes(e[l])?(i+=1,o+=1):t.includes(e[l])&&(i-=1),0==i&&o>0&&(r=e.slice(a,l+1),s+=Vo(r,o),o=0,a=l+1);return s+=e.slice(a),s}(e=ri(e))).replaceAll(/[\(\[]/g,"\\left$&")).replaceAll(/[\)\]]/g,"\\right$&")).replaceAll(/_(\w+\b)/g,"_{$1}")}function Co(e,n,t){var i=e;const o=e.matchAll(new RegExp("\\b"+n+"\\b","g"));let a,r,s,l,u,c,d,f=0;for(const m of o){for(a=m.index,r=a+n.length,l=e.slice(r),d=0,u=0,c=!1;d<=l.length&(!c|!(c&&0==u));)u+=["(","["].includes(l[d]),u-=[")","]"].includes(l[d]),c|=u,d+=1;c&&0==u&&(s=d-1+r,i=_o(i,"\\",a+f),f+=1,t?(i=_o(i,"{",r+f),f+=1,i=_o(i,"}",s+1+f),f+=1):(i=Uo(i,"{",r+f),i=Uo(i,"}",s+f)))}return i}function Vo(e,n){const t=["(","["],i=[")","]"];let o=xo(1-n,t.length);for(var a=0;a<e.length;a++)t.includes(e[a])?(e=Uo(e,t[o],a),o+=1,o=xo(o,t.length)):i.includes(e[a])&&(o-=1,o=xo(o,t.length),e=Uo(e,i[o],a));return e}function xo(e,n){return(e%n+n)%n}function Uo(e,n,t){return e.slice(0,t)+n+e.slice(t+1,e.length)}function _o(e,n,t){return e.slice(0,t)+n+e.slice(t,e.length)}function $o(e){return e=e.replace(/\s+/g,"  ").trim()}function Fo(e,n){let t;function i(){t.hasOwnProperty("slider")&&(t.slider.remove(),delete t.slider,t.domElement.closest("li").classList.remove("parameterSlider"));let n=In[e].match(/\s*(\w+)\s*=\s*(\S*)\s*in\s*[\[\(]([0-9\.\-]+)\s*,\s*(?:([0-9\.]*)\s*,)?\s*([0-9\.\-]+)[\]\)]/);if(n){let i;t.domElement.parentElement.parentElement.classList.add("parameterSlider"),t.slider=document.createElement("input"),t.slider.classList.add("styled-slider"),t.slider.classList.add("slider-progress"),t.slider.type="range",t.slider.min=n[3],t.slider.max=n[5],null==n[4]?(n[4]="",!In[e].includes(".")&parseFloat(n[5])-parseFloat(n[3])>1?i=1:(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=Math.min((parseFloat(n[5])-parseFloat(n[3]))/20,10**-t.slider.precision))):(t.slider.precision=Math.max(parseFloat(n[2]).countDecimals(),parseFloat(n[3]).countDecimals(),parseFloat(n[4]).countDecimals(),parseFloat(n[5]).countDecimals())+1,i=n[4],n[4]+=", "),t.slider.step=i.toString(),t.slider.value=n[2],t.slider.addEventListener("input",(function(){t.slider.style.setProperty("--value",t.slider.value);In[e]=In[e].replace(/\s*(\w+)\s*=\s*(\S*)\s*/g,n[1]+" = "+parseFloat(t.slider.value).toFixed(t.slider.precision).toString()+" "),Zi(En),Eo(),Ai(),(na(In[e])||Qn)&&(Qn=!1,ia())})),t.__oldOnFinishChange=t.onFinishChange,t.onFinishChange=function(){t.__oldOnFinishChange(),t.slider.value=n[2]},t.slider.style.setProperty("--value",t.slider.value),t.slider.style.setProperty("--min",t.slider.min),t.slider.style.setProperty("--max",t.slider.max),t.domElement.appendChild(t.slider)}}if(n)Ln.push(e),In[e]="",t=En.add(In,e).name(""),t.domElement.classList.add("params"),t.onFinishChange((function(){const n=Ln.indexOf(e);let t=$o(In[Ln.at(n)]);if(""==t);else{let e=Fo(Ln.at(n),!1);const i=t.match(/\s*(\w+)\s*=/);i&&(e.lastName=i[1],Mn[e.lastName]=e),qn+=1;let o="params"+qn;this.remove(),Fo(o,!0),Eo(),(na(t)||Qn)&&(Qn=!1,ia())}}));else{t=En.add(In,e).name(""),t.domElement.classList.add("params");const n=In[e].match(/\s*(\w+)\s*=/);n&&(t.lastName=n[1],Mn[t.lastName]=t),t.onFinishChange((function(){let n=$o(In[e]);if(""==n){t.domElement.closest("li").hasOwnProperty("parameterSlider")&&(t.slider.remove(),t.domElement.closest("li").classList.remove("parameterSlider")),this.remove();const n=Ln.indexOf(e);Ln.splice(n,1),delete In[e],t.hasOwnProperty("lastName")&&delete N[t.lastName]}else{i();const e=oa(n).match(/\s*(\w+)\s*=/);e&&t.hasOwnProperty("lastName")&&t.lastName!=e[1]&&(delete N[t.lastName],t.lastName=e[1],Mn[t.lastName]=t)}Eo(),na(n)&&ia()}))}return i(),t}function Eo(){k.kineticParams=Object.values(In).map((function(e){return e.replaceAll(/"\s+"/g," ")})).join(";")}function Do(){const e=document.createElement("a");return e.href=document.referrer,e.href==window.location||!e.href.includes(window.location.origin)}function Wo(e){$(e).removeClass("fading_out"),$(e).show(),$(e).addClass("fading_in")}function To(e){$(e).removeClass("fading_in"),$(e).addClass("fading_out"),setTimeout((function(){$(e).hasClass("fading_out")&&($(e).removeClass("fading_out"),$(e).hide())}),1e3)}function Qo(){if(k.colourbar){$("#colourbar").show();let n="linear-gradient(90deg, ";for(var e=0;e<1;e+=.01)n+="rgb("+da(e).map((e=>255*e))+") "+100*e+"%,";n=n.slice(0,-1)+")",$("#colourbar").css("background",n),"MAX"==k.whatToPlot?($("#minLabel").html("$"+si[0]+"$"),$("#midLabel").html("$"+si[1]+"$"),$("#maxLabel").html("$"+si[2]+"$")):$("#midLabel").html("$"+yo(k.whatToPlot)+"$"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#midLabel")),Ko(),Ao()}else $("#colourbar").hide()}function Ao(){if("MAX"!=k.whatToPlot){let e,n;[e,n]=function(e,n){const t=3;if(Math.abs(e)<.001&&Math.abs(n)<.001)return[e.toExponential(t-1),n.toExponential(t-1)];return[Po(e,t),Po(n,t)]}(k.minColourValue,k.maxColourValue);const t=/[1-9]/;t.test(e)||(e="0"),t.test(n)||(n="0"),$("#minLabel").html(e),$("#maxLabel").html(n)}let e=ra(da(0)),n=ra(da(.5)),t=ra(da(1));const i=.51;e<i?$("#minLabel").css("color","#fff"):$("#minLabel").css("color","#000"),n<i?$("#midLabel").css("color","#fff"):$("#midLabel").css("color","#000"),t<i?$("#maxLabel").css("color","#fff"):$("#maxLabel").css("color","#000")}function Ro(e,n){return e.toPrecision(n)}function Po(e,n){const t=e.toFixed(n),i=e.toPrecision(n);return t.length<i.length?t:i}function ko(){k.timeDisplay?($("#timeDisplay").show(),No()):$("#timeDisplay").hide(),Mo()}function No(){if(k.timeDisplay){let e=Ro(N.t.value,3);e=e.replace(/e(\+)*(\-)*([0-9]*)/," × 10<sup>$2$3<sup>"),$("#timeValue").html(e),Bo()}}function Io(){if(k.integrate){$("#integralDisplay").show();let e="";1==k.dimension?e+="$\\int":e+="$\\iint",e+="_{\\domain}"+yo(k.whatToPlot)+"\\,\\d x",1==k.dimension||(e+="\\d y"),$("#integralLabel").html(e+" = $"),null!=MathJax.typesetPromise&&MathJax.typesetPromise($("#integralLabel"))}else $("#integralDisplay").hide();Mo()}function Lo(e,n){$(e).css("bottom",""),$(e).css("bottom","+="+n.toString())}function Mo(){k.integrate&&k.timeDisplay?Lo("#timeDisplay",10):Lo("#timeDisplay",0)}function qo(){let e=po();isFinite(e[0])&&isFinite(e[1])?vn=setTimeout(qo,1e3):(Wo("#oops_hit_nan"),$("#erase").one("click",(()=>To("#oops_hit_nan"))))}function Oo(){if(!et){try{s.readRenderTargetPixels(f,0,0,Cn,Vn,Yn)}catch{alert("Sadly, your configuration is not fully supported by VisualPDE. Some features may not work as expected, but we encourage you to try!")}et=!0}}function Bo(){if(k.colourbar&&k.integrate|k.timeDisplay){let e,n=$("#colourbar")[0].getBoundingClientRect();e=k.integrate?$("#integralDisplay")[0]:$("#timeDisplay")[0];let t=e.getBoundingClientRect();n.right>=t.left?n.top<=t.bottom&&(Lo("#dataContainer",40),Tn=!0):Tn&&(Lo("#dataContainer",0),Tn=!1)}}function jo(){Go()?(Dn.forEach((e=>{e.texture.magFilter=Jt.NearestFilter})),f.texture.magFilter=Jt.NearestFilter,m.texture.magFilter=Jt.NearestFilter):(Dn.forEach((e=>{e.texture.magFilter=Jt.LinearFilter})),f.texture.magFilter=Jt.LinearFilter,m.texture.magFilter=Jt.LinearFilter),bo()}function Go(){return t||k.forceManualInterpolation}function zo(e,n,t){return new Promise((function(i,o){var a=o=>{e.removeEventListener(n,a),i(t)};e.addEventListener(n,a)}))}function Jo(e,n){return null==n&&(n=[]),function(e){return[...(bt()+Ut()).matchAll(/(?:float|vec\d|ivec\d|function|void)\b\s+(\w+)\b/g)].map((e=>e[1])).concat(e)}(n).some((function(n){return new RegExp("\\b"+n+"\\b","g").test(e)}))}function Ho(e,n,t){return"0"==t.replace(/\s+/g,"  ").trim()?e.replaceAll(n,""):t.match(/[a-zA-Z]/)?e.replaceAll(n,t):e}function Xo(){"line"==k.plotType?(ma(),k.typeOfBrush="vline",Wi(),Zi(q),F.visible=!1,W.visible=!0,k.contours=!1,k.emboss=!1):(F.visible=!0,W.visible=!1,"surface"==k.plotType?(k.contours=!1,$("#simCanvas").css("outline","2px #000 solid"),kn&&(kn=!1,wi())):$("#simCanvas").css("outline","")),Ti(),yi(),bo()}function Yo(){1!=k.dimension&&"line"==k.plotType&&(k.plotType="plane",Xo()),1==k.dimension&&"line"!=k.plotType&&(k.plotType="line",Xo()),Si(),zi(),wo(),bo(),Io()}function Zo(){const e=(new Jt.Vector3).setFromSphericalCoords(1,Math.PI/2-k.cameraTheta*Math.PI/180,k.cameraPhi*Math.PI/180);i.position.set(e.x,e.y,e.z),i.lookAt(0,0,0)}function Ko(){$("#logo").is(":visible")&&$("#colourbar").is(":visible")&&$("#logo")[0].getBoundingClientRect().right>=$("#colourbar")[0].getBoundingClientRect().left&&$("#logo").hide()}function ea(){let e=k.kineticParams.replaceAll(/\bin[^;]*;?/g,";");return e=oa(e),e}function na(e){const n=e.match(/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/);let t=!1;return n&&(n[1]=oa(n[1]),Jo(n[1])?alert("The name '"+n[1]+"' is used under the hood, so can't be used as a parameter name. Please use a different name for "+n[1]+"."):(t=!N.hasOwnProperty(n[1]),N[n[1]]={type:"float",value:parseFloat(n[2]+n[3])})),t}function ta(){return oa(ea().replaceAll(/;?\s*(\w+)\s*=\s*[\+\-]?\s*([0-9\.]+)\s*;?/g,"uniform float $1;\n"))}function ia(){zi(),so(),Wi(),fo(),Di(),ho()}function oa(e){let n,t=e;for(let e=0;e<10;e++)for(n=new RegExp("([a-zA-Z_]+)("+e.toString()+")","g");t!=(t=t.replace(n,"$1"+nt[e])););return t}function aa(){const e=$("#equation_display div mjx-container").children("mjx-math");var n;e.css("font-size","");var t=0;if(null==$("#leftGUI")[0])return;const i=$("#rightGUI")[0];var o=0;for(null!=i&&(o=i.getBoundingClientRect().width);t<20&$("#equation_display")[0].getBoundingClientRect().right>=window.innerWidth-65-o&$("#equation_display")[0].getBoundingClientRect().width>$("#leftGUI")[0].getBoundingClientRect().width;)n=(.9*parseFloat(e.css("font-size"))).toString()+"px",e.css("font-size",n),t+=1;$(":root").css("--left-ui-v-offset",$("#leftGUI")[0].getBoundingClientRect().top)}function ra(e){return e.reduce(((e,n)=>e+n),0)/3}function sa(){let e=po();if(Math.abs(e[0]-e[1])<.005){const n=(e[0]+e[1])/2;e[0]=n-.0025,e[1]=n+.0025}k.minColourValue=e[0],k.maxColourValue=e[1],N.maxColourValue.value=k.maxColourValue,N.minColourValue.value=k.minColourValue,Ee.updateDisplay(),Fe.updateDisplay(),Ao()}function la(e,n,t){null==t&&(t=n);let i="";for(var o=0;o<n.length;o++){i+="<option value='"+t[o].toString()+"'>"+n[o].toString()+"</option>"}e.domElement.children[0].innerHTML=i}function ua(e){let n;null!=si&&(n=si);const t=k.speciesNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,On.length),i=k.reactionNames.replaceAll(/\W+/g," ").trim().split(" ").slice(0,Bn.length),o=t.concat(jn.slice(t.length)),a=i.concat(Gn.slice(i.length)),r=function(){const e=/(\w+)\s*=\s*([\+\-]?)\s*([0-9\.]+)/;return ea().split(";").filter((e=>e.length>0)).map((n=>n.replace(e,"$1").trim()))}();let s;for(var l=0;l<o.length;l++)if(Jo(o[l],r.concat(a)))return s=r.includes(o[l])?"as a parameter":a.includes(o[l])?"as a reaction":"under the hood",void alert("The name '"+o[l]+"' is used "+s+", so can't be used as a species name. Please use a different name for "+o[l]+".");for(l=0;l<a.length;l++)if(Jo(a[l],r.concat(o[l])))return s=r.includes(a[l])?"as a parameter":o.includes(a[l])?"as a reaction":"under the hood",void alert("The name '"+a[l]+"' is used "+s+", so can't be used as a function name. Please use a different name for "+a[l]+".");si=o,li=a,function(){ui=[];for(let e=0;e<si.length;e++)ui.push("(?:"+si.slice(e).sort(((e,n)=>n.length-e.length)).map((e=>"(?:"+e+")")).join("|")+")")}();let u={...ii(),...ai()};Object.keys(u).forEach((function(e){di[e]=yo(ca(u[e],On,si,"_[xy]"))})),u=oi(),Object.keys(u).forEach((function(e){di[e]=yo(ca(u[e],Bn,li))})),e||(Object.keys(k).forEach((function(e){mi.includes(e)&&(k[e]=ca(k[e],n,si,"_[xy]"))})),k.views=k.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){mi.includes(i)&&(t[i]=ca(e[i],n,si,"_[xy]"))})),t})),Object.keys(L).forEach((function(e){mi.includes(e)&&(L[e]=ca(L[e],n,si,"_[xy]"))})),L.views=L.views.map((function(e){let t={};return t.name=e.name,Object.keys(e).forEach((function(i){mi.includes(i)&&(t[i]=ca(e[i],n,si,"_[xy]"))})),t})),vo(),bo(),ia(),wo())}function ca(e,n,t,i){null==i&&(i="");const o=new Array(n.length).fill(0).map(((e,n)=>"PLACE"+n.toString()));let a;for(var r=0;r<n.length;r++)a=new RegExp("\\b("+n[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,o[r]+"$2");for(r=0;r<o.length;r++)a=new RegExp("\\b("+o[r]+")("+i+")?\\b","g"),e=e.replaceAll(a,t[r]+"$2");return e}function da(e){e=e.clamp(0,1);let n=0;for(;e>=P[n+1]&&n<R.length-2;)n+=1;return P[n+1]==P[n]?R[n]:function(e,n,t){let i=new Array(e.length);for(let o=0;o<i.length;o++)i[o]=fa(e[o],n[o],t);return i}(R[n],R[n+1],(e-P[n])/(P[n+1]-P[n])).map((e=>e.clamp(0,1)))}function fa(e,n,t){return(1-t)*e+t*n}function ma(){x.linewidth=.01*k.lineWidthMul,x.needsUpdate=!0}function pa(e,n,t){e.domElement.firstChild.onfocus=()=>n(t)}function ha(e,n,t){e.domElement.firstChild.onblur=()=>n(t)}function ga(e){e.forEach((function(e){Wn.add(e)})),wo()}function ba(e){e.forEach((function(e){Wn.delete(e)})),wo()}function va(){Zn=new Float32Array(Cn*Vn*4),s.readRenderTargetPixels(Dn[1],0,0,Cn,Vn,Zn),Ca(Zn),Rn=!0}function Sa(){Rn||va();var e=document.createElement("a");e.download="VisualPDEState",e.href=URL.createObjectURL(new Blob([new Float32Array([Cn,Vn]),Zn])),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function wa(e){const n=new FileReader;n.onload=function(){const e=new Float32Array(n.result);Ca(e.slice(2),e.slice(0,2)),ya(h),Rn=!0,qi()},n.readAsArrayBuffer(e)}function ya(e){if(null!=e)if("crop"==k.resizeCheckpoints){let n=e.source.data.height/e.source.data.width,t=1,i=l/n;i>1&&(t=n/l,i=1),e.repeat.set(t,i),e.offset.set((1-t)/2,(1-i)/2)}else e.repeat.set(1,1),e.offset.set(0,0)}function Ca(e,n){null!=h&&h.dispose(),null==n&&(n=[Cn,Vn]),h=new Jt.DataTexture(e,n[0],n[1],Jt.RGBAFormat,Jt.FloatType),h.needsUpdate=!0,h.magFilter=t?Jt.NearestFilter:Jt.LinearFilter,null!=_&&(_.map=h,_.needsUpdate)}function Va(){s.setSize(Math.round(devicePixelRatio*$n),Math.round(devicePixelRatio*Fn),!1)}function xa(e){$("#error").is(":visible")?$("#error_description").html(e):($("#error_description").html(e),Wo("#error"),$("#error").one("click",(function(){To("#error")})))}function Ua(e){if(/\(\s*\)/.test(e))return xa("Empty parentheses in "+e.trim()+"."),!1;let n=0;for(var t=0;t<e.length;t++)"("==e[t]?n+=1:")"==e[t]&&(n-=1);return 0!=n?(xa("Unbalanced parentheses in "+e.trim()+"."),!1):!/[\+\-\*\^\/]\s*$/.test(e)||(xa("A binary operator is missing an operand in "+e.trim()+"."),!1)}function _a(){let e;$("#views_list").empty();for(let n=0;n<k.views.length;n++)e=document.createElement("a"),e.onclick=function(){k.activeViewInd=n,$a(k.views[n])},e.innerHTML="<div class='view_label'>"+k.views[n].name+"</div>",n==k.activeViewInd&&e.classList.add("active_button"),$("#views_list").append(e);k.views.length>1?$("#deleteViewButton").removeClass("hidden"):$("#deleteViewButton").addClass("hidden"),null!=MathJax.typesetPromise&&MathJax.typesetPromise(),k.views.length}function $a(e,n){Object.assign(k,e),delete k.name,Zi(O),(null==n||n)&&(fo(),Xo(),Ti(),Ci(),Ao(),Qo(),Ai())}function Fa(){let e=prompt("Enter a name for the current View. You can enclose mathematics in $ $.",k.views[k.activeViewInd].name);null!=e&&(k.views[k.activeViewInd].name=e,_a(),null!=MathJax.typesetPromise&&MathJax.typesetPromise())}function Ea(){k.views.length>1?(k.views.splice(k.activeViewInd,1),k.activeViewInd<1?k.activeViewInd=0:k.activeViewInd-=1):k.views[k.activeViewInd].name="Custom",_a()}function Da(){let e={};return fi.forEach((function(n){e[n]=L[n]})),e}function Wa(e){k.activeViewInd<k.views.length&&(k.views[k.activeViewInd][e]=k[e])}function Ta(e,n){let t="";return t+=io(Ct(n),si[e]),k.dimension>1&&(t+=io(Vt(n),si[e])),t}function Qa(e,n){let t="";return t+=io(St(n),si[e]),k.dimension>1&&(t+=io(wt(n),si[e])),t}function Aa(e,n){let t="";return t+=io(Ct(n),si[e]),k.dimension>1&&(t+=io(Vt(n),si[e])),t}function Ra(e,n){let t="";return t+=io(St(n).replaceAll(/updated/g,"gl_FragColor"),si[e]),k.dimension>1&&(t+=io(wt(n).replaceAll(/updated/g,"gl_FragColor"),si[e])),t}function Pa(e,n,t,i,o){const a=document.createElement("a");null!=t&&(a.onclick=t),null!=i&&(a.id=i),null!=o&&(a.title=o),null!=n&&(a.innerHTML=n),e.appendChild(a)}function ka(){let e=mo(k,Ot("default"));e.preset="PRESETNAME";let n=JSON.stringify(e).replaceAll(/\s*,\s*([^0-9-\.\s])/g,",\n\t$1").replaceAll(":",": ").replaceAll("  "," ").replace("{","{\n\t").replace("}",",\n}");n='case "PRESETNAME":\n\toptions = '+n+";\nbreak;",navigator.clipboard.writeText(n)}function Na(){let n="";n+=JSON.stringify(k),n+=JSON.stringify(N),n+=JSON.stringify({nXDisc:Cn,nYDisc:Vn,domainHeight:Un,domainWidth:xn,aspectRatio:l,canvas:e.getBoundingClientRect()}),navigator.clipboard.writeText(n)}function Ia(){$("#right_ui").toggle(),$("#settings").toggleClass("clicked")}function La(){$("#left_ui").toggle(),$("#equations").toggleClass("clicked")}function Ma(){$("#views_ui").toggle(),$("#views").toggleClass("clicked")}function qa(){$("#help_panel").toggle(),$("#help").toggleClass("clicked")}function Oa(){$("#share_panel").toggle(),$("#share").toggleClass("clicked")}function Ba(){let e=mo(k,Ot("default"));return e.preset="Custom",e=Kt(e),[location.href.replace(location.search,""),"?options=",ni.compressToEncodedURIComponent(JSON.stringify(e))].join("")}function ja(e){navigator.clipboard.writeText(e).then((()=>{$("#link_copied").fadeIn(1e3),setTimeout((()=>$("#link_copied").fadeOut(1e3)),2e3)}),(()=>{}))}function Ga(e){const n=Mn[e.data.name];if(null!=n)if(null!=n.slider)n.slider.value=e.data.value,n.slider.dispatchEvent(new Event("input"));else{const t=n.object[n.property].split("=")[0]+"= "+e.data.value.toString();n.setValue(t),n.__onFinishChange(n,t)}}function za(){N.embossAmbient.value=k.embossAmbient,N.embossDiffuse.value=k.embossDiffuse,N.embossShiny.value=k.embossShiny,N.embossSmoothness.value=k.embossSmoothness,N.embossSpecular.value=k.embossSpecular,N.embossLightDir.value=new Jt.Vector3(Math.sin(k.embossTheta)*Math.cos(k.embossPhi),Math.sin(k.embossTheta)*Math.sin(k.embossPhi),Math.cos(k.embossTheta))}function Ja(e,n,t,i){e.slider=document.createElement("input"),e.slider.classList.add("styled-slider"),e.slider.classList.add("slider-progress"),e.slider.type="range",e.slider.min=n,e.slider.max=t,e.slider.step=i,e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value),e.slider.style.setProperty("--min",e.slider.min),e.slider.style.setProperty("--max",e.slider.max),e.slider.addEventListener("input",(function(){e.slider.style.setProperty("--value",e.slider.value),e.setValue(parseFloat(e.slider.value))})),null!=e.__onChange&&(e.oldOnChange=e.__onChange,e.__onChange=function(){e.oldOnChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),null!=e.__onFinishChange&&(e.oldOnFinishChange=e.__onFinishChange,e.__onFinishChange=function(){e.oldOnFinishChange(),e.slider.value=e.getValue(),e.slider.style.setProperty("--value",e.slider.value)}),e.domElement.appendChild(e.slider),e.domElement.parentElement.parentElement.classList.add("parameterSlider")}function Ha(){N.contourColour.value=new Jt.Color(k.contourColour),N.contourEpsilon.value=k.contourEpsilon,N.contourStep.value=1/(k.contourNum+1)}function Xa(){pn||Ai()}bi&&Xi("GrayScott"),(Do()||bi||k.forceTryClickingPopup)&&!k.suppressTryClickingPopup&&k.brushEnabled&&($("#top_message").html("<p>"+k.tryClickingText+"</p>"),Wo("#top_message"),setTimeout((()=>To("#top_message")),5e3),$("#simCanvas").one("pointerdown touchstart",(()=>To("#top_message")))),$("#settings").click((function(){Ia(),$("#right_ui").is(":visible")&&$("#help_panel").is(":visible")&&qa(),$("#right_ui").is(":visible")&&$("#share_panel").is(":visible")&&Oa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&($("#left_ui").is(":visible")&&La(),$("#views_ui").is(":visible")&&Ma()),$("#left_ui").is(":visible")&&aa()})),$("#equations").click((function(){La(),aa(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ia(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&Ma()})),$("#pause").click((function(){Li()})),$("#play").click((function(){Mi()})),$("#erase").click((function(){qi()})),$("#warning_restart").click((function(){$("#oops_hit_nan").hide(),qi()})),$("#share").click((function(){Oa(),$("#help_panel").is(":visible")&&qa()})),$("#help").click((function(){qa(),$("#share_panel").is(":visible")&&Oa()})),$("#screenshot").click((function(){Kn=!0,Ai(),Oa()})),$("#link").click((function(){I.copyConfigAsURL(),Oa()})),$("#embed").click((function(){!function(){let e=Ba();switch(document.getElementById("embed_ui_type").value){case"full":break;case"story":e+="&story";break;case"none":e+="&no_ui"}ja('<iframe style="border:0;width:100%;height:100%;" src="'+e+'" frameborder="0" loading="lazy"></iframe>')}(),Oa()})),$("#embed_ui_type").change((function(){$("#embed_ui_type").blur()})),$("#help_panel .container .button").click((function(){qa()})),$("#views").click((function(){Ma(),window.innerWidth<629&&$("#right_ui").is(":visible")&&$("#views_ui").is(":visible")&&Ia(),$("#views_ui").is(":visible")&&$("#left_ui").is(":visible")&&La()})),$(document).on("click","#add_view",(function(){!function(){let e=Da();e.name=k.views.length+1,k.views.push(e),k.activeViewInd=k.views.length-1,_a()}()})),function e(){requestAnimationFrame(e),gn=hn,hn&&k.brushEnabled&&function(){!k.fixRandSeed&&k.brushValue.includes("RAND")&&ro();E.material=v;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1)}();if(pn){!bn||function(){E.material=w;for(let e=1;e<Dn.length;e++)N.textureSource.value=Dn[e].texture,s.setRenderTarget(Dn[e-1]),s.render(r,o);Dn.rotate(-1)}(),E.material=S;for(let e=0;e<k.numTimestepsPerFrame;e++)Qi()}(gn||pn)&&Ai()}();